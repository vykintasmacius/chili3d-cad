"use strict";(self.webpackChunkchili3d=self.webpackChunkchili3d||[]).push([["796"],{8249:function(e,t,i){i.r(t),i.d(t,{MainWindow:()=>MainWindow,Dialog:()=>Dialog});var n,a=i(4501),o=i(8909),s=i(9734);let Dialog=class Dialog{constructor(){}static show(e,t,i){let n=document.createElement("dialog");document.body.appendChild(n),n.appendChild((0,a.hi)({className:s.root},(0,a.hi)({className:s.title},o.oc.translate(e)??"chili3d"),(0,a.hi)({className:s.content},t),(0,a.hi)({className:s.buttons},(0,a.LI)({textContent:o.oc.translate("common.confirm"),onclick:()=>{n.remove(),i?.(o.Xs.ok)}}),(0,a.LI)({textContent:o.oc.translate("common.cancel"),onclick:()=>{n.remove(),i?.(o.Xs.cancel)}})))),n.showModal()}};var r=i(1166),c=i(4871),l=i(6130),d=i(1176);let TreeItem=class TreeItem extends HTMLElement{document;name;visibleIcon;_node;get node(){return this._node}constructor(e,t){super(),this.document=e,this.onPropertyChanged=(e,t)=>{"visible"===e?(0,a.bQ)(this.visibleIcon,this.getVisibleIcon()):"parentVisible"===e&&this.setVisibleStyle(t[e])},this.onVisibleIconClick=e=>{e.stopPropagation(),o.YW.execute(this.document,"change visible",()=>{this.node.visible=!this.node.visible}),this.document.visual.update()},this._node=t,this.draggable=!0,this.name=(0,a.PS)({className:d.name,textContent:new o.KX(t,"name")}),this.visibleIcon=(0,a.YP)({className:d.icon,icon:this.getVisibleIcon(),onclick:this.onVisibleIconClick}),this.setVisibleStyle(t.parentVisible)}connectedCallback(){this.node.onPropertyChanged(this.onPropertyChanged)}disconnectedCallback(){this.node.removePropertyChanged(this.onPropertyChanged)}onPropertyChanged;setVisibleStyle(e){!0===e?this.visibleIcon.classList.remove(d["parent-hidden"]):this.visibleIcon.classList.add(d["parent-hidden"])}addSelectedStyle(e){this.getSelectedHandler().classList.add(e)}removeSelectedStyle(e){this.getSelectedHandler().classList.remove(e)}dispose(){this.remove(),this.node.removePropertyChanged(this.onPropertyChanged),this.visibleIcon.removeEventListener("click",this.onVisibleIconClick),this.document=null,this._node=null}getVisibleIcon(){return this.node.visible?"icon-eye":"icon-eye-slash"}onVisibleIconClick};var h=i(1132);let TreeGroup=class TreeGroup extends TreeItem{_isExpanded=!0;header;items=(0,a.hi)({className:`${h.container} ${h.left16px}`});expanderIcon;constructor(e,t){super(e,t),this.expanderIcon=(0,a.YP)({icon:this.getExpanderIcon(),className:h.expanderIcon,onclick:this.handleExpanderClick}),this.header=(0,a.hi)({className:`${h.row} ${h.header}`},this.expanderIcon,this.name,this.visibleIcon),super.append((0,a.hi)({className:h.container},this.header,this.items))}get isExpanded(){return this._isExpanded}set isExpanded(e){this._isExpanded=e,(0,a.bQ)(this.expanderIcon,this.getExpanderIcon()),this.items.classList.toggle(h.hide,!this._isExpanded)}getSelectedHandler(){return this.header}dispose(){super.dispose(),this.header.remove(),this.expanderIcon.removeEventListener("click",this.handleExpanderClick)}handleExpanderClick=e=>{e.stopPropagation(),this.isExpanded=!this._isExpanded};getExpanderIcon(){return this._isExpanded?"icon-angle-down":"icon-angle-right"}appendChild(e){return this.items.appendChild(e),e}append(...e){this.items.append(...e)}removeChild(e){return e.parentNode===this.items&&this.items.removeChild(e),e}addItem(...e){return this.items.append(...e),this}insertAfter(e,t){let i=t?t.nextSibling:this.items.firstChild;this.items.insertBefore(e,i)}};customElements.define("tree-group",TreeGroup);let ToolBar=class ToolBar extends HTMLElement{projectView;constructor(e){super(),this.projectView=e,this.newGroup=()=>{o.pS.default.pub("executeCommand","create.folder")},this.expandAll=()=>{this.setExpand(!0)},this.unExpandAll=()=>{this.setExpand(!1)},this.className=l.panel,this.render()}render(){[{icon:"icon-folder-plus",tip:"items.tool.newFolder",command:this.newGroup},{icon:"icon-unexpand",tip:"items.tool.unexpandAll",command:this.unExpandAll},{icon:"icon-expand",tip:"items.tool.expandAll",command:this.expandAll}].forEach(({icon:e,tip:t,command:i})=>this.button(e,t,i))}button(e,t,i){this.append((0,a.a)({title:o.oc.translate(t)},(0,a.YP)({icon:e,className:l.svg,onclick:i})))}newGroup;expandAll;unExpandAll;setExpand(e){let t=this.projectView.activeTree();if(!t)return;let i=this.projectView.activeDocument?.rootNode.firstChild;i&&this.setNodeExpand(t,i,e)}setNodeExpand(e,t,i){let n=e.treeItem(t);n instanceof TreeGroup&&(n.isExpanded=i),o.ND.isLinkedListNode(t)&&t.firstChild&&this.setNodeExpand(e,t.firstChild,i),t.nextSibling&&this.setNodeExpand(e,t.nextSibling,i)}};customElements.define("chili-toolbar",ToolBar);var p=i(492),m=i(780),u=i(7935);let TreeModel=class TreeModel extends TreeItem{constructor(e,t){super(e,t),this.append(this.name,this.visibleIcon),this.classList.add(u.panel)}getSelectedHandler(){return this}};customElements.define("tree-model",TreeModel);let Tree=class Tree extends HTMLElement{document;nodeMap;lastClicked;selectedNodes;dragging;constructor(e){super(),this.document=e,this.nodeMap=new Map,this.selectedNodes=new Set,this.handleSelectionChanged=(e,t,i)=>{i.forEach(e=>{this.nodeMap.get(e)?.removeSelectedStyle(m.selected),this.selectedNodes.delete(e)}),this.setLastClickItem(void 0),t.forEach(e=>{this.selectedNodes.add(e),this.nodeMap.get(e)?.addSelectedStyle(m.selected)}),this.scrollToNode(t)},this.onClick=e=>{if(!this.canSelect())return;let t=this.getTreeItem(e.target)?.node;t&&(e.stopPropagation(),e.shiftKey?this.handleShiftClick(t):this.document.selection.setSelection([t],e.ctrlKey),this.setLastClickItem(t))},this.onDragLeave=e=>{if(!this.canDrop(e))return},this.onDragOver=e=>{this.canDrop(e)&&(e.preventDefault(),e.dataTransfer.dropEffect="move")},this.onDrop=e=>{e.preventDefault(),e.stopPropagation();let t=this.getTreeItem(e.target)?.node;void 0!==t&&o.YW.execute(this.document,"move node",()=>{let e=o.ND.isLinkedListNode(t),i=e?t:t.parent,n=e?void 0:t;this.dragging?.forEach(e=>{e.parent?.move(e,i,n)}),this.dragging=void 0})},this.onDragStart=e=>{e.stopPropagation();let t=this.getTreeItem(e.target)?.node;this.dragging=o.ND.findTopLevelNodes(this.selectedNodes),t&&!o.ND.containsDescendant(this.selectedNodes,t)&&this.dragging.push(t)},this.className=m.panel,this.initializeTree(e)}initializeTree(e){this.addAllNodes(e,this,e.rootNode),this.addEvents(this)}connectedCallback(){this.document.addNodeObserver(this),o.pS.default.sub("selectionChanged",this.handleSelectionChanged)}disconnectedCallback(){this.document.removeNodeObserver(this),o.pS.default.remove("selectionChanged",this.handleSelectionChanged)}treeItem(e){return this.nodeMap.get(e)}dispose(){this.lastClicked=void 0,this.dragging=void 0,this.nodeMap.forEach(e=>e.dispose()),this.nodeMap.clear(),this.selectedNodes.clear(),this.removeEvents(this),this.document.removeNodeObserver(this),o.pS.default.remove("selectionChanged",this.handleSelectionChanged),this.document=null}handleNodeChanged(e){this.ensureHasHTML(e),e.forEach(e=>{let t=this.nodeMap.get(e.node);if(t?.remove(),!t||!e.newParent)return;let i=this.nodeMap.get(e.newParent)||this.createAndMapParent(e.newParent);if(i instanceof TreeGroup){let n=e.newPrevious?this.nodeMap.get(e.newPrevious):null;i.insertAfter(t,n??null)}})}createAndMapParent(e){let t=this.createHTMLElement(this.document,e);return this.nodeMap.set(e,t),t}handleSelectionChanged;ensureHasHTML(e){e.forEach(e=>{this.nodeMap.has(e.node)||this.nodeMap.set(e.node,this.createHTMLElement(this.document,e.node))})}scrollToNode(e){let t=e.at(0);t&&(this.expandParents(t),this.nodeMap.get(t)?.scrollIntoView({block:"nearest",behavior:"smooth"}))}expandParents(e){let t=e.parent;for(;t;){let e=this.nodeMap.get(t);e&&!e.isExpanded&&(e.isExpanded=!0),t=t.parent}}addAllNodes(e,t,i){let n=this.createHTMLElement(e,i);this.nodeMap.set(i,n),t.appendChild(n);let a=i.firstChild;a&&this.addAllNodes(e,n,a),i.nextSibling&&this.addAllNodes(e,t,i.nextSibling)}createHTMLElement(e,t){let i;if(o.ND.isLinkedListNode(t))i=new TreeGroup(e,t);else if(t instanceof o.S3)i=new TreeModel(e,t);else throw Error("unknown node");return i}addEvents(e){e.addEventListener("dragstart",this.onDragStart),e.addEventListener("dragover",this.onDragOver),e.addEventListener("dragleave",this.onDragLeave),e.addEventListener("drop",this.onDrop),e.addEventListener("click",this.onClick)}removeEvents(e){e.removeEventListener("dragstart",this.onDragStart),e.removeEventListener("dragover",this.onDragOver),e.removeEventListener("dragleave",this.onDragLeave),e.removeEventListener("drop",this.onDrop),e.removeEventListener("click",this.onClick)}getTreeItem(e){if(null!==e)return e instanceof TreeItem?e:this.getTreeItem(e.parentElement)}onClick;handleShiftClick(e){if(this.lastClicked){let t=o.ND.getNodesBetween(this.lastClicked,e);this.document.selection.setSelection(t,!1)}}onDragLeave;onDragOver;canSelect(){return this.document.visual.eventHandler instanceof p.t||this.document.visual.eventHandler instanceof p.k8&&this.document.visual.eventHandler.shapeType===o.ax.Shape}setLastClickItem(e){void 0!==this.lastClicked&&this.nodeMap.get(this.lastClicked)?.removeSelectedStyle(m.current),this.lastClicked=e,void 0!==e&&(this.nodeMap.get(e)?.addSelectedStyle(m.current),this.document.currentNode=o.ND.isLinkedListNode(e)?e:e.parent)}canDrop(e){let t=this.getTreeItem(e.target)?.node;if(void 0===t||this.dragging?.includes(t))return!1;let i=t.parent;for(;void 0!==i;){if(this.dragging?.includes(i))return!1;i=i.parent}return!0}onDrop;onDragStart};customElements.define("ui-tree",Tree);let ProjectView=class ProjectView extends HTMLElement{_documentTreeMap=new Map;_activeDocument;get activeDocument(){return this._activeDocument}panel;constructor(e){super(),this.classList.add(c.root,e.className),this.panel=(0,a.hi)({className:c.itemsPanel}),o.pS.default.sub("activeViewChanged",this.handleActiveViewChanged),o.pS.default.sub("documentClosed",this.handleDocumentClosed),this.render()}render(){this.append((0,a.hi)({className:c.headerPanel},(0,a.yP)({className:c.header,textContent:new o.Xx("items.header")}),new ToolBar(this)),this.panel)}activeTree(){if(this._activeDocument)return this._documentTreeMap.get(this._activeDocument)}handleDocumentClosed=e=>{let t=this._documentTreeMap.get(e);t&&(t.remove(),t.dispose(),this._documentTreeMap.delete(e))};handleActiveViewChanged=e=>{if(this._activeDocument!==e?.document&&(this._documentTreeMap.get(this._activeDocument)?.remove(),this._activeDocument=e?.document,e)){let t=this._documentTreeMap.get(e.document);t||(t=new Tree(e.document),this._documentTreeMap.set(e.document,t)),this.panel.append(t)}}};customElements.define("chili-project-view",ProjectView);var A=i(4709),f=i(7418),b=i(4009);let PropertyBase=class PropertyBase extends HTMLElement{objects;constructor(e){if(super(),this.objects=e,this.className=b.panel,0===e.length)throw Error("there are no objects")}};let ArrayValueConverter=class ArrayValueConverter{objects;property;converter;constructor(e,t,i){this.objects=e,this.property=t,this.converter=i}convert(e){return o.x4.ok(this.getDefaultValue())}convertBack(e){throw Error("Method not implemented.")}getValueString(e){let t=e[this.property.name],i=this.converter?.convert(t);return i?.isOk?i.value:String(t)}getDefaultValue(){let e=this.objects.map(this.getValueString.bind(this));return 1===new Set(e).size?e[0]:""}};let InputProperty=class InputProperty extends PropertyBase{document;property;converter;constructor(e,t,i,n){super(t),this.document=e,this.property=i,this.handleBlur=e=>{this.setValue(e.target)},this.handleKeyDown=e=>{e.stopPropagation(),this.converter&&"Enter"===e.key&&this.setValue(e.target)},this.setValue=e=>{if(this.isReadOnly())return;let t=this.converter?.convertBack?.(e.value);if(!t?.isOk)return void o.pS.default.pub("showToast","error.default:{0}",t?.error);o.YW.execute(this.document,"modify property",()=>{this.objects.forEach(e=>{e[this.property.name]=t.value}),this.document.visual.update()})},this.converter=n??this.getConverter();let s=new ArrayValueConverter(t,i,this.converter);this.append((0,a.hi)({className:A.panel},(0,a.yP)({className:A.propertyName,textContent:new o.Xx(i.display)}),(0,a.qH)({className:f.box,value:new o.KX(t[0],i.name,s),readOnly:this.isReadOnly(),onkeydown:this.handleKeyDown,onblur:this.handleBlur})))}isReadOnly(){let e=Object.getOwnPropertyDescriptor(this.objects[0],this.property.name);if(!e){let t=Object.getPrototypeOf(this.objects[0]);for(;(0,o.Cy)(t)&&!(e=Object.getOwnPropertyDescriptor(t,this.property.name));)t=Object.getPrototypeOf(t)}return e?.set===void 0||void 0===this.converter&&"string"!=typeof this.objects[0][this.property.name]}handleBlur;handleKeyDown;setValue;getConverter(){let e=this.objects[0][this.property.name].constructor.name,t={[o.vY.name]:()=>new a.S6,[o.XY.name]:()=>new a.pr,[String.name]:()=>new a.B0,[Number.name]:()=>new a.vU};return t[e]?.()}};customElements.define("chili-input-property",InputProperty);let MatrixProperty=class MatrixProperty extends PropertyBase{document;first;constructor(e,t,i){super(t),this.document=e,this.onPropertyChanged=e=>{"transform"===e&&this.objects.forEach(e=>{e!==this.first&&(e.transform=this.first.transform)})},this.first=t[0],this.className=i,this.append(new InputProperty(e,[this.first],{name:"transform",display:"transform.translation"},new TranslationConverter(this.first)),new InputProperty(e,[this.first],{name:"transform",display:"transform.scale"},new ScalingConverter(this.first)),new InputProperty(e,[this.first],{name:"transform",display:"transform.rotation"},new RotateConverter(this.first)))}onPropertyChanged;connectedCallback(){this.first.onPropertyChanged(this.onPropertyChanged)}disconnectedCallback(){this.first.removePropertyChanged(this.onPropertyChanged)}};customElements.define("matrix-property",MatrixProperty);let MatrixConverter=class MatrixConverter{geometry;constructor(e){this.geometry=e}convert(e){let[t,i,n]=this.convertFrom(e);return o.x4.ok(`${t.toFixed(6)}, ${i.toFixed(6)}, ${n.toFixed(6)}`)}convertBack(e){let t=e.split(",").map(Number).filter(e=>!isNaN(e));if(3!==t.length)return o.x4.err("invalid number of values");let i={x:t[0],y:t[1],z:t[2]},n=this.convertTo(i);return o.x4.ok(n)}};let TranslationConverter=class TranslationConverter extends MatrixConverter{convertFrom(e){let t=e.translationPart();return[t.x,t.y,t.z]}convertTo(e){let t=this.geometry.transform.getEulerAngles(),i=this.geometry.transform.getScale();return o.yG.createFromTRS(e,t,i)}};let ScalingConverter=class ScalingConverter extends MatrixConverter{convertFrom(e){let t=e.getScale();return[t.x,t.y,t.z]}convertTo(e){let t=this.geometry.transform.getEulerAngles(),i=this.geometry.transform.translationPart();return o.yG.createFromTRS(i,t,e)}};let RotateConverter=class RotateConverter extends MatrixConverter{convertFrom(e){let t=e.getEulerAngles();return[180*t.pitch/Math.PI,180*t.yaw/Math.PI,180*t.roll/Math.PI]}convertTo(e){let t=this.geometry.transform.getScale(),i=this.geometry.transform.translationPart();return o.yG.createFromTRS(i,{pitch:e.x*Math.PI/180,yaw:e.y*Math.PI/180,roll:e.z*Math.PI/180},t)}};var g=i(1503);let CheckProperty=class CheckProperty extends PropertyBase{property;constructor(e,t){super(e),this.property=t}};customElements.define("chili-check-property",CheckProperty);var v=i(2958);let ColorProperty=class ColorProperty extends PropertyBase{document;property;converter;input;constructor(e,t,i){super(t),this.document=e,this.property=i,this.converter=new a.No,this.setColor=e=>{let t=e.target.value,i=this.converter.convertBack(t).value;if(void 0===i)return void o.pS.default.pub("showToast","toast.converter.invalidColor");o.YW.execute(this.document,"change color",()=>{this.objects.forEach(e=>{e[this.property.name]=i})})},this.input=this.createInput(t[0]),this.appendChild(this.createPanel())}createInput(e){return(0,a.qH)({className:v.color,type:"color",value:new o.KX(e,this.property.name,this.converter),onchange:this.setColor})}createPanel(){return(0,a.hi)({className:A.panel},(0,a.PS)({className:A.propertyName,textContent:new o.Xx(this.property.display)}),this.input)}disconnectedCallback(){this.input.removeEventListener("onchange",this.setColor)}setColor};customElements.define("chili-color-property",ColorProperty);var C=i(7604),w=i(975);let TextureProperty=class TextureProperty extends a.xH{document;texture;constructor(e,t,i){super(t),this.document=e,this.texture=i,this.selectTexture=async()=>{let e=await (0,o.vZ)(".png, .jpg, .jpeg",!1,"readAsDataURL");this.texture.image=e.value[0].data},this.classList.add(w.root),this.append(this.render())}render(){let e=o.Z9.getProperties(this.texture).filter(e=>"image"!==e.name).map(e=>findPropertyControl(this.document,[this.texture],e));return(0,a.hi)({className:w.expander},(0,a.hi)({className:w.properties},...e),(0,a.hi)({className:w.image},(0,a.lv)({style:{backgroundImage:new o.wK(this.texture,"image",new C.C),backgroundSize:"contain"},onclick:this.selectTexture}),(0,a.YP)({icon:"icon-times",onclick:()=>{this.texture.image=""}})))}selectTexture};customElements.define("texture-editor",TextureProperty);var y=i(1868);let MaterialProperty=class MaterialProperty extends PropertyBase{document;property;materials;constructor(e,t,i){super(t),this.document=e,this.property=i,this.materials=this.materialCollection(t[0].materialId),this.append((0,a.hJ)({sources:this.materials,template:(t,i)=>this.materialControl(e,t,i)}))}materialControl(e,t,i){return(0,a.hi)({className:y.material},(0,a.hi)((0,a.yP)({textContent:new o.Xx("common.material")}),this.materials.length>1?(0,a.yP)({textContent:` ${i+1}`}):""),(0,a.LI)({textContent:t.name,style:{backgroundColor:new o.KX(t,"color",new a.No),backgroundImage:new o.wK(t,"map.image",new a.C8),backgroundBlendMode:"multiply",backgroundSize:"cover",cursor:"pointer"},onclick:n=>{o.pS.default.pub("editMaterial",e,t,e=>{this.setMaterial(n,e,i)})}}))}setMaterial(e,t,i){o.YW.execute(this.document,"change material",()=>{this.materials.replace(i,t),this.objects.forEach(e=>{this.property.name in e&&(e.materialId=this.materials.length>1?e.materialId.toSpliced(i,1,t.id):t.id)})}),this.document.visual.update()}materialCollection(e){let findMaterial=e=>this.document.materials.find(t=>t.id===e),t=Array.isArray(e)?e.map(findMaterial).filter(Boolean):[findMaterial(e)].filter(Boolean);return new o.Vn(...t)}};function findPropertyControl(e,t,i,n){if(void 0===i||0===t.length)return"";if("color"===i.type)return new ColorProperty(e,t,i);if("materialId"===i.type&&canShowMaterialProperty(t,i))return new MaterialProperty(e,t,i);let a=t[0][i.name];return a instanceof o.xE?new TextureProperty(e,i.display,a):["object","string","number"].includes(typeof a)?new InputProperty(e,t,i,n):"boolean"==typeof a?new CheckProperty(t,i):(o.Yd.warn(`Property ${i.name} not found in ${Object.getPrototypeOf(t[0]).constructor.name}`),"")}function canShowMaterialProperty(e,t){return 0!==e.length&&(1===e.length||e.every(i=>i[t.name]===e[0][t.name]))}customElements.define("chili-material-property",MaterialProperty);let PropertyView=class PropertyView extends HTMLElement{panel=(0,a.hi)({className:g.panel});constructor(e){super(),this.classList.add(e.className,g.root),this.append((0,a.PS)({className:g.header,textContent:new o.Xx("properties.header")}),this.panel),o.pS.default.sub("showProperties",this.handleShowProperties),o.pS.default.sub("activeViewChanged",this.handleActiveViewChanged)}handleActiveViewChanged=e=>{if(e){let t=e.document.selection.getSelectedNodes();this.handleShowProperties(e.document,t)}};handleShowProperties=(e,t)=>{this.removeProperties(),0!==t.length&&(this.addModel(e,t),this.addGeometry(t,e))};removeProperties(){for(;this.panel.lastElementChild;)this.panel.removeChild(this.panel.lastElementChild)}addModel(e,t){if(0===t.length)return;let i=[];t[0]instanceof o.YT?i=o.Z9.getProperties(Object.getPrototypeOf(t[0])).map(i=>findPropertyControl(e,t,i)):t[0]instanceof o.NB&&(i=o.Z9.getOwnProperties(o.NB.prototype).map(i=>findPropertyControl(e,t,i))),this.panel.append((0,a.hi)({className:g.properties},...i))}addGeometry(e,t){let i=e.filter(e=>e instanceof o.S3||e instanceof o.Gw);0!==i.length&&this.isAllElementsOfTypeFirstElement(i)&&(this.addTransform(t,i),this.addParameters(i,t))}addTransform(e,t){let i=new a.xH("common.matrix");this.panel.append(i),i.contenxtPanel.append(new MatrixProperty(e,t,g.properties))}addParameters(e,t){let i=e.filter(e=>e instanceof o.S3);if(0===i.length||!this.isAllElementsOfTypeFirstElement(i))return;let n=new a.xH(i[0].display());n.contenxtPanel.append(...o.Z9.getProperties(Object.getPrototypeOf(i[0]),o.NB.prototype).map(e=>findPropertyControl(t,i,e))),this.panel.append(n)}isAllElementsOfTypeFirstElement(e){if(e.length<=1)return!0;let t=Object.getPrototypeOf(e[0]).constructor;for(let i=1;i<e.length;i++)if(Object.getPrototypeOf(e[i]).constructor!==t)return!1;return!0}};customElements.define("chili-property-view",PropertyView);var x=i(1530),P=i(8930);let CommandContext=class CommandContext extends HTMLElement{command;propMap;constructor(e){super(),this.command=e,this.propMap=new Map,this.onPropertyChanged=e=>{if(this.propMap.has(e)){let[t,i]=this.propMap.get(e);this.setVisible(i,t)}},this.className=P.panel;let t=o.mY.getData(e);this.append((0,a.YP)({className:P.icon,icon:t.icon}),(0,a.PS)({className:P.title,textContent:new o.Xx(`command.${t.key}`)},": ")),this.initContext()}connectedCallback(){this.command instanceof o.y$&&this.command.onPropertyChanged(this.onPropertyChanged)}disconnectedCallback(){this.command instanceof o.y$&&this.command.removePropertyChanged(this.onPropertyChanged)}dispose(){this.propMap.clear()}onPropertyChanged;initContext(){let e=new Map;o.Z9.getProperties(this.command).forEach(t=>{let i=this.findGroup(e,t),n=this.createItem(this.command,t);this.setVisible(n,t),this.cacheDependencies(n,t),i.append(n)})}cacheDependencies(e,t){if(t.dependencies)for(let i of t.dependencies)this.propMap.set(i.property,[t,e])}setVisible(e,t){let i=!0;if(t.dependencies){for(let e of t.dependencies)if(this.command[e.property]!==e.value){i=!1;break}}e.style.display=i?"":"none"}findGroup(e,t){let i=e.get(t.group);return void 0===i&&(i=(0,a.hi)({className:P.group}),e.set(t.group,i),this.append(i)),i}createItem(e,t){let i=typeof e[t.name];if("materialId"===t.type)return this.materialEditor(t,e);switch(i){case"function":return this.newButton(t,e);case"boolean":return this.newCheckbox(t,e);case"number":return this.newInput(t,e,parseFloat);case"string":return this.newInput(t,e);default:if(e[t.name]instanceof o.hQ)return this.newCombobox(e,t);throw Error("暂不支持的类型")}}newCombobox(e,t){let i=e[t.name],n=i.items.map((e,t)=>(0,a.Kw)({selected:t===i.selectedIndex,textContent:o.oc.isI18nKey(e)?new o.Xx(e):i.converter?.convert(e).unchecked()??String(e)}));return(0,a.hi)((0,a.PS)({textContent:new o.Xx(t.display)}),(0,a.Ys)({className:P.select,onchange:e=>{i.selectedIndex=e.target.selectedIndex}},...n))}newInput(e,t,i){return(0,a.hi)((0,a.PS)({textContent:new o.Xx(e.display)}),(0,a.qH)({type:"text",className:P.input,value:new o.KX(t,e.name),onkeydown:n=>{if(n.stopPropagation(),"Enter"===n.key){let a=n.target;t[e.name]=i?i(a.value):a.value,a.blur()}}}))}newCheckbox(e,t){return(0,a.hi)((0,a.PS)({textContent:new o.Xx(e.display)}),(0,a.qH)({type:"checkbox",checked:new o.KX(t,e.name),onclick:()=>{t[e.name]=!t[e.name]}}))}newButton(e,t){return(0,a.LI)({className:P.button,textContent:new o.Xx(e.display),onclick:()=>t[e.name]()})}materialEditor(e,t){if(!(this.command instanceof o.uu))throw Error("MaterialEditor only support CancelableCommand");let i=this.command.document.materials.find(i=>i.id===t[e.name]),n=i.clone();return(0,a.LI)({className:P.materialButton,style:{backgroundColor:new o.KX(n,"color",new a.No),backgroundImage:new o.wK(n,"map.image",new a.C8),backgroundBlendMode:"multiply",backgroundSize:"cover",cursor:"pointer"},textContent:new o.Xx(e.display),onclick:()=>{this.command instanceof x.av&&o.pS.default.pub("editMaterial",this.command.document,i,i=>{t[e.name]=i.id,n.color=i.color,n.map=i.map})}})}};customElements.define("command-context",CommandContext);var _=i(6608),k=i(1752);let RibbonButton=class RibbonButton extends HTMLElement{onClick;constructor(e,t,i,n){super(),this.onClick=n,this.initHTML(e,t,i),this.addEventListener("click",n)}static fromCommandName(e,t){let i=o.mY.getData(e);return i?i.toggle?new RibbonToggleButton(i,t):new RibbonButton(`command.${i.key}`,i.icon,t,()=>{o.pS.default.pub("executeCommand",e)}):void o.Yd.warn(`commandData of ${e} is undefined`)}dispose(){this.removeEventListener("click",this.onClick)}initHTML(e,t,i){let n=(0,a.YP)({icon:t});this.className=i===o.qE.large?k.normal:k.small,n.classList.add(i===o.qE.large?k.icon:k.smallIcon);let s=(0,a.PS)({className:k.buttonText,textContent:new o.Xx(e)});o.oc.set(this,"title",e),this.append(n,s)}};customElements.define("ribbon-button",RibbonButton);let ToggleConverter=class ToggleConverter{className;active;constructor(e,t){this.className=e,this.active=t}convert(e){return e?o.x4.ok(`${this.className} ${this.active}`):o.x4.ok(this.className)}};let RibbonToggleButton=class RibbonToggleButton extends RibbonButton{constructor(e,t){super(`command.${e.key}`,e.icon,t,()=>{o.pS.default.pub("executeCommand",e.key)}),e.toggle&&(e.toggle.converter=new ToggleConverter(this.className,k.checked),e.toggle.setBinding(this,"className"))}};customElements.define("ribbon-toggle-button",RibbonToggleButton);var N=i(5692);let RibbonStack=class RibbonStack extends HTMLElement{constructor(){super(),this.className=N.root}};customElements.define("ribbon-stack",RibbonStack);let RibbonDataContent=class RibbonDataContent extends o.y${app;quickCommands;ribbonTabs;_activeTab;_activeView;constructor(e,t,i){super(),this.app=e,this.quickCommands=new o.Vn,this.ribbonTabs=new o.Vn,this.quickCommands.push(...t),this.ribbonTabs.push(...i),this._activeTab=i[0],o.pS.default.sub("activeViewChanged",e=>this.activeView=e)}get activeTab(){return this._activeTab}set activeTab(e){this.setProperty("activeTab",e)}get activeView(){return this._activeView}set activeView(e){this.setProperty("activeView",e)}};let QuickButton=e=>{let t=o.mY.getData(e);return t?(0,a.YP)({icon:t.icon,title:new o.Xx(`command.${t.key}`),onclick:()=>o.pS.default.pub("executeCommand",t.key)}):(o.Yd.warn("commandData is undefined"),(0,a.yP)({textContent:"null"}))};let ViewActiveConverter=class ViewActiveConverter{target;style;activeStyle;constructor(e,t,i){this.target=e,this.style=t,this.activeStyle=i}convert(e){return o.x4.ok(this.target===e?`${this.style} ${this.activeStyle}`:this.style)}};let ActivedRibbonTabConverter=class ActivedRibbonTabConverter{tab;style;activeStyle;constructor(e,t,i){this.tab=e,this.style=t,this.activeStyle=i}convert(e){return o.x4.ok(this.tab===e?`${this.style} ${this.activeStyle}`:this.style)}};let DisplayConverter=class DisplayConverter{tab;constructor(e){this.tab=e}convert(e){return o.x4.ok(this.tab===e?"":"none")}};let Ribbon=class Ribbon extends HTMLElement{dataContent;_commandContext;commandContext;constructor(e){super(),this.dataContent=e,this._commandContext=(0,a.hi)({className:_.commandContextPanel}),this.openContext=e=>{this.commandContext&&this.closeContext(),this.commandContext=new CommandContext(e),this._commandContext.append(this.commandContext)},this.closeContext=()=>{this.commandContext?.remove(),this.commandContext?.dispose(),this.commandContext=void 0,this._commandContext.innerHTML=""},this.className=_.root,this.append(this.header(),this.ribbonTabs(),this._commandContext)}header(){return(0,a.hi)({className:_.titleBar},this.leftPanel(),this.centerPanel(),this.rightPanel())}leftPanel(){return(0,a.hi)({className:_.left},(0,a.hi)({className:_.appIcon,onclick:()=>o.pS.default.pub("displayHome",!0)},(0,a.YP)({className:_.icon,icon:"icon-chili"}),(0,a.yP)({id:"appName",textContent:"Chili3D - v0.6.0"})),(0,a.hi)({className:_.ribbonTitlePanel},(0,a.YP)({className:_.home,icon:"icon-home",onclick:()=>o.pS.default.pub("displayHome",!0)}),(0,a.hJ)({className:_.quickCommands,sources:this.dataContent.quickCommands,template:e=>QuickButton(e)}),(0,a.yP)({className:_.split}),this.createRibbonHeader()))}createRibbonHeader(){return(0,a.hJ)({sources:this.dataContent.ribbonTabs,template:e=>{let t=new ActivedRibbonTabConverter(e,_.tabHeader,_.activedTab);return(0,a.PS)({className:new o.KX(this.dataContent,"activeTab",t),textContent:new o.Xx(e.tabName),onclick:()=>this.dataContent.activeTab=e})}})}centerPanel(){return(0,a.hi)({className:_.center},(0,a.hJ)({className:_.views,sources:this.dataContent.app.views,template:e=>this.createViewItem(e)}),(0,a.YP)({className:_.new,icon:"icon-plus",title:o.oc.translate("command.doc.new"),onclick:()=>o.pS.default.pub("executeCommand","doc.new")}))}createViewItem(e){return(0,a.hi)({className:new o.KX(this.dataContent,"activeView",new ViewActiveConverter(e,_.tab,_.active)),onclick:()=>{this.dataContent.app.activeView=e}},(0,a.hi)({className:_.name},(0,a.yP)({textContent:new o.KX(e.document,"name")})),(0,a.YP)({className:_.close,icon:"icon-times",onclick:t=>{t.stopPropagation(),e.close()}}))}rightPanel(){return(0,a.hi)({className:_.right},(0,a.a)({href:"https://github.com/xiangechen/chili3d",target:"_blank"},(0,a.YP)({title:"Github",className:_.icon,icon:"icon-github"})))}ribbonTabs(){return(0,a.hJ)({className:_.tabContentPanel,sources:this.dataContent.ribbonTabs,template:e=>this.ribbonTab(e)})}ribbonTab(e){return(0,a.hJ)({className:_.groupPanel,sources:e.groups,style:{display:new o.KX(this.dataContent,"activeTab",new DisplayConverter(e))},template:e=>this.ribbonGroup(e)})}ribbonGroup(e){return(0,a.hi)({className:_.ribbonGroup},(0,a.hJ)({sources:e.items,className:_.content,template:e=>this.ribbonButton(e)}),(0,a.PS)({className:_.header,textContent:new o.Xx(e.groupName)}))}ribbonButton(e){if("string"==typeof e)return RibbonButton.fromCommandName(e,o.qE.large);if(!(e instanceof o.Vn))return new RibbonButton(e.display,e.icon,o.qE.large,e.onClick);{let t=new RibbonStack;return e.forEach(e=>{let i=RibbonButton.fromCommandName(e,o.qE.small);i&&t.append(i)}),t}}connectedCallback(){o.pS.default.sub("openCommandContext",this.openContext),o.pS.default.sub("closeCommandContext",this.closeContext)}disconnectedCallback(){o.pS.default.remove("openCommandContext",this.openContext),o.pS.default.remove("closeCommandContext",this.closeContext)}openContext;closeContext};customElements.define("chili-ribbon",Ribbon);let RibbonGroupData=class RibbonGroupData extends o.y${items;get groupName(){return this.getPrivateValue("groupName")}set groupName(e){this.setProperty("groupName",e)}constructor(e,...t){super(),this.setPrivateValue("groupName",e),this.items=new o.Vn(...t)}static fromProfile(e){return new RibbonGroupData(e.groupName,...e.items.map(e=>Array.isArray(e)?new o.Vn(...e):e))}};let RibbonTabData=class RibbonTabData extends o.y${groups=new o.Vn;get tabName(){return this.getPrivateValue("tabName")}set tabName(e){this.setProperty("tabName",e)}constructor(e,...t){super(),this.setPrivateValue("tabName",e),this.groups.push(...t)}static fromProfile(e){return new RibbonTabData(e.tabName,...e.groups.map(e=>RibbonGroupData.fromProfile(e)))}};var E=i(7141);let S=[{type:o.DE.endPoint,display:"snap.end"},{type:o.DE.midPoint,display:"snap.mid"},{type:o.DE.center,display:"snap.center"},{type:o.DE.perpendicular,display:"snap.perpendicular"},{type:o.DE.intersection,display:"snap.intersection"}];let SnapConfig=class SnapConfig extends HTMLElement{constructor(){super(),this.className=E.container,o.De.instance.onPropertyChanged(this.snapTypeChanged),this.render()}snapTypeChanged=e=>{("snapType"===e||"enableSnap"===e||"enableSnapTracking"===e)&&(this.innerHTML="",this.render())};handleSnapClick(e){o.DE.has(o.De.instance.snapType,e)?o.De.instance.snapType=o.DE.remove(o.De.instance.snapType,e):o.De.instance.snapType=o.DE.add(o.De.instance.snapType,e)}render(){this.append(...S.map(e=>(0,a.hi)((0,a.qH)({type:"checkbox",id:`snap-${e.type}`,checked:o.DE.has(o.De.instance.snapType,e.type),onclick:()=>this.handleSnapClick(e.type)}),(0,a.PS)({htmlFor:`snap-${e.type}`,textContent:new o.Xx(e.display)}))),(0,a.hi)((0,a.qH)({type:"checkbox",id:"snap-tracking",checked:o.De.instance.enableSnapTracking,onclick:()=>o.De.instance.enableSnapTracking=!o.De.instance.enableSnapTracking}),(0,a.PS)({htmlFor:"snap-tracking",textContent:new o.Xx("statusBar.tracking")})))}};customElements.define("chili-snap-config",SnapConfig);var T=i(4714);let Statusbar=class Statusbar extends HTMLElement{tip=(0,a.PS)({textContent:new o.Xx("prompt.default"),className:T.tip});constructor(e){super(),this.className=`${T.panel} ${e}`,o.pS.default.sub("statusBarTip",this.statusBarTip),o.pS.default.sub("clearStatusBarTip",this.clearStatusBarTip),this.render()}render(){this.append((0,a.hi)({className:T.left},this.tip),(0,a.hi)({className:T.right},new SnapConfig))}statusBarTip=e=>{o.oc.set(this.tip,"textContent",e)};clearStatusBarTip=()=>{o.oc.set(this.tip,"textContent","prompt.default")}};customElements.define("chili-statusbar",Statusbar);let M=new Map([["default","default"],["draw","url(data:application/octet-stream;base64,AAACAAEAMDAAABcAFwAwAwAAFgAAACgAAAAwAAAAYAAAAAEAAQAAAAAAgAEAAAAAAAAAAAAAAgAAAAIAAAAAAAAA////AAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAA4AAAAAAAAADgAAAAAAAAAOAAAAAAAAAA4AAAAAAAAADgAAAAAAAAAOAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/gAAAA/wAAH+AAAAD/AAAf4AAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAADgAAAAAAAAAOAAAAAAAAAA4AAAAAAAAADgAAAAAAAAAOAAAAAAAAAA4AAAAAAAAADgAAAAAAAAAAAAAAAAP///////wAA///4P///AAD///g///8AAP//+D///wAA///4P///AAD///g///8AAP//+D///wAA///4P///AAD///g///8AAP//+D///wAA///4P///AAD///////8AAP///////wAA////////AAD///////8AAP///////wAA////////AAD///////8AAP///////wAA////////AAD///////8AAP///////wAAAD////gBAAAAP///+AEAAAA////4AQAAAD////gBAAAAP///+AEAAP///////wAA////////AAD///////8AAP///////wAA////////AAD///////8AAP///////wAA////////AAD///////8AAP///////wAA////////AAD///g///8AAP//+D///wAA///4P///AAD///g///8AAP//+D///wAA///4P///AAD///g///8AAP//+D///wAA///4P///AAD///g///8AAA==), default"],["select.default","crosshair"]]);(n||(n={})).get=function(e){return M.get(e)??"default"};let D=1;let MaterialDataContent=class MaterialDataContent extends o.y${document;callback;get editingMaterial(){return this.getPrivateValue("editingMaterial")}set editingMaterial(e){this.setProperty("editingMaterial",e)}constructor(e,t,i){super(),this.document=e,this.callback=t,this.setPrivateValue("editingMaterial",i)}deleteMaterial(){if(this.document.materials.length<=1)return;let e=this.editingMaterial;this.editingMaterial=this.document.materials.find(e=>e.id!==this.editingMaterial.id),this.callback(this.editingMaterial),this.document.materials.remove(e)}addMaterial(){this.document.materials.push(new o.F5(this.document,`Material ${D++}`,0xdddddd))}copyMaterial(){this.document.materials.push(this.editingMaterial.clone())}};var I=i(8969);let ActiveStyleConverter=class ActiveStyleConverter{material;constructor(e){this.material=e}convert(e){return o.x4.ok(this.material===e?`${I.material} ${I.active}`:I.material)}};let MaterialEditor=class MaterialEditor extends HTMLElement{dataContent;editingControl;colorConverter;constructor(e){super(),this.dataContent=e,this.colorConverter=new a.No,this._handleShowProperty=()=>{this.remove()},this._onEditingMaterialChanged=e=>{"editingMaterial"===e&&(this.editingControl.firstChild?.remove(),this.initEditingControl(this.dataContent.editingMaterial))},this.editingControl=(0,a.hi)({className:I.properties}),this.initEditingControl(e.editingMaterial),this.append(this.createEditorUI())}createEditorUI(){return(0,a.hi)({className:I.root},this.titleSection(),this.materialsCollection(),this.editingControl,this.buttons())}titleSection(){return(0,a.hi)({className:I.title},(0,a.yP)({textContent:new o.Xx("common.material")}),this.iconButton("icon-plus",()=>this.dataContent.addMaterial()),this.iconButton("icon-clone",()=>this.dataContent.copyMaterial()),this.iconButton("icon-trash",()=>this.dataContent.deleteMaterial()))}iconButton(e,t){return(0,a.YP)({icon:e,onclick:t})}materialsCollection(){return(0,a.hJ)({className:I.materials,sources:this.dataContent.document.materials,template:e=>this.material(e)})}material(e){return(0,a.yP)({className:new o.KX(this.dataContent,"editingMaterial",new ActiveStyleConverter(e)),title:e.name,style:{backgroundColor:new o.KX(e,"color",this.colorConverter),backgroundImage:new o.wK(e,"map.image",new C.C),backgroundBlendMode:"multiply",backgroundSize:"contain"},onclick:()=>{this.dataContent.editingMaterial=e},ondblclick:()=>{this.dataContent.callback(e),this.remove()}})}buttons(){return(0,a.hi)({className:I.bottom},(0,a.LI)({textContent:new o.Xx("common.confirm"),onclick:()=>{this.dataContent.callback(this.dataContent.editingMaterial),this.remove()}}),(0,a.LI)({textContent:new o.Xx("common.cancel"),onclick:()=>this.remove()}))}connectedCallback(){this.dataContent.onPropertyChanged(this._onEditingMaterialChanged),o.pS.default.sub("showProperties",this._handleShowProperty)}disconnectedCallback(){o.pS.default.remove("showProperties",this._handleShowProperty)}_handleShowProperty;_onEditingMaterialChanged;initEditingControl(e){this.editingControl.innerHTML="";let isTexture=t=>e[t.name]instanceof o.xE,t=o.Z9.getProperties(e);this.editingControl.append(...t.filter(e=>!isTexture(e)).map(t=>findPropertyControl(this.dataContent.document,[e],t)),...t.filter(isTexture).map(t=>findPropertyControl(this.dataContent.document,[e],t)))}};customElements.define("material-editor",MaterialEditor);var L=i(3113),V=i(5031);let OKCancel=class OKCancel extends HTMLElement{control;constructor(){super(),this.className=V.root,this.append(this.container())}container(){return(0,a.hi)({className:V.container},(0,a.yP)({textContent:new o.Xx("ribbon.group.selection")}),(0,a.hi)({className:V.spacer}),this.buttons())}buttons(){return(0,a.hi)({className:V.panel},this._createIcon("icon-confirm","common.confirm",this._onConfirm),this._createIcon("icon-cancel","common.cancel",this._onCancel))}_createIcon(e,t,i){return(0,a.hi)({className:V.icon,onclick:i},(0,a.YP)({icon:e}),(0,a.yP)({textContent:new o.Xx(t)}))}setControl(e){this.control=e}_onConfirm=()=>{this.control?.success()};_onCancel=()=>{this.control?.cancel()}};customElements.define("ok-cancel",OKCancel);var H=i(2573),B=i(1174);let Input=class Input extends HTMLElement{handler;_cancelledCallbacks;_completedCallbacks;textbox;tip;constructor(e,t){super(),this.handler=t,this._cancelledCallbacks=[],this._completedCallbacks=[],this.handleKeyDown=e=>{e.stopPropagation(),"Enter"===e.key?this.processEnterKey():"Escape"===e.key?this._cancelledCallbacks.forEach(e=>e()):this.removeTip()},this.className=B.panel,this.textbox=(0,a.qH)({value:e,onkeydown:this.handleKeyDown}),this.append(this.textbox)}onCancelled(e){this._cancelledCallbacks.push(e)}onCompleted(e){this._completedCallbacks.push(e)}get text(){return this.textbox.value}focus(){this.textbox.focus()}dispose(){this._cancelledCallbacks.length=0,this._completedCallbacks.length=0}showTip(e){void 0===this.tip?(this.tip=(0,a.PS)({textContent:new o.Xx(e),className:B.error}),this.append(this.tip)):o.oc.set(this.tip,"textContent",e)}removeTip(){void 0!==this.tip&&(this.removeChild(this.tip),this.tip=void 0)}handleKeyDown;processEnterKey(){this.textbox.readOnly=!0;let e=this.handler(this.textbox.value);e.isOk?this._completedCallbacks.forEach(e=>e()):(this.textbox.readOnly=!1,this.showTip(e.error))}};customElements.define("chili-input",Input);var O=i(8705);let Tip=class Tip extends HTMLElement{color;constructor(e,t){super(),this.className=O.tip,this.set(e,t)}set(e,t){this.textContent!==e&&(this.textContent=e);let i=this.getStyle(t);this.setStyle(i)}setStyle(e){this.color!==e&&void 0!==e&&(void 0!==this.color&&this.classList.remove(this.color),this.classList.add(e),this.color=e)}getStyle(e){switch(e){case o.Cs.error:return O.error;case o.Cs.warn:return O.warn;default:return O.info}}};customElements.define("chili-tip",Tip);let Flyout=class Flyout extends HTMLElement{_tip;_input;lastFocus=null;constructor(){super(),this.className=H.root}connectedCallback(){o.pS.default.sub("showFloatTip",this.showTip),o.pS.default.sub("clearFloatTip",this.clearTip),o.pS.default.sub("showInput",this.displayInput),o.pS.default.sub("clearInput",this.clearInput)}disconnectedCallback(){o.pS.default.remove("showFloatTip",this.showTip),o.pS.default.remove("clearFloatTip",this.clearTip),o.pS.default.remove("showInput",this.displayInput),o.pS.default.remove("clearInput",this.clearInput)}showTip=(e,t)=>{void 0===this._tip?(this._tip=new Tip(t,e),this.append(this._tip)):this._tip.set(t,e)};clearTip=()=>{void 0!==this._tip&&(this._tip.remove(),this._tip=void 0)};displayInput=(e,t)=>{void 0===this._input&&(this.lastFocus=document.activeElement,this._input=new Input(e,t),this._input.onCancelled(this.clearInput),this._input.onCompleted(this.clearInput),this.append(this._input),this._input.focus())};clearInput=()=>{void 0!==this._input&&(this.removeChild(this._input),this._input.dispose(),this._input=void 0,this.lastFocus?.focus())}};customElements.define("chili-flyout",Flyout);var X=i(8022);let CameraConverter=class CameraConverter{type;constructor(e){this.type=e}convert(e){return e===this.type?o.x4.ok(X.actived):o.x4.ok("")}};let Viewport=class Viewport extends HTMLElement{view;_flyout;_eventCaches;_acts;constructor(e){super(),this.view=e,this._eventCaches=[],this.onActCollectionChanged=()=>{0===this.view.document.acts.length?this._acts.style.display="none":this._acts.style.display="flex"},this.setActName=e=>{let t=(0,a.qH)({value:e.name,onkeydown:e=>{e.stopPropagation()}});o.pS.default.pub("showDialog","ribbon.group.act",(0,a.hi)((0,a.PS)({textContent:new o.Xx("common.name")}),": ",t),i=>{i===o.Xs.ok&&(e.name=t.value)})},this.pointerMove=(e,t)=>{this._flyout&&(this._flyout.style.top=t.offsetY+"px",this._flyout.style.left=t.offsetX+"px"),e.document.visual.eventHandler.pointerMove(e,t),e.document.visual.viewHandler.pointerMove(e,t)},this.pointerDown=(e,t)=>{e.document.application.activeView=e,e.document.visual.eventHandler.pointerDown(e,t),e.document.visual.viewHandler.pointerDown(e,t)},this.pointerUp=(e,t)=>{e.document.visual.eventHandler.pointerUp(e,t),e.document.visual.viewHandler.pointerUp(e,t)},this.pointerOut=(e,t)=>{e.document.visual.eventHandler.pointerOut?.(e,t),e.document.visual.viewHandler.pointerOut?.(e,t)},this.mouseWheel=(e,t)=>{e.document.visual.eventHandler.mouseWheel?.(e,t),e.document.visual.viewHandler.mouseWheel?.(e,t)},this.className=X.root,this._flyout=new Flyout,this._acts=this.createActs(),this.render(),e.setDom(this)}onActCollectionChanged;render(){this.append(this._acts,(0,a.hi)({className:X.viewControls,onpointerdown:e=>e.stopPropagation(),onclick:e=>e.stopPropagation()},this.createCameraControls(),this.createActionControls()))}createCameraControls(){return(0,a.hi)({className:X.border},this.createCameraControl("orthographic","icon-orthographic"),this.createCameraControl("perspective","icon-perspective"))}createActionControls(){return(0,a.hi)({className:X.border},(0,a.YP)({icon:"icon-fitcontent",onclick:async e=>{e.stopPropagation(),this.view.cameraController.fitContent(),this.view.update()}}),(0,a.YP)({icon:"icon-zoomin",onclick:()=>{this.view.cameraController.zoom(this.view.width/2,this.view.height/2,-5),this.view.update()}}),(0,a.YP)({icon:"icon-zoomout",onclick:()=>{this.view.cameraController.zoom(this.view.width/2,this.view.height/2,5),this.view.update()}}))}createActs(){return(0,a.hi)({className:X.actsContainer},(0,a.hi)({className:X.border,onpointerdown:e=>e.stopPropagation(),onclick:e=>e.stopPropagation()},(0,a.hJ)({className:X.acts,sources:this.view.document.acts,template:e=>(0,a.hi)({onclick:()=>{this.view.cameraController.lookAt(e.cameraPosition,e.cameraTarget,e.cameraUp),this.view.update()}},(0,a.yP)({textContent:new o.KX(e,"name")}),(0,a.hi)({className:X.tools},(0,a.YP)({icon:"icon-cog",onclick:()=>this.setActName(e)}),(0,a.YP)({icon:"icon-times",onclick:()=>{this.view.document.acts.remove(e)}}))),onwheel:e=>{e.preventDefault();let t=e.currentTarget;t.scrollLeft+=e.deltaY}})))}setActName;createCameraControl(e,t){return(0,a.hi)({className:new o.KX(this.view.cameraController,"cameraType",new CameraConverter(e))},(0,a.YP)({icon:t,onclick:t=>{t.stopPropagation(),this.view.cameraController.cameraType=e,this.view.update()}}))}connectedCallback(){this.initEvent(),this.appendChild(this._flyout),this.view.document.acts.onCollectionChanged(this.onActCollectionChanged),this.onActCollectionChanged()}disconnectedCallback(){this.removeEvents(),this._flyout.remove(),this.view.document.acts.removeCollectionChanged(this.onActCollectionChanged)}dispose(){this.removeEvents()}initEvent(){[["pointerdown",this.pointerDown],["pointermove",this.pointerMove],["pointerout",this.pointerOut],["pointerup",this.pointerUp],["wheel",this.mouseWheel]].forEach(e=>{this.addEventListenerHandler(e[0],e[1])})}addEventListenerHandler(e,t){let listener=e=>{e.preventDefault(),t(this.view,e)};this.addEventListener(e,listener),this._eventCaches.push([e,listener])}removeEvents(){this._eventCaches.forEach(e=>{this.removeEventListener(e[0],e[1])}),this._eventCaches.length=0}pointerMove;pointerDown;pointerUp;pointerOut;mouseWheel};customElements.define("chili-uiview",Viewport);let LayoutViewport=class LayoutViewport extends HTMLElement{app;_selectionController;_viewports;constructor(e){super(),this.app=e,this._viewports=new Map,this._handleViewCollectionChanged=e=>{e.action===o.mn.add?e.items.forEach(e=>{this.createViewport(e)}):e.action===o.mn.remove&&e.items.forEach(e=>{let t=this._viewports.get(e);t?.remove(),t?.dispose(),this._viewports.delete(e)})},this._handleCursor=e=>{this.style.cursor=n.get(e)},this._handleActiveViewChanged=e=>{this._viewports.forEach(t=>{t.view===e?t.classList.remove(L.hidden):t.classList.add(L.hidden)})},this.showSelectionControl=e=>{this._selectionController.setControl(e),this._selectionController.style.visibility="visible",this._selectionController.style.zIndex="1000"},this.clearSelectionControl=()=>{this._selectionController.setControl(void 0),this._selectionController.style.visibility="hidden"},this._handleMaterialEdit=(e,t,i)=>{let n=new MaterialDataContent(e,i,t);this.append(new MaterialEditor(n))},this.className=L.root,this._selectionController=new OKCancel,this.append(this._selectionController),this.clearSelectionControl(),e.views.onCollectionChanged(this._handleViewCollectionChanged)}_handleViewCollectionChanged;connectedCallback(){o.pS.default.sub("activeViewChanged",this._handleActiveViewChanged),o.pS.default.sub("showSelectionControl",this.showSelectionControl),o.pS.default.sub("editMaterial",this._handleMaterialEdit),o.pS.default.sub("clearSelectionControl",this.clearSelectionControl),o.pS.default.sub("viewCursor",this._handleCursor)}disconnectedCallback(){o.pS.default.remove("activeViewChanged",this._handleActiveViewChanged),o.pS.default.remove("showSelectionControl",this.showSelectionControl),o.pS.default.remove("editMaterial",this._handleMaterialEdit),o.pS.default.remove("clearSelectionControl",this.clearSelectionControl),o.pS.default.remove("viewCursor",this._handleCursor)}_handleCursor;createViewport(e){let t=new Viewport(e);return t.classList.add(L.viewport,L.hidden),this.appendChild(t),this._viewports.set(e,t),t}_handleActiveViewChanged;showSelectionControl;clearSelectionControl;_handleMaterialEdit};customElements.define("chili-viewport",LayoutViewport);let R=["doc.save","doc.saveToFile","edit.undo","edit.redo"];let Editor=class Editor extends HTMLElement{ribbonContent;constructor(e,t){super();let i=new LayoutViewport(e);i.classList.add(r.viewport),this.ribbonContent=new RibbonDataContent(e,R,t.map(RibbonTabData.fromProfile)),this.render(i),document.body.appendChild(this)}render(e){this.append((0,a.hi)({className:r.root},new Ribbon(this.ribbonContent),(0,a.hi)({className:r.content},(0,a.hi)({className:r.sidebar},new ProjectView({className:r.sidebarItem}),new PropertyView({className:r.sidebarItem})),e),new Statusbar(r.statusbar)))}registerRibbonCommand(e,t,i){let n=this.ribbonContent.ribbonTabs.find(t=>t.tabName===e),a=n?.groups.find(e=>e.groupName===t);a?.items.push(i)}};customElements.define("chili-editor",Editor);var Y=i(4931);let LanguageSelector=e=>{let t=[];return o.oc.languages.forEach((e,i)=>t.push((0,a.Kw)({selected:i===o.oc.currentLanguage(),textContent:e.display}))),(0,a.Ys)({onchange:e=>{let t=e.target.selectedIndex;o.oc.changeLanguage(t)},...e},...t)},$=new o.Vn({display:"command.doc.new",onclick:()=>o.pS.default.pub("executeCommand","doc.new")},{display:"command.doc.open",onclick:()=>o.pS.default.pub("executeCommand","doc.open")});let Home=class Home extends HTMLElement{app;constructor(e){super(),this.app=e,this.className=Y.root}hasOpen(e){for(let t of this.app.documents)if(t.id===e)return!0;return!1}async getDocuments(){return new o.Vn(...await this.app.storage.page(o.gT.DBName,o.gT.RecentTable,0))}async render(){let e=await this.getDocuments();this.append(this.leftSection(),this.rightSection(e),LanguageSelector({className:Y.language})),document.body.appendChild(this)}leftSection(){return(0,a.hi)({className:Y.left},(0,a.hi)({className:Y.top},this.logoSection(),this.applicationCommands(),this.currentDocument()),this.links())}logoSection(){return(0,a.hi)({className:Y.logo},(0,a.YP)({icon:"icon-chili"}),(0,a.yP)({textContent:"CHILI3D"}),(0,a.yP)({className:Y.version,textContent:"0.6.0"}))}applicationCommands(){return(0,a.hJ)({className:Y.buttons,sources:$,template:e=>(0,a.LI)({className:Y.button,textContent:new o.Xx(e.display),onclick:e.onclick})})}currentDocument(){return this.app.activeView?.document?(0,a.LI)({className:`${Y.button} ${Y.back}`,textContent:new o.Xx("common.back"),onclick:()=>{o.pS.default.pub("displayHome",!1)}}):""}links(){return(0,a.hi)({className:Y.bottom},(0,a.a)({textContent:"Github",href:"https://github.com/xiangechen/chili3d",target:"_blank"}))}rightSection(e){return(0,a.hi)({className:Y.right},(0,a.PS)({className:Y.welcome,textContent:new o.Xx("home.welcome")}),(0,a.hi)({className:Y.recent,textContent:new o.Xx("home.recent")}),this.documentCollection(e))}documentCollection(e){return(0,a.hJ)({className:Y.documents,sources:e,template:t=>this.recentDocument(t,e)})}recentDocument(e,t){return(0,a.hi)({className:Y.document,onclick:()=>this.handleDocumentClick(e)},(0,a.lv)({className:Y.img,src:e.image}),this.documentDescription(e),this.deleteIcon(e,t))}documentDescription(e){return(0,a.hi)({className:Y.description},(0,a.yP)({className:Y.title,textContent:e.name}),(0,a.yP)({className:Y.date,textContent:new Date(e.date).toLocaleDateString()}))}deleteIcon(e,t){return(0,a.YP)({className:Y.delete,icon:"icon-times",onclick:async i=>{i.stopPropagation(),window.confirm(o.oc.translate("prompt.deleteDocument{0}",e.name))&&(await Promise.all([this.app.storage.delete(o.gT.DBName,o.gT.DocumentTable,e.id),this.app.storage.delete(o.gT.DBName,o.gT.RecentTable,e.id)]),t.remove(e))}})}handleDocumentClick(e){this.hasOpen(e.id)?o.pS.default.pub("displayHome",!1):o.pS.default.pub("showPermanent",async()=>{let t=await this.app.openDocument(e.id);t?.application.activeView?.cameraController.fitContent()},"toast.excuting{0}",o.oc.translate("command.doc.open"))}};customElements.define("chili-home",Home);var K=i(3035);let Permanent=class Permanent{static async show(e,t,...i){let n=document.createElement("dialog");n.appendChild((0,a.hi)({className:K.container},(0,a.hi)({className:K.loading,style:{animation:`${K.circle} infinite 0.75s linear`}}),(0,a.yP)({className:K.message,textContent:o.oc.translate(t,...i)}))),document.body.appendChild(n),n.showModal(),e().finally(()=>n.remove())}};var j=i(6278);let Toast=class Toast{static _lastToast;static info=(e,...t)=>{Toast.display(j.info,o.oc.translate(e,...t))};static error=e=>{Toast.display(j.error,e)};static warn=e=>{Toast.display(j.warning,e)};static display(e,t){this._lastToast&&(clearTimeout(this._lastToast[0]),this._lastToast[1].remove());let i=(0,a.PS)({className:`${j.toast} ${e}`,textContent:t});document.body.appendChild(i),this._lastToast=[window.setTimeout(()=>{i.remove(),this._lastToast=void 0},2e3),i]}};document.oncontextmenu=e=>e.preventDefault(),document.body.addEventListener("scroll",e=>{document.body.scrollTop=0});let MainWindow=class MainWindow{tabs;_inited;_home;_editor;constructor(e){this.tabs=e,this._inited=!1,this.displayHome=(e,t)=>{this._home&&(this._home.remove(),this._home=void 0),t&&this._initHome(e)},this.setTheme("light")}init(e){if(this._inited)throw Error("MainWindow is already inited");this._inited=!0,this._initHome(e),this._initEditor(e),this._initSubs(e)}_initSubs(e){let t=(0,o.Ds)(this.displayHome,100);o.pS.default.sub("showToast",Toast.info),o.pS.default.sub("displayError",Toast.error),o.pS.default.sub("showDialog",Dialog.show),o.pS.default.sub("showPermanent",Permanent.show),o.pS.default.sub("activeViewChanged",i=>t(e,void 0===i)),o.pS.default.sub("displayHome",i=>t(e,i))}displayHome;async _initHome(e){this._home=new Home(e),await this._home.render()}async _initEditor(e){this._editor=new Editor(e,this.tabs)}registerHomeCommand(e,t){throw Error("Method not implemented.")}registerRibbonCommand(e,t,i){this._editor?.registerRibbonCommand(e,t,i)}setTheme(e){document.documentElement.setAttribute("theme",e)}}},9734:function(e,t,i){e.exports={root:"chili3d-f2e86e387c18234c-root",title:"chili3d-f2e86e387c18234c-title",content:"chili3d-f2e86e387c18234c-content",buttons:"chili3d-f2e86e387c18234c-buttons"}},1166:function(e,t,i){e.exports={root:"chili3d-_72f353060cc4e144-root",content:"chili3d-_72f353060cc4e144-content",sidebar:"chili3d-_72f353060cc4e144-sidebar",sidebarItem:"chili3d-_72f353060cc4e144-sidebarItem",viewport:"chili3d-_72f353060cc4e144-viewport",statusbar:"chili3d-_72f353060cc4e144-statusbar"}},4931:function(e,t,i){e.exports={root:"chili3d-_79be0ff8e457c796-root",left:"chili3d-_79be0ff8e457c796-left",top:"chili3d-_79be0ff8e457c796-top",buttons:"chili3d-_79be0ff8e457c796-buttons",button:"chili3d-_79be0ff8e457c796-button",back:"chili3d-_79be0ff8e457c796-back",logo:"chili3d-_79be0ff8e457c796-logo",version:"chili3d-_79be0ff8e457c796-version",bottom:"chili3d-_79be0ff8e457c796-bottom",right:"chili3d-_79be0ff8e457c796-right",welcome:"chili3d-_79be0ff8e457c796-welcome",recent:"chili3d-_79be0ff8e457c796-recent",documents:"chili3d-_79be0ff8e457c796-documents",document:"chili3d-_79be0ff8e457c796-document",img:"chili3d-_79be0ff8e457c796-img",description:"chili3d-_79be0ff8e457c796-description",title:"chili3d-_79be0ff8e457c796-title",date:"chili3d-_79be0ff8e457c796-date",delete:"chili3d-_79be0ff8e457c796-delete",language:"chili3d-_79be0ff8e457c796-language"}},3035:function(e,t,i){e.exports={loading:"chili3d-_1a6544955c93c7e1-loading",circle:"chili3d-_1a6544955c93c7e1-circle",container:"chili3d-_1a6544955c93c7e1-container",message:"chili3d-_1a6544955c93c7e1-message"}},4871:function(e,t,i){e.exports={root:"chili3d-a1bf1c8f141d414c-root",headerPanel:"chili3d-a1bf1c8f141d414c-headerPanel",itemsPanel:"chili3d-a1bf1c8f141d414c-itemsPanel",header:"chili3d-a1bf1c8f141d414c-header"}},6130:function(e,t,i){e.exports={panel:"chili3d-_5c9d5f6aaede5713-panel",svg:"chili3d-_5c9d5f6aaede5713-svg"}},780:function(e,t,i){e.exports={panel:"chili3d-c0153fe38177ee49-panel",selected:"chili3d-c0153fe38177ee49-selected",current:"chili3d-c0153fe38177ee49-current"}},1176:function(e,t,i){e.exports={name:"chili3d-_4cbaa0cb251b0472-name",icon:"chili3d-_4cbaa0cb251b0472-icon","parent-hidden":"chili3d-_4cbaa0cb251b0472-parent-hidden"}},1132:function(e,t,i){e.exports={expanderIcon:"chili3d-_416d7cc466a707ce-expanderIcon",left16px:"chili3d-_416d7cc466a707ce-left16px",container:"chili3d-_416d7cc466a707ce-container",hide:"chili3d-_416d7cc466a707ce-hide",header:"chili3d-_416d7cc466a707ce-header",row:"chili3d-_416d7cc466a707ce-row"}},7935:function(e,t,i){e.exports={panel:"chili3d-_9a1a06825148df10-panel"}},2958:function(e,t,i){e.exports={color:"chili3d-_781beda975fff15e-color"}},4709:function(e,t,i){e.exports={panel:"chili3d-_5778aa8750d893cd-panel",propertyName:"chili3d-_5778aa8750d893cd-propertyName"}},7418:function(e,t,i){e.exports={box:"chili3d-_9e645cf57caa5280-box"}},1868:function(e,t,i){e.exports={material:"chili3d-_2ac5c2bc69e315de-material"}},8969:function(e,t,i){e.exports={root:"chili3d-_43828c53e11f52d5-root",title:"chili3d-_43828c53e11f52d5-title",materials:"chili3d-_43828c53e11f52d5-materials",material:"chili3d-_43828c53e11f52d5-material",active:"chili3d-_43828c53e11f52d5-active",properties:"chili3d-_43828c53e11f52d5-properties",bottom:"chili3d-_43828c53e11f52d5-bottom"}},975:function(e,t,i){e.exports={root:"chili3d-f3649cf328db1bed-root",expander:"chili3d-f3649cf328db1bed-expander",properties:"chili3d-f3649cf328db1bed-properties",image:"chili3d-f3649cf328db1bed-image"}},4009:function(e,t,i){e.exports={panel:"chili3d-_16bb4e210a011d49-panel"}},1503:function(e,t,i){e.exports={root:"chili3d-_01224db45e2b02a4-root",header:"chili3d-_01224db45e2b02a4-header",panel:"chili3d-_01224db45e2b02a4-panel",properties:"chili3d-_01224db45e2b02a4-properties"}},8930:function(e,t,i){e.exports={panel:"chili3d-e95e75a852eb7444-panel",title:"chili3d-e95e75a852eb7444-title",group:"chili3d-e95e75a852eb7444-group",button:"chili3d-e95e75a852eb7444-button",icon:"chili3d-e95e75a852eb7444-icon",input:"chili3d-e95e75a852eb7444-input",select:"chili3d-e95e75a852eb7444-select",materialButton:"chili3d-e95e75a852eb7444-materialButton"}},6608:function(e,t,i){e.exports={root:"chili3d-a1f93407f854e0cf-root",split:"chili3d-a1f93407f854e0cf-split",titleBar:"chili3d-a1f93407f854e0cf-titleBar",left:"chili3d-a1f93407f854e0cf-left",appIcon:"chili3d-a1f93407f854e0cf-appIcon",icon:"chili3d-a1f93407f854e0cf-icon",center:"chili3d-a1f93407f854e0cf-center",views:"chili3d-a1f93407f854e0cf-views",tab:"chili3d-a1f93407f854e0cf-tab",name:"chili3d-a1f93407f854e0cf-name",close:"chili3d-a1f93407f854e0cf-close",active:"chili3d-a1f93407f854e0cf-active",new:"chili3d-a1f93407f854e0cf-new",right:"chili3d-a1f93407f854e0cf-right",ribbonTitlePanel:"chili3d-a1f93407f854e0cf-ribbonTitlePanel",home:"chili3d-a1f93407f854e0cf-home",quickCommands:"chili3d-a1f93407f854e0cf-quickCommands",tabHeader:"chili3d-a1f93407f854e0cf-tabHeader",activedTab:"chili3d-a1f93407f854e0cf-activedTab",tabContentPanel:"chili3d-a1f93407f854e0cf-tabContentPanel",groupPanel:"chili3d-a1f93407f854e0cf-groupPanel",commandContextPanel:"chili3d-a1f93407f854e0cf-commandContextPanel",ribbonGroup:"chili3d-a1f93407f854e0cf-ribbonGroup",header:"chili3d-a1f93407f854e0cf-header",content:"chili3d-a1f93407f854e0cf-content"}},1752:function(e,t,i){e.exports={normal:"chili3d-_22dd51000e703ce8-normal",small:"chili3d-_22dd51000e703ce8-small",checked:"chili3d-_22dd51000e703ce8-checked",buttonText:"chili3d-_22dd51000e703ce8-buttonText",icon:"chili3d-_22dd51000e703ce8-icon",smallIcon:"chili3d-_22dd51000e703ce8-smallIcon"}},5692:function(e,t,i){e.exports={root:"chili3d-fd3d882d621755a8-root"}},7141:function(e,t,i){e.exports={container:"chili3d-_99d96288eb02a6ac-container"}},4714:function(e,t,i){e.exports={panel:"chili3d-a31a1d1ac116e370-panel",left:"chili3d-a31a1d1ac116e370-left",tip:"chili3d-a31a1d1ac116e370-tip",right:"chili3d-a31a1d1ac116e370-right"}},6278:function(e,t,i){e.exports={toast:"chili3d-_8478fd55a1e71fc6-toast",info:"chili3d-_8478fd55a1e71fc6-info",error:"chili3d-_8478fd55a1e71fc6-error",warning:"chili3d-_8478fd55a1e71fc6-warning"}},2573:function(e,t,i){e.exports={root:"chili3d-_681a31c0bce56834-root"}},1174:function(e,t,i){e.exports={panel:"chili3d-ad12af530995bdef-panel",error:"chili3d-ad12af530995bdef-error"}},8705:function(e,t,i){e.exports={tip:"chili3d-_2b24de4aeceaaf5c-tip",info:"chili3d-_2b24de4aeceaaf5c-info",warn:"chili3d-_2b24de4aeceaaf5c-warn",error:"chili3d-_2b24de4aeceaaf5c-error"}},3113:function(e,t,i){e.exports={root:"chili3d-_6a9e5885af8e2158-root",viewport:"chili3d-_6a9e5885af8e2158-viewport",hidden:"chili3d-_6a9e5885af8e2158-hidden"}},5031:function(e,t,i){e.exports={root:"chili3d-b5404a90bb0fb654-root",container:"chili3d-b5404a90bb0fb654-container",panel:"chili3d-b5404a90bb0fb654-panel",icon:"chili3d-b5404a90bb0fb654-icon",spacer:"chili3d-b5404a90bb0fb654-spacer"}},8022:function(e,t,i){e.exports={root:"chili3d-_6a24b1e3f181f1e2-root",actsContainer:"chili3d-_6a24b1e3f181f1e2-actsContainer",border:"chili3d-_6a24b1e3f181f1e2-border",acts:"chili3d-_6a24b1e3f181f1e2-acts",tools:"chili3d-_6a24b1e3f181f1e2-tools",viewControls:"chili3d-_6a24b1e3f181f1e2-viewControls",actived:"chili3d-_6a24b1e3f181f1e2-actived"}}}]);
//# sourceMappingURL=796.js.map