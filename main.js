(()=>{"use strict";var e={7604:function(e,t,r){r.d(t,{C:()=>UrlStringConverter});var i=r(8909);let UrlStringConverter=class UrlStringConverter{convert(e){return i.x4.ok(`url('${e}')`)}}},4501:function(e,t,r){r.d(t,{pr:()=>XYConverter,yP:()=>s,vU:()=>NumberConverter,No:()=>ColorConverter,Ee:()=>RadioGroup,C8:()=>g.C,S6:()=>XYZConverter,YP:()=>controls_svg,h1:()=>h,hi:()=>a,h2:()=>u,lv:()=>f,PS:()=>l,qH:()=>n,Kw:()=>d,hJ:()=>collection,Ys:()=>c,bQ:()=>setSVGIcon,LI:()=>o,xH:()=>Expander,ul:()=>m,a:()=>p,B0:()=>StringConverter});var i=r(8909);function createControl(e){return(t,...r)=>{let i=document.createElement(e);return t&&("string"==typeof t||t instanceof Node?i.append(t):setProperties(i,t)),r.forEach(e=>i.append(e)),i}}function setProperties(e,t){for(let r in t){let a=t[r];a instanceof i.Xx&&("textContent"===r||"title"===r)?a.set(e,r):a instanceof i.wK?a.setBinding(e,r):"object"==typeof a&&"object"==typeof e[r]?setProperties(e[r],a):e[r]=a}}let a=createControl("div"),s=createControl("span"),n=createControl("input"),o=createControl("button"),l=createControl("label");createControl("textarea");let c=createControl("select"),d=createControl("option"),p=createControl("a"),h=createControl("h1"),u=createControl("h2");createControl("h3"),createControl("p");let m=createControl("ul");createControl("li");let f=createControl("img");function controls_svg(e){let t="http://www.w3.org/2000/svg",r=document.createElementNS(t,"use");r.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",`#${e.icon}`);let i=document.createElementNS(t,"svg");i.append(r);let a=String(e.className);return delete e.className,setProperties(i,e),i.classList.add(a),e.title&&addTitle(e,i),i}function setSVGIcon(e,t){let r=e.firstChild;r?.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",`#${t}`)}function addTitle(e,t){let r=document.createElementNS("http://www.w3.org/2000/svg","title");e.title instanceof i.Xx?e.title.set(r,"textContent"):"string"==typeof e.title?r.textContent=e.title:e.title?.setBinding(r,"textContent"),t.appendChild(r)}createControl("dialog"),createControl("canvas"),createControl("sup"),createControl("form");let collection=e=>new Collection(e);let Collection=class Collection extends HTMLElement{props;_itemMap;constructor(e){super(),this.props=e,this._itemMap=new Map,this._onCollectionChanged=e=>{switch(e.action){case i.mn.add:this.append(...this._mapItems(e.items));break;case i.mn.remove:this._removeItem(e.items);break;case i.mn.move:this._moveItem(e.from,e.to);break;case i.mn.replace:this._replaceItem(e.index,e.item,e.items);break;default:throw Error("Unknown collection action")}},setProperties(this,e)}getItem(e){return this._itemMap.get(e)}connectedCallback(){let e=Array.isArray(this.props.sources)?this.props.sources:this.props.sources.items;this.append(...this._mapItems(e)),this.props.sources instanceof i.Vn&&this.props.sources.onCollectionChanged(this._onCollectionChanged)}disconnectedCallback(){this._itemMap.forEach(e=>e.remove()),this._itemMap.clear(),this.props.sources instanceof i.Vn&&this.props.sources.removeCollectionChanged(this._onCollectionChanged)}_onCollectionChanged;_moveItem(e,t){let r=this.children.item(e),i=this.children.item(t);r&&i&&this.insertBefore(r,i)}_replaceItem(e,t,r){let i=this._itemMap.get(t);i&&(r.forEach((t,r)=>{let a=this.props.template(t,e+r);this._itemMap.set(t,a),this.insertBefore(a,i)}),this._removeItem([t]))}_mapItems(e){let t=this._itemMap.size;return e.map((e,r)=>{if(this._itemMap.has(e))return this._itemMap.get(e);let i=this.props.template(e,t+r);return this._itemMap.set(e,i),i})}_removeItem(e){e.forEach(e=>{let t=this._itemMap.get(e);t&&(t.remove(),this._itemMap.delete(e))})}};customElements.define("chili-collection",Collection);let ColorConverter=class ColorConverter{convert(e){return i.x4.ok("string"==typeof e?e:`#${e.toString(16).padStart(6,"0")}`)}convertBack(e){let t=parseInt(e.startsWith("#")?e.substring(1):e,16);return Number.isNaN(t)?i.x4.err(`Invalid hex string: ${e}`):i.x4.ok(t)}};let NumberConverter=class NumberConverter{convert(e){return Number.isNaN(e)?i.x4.err("Number is NaN"):i.x4.ok(String(e))}convertBack(e){let t=Number(e);return Number.isNaN(t)?i.x4.err(`${e} can not convert to number`):i.x4.ok(t)}};let StringConverter=class StringConverter{convert(e){return i.x4.ok(e)}convertBack(e){return i.x4.ok(e)}};let XYConverter=class XYConverter{convert(e){return i.x4.ok(`${e.x},${e.y}`)}convertBack(e){let t=e.split(",").map(Number).filter(isFinite);return 2===t.length?i.x4.ok(new i.XY(t[0],t[1])):i.x4.err(`${e} convert to XY error`)}};let XYZConverter=class XYZConverter{convert(e){return i.x4.ok(`${e.x},${e.y},${e.z}`)}convertBack(e){let t=e.split(",").map(Number).filter(isFinite);return 3===t.length?i.x4.ok(new i.vY(t[0],t[1],t[2])):i.x4.err(`${e} convert to XYZ error`)}};var g=r(7604),y=r(8057);let Expander=class Expander extends HTMLElement{_isExpanded=!0;expanderIcon;headerPanel=a({className:y.headerPanel});contenxtPanel=a({className:y.contextPanel});constructor(e){super(),this.className=y.rootPanel,this.expanderIcon=controls_svg({icon:this.getExpanderIcon(),className:y.expanderIcon,onclick:this._handleExpanderClick});let t=l({textContent:new i.Xx(e),className:y.headerText});this.headerPanel.append(this.expanderIcon,t),super.append(this.headerPanel,this.contenxtPanel)}appendChild(e){return this.contenxtPanel.appendChild(e)}append(...e){this.contenxtPanel.append(...e)}removeChild(e){return this.contenxtPanel.removeChild(e)}addItem(...e){return this.append(...e),this}getExpanderIcon(){return this._isExpanded?"icon-angle-down":"icon-angle-right"}_handleExpanderClick=e=>{e.stopPropagation(),this._isExpanded=!this._isExpanded,setSVGIcon(this.expanderIcon,this.getExpanderIcon()),this.contenxtPanel.classList.toggle(y.hidden,!this._isExpanded)}};customElements.define("chili-expander",Expander);var v=r(2921);let RadioGroup=class RadioGroup extends HTMLElement{header;context;constructor(e,t){super(),this.header=e,this.context=t,this._onClick=e=>{let t=e.target;t?.type==="radio"&&(this.querySelectorAll("input").forEach(e=>e.checked=e===t),this.context.selectedItems=new Set([t.value]))},this.appendChild(this.render())}render(){return a({className:v.radioGroup},...this.context.items.flatMap((e,t)=>[n({type:"radio",value:e,checked:this.context.selectedItems.has(e),id:`radio-${t}`}),l({htmlFor:`radio-${t}`,textContent:e})]))}connectedCallback(){this.addEventListener("click",this._onClick)}disconnectedCallback(){this.removeEventListener("click",this._onClick)}_onClick};customElements.define("chili-radios",RadioGroup)},8909:function(e,t,r){r.d(t,{Z9:()=>A,XY:()=>XY,PY:()=>em,Xs:()=>eC,gT:()=>Constants,oc:()=>V,yG:()=>Matrix4,NB:()=>Node,pS:()=>PubSub,ei:()=>R,Cy:()=>isPropertyChanged,JO:()=>Plane,io:()=>SelectableItems,uu:()=>CancelableCommand,xE:()=>Texture,gc:()=>gc,vZ:()=>readFileAsync,DE:()=>en,EK:()=>ShapeNode,Wj:()=>Act,bj:()=>L,qV:()=>q,tR:()=>ek,Ay:()=>History,Gq:()=>el,G$:()=>EdgeMeshDataBuilder,Yd:()=>Logger,mn:()=>G,i5:()=>ey,W7:()=>U,OI:()=>eo,Cs:()=>et,Xx:()=>Localize,R3:()=>GeometryNode,Vl:()=>ef,wK:()=>PathBinding,yx:()=>PhysicalMaterial,gC:()=>EditableShapeNode,wV:()=>j,_J:()=>ShapeNodeFilter,cx:()=>ex,h3:()=>readFilesAsync,Id:()=>Id,Gc:()=>F,gR:()=>ParameterShapeNode,ud:()=>DeepObserver,y$:()=>Observable,x4:()=>Result,wO:()=>eD,F5:()=>Material,Vt:()=>FacebaseNode,ND:()=>X,kB:()=>BoundingBox,qE:()=>eS,hQ:()=>Combobox,mY:()=>I,v7:()=>eu,Rr:()=>MultiShapeNode,Hm:()=>NodeLinkedListHistoryRecord,YO:()=>W,DY:()=>B,JF:()=>PhongMaterial,SP:()=>eg,bR:()=>MeshNode,ax:()=>e_,wA:()=>Component,s4:()=>K,zH:()=>Ray,zp:()=>Y,lx:()=>concatTypedArrays,LR:()=>download,Ds:()=>debounce,YW:()=>Transaction,S3:()=>VisualNode,WD:()=>decarator_command,n4:()=>PlaneAngle,vY:()=>XYZ,De:()=>Config,M8:()=>MathUtils,Vn:()=>ObservableCollection,KX:()=>Binding,Op:()=>AsyncController,YT:()=>FolderNode,Gw:()=>GroupNode,sK:()=>ComponentNode,Rl:()=>E,wB:()=>Z,AH:()=>ev});let AsyncController=class AsyncController{_failListeners=new Set;_successListeners=new Set;_result;get result(){return this._result}fail=e=>{this.notifyListeners(this._failListeners,"fail",e)};cancel=e=>{this.notifyListeners(this._failListeners,"cancel",e)};success=e=>{this.notifyListeners(this._successListeners,"success",e)};notifyListeners(e,t,r){void 0===this._result&&(this._result={status:t,message:r},e.forEach(e=>e(this._result)))}onCancelled(e){this._failListeners.add(e)}onCompleted(e){this._successListeners.add(e)}dispose(){this._failListeners.clear(),this._successListeners.clear()}};let i=new FinalizationRegistry(e=>{e.removeBinding()});let PathBinding=class PathBinding{source;path;converter;_target;_oldPathObjects;_actualSource;constructor(e,t,r){this.source=e,this.path=t,this.converter=r,this.handleAllPathPropertyChanged=(e,t)=>{this.shouldUpdateHandler(e,t)&&(this.removePropertyChangedHandler(),this.addPropertyChangedHandler())},this.handlePropertyChanged=(e,t)=>{this.path.endsWith(e)&&this._target&&this.setValue(t,e)}}setBinding(e,t){if(this._target)throw Error("Binding already set");this._target={element:new WeakRef(e),property:t},i.register(e,this),this.addPropertyChangedHandler()}removeBinding(){let e=this._target?.element.deref();e&&i.unregister(e),this._target=void 0,this.removePropertyChangedHandler()}handleAllPathPropertyChanged;handlePropertyChanged;shouldUpdateHandler(e,t){return!!(void 0===this._oldPathObjects||this._oldPathObjects.some(r=>r.property===e&&r.source===t))||!this._actualSource&&this.path.includes(e)}addPropertyChangedHandler(){let e=this.path.split("."),t=this.source;this._oldPathObjects=[];for(let r=0;r<e.length&&t&&e[r]in t;r++){let i={source:t,property:e[r]};if(r===e.length-1){this.setValue(t,e[r]),this._actualSource=i,t.onPropertyChanged(this.handlePropertyChanged);break}t.onPropertyChanged(this.handleAllPathPropertyChanged),this._oldPathObjects.push(i),t=t[e[r]]}}removePropertyChangedHandler(){this._oldPathObjects&&(this._oldPathObjects.forEach(e=>e.source.removePropertyChanged(this.handleAllPathPropertyChanged)),this._actualSource?.source.removePropertyChanged(this.handlePropertyChanged),this._actualSource=void 0,this._oldPathObjects=void 0)}setValue(e,t){if(!this._target)return;let r=this._target.element.deref();if(!r)return;let i=e[t];if(this.converter){let e=this.converter.convert(i);e.isOk&&(r[this._target.property]=e.value)}else r[this._target.property]=i}getPropertyValue(){return this._actualSource?this._actualSource.source[this._actualSource.property]:void 0}};let Binding=class Binding extends PathBinding{constructor(e,t,r){super(e,t.toString(),r)}};var a,s,n,o,l,c,d,p,h,u,m,f,g,y,v,_,x,P,b,w,S,C,D,k,M,T,O,N,R,E,z,F,A,j,I,V,B,W,Y,L,H,X,q,Z,$,G=((O={})[O.add=0]="add",O[O.remove=1]="remove",O[O.move=2]="move",O[O.replace=3]="replace",O);let ObservableCollection=class ObservableCollection{_callbacks=new Set;_items;constructor(...e){this._items=[...e]}push(...e){0!==e.length&&(this._items.push(...e),this.notifyChange({action:0,items:e}))}remove(...e){if(0===e.length)return;let t=new Set(e);this._items=this._items.filter(e=>!t.has(e)),this.notifyChange({action:1,items:e})}move(e,t){if(!this.isValidMove(e,t))return;let r=this._items.splice(e,1);this._items.splice(e<t?t-1:t,0,...r),this.notifyChange({action:2,from:e,to:t})}isValidMove(e,t){return e!==t&&e>=0&&e<this._items.length&&t>=0&&t<this._items.length}clear(){if(0===this._items.length)return;let e=[...this._items];this._items=[],this.notifyChange({action:1,items:e})}get length(){return this._items.length}replace(e,...t){if(!this.isValidIndex(e))return;let r=this._items[e];this._items.splice(e,1,...t),this.notifyChange({action:3,index:e,item:r,items:t})}isValidIndex(e){return e>=0&&e<this._items.length}notifyChange(e){this._callbacks.forEach(t=>t(e))}forEach(e){this.items.forEach(e)}map(e){return this.items.map(e)}get items(){return[...this._items]}[Symbol.iterator](){return this.items[Symbol.iterator]()}item(e){return this._items[e]}at(e){return this._items.at(e)}filter(e){return this._items.filter(e)}find(e){return this._items.find(e)}indexOf(e,t){return this._items.indexOf(e,t)}contains(e){return -1!==this._items.indexOf(e)}get count(){return this._items.length}onCollectionChanged(e){this._callbacks.add(e)}removeCollectionChanged(e){this._callbacks.delete(e)}dispose(){this._callbacks.clear(),this._items.length=0}};var U=((a={})[a.check=0]="check",a[a.radio=1]="radio",a[a.combo=2]="combo",a);let SelectableItems=class SelectableItems{mode;items;selectedItems;get selectedIndexes(){let e=[];return this.selectedItems.forEach(t=>{let r=this.items.indexOf(t);r>-1&&e.push(r)}),e}firstSelectedItem(){return this.selectedItems.values().next().value}constructor(e,t=1,r){this.mode=t,this.items=e,this.selectedItems=new Set(r??[])}};let History=class History{_undos=[];_redos=[];disabled=!1;undoLimits=50;dispose(){this._redos.forEach(e=>e.dispose()),this._undos.forEach(e=>e.dispose()),this.clear()}clear(){this._undos.length=0,this._redos.length=0}add(e){if(!this.disabled&&(this._redos.length=0,this._undos.push(e),this._undos.length>this.undoLimits)){let e=this._undos.shift();e?.dispose()}}undoCount(){return this._undos.length}redoCount(){return this._redos.length}undo(){this.tryOperate(()=>{let e=this._undos.pop();e&&(e.undo(),this._redos.push(e))})}redo(){this.tryOperate(()=>{let e=this._redos.pop();e&&(e.redo(),this._undos.push(e))})}tryOperate(e){let t=this.disabled;this.disabled=!0;try{e()}finally{this.disabled=t}}};let PropertyHistoryRecord=class PropertyHistoryRecord{object;property;oldValue;newValue;name;constructor(e,t,r,i){this.object=e,this.property=t,this.oldValue=r,this.newValue=i,this.name=`change ${String(t)} property`}dispose(){}undo(){this.object[this.property]=this.oldValue}redo(){this.object[this.property]=this.newValue}};var K=((s={})[s.add=0]="add",s[s.remove=1]="remove",s[s.move=2]="move",s[s.transfer=3]="transfer",s[s.insertAfter=4]="insertAfter",s[s.insertBefore=5]="insertBefore",s);let NodeLinkedListHistoryRecord=class NodeLinkedListHistoryRecord{records;name;constructor(e){this.records=e,this.name="change node"}dispose(){this.records.forEach(e=>{1===e.action&&e.node.dispose()}),this.records.length=0}handleUndo(e){switch(e.action){case 0:case 4:case 5:e.newParent?.remove(e.node);break;case 1:case 3:e.oldParent?.add(e.node);break;case 2:e.newParent?.move(e.node,e.oldParent,e.oldPrevious)}}handleRedo(e){switch(e.action){case 0:e.newParent?.add(e.node);break;case 1:e.oldParent?.remove(e.node);break;case 3:e.oldParent?.transfer(e.node);break;case 2:e.oldParent?.move(e.node,e.newParent,e.newPrevious);break;case 4:e.newParent?.insertAfter(e.newPrevious,e.node);break;case 5:e.newParent?.insertBefore(e.newPrevious?.nextSibling,e.node)}}undo(){for(let e=this.records.length-1;e>=0;e--)this.handleUndo(this.records[e])}redo(){this.records.forEach(e=>this.handleRedo(e))}};let ArrayRecord=class ArrayRecord{name;records;constructor(e){this.name=e,this.records=[]}dispose(){this.records.forEach(e=>e.dispose())}undo(){for(let e=this.records.length-1;e>=0;e--)this.records[e].undo()}redo(){for(let e of this.records)e.redo()}};let Logger=class Logger{static debug(e,...t){console.log(e,...t)}static info(e,...t){console.log(e,...t)}static warn(e,...t){console.warn(e,...t)}static error(e,...t){console.error(e,...t)}};Logger.info=console.log,Logger.warn=console.warn,Logger.debug=console.log,Logger.error=console.error;let Transaction=class Transaction{document;name;static _transactionMap=new WeakMap;constructor(e,t){this.document=e,this.name=t}static add(e,t){if(e.history.disabled)return;let r=Transaction._transactionMap.get(e);void 0!==r?r.records.push(t):Transaction.addToHistory(e,t)}static addToHistory(e,t){e.history.add(t),Logger.info(`history added ${t.name}`)}static execute(e,t,r){let i=new Transaction(e,t);i.start();try{r(),i.commit()}catch(e){throw i.rollback(),e}}static async executeAsync(e,t,r){let i=new Transaction(e,t);i.start();try{await r(),i.commit()}catch(e){throw i.rollback(),e}}start(e){let t=e??this.name;if(Transaction._transactionMap.has(this.document))throw Error(`The document has started a transaction ${this.name}`);Transaction._transactionMap.set(this.document,new ArrayRecord(t))}commit(){let e=Transaction._transactionMap.get(this.document);if(!e)throw Error("Transaction has not started");e.records.length>0&&Transaction.addToHistory(this.document,e),Transaction._transactionMap.delete(this.document)}rollback(){Transaction._transactionMap.get(this.document)?.undo(),Transaction._transactionMap.delete(this.document)}};function isPropertyChanged(e){return e&&"function"==typeof e.onPropertyChanged&&"function"==typeof e.removePropertyChanged}let Observable=class Observable{propertyChangedHandlers=new Set;_isDisposed=!1;getPrivateKey(e){return`_${String(e)}`}getPrivateValue(e,t){let r=this.getPrivateKey(e);return r in this?this[r]:this.initializeDefaultValue(e,t)}initializeDefaultValue(e,t){return void 0===t?void Logger.warn(`${this.constructor.name}: The property "${String(e)}" is not initialized, and no default value is provided`):(this[this.getPrivateKey(e)]=t,t)}setPrivateValue(e,t){this[this.getPrivateKey(e)]=t}setProperty(e,t,r,i){let a=this[e];return!this.isEuqals(a,t,i)&&(this.setPrivateValue(e,t),r?.(e,a),this.emitPropertyChanged(e,a),!0)}isEuqals(e,t,r){return r?r.equals(e,t):e===t}emitPropertyChanged(e,t){Array.from(this.propertyChangedHandlers).forEach(r=>r(e,this,t))}onPropertyChanged(e){this.propertyChangedHandlers.add(e)}removePropertyChanged(e){this.propertyChangedHandlers.delete(e)}clearPropertyChanged(){this.propertyChangedHandlers.clear()}dispose=()=>{this._isDisposed||(this._isDisposed=!0,this.disposeInternal())};disposeInternal(){this.propertyChangedHandlers.clear()}};let HistoryObservable=class HistoryObservable extends Observable{_document;get document(){return this._document}constructor(e){super(),this._document=e}setProperty(e,t,r,i){return super.setProperty(e,t,(e,i)=>{r?.(e,i),Transaction.add(this.document,new PropertyHistoryRecord(this,e,i,t))},i)}disposeInternal(){super.disposeInternal(),this._document=null}};let J=new Map;function serializeTypeArray(e){return{ctor:e,ctorParamNames:["buffer"],serialize:e=>({buffer:Array.from(e)}),deserialize:t=>new e(t)}}(n=N||(N={})).save=function(e,t){if(J.has(e))throw Error(`Class ${e} already registered`);J.set(e,t)},n.getClass=function(e){let t=J.get(e);if(t)return t;throw Error(`Type ${e} is not find, please add the @Serializer.register decorator.`)};let Q=new Map,ee=new Map;function _ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}ee.set("Float32Array",serializeTypeArray(Float32Array)),ee.set("Uint32Array",serializeTypeArray(Uint32Array)),(o=R||(R={})).serialze=function(){return(e,t)=>{let r=Q.get(e);void 0===r&&(r=new Set,Q.set(e,r)),r.add(t)}},o.register=function(e,t,r){return i=>{N.save(i.name,i),ee.set(i.name,{ctor:i,ctorParamNames:e,serialize:r,deserialize:t})}},function(e){function deserializeObject(e,t){let r=deserializeInstance(e,t.classKey,t.properties);return deserializeProperties(e,r,t),r}function deserializeInstance(e,t,r){if(!ee.has(t))throw Error(`${t} cannot be deserialize. Did you forget to add the decorator @Serializer.register?`);let{ctor:i,ctorParamNames:a,deserialize:s}=ee.get(t),n=deserilizeParameters(e,a,r,t);return s?s(...a.map(e=>n[e])):new i(...a.map(e=>n[e]))}function deserilizeParameters(e,t,r,i){let a={};for(let s of(a.document=e,t))s in r?void 0!==r[s]&&(a[s]=deserialValue(e,r[s])):"document"!==s&&(a[s]=void 0,console.warn(`${i} constructor parameter ${s} is missing`));return a}function deserialValue(e,t){if(void 0!==t)return Array.isArray(t)?t.map(t=>"object"==typeof t?deserializeObject(e,t):t):t.classKey?deserializeObject(e,t):t}function deserializeProperties(e,t,r,i){let{ctorParamNames:a}=ee.get(r.classKey);for(let s of Object.keys(r.properties).filter(e=>!a.includes(e)&&!i?.includes(e)))t[s]=deserialValue(e,r.properties[s])}e.deserializeObject=deserializeObject}(R||(R={})),function(e){function serializeObject(e){let t=e.constructor.name;if(!ee.has(t))throw console.log(e),Error(`Type ${e.constructor.name} is not registered, please add the @Serializer.register decorator.`);let r=ee.get(t);return{classKey:t,properties:r.serialize?.(e)??serializeProperties(e)}}function serializeProperties(e){let t={};for(let r of getAllKeysOfPrototypeChain(e,Q)){let i=e[r];Array.isArray(i)?t[r]=i.map(e=>serializePropertyValue(e)):t[r]=serializePropertyValue(i)}return t}function serializePropertyValue(e){let t=typeof e;if("object"===t)return serializeObject(e);if("function"!==t&&"symbol"!==t)return e;throw Error(`Unsupported serialized object: ${e}`)}function getAllKeysOfPrototypeChain(e,t){let r=[],i=Object.getPrototypeOf(e);for(;null!==i;){let e=t.get(i);e&&r.push(...e.values()),i=Object.getPrototypeOf(i)}return new Set(r)}e.serializeObject=serializeObject,e.serializeProperties=serializeProperties}(R||(R={}));let Result=class Result{#e;#t;#r;get isOk(){return this.#e}get value(){return this.#e||Logger.warn("Result is error"),this.#t}get error(){return this.#e&&Logger.warn("Result is ok"),this.#r}constructor(e,t,r){this.#e=e,this.#t=t,this.#r=r}parse(){return Result.err(this.#r)}isOkAnd(e){return this.#e&&e(this.#t)}isErrorOr(e){return!this.#e||e(this.#t)}unchecked(){return this.#t}static ok(e){return new Result(!0,e,void 0)}static err(e){return new Result(!1,void 0,e)}};_ts_decorate([R.serialze()],Result.prototype,"isOk",null),_ts_decorate([R.serialze()],Result.prototype,"value",null),_ts_decorate([R.serialze()],Result.prototype,"error",null),Result=_ts_decorate([R.register(["isOk","value","error"])],Result);let DeepObserver=class DeepObserver{static handlers=new Map;static getPathValue(e,t){let r=t.split("."),i=e;for(let e=0;e<r.length;e++)if(i=i[r[e]],e<r.length-1&&!isPropertyChanged(i))return Result.err(`Path ${t} is not valid`);return Result.ok(i)}static addDeepPropertyChangedHandler(e,t){let r=DeepObserver.getOrInitHandler(e,t);this.deepHandlePropertyChanged(r,e)}static deepHandlePropertyChanged(e,t,r){for(let i of(t.onPropertyChanged(e.handler),e.sources.push({source:t,prefix:r}),Object.keys(Object.getOwnPropertyDescriptors(Object.getPrototypeOf(t))))){if("constructor"===i||i.startsWith("_"))continue;let a=t[i];isPropertyChanged(a)&&this.deepHandlePropertyChanged(e,a,r?`${r}.${i}`:i)}}static removeDeepPropertyChangedHandler(e,t){let r=this.handlers.get(e);if(!r)return;let i=r.get(t);if(!i)return void this.handlers.delete(e);i.sources.forEach(e=>{e.source.removePropertyChanged(i.handler)}),r.delete(t),0===r.size&&this.handlers.delete(e)}static getOrInitHandler(e,t){let r=DeepObserver.handlers.get(e);r||(r=new Map,DeepObserver.handlers.set(e,r));let i=r.get(t);return i&&i.sources.forEach(e=>{e.source.removePropertyChanged(i.handler)}),i=this.initSourceHandler(e,t),r.set(t,i),i}static initSourceHandler(e,t){return{handler:(r,i,a)=>{let s=this.handlers.get(e)?.get(t);if(!s)return;let n=s.sources.find(e=>e.source===i);if(!n)return;let o=n.prefix?`${n.prefix}.${r}`:r;this.updateHandlers(s,i,r,o),t(o,e,a)},sources:[]}}static updateHandlers(e,t,r,i){let a=t[r];if(void 0===a&&void 0!=i){let t=[];for(let r of e.sources)r.prefix?.startsWith(i)?r.source.removePropertyChanged(e.handler):t.push(r);e.sources=t;return}isPropertyChanged(a)&&this.deepHandlePropertyChanged(e,a,i)}};(E||(E={})).isDisposable=function(e){return null!=e&&"object"==typeof e&&"dispose"in e&&"function"==typeof e.dispose&&0===e.dispose.length},(z||(z={})).isDeletable=function(e){return"function"==typeof e?.delete&&0===e.delete.length};let gc=e=>{let t=new Set;try{return e(e=>(t.add(e),e))}finally{for(let e of t)z.isDeletable(e)?e.delete():E.isDisposable(e)&&e.dispose();t.clear()}};let Id=class Id{static generate(e=21){let t="",r=e;for(;r--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[64*Math.random()|0];return t}};var et=((l={})[l.info=0]="info",l[l.warn=1]="warn",l[l.error=2]="error",l);(c=F||(F={})).Distance=1e-7,c.Angle=.001,c.Float=1e-7;let PubSub=class PubSub{static default=new PubSub;events=new Map;dispose(){this.events.forEach(e=>e.clear()),this.events.clear()}sub(e,t){let r=this.events.get(e)??new Set;r.add(t),this.events.set(e,r)}pub(e,...t){this.events.get(e)?.forEach(e=>e(...t))}remove(e,t){this.events.get(e)?.delete(t)}removeAll(e){this.events.get(e)?.clear()}};let debounce=(e,t)=>{let r;return(...i)=>{r&&clearTimeout(r),r=window.setTimeout(()=>{e(...i),r=void 0},t)}};function download(e,t){let r=new Blob(e),i=URL.createObjectURL(r);try{let e=document.createElement("a");e.style.visibility="hidden",e.href=i,e.download=t,e.click()}finally{URL.revokeObjectURL(i)}}let er=/iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase())||navigator.maxTouchPoints>0&&/(Macintosh)/.test(navigator.userAgent);async function readFilesAsync(e,t){return new Promise(r=>{let i=document.createElement("input");i.type="file",i.multiple=t,er||(i.accept=e),i.style.visibility="hidden";let cleanup=()=>document.body.removeChild(i);i.onchange=()=>{cleanup(),r(i.files?Result.ok(i.files):Result.err("no files selected"))},i.oncancel=()=>{cleanup(),r(Result.err("cancel"))},document.body.appendChild(i),i.click()})}async function readFileAsync(e,t,r="readAsText"){let i=await readFilesAsync(e,t);return i.isOk?readInputedFiles(i.value,r):i.parse()}async function readInputedFiles(e,t){let r=Array.from(e).map(async e=>{let r=await readFileDataAsync(e,t);if(!r)throw Error(`Error occurred reading file: ${e.name}`);return{fileName:e.name,data:r}});try{let e=await Promise.all(r);return Result.ok(e)}catch(e){return Result.err(e.message)}}function readFileDataAsync(e,t){return new Promise(r=>{let i=new FileReader;i.onload=e=>{e.target?.readyState===FileReader.DONE&&r(e.target.result)},i.onerror=()=>r(null),i[t](e)})}let ei=new Map;var ea=A||(A={});function getAllKeysOfPrototypeChain(e,t,r){e&&e!==r&&(ei.has(e)&&t.splice(0,0,...ei.get(e).values()),getAllKeysOfPrototypeChain(Object.getPrototypeOf(e),t,r))}function getProperty(e,t){if(!e)return;let r=ei.get(e);return r?.has(t)?r.get(t):getProperty(Object.getPrototypeOf(e),t)}function command_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}ea.define=function(e,t){return(r,i)=>{ei.has(r)||ei.set(r,new Map),ei.get(r)?.set(i,{display:e,name:i,...t})}},ea.getProperties=function(e,t){let r=[];return getAllKeysOfPrototypeChain(e,r,t),r},ea.getOwnProperties=function(e){let t=ei.get(e);return t?[...t.values()]:[]},ea.getProperty=getProperty,(j||(j={})).isCancelableCommand=function(e){return"cancel"in e};let CancelableCommand=class CancelableCommand extends Observable{static _propertiesCache=new Map;disposeStack=new Set;_isCompleted=!1;get isCompleted(){return this._isCompleted}_application;get application(){if(!this._application)throw Error("application is not set");return this._application}get document(){return this.application.activeView?.document}#i;get controller(){return this.#i}set controller(e){this.#i!==e&&(this.#i?.dispose(),this.#i=e)}async cancel(){for(this.controller?.cancel();!this._isCompleted;)await new Promise(e=>setTimeout(e,30))}async execute(e){if(e.activeView?.document){this._application=e;try{this.beforeExecute(),await this.executeAsync()}finally{this.afterExecute()}}}beforeExecute(){this.readProperties(),PubSub.default.pub("openCommandContext",this)}afterExecute(){this.saveProperties(),PubSub.default.pub("closeCommandContext"),this.controller?.dispose(),this.disposeStack.forEach(e=>e.dispose()),this.disposeStack.clear(),this._isCompleted=!0}readProperties(){A.getProperties(this).forEach(e=>{let t=this.cacheKeyOfProperty(e);CancelableCommand._propertiesCache.has(t)&&(this[t]=CancelableCommand._propertiesCache.get(t))})}saveProperties(){A.getProperties(this).forEach(e=>{let t=this.cacheKeyOfProperty(e),r=this[t];"function"!=typeof r&&CancelableCommand._propertiesCache.set(t,r)})}cacheKeyOfProperty(e){return e.name}};command_ts_decorate([A.define("common.cancel")],CancelableCommand.prototype,"cancel",null);let es=new Map;function decarator_command(e){return t=>{es.set(e.key,t),t.prototype.data=e}}(d=I||(I={})).getData=function(e){if("string"==typeof e){let t=es.get(e);return t?.prototype.data}return("function"==typeof e?e.prototype:Object.getPrototypeOf(e)).data},d.get=function(e){return es.get(e)};var en=((p={})[p.none=0]="none",p[p.endPoint=1]="endPoint",p[p.midPoint=2]="midPoint",p[p.center=4]="center",p[p.angle=8]="angle",p[p.intersection=16]="intersection",p[p.perpendicular=32]="perpendicular",p[p.extension=64]="extension",p[p.parallel=128]="parallel",p[p.special=256]="special",p[p.nearest=512]="nearest",p[p.vertex=1024]="vertex",p[p.grid=2048]="grid",p);(h=en||(en={})).has=function(e,t){return(e&t)===t},h.add=function(e,t){return e|t},h.remove=function(e,t){return e&~t};let eo={defaultEdgeColor:1118481,defaultFaceColor:0xdedede,highlightEdgeColor:3355647,highlightFaceColor:3355647,selectedEdgeColor:255,selectedFaceColor:255,editVertexSize:7,editVertexColor:255,hintVertexSize:5,hintVertexColor:255,trackingVertexSize:7,trackingVertexColor:255,temporaryVertexSize:5,temporaryVertexColor:255,temporaryEdgeColor:255};let Config=class Config extends Observable{static #a=new Config;static get instance(){return this.#a}get snapType(){return this.getPrivateValue("snapType",en.midPoint|en.endPoint|en.center|en.perpendicular|en.intersection|en.nearest)}set snapType(e){this.setProperty("snapType",e)}get enableSnapTracking(){return this.getPrivateValue("enableSnapTracking",!0)}set enableSnapTracking(e){this.setProperty("enableSnapTracking",e)}get enableSnap(){return this.getPrivateValue("enableSnap",!0)}set enableSnap(e){this.setProperty("enableSnap",e)}get dynamicWorkplane(){return this.getPrivateValue("dynamicWorkplane",!0)}set dynamicWorkplane(e){this.setProperty("dynamicWorkplane",e)}SnapDistance=5;constructor(){super()}};let Constants=class Constants{static DBName="chili3d-db";static DocumentTable="documents";static RecentTable="recents"};let el=".cd",ec={display:"English",code:"en",translation:{"arc.angle":"Angle","arc.start":"Start","axis.x":"X Axis","axis.y":"Y Axis","axis.z":"Z Axis","body.arc":"Arc","body.bolean":"Boolean","body.box":"Box","body.pyramid":"Pyramid","body.cylinder":"Cylinder","body.cone":"Cone","body.group":"Group","body.sphere":"Sphere","body.ellipse":"Ellipse","body.circle":"Circle","body.face":"Face","body.fuse":"Fuse","body.imported":"Imported","body.line":"Line","body.polygon":"Polygon","body.prism":"Prism","body.rect":"Rectangle","body.revol":"Revolve","body.sweep":"Sweep","body.wire":"Wire","box.dx":"Length","box.dy":"Width","box.dz":"Height","body.editableShape":"Editable Shape","body.meshNode":"Mesh Node","body.multiShape":"Multi Shape","circle.center":"Center","circle.radius":"Radius","ellipsoid.radiusX":"RadiusX","ellipsoid.radiusY":"RadiusY","ellipsoid.radiusZ":"RadiusZ","ellipse.majorRadius":"majorRadius","ellipse.minorRadius":"minorRadius","command.act.alignCamera":"AlignCamera","command.boolean.common":"Intersect","command.boolean.cut":"Cut","command.boolean.fuse":"Join","command.convert.fuse":"Fuse","command.convert.prism":"Extrude","command.convert.revol":"Revolve","command.convert.sweep":"Sweep","command.convert.toFace":"ToFace","command.convert.toShell":"ToShell","command.convert.toSolid":"ToSolid","command.convert.toWire":"ToWire","command.create.arc":"Arc","command.create.bezier":"Bezier","command.create.box":"Box","command.create.circle":"Circle","command.create.cone":"Cone","command.create.copyShape":"CopyShape","command.create.cylinder":"Cylinder","command.create.ellipse":"Ellipse","command.create.ellipsoid":"Ellipsoid","command.create.folder":"Folder","command.create.group":"Create Group","command.create.line":"Line","command.create.offset":"Offset","command.create.polygon":"Polygon","command.create.pyramid":"Pyramid","command.create.rect":"Rectangle","command.create.section":"Section","command.create.sphere":"Sphere","command.create.thickSolid":"ThickSolid","command.doc.new":"New Document","command.doc.open":"Open Document","command.doc.save":"Save Document","command.doc.saveToFile":"SaveToFile","command.edit.redo":"Redo","command.edit.undo":"Undo","command.file.export":"Export","command.file.import":"Import","command.measure.angle":"Angle","command.measure.length":"Length","command.measure.select":"Select","command.modify.array":"Array","command.modify.break":"Break","command.modify.brushAdd":"BrushAdd","command.modify.brushRemove":"BrushRemove","command.modify.brushClear":"BrushClear","command.modify.chamfer":"Chamfer","command.modify.deleteNode":"DeleteNode","command.modify.explode":"Explode","command.modify.fillet":"Fillet","command.modify.mirror":"Mirror","command.modify.move":"Move","command.modify.removeFeature":"RemoveFeature","command.modify.removeShapes":"RemoveShapes","command.modify.rotate":"Rotate","command.modify.split":"Split","command.modify.trim":"Trim","command.special.last":"__Last_COMMAND__","command.test.performace":"Performance Test","command.wechat.group":"Wechat","command.workingPlane.alignToPlane":"Align","command.workingPlane.fromSection":"Section","command.workingPlane.set":"Set","command.workingPlane.toggleDynamic":"Toggle","common.angle":"Angle","common.area":"Area","common.back":"Back","common.cancel":"Cancel","common.clone":"Clone","common.color":"Color","common.confirm":"Confirm","common.general":"General","common.length":"Length","common.material":"Material","common.matrix":"Matrix","common.name":"Name","common.normal":"Normal","common.opacity":"Opacity","common.thickness":"Thickness","common.type":"Type","common.volume":"Volume","dialog.title.selectWorkingPlane":"Select Working Plane","entity.editable":"Editable Entity","entity.parameter":"Parameter Entity","error.default:{0}":"error: {0}","error.input.cannotInputANumber":"Overlap with reference point, 1 number cannot be entered","error.input.invalidNumber":"Please enter a valid number, separated by ,","error.input.threeNumberCanBeInput":"Reference point is empty, only 3 numbers can be entered","error.input.unsupportedInputs":"Exceeds the maximum number of inputs","error.import.unsupportedFileType:{0}":"Unsupported file type: {0}","error.export.noNodeCanBeExported":"No node can be exported","file.format":"Format","home.recent":"Recent","home.welcome":"Welcome to chili3d","items.header":"Items","items.tool.delete":"Delete","items.tool.expandAll":"Expand All","items.tool.newFolder":"New Folder","items.tool.unexpandAll":"Unexpand all","line.end":"End","line.start":"Start","line.type.line":"Line","line.type.xline":"XLine","material.texture.image":"Image","material.texture.rotation":"Rotation","material.texture.wrapS":"Wrap S","material.texture.wrapT":"Wrap T","material.texture.repeat":"Repeat","material.texture.offset":"Offset","material.map":"Map","material.specular":"Specular","material.shininess":"Shininess","material.emissive":"Emissive","material.specularMap":"Specular Map","material.normalMap":"Normal Map","material.bumpMap":"BumpMap","material.roughnessMap":"Roughness Map","material.emissiveMap":"Emissive Map","material.metalness":"Metalness","material.metalnessMap":"Metalness Map","material.roughness":"Roughness","model.visible":"Visible","operate.pickCircleCenter":"pick center, ESC key to cancel","operate.pickFistPoint":"Pick first point, ESC key to cancel","operate.pickNextPoint":"pick next point, ESC key to cancel","operate.pickRadius":"input radius, ESC key to cancel","option.command.repeat":"Repeat","option.command.isFace":"Face","option.command.thickness":"Thickness","option.command.isConnected":"Connected","option.command.isConvertInstance":"Convert Instance","option.command.insertPoint":"Insert Point","polygon.points":"Points","prompt.default":"Middle mouse button to pan the view, Shift + Middle button to rotate the view, Middle button to scroll the zoom view","prompt.deleteDocument{0}":"Do you want to delete {0}?","prompt.polygon.close":"Close","prompt.saveDocument{0}":"Do you want to save the changes to {0}?","prompt.select.edges":"Please select edges","prompt.select.faces":"Please select faces","prompt.select.models":"Please select models","prompt.select.noModelSelected":"No model selected","prompt.select.shape":"Please select shape","prompt.select.solids":"Please select solids","prompt.select.vertexs":"Please select vertexes","prompt.select.wires":"Please select wires","toast.snap.notFoundValidPoint":"No valid point","properties.group.transform":"Transform","properties.header":"Properties","properties.multivalue":"Multi Value","rect.dx":"Length","rect.dy":"Width","ribbon.group.2d":"2D","ribbon.group.3d":"3D","ribbon.group.act":"Act","ribbon.group.boolean":"Boolean","ribbon.group.converter":"Converter","ribbon.group.draw":"Drawing","ribbon.group.importExport":"Import/Export","ribbon.group.measure":"Measure","ribbon.group.modify":"Modify","ribbon.group.other":"Other","ribbon.group.selection":"Selection","ribbon.group.tools":"Tools","ribbon.group.workingPlane":"Working Plane","ribbon.tab.draw":"Drawing","ribbon.tab.file":"File","ribbon.tab.tools":"Tools","ribbon.tab.startup":"Startup","snap.center":"Center","snap.end":"End","snap.intersection":"Intersection","snap.mid":"Middle","snap.perpendicular":"Perpendicular","snap.nearest":"Nearest","statusBar.snap":"Snap","statusBar.tracking":"Tracking","toast.command.{0}excuting":"Command {0} is runing","toast.converter.error":"Converter error","toast.converter.invalidColor":"The color is invalid","toast.delete{0}Objects":"Deleted {0} objects","toast.document.noActived":"No document activated","toast.document.saved":"Document saved","toast.downloading":"Downloading","toast.excuting{0}":"Excuting {0}","toast.fail":"Fail","toast.read.error":"Read error","toast.select.noSelected":"No selected","toast.success":"Success","transform.rotation":"Rotation","transform.scale":"Scale","transform.translation":"Translation","vertex.point":"Point"}},ed={display:"简体中文",code:"zh-CN",translation:{"arc.angle":"角度","arc.start":"起点","axis.x":"X 轴","axis.y":"Y 轴","axis.z":"Z 轴","body.arc":"圆弧","body.bolean":"布尔","body.box":"立方体","body.pyramid":"棱锥","body.cylinder":"圆柱","body.cone":"圆锥","body.group":"组","body.sphere":"球体","body.ellipse":"椭圆","body.circle":"圆形","body.face":"面","body.fuse":"合并","body.imported":"导入的模型","body.line":"直线","body.polygon":"多边形","body.prism":"拉伸","body.rect":"矩形","body.revol":"旋转","body.sweep":"扫略","body.wire":"线框","body.editableShape":"可编辑的形状","body.meshNode":"网格节点","body.multiShape":"多形状","box.dx":"长","box.dy":"宽","box.dz":"高","circle.center":"圆心","circle.radius":"半径","ellipsoid.radiusX":"半径X","ellipsoid.radiusY":"半径Y","ellipsoid.radiusZ":"半径Z","ellipse.majorRadius":"长轴","ellipse.minorRadius":"短轴","command.act.alignCamera":"对齐相机","command.boolean.common":"交集","command.boolean.cut":"减去","command.boolean.fuse":"合并","command.convert.fuse":"融合","command.convert.prism":"拉伸","command.convert.revol":"旋转","command.convert.sweep":"扫略","command.convert.toFace":"转为面","command.convert.toShell":"转为壳","command.convert.toSolid":"转为体","command.convert.toWire":"转多段线","command.create.arc":"圆弧","command.create.bezier":"贝塞尔","command.create.box":"立方体","command.create.circle":"圆形","command.create.cone":"圆锥","command.create.copyShape":"复制形状","command.create.cylinder":"圆柱","command.create.ellipse":"椭圆","command.create.ellipsoid":"椭球体","command.create.folder":"文件夹","command.create.group":"创建组","command.create.line":"直线","command.create.offset":"偏移","command.create.polygon":"多边形","command.create.pyramid":"金字塔","command.create.rect":"矩形","command.create.section":"截面","command.create.sphere":"球体","command.create.thickSolid":"厚体","command.doc.new":"新建文档","command.doc.open":"打开文档","command.doc.save":"保存文档","command.doc.saveToFile":"保存到文件","command.edit.redo":"重做","command.edit.undo":"撤销","command.file.export":"导出","command.file.import":"导入","command.measure.angle":"角度","command.measure.length":"长度","command.measure.select":"选择","command.modify.array":"阵列","command.modify.break":"打断","command.modify.brushAdd":"添加画笔","command.modify.brushRemove":"删除画笔","command.modify.brushClear":"清除画笔","command.modify.chamfer":"倒角","command.modify.deleteNode":"删除节点","command.modify.explode":"分解","command.modify.fillet":"倒角","command.modify.mirror":"镜像","command.modify.move":"移动","command.modify.removeFeature":"删除特征","command.modify.removeShapes":"删除图形","command.modify.rotate":"旋转","command.modify.split":"分割","command.modify.trim":"修剪","command.special.last":"__上一步__","command.test.performace":"性能测试","command.wechat.group":"微信群","command.workingPlane.alignToPlane":"对齐","command.workingPlane.fromSection":"从截面","command.workingPlane.set":"设置","command.workingPlane.toggleDynamic":"动态","common.angle":"角度","common.area":"面积","common.back":"返回","common.cancel":"取消","common.clone":"复制对象","common.color":"颜色","common.confirm":"确定","common.general":"常规","common.length":"长度","common.material":"材质","common.matrix":"矩阵","common.name":"名称","common.normal":"法向量","common.opacity":"不透明度","common.thickness":"厚度","common.type":"类型","common.volume":"体积","dialog.title.selectWorkingPlane":"选择工作平面","entity.editable":"可编辑实体","entity.parameter":"参数化实体","error.default:{0}":"错误: {0}","error.input.cannotInputANumber":"与参照点重合，无法输入 1 个数","error.input.invalidNumber":"输入错误，请输入有效的数字，以,分开","error.input.threeNumberCanBeInput":"参照点为空，只能输入 3 个数","error.input.unsupportedInputs":"超过最大输入数","error.import.unsupportedFileType:{0}":"不支持的文件类型: {0}","error.export.noNodeCanBeExported":"没有可导出的节点","file.format":"文件格式","home.recent":"最近使用","home.welcome":"欢迎使用 chili3d","items.header":"项目","items.tool.delete":"删除","items.tool.expandAll":"展开所有","items.tool.newFolder":"文件夹","items.tool.unexpandAll":"折叠所有","line.end":"终点","line.start":"起点","line.type.line":"直线","line.type.xline":"构造线","material.texture.image":"图片","material.texture.rotation":"旋转","material.texture.wrapS":"Wrap S","material.texture.wrapT":"Wrap T","material.texture.repeat":"重复","material.texture.offset":"偏移","material.map":"贴图","material.specular":"高光","material.shininess":"高光强度","material.emissive":"自发光","material.specularMap":"高光贴图","material.normalMap":"法线贴图","material.bumpMap":"凹凸贴图","material.roughnessMap":"粗糙度贴图","material.emissiveMap":"自发光贴图","material.metalness":"金属度","material.metalnessMap":"金属度贴图","material.roughness":"粗糙度","model.visible":"可见","operate.pickCircleCenter":"请选择圆心  按 ESC 键取消","operate.pickFistPoint":"请选择第一个点, 按 ESC 键取消","operate.pickNextPoint":"请选择下一个点， 按 ESC 键取消","operate.pickRadius":"请选择半径，按 ESC 键取消","option.command.repeat":"重复","option.command.isFace":"面","option.command.thickness":"厚度","option.command.isConnected":"相连","option.command.isConvertInstance":"转为实例","option.command.insertPoint":"插入点","polygon.points":"点","prompt.default":"鼠标中键平移视图，Shift + 中键旋转视图，中键滚动缩放视图","prompt.deleteDocument{0}":"是否删除 {0} ？","prompt.polygon.close":"闭合","prompt.saveDocument{0}":"是否保存对 {0} 的更改？","prompt.select.edges":"请选择边","prompt.select.faces":"请选择面","prompt.select.models":"请选择模型","prompt.select.noModelSelected":"未选择任何模型","prompt.select.shape":"选择形状","prompt.select.solids":"请选择实体","prompt.select.vertexs":"请选择点","prompt.select.wires":"请选择线","toast.snap.notFoundValidPoint":"未找到有效的点","properties.group.transform":"转换","properties.header":"属性","properties.multivalue":"多个值","rect.dx":"长","rect.dy":"宽","ribbon.group.2d":"2D","ribbon.group.3d":"3D","ribbon.group.act":"场景","ribbon.group.boolean":"布尔运算","ribbon.group.converter":"转换","ribbon.group.draw":"绘制","ribbon.group.importExport":"导入/导出","ribbon.group.measure":"测量","ribbon.group.modify":"修改","ribbon.group.other":"其他","ribbon.group.selection":"选择","ribbon.group.tools":"工具","ribbon.group.workingPlane":"工作平面","ribbon.tab.draw":"绘图","ribbon.tab.file":"文件","ribbon.tab.tools":"工具","ribbon.tab.startup":"开始","snap.center":"圆心","snap.end":"端点","snap.intersection":"交点","snap.mid":"中点","snap.perpendicular":"垂点","snap.nearest":"最近点","statusBar.snap":"捕捉","statusBar.tracking":"追踪","toast.command.{0}excuting":"{0}命令正在执行","toast.converter.error":"转换错误","toast.converter.invalidColor":"无效的颜色","toast.delete{0}Objects":"删除了 {0} 个对象","toast.document.noActived":"未打开任何文档","toast.document.saved":"文档已保存","toast.downloading":"正在下载","toast.excuting{0}":"正在执行{0}","toast.fail":"失败","toast.read.error":"读取错误","toast.select.noSelected":"未选择任何对象","toast.success":"成功","transform.rotation":"旋转","transform.scale":"缩放","transform.translation":"位移","vertex.point":"点"}},ep="chili18n",eh=new WeakMap;let Localize=class Localize{key;constructor(e){this.key=e}set(e,t){V.set(e,t,this.key)}};!function(e){e.languages=new Map([["en",ec],["zh-CN",ed]]);let t="zh-CN";function combineTranslation(t,r){let i=e.languages.get(t);i&&(i.translation={...i.translation,...r})}function translate(r,...i){let a=e.languages.get(t).translation[r]??e.languages.get("zh-CN").translation[r];return i.length>0&&(a=a.replace(/\{(\d+)\}/g,(e,t)=>i[t])),a}function isI18nKey(t){return t in e.languages.get("zh-CN").translation}function changeLanguage(r){if(r<0||r>=e.languages.size)return;let i=Array.from(e.languages.keys())[r];i!==t&&(t=i,document.querySelectorAll(`[data-${ep}]`).forEach(e=>{let t=e?.dataset[ep]?.split("_:_");if(t?.length!==2)return;let r=eh.get(e)??[];e[t[1]]=translate(t[0],...r)}))}e.currentLanguage=function(){return t},e.combineTranslation=combineTranslation,e.translate=translate,e.isI18nKey=isI18nKey,e.set=function(e,t,r,...i){e[t]=translate(r,...i),e.dataset[ep]=`${r}_:_${t}`,i.length>0&&eh.set(e,i)},e.changeLanguage=changeLanguage}(V||(V={}));var eu=((u={})[u.Line=0]="Line",u[u.Circle=1]="Circle",u[u.Ellipse=2]="Ellipse",u[u.Hyperbola=3]="Hyperbola",u[u.Parabola=4]="Parabola",u[u.BezierCurve=5]="BezierCurve",u[u.BSplineCurve=6]="BSplineCurve",u[u.OffsetCurve=7]="OffsetCurve",u[u.OtherCurve=8]="OtherCurve",u[u.TrimmedCurve=9]="TrimmedCurve",u),em=((m={})[m.C0=0]="C0",m[m.G1=1]="G1",m[m.C1=2]="C1",m[m.G2=3]="G2",m[m.C2=4]="C2",m[m.C3=5]="C3",m[m.CN=6]="CN",m);(f=B||(B={})).isConic=function(e){return void 0!==e.axis},f.isCircle=function(e){return void 0!==e.center&&void 0!==e.radius},f.isLine=function(e){return void 0!==e.direction},f.isTrimmed=function(e){return void 0!==e.basisCurve};var ef=((g={})[g.Curve=0]="Curve",g[g.Surface=1]="Surface",g),eg=((y={})[y.Solid=0]="Solid",y[y.Dash=1]="Dash",y);function meshData_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let MeshGroup=class MeshGroup{start;count;materialIndex;constructor(e,t,r){this.start=e,this.count=t,this.materialIndex=r}};meshData_ts_decorate([R.serialze()],MeshGroup.prototype,"start",void 0),meshData_ts_decorate([R.serialze()],MeshGroup.prototype,"count",void 0),meshData_ts_decorate([R.serialze()],MeshGroup.prototype,"materialIndex",void 0),MeshGroup=meshData_ts_decorate([R.register(["start","count","materialIndex"])],MeshGroup);let Mesh=class Mesh{static createSurface(e,t){let r=new Mesh;return r.meshType="surface",r.normal=new Float32Array(3*e),r.uv=new Float32Array(2*e),r.position=new Float32Array(3*e),r.index=new Uint32Array(t),r}static createLineSegments(e){let t=new Mesh;return t.meshType="linesegments",t.position=new Float32Array(3*e),t}meshType="linesegments";position;normal=void 0;index=void 0;color=4095;uv=void 0;groups=[]};function concatTypedArrays(e){let t=e.reduce((e,t)=>e+t.length,0),r=new e[0].constructor(t),i=0;for(let t of e)r.set(t,i),i+=t.length;return r}meshData_ts_decorate([R.serialze()],Mesh.prototype,"meshType",void 0),meshData_ts_decorate([R.serialze()],Mesh.prototype,"position",void 0),meshData_ts_decorate([R.serialze()],Mesh.prototype,"normal",void 0),meshData_ts_decorate([R.serialze()],Mesh.prototype,"index",void 0),meshData_ts_decorate([R.serialze()],Mesh.prototype,"color",void 0),meshData_ts_decorate([R.serialze()],Mesh.prototype,"uv",void 0),meshData_ts_decorate([R.serialze()],Mesh.prototype,"groups",void 0),Mesh=meshData_ts_decorate([R.register([])],Mesh),(v=W||(W={})).isVertex=function(e){return e?.size!==void 0},v.isEdge=function(e){return e?.lineType!==void 0},v.isFace=function(e){return e?.index!==void 0},(Y||(Y={})).from=function(e,t,r){return{position:new Float32Array([e.x,e.y,e.z]),range:[],color:r,size:t}},(_=L||(L={})).from=function(e,t,r,i){return{position:new Float32Array([e.x,e.y,e.z,t.x,t.y,t.z]),color:r,lineType:i,range:[]}},_.merge=function(e,t){let r=t.range.map(t=>({start:t.start+e.position.length/3,count:t.count,shape:t.shape,transform:t.transform}));return{position:concatTypedArrays([e.position,t.position]),range:e.range.concat(r),color:e.color,lineType:e.lineType,lineWidth:e.lineWidth}},(H||(H={})).merge=function(e,t){let r=t.range.map(t=>({start:t.start+e.position.length/3,count:t.count,shape:t.shape,transform:t.transform})),i=t.groups.map(t=>({start:t.start+e.index.length,count:t.count,materialIndex:t.materialIndex}));return{position:concatTypedArrays([e.position,t.position]),range:e.range.concat(r),index:concatTypedArrays([e.index,t.index]),normal:concatTypedArrays([e.normal,t.normal]),uv:concatTypedArrays([e.uv,t.uv]),color:e.color,groups:i}};let MeshDataBuilder=class MeshDataBuilder{_positions=[];_groups=[];_color;_vertexColor;setColor(e){this._color=e}addColor(e,t,r){return this._vertexColor??=[],this._vertexColor.push(e,t,r),this}getColor(){let e=this._vertexColor;return this._vertexColor?.length!==this._positions.length&&(e=this._color),e}};let EdgeMeshDataBuilder=class EdgeMeshDataBuilder extends MeshDataBuilder{_positionStart=0;_previousVertex=void 0;_lineType=eg.Solid;constructor(){super(),this._color=eo.defaultEdgeColor}setType(e){this._lineType=e}newGroup(){return this._positionStart=this._positions.length,this._previousVertex=void 0,this}endGroup(e){return this._groups.push({start:this._positionStart/3,count:(this._positions.length-this._positionStart)/3,shape:e}),this}addPosition(e,t,r){return this._previousVertex&&this._positions.push(...this._previousVertex,e,t,r),this._previousVertex=[e,t,r],this}build(){let e=this.getColor();return{position:new Float32Array(this._positions),range:this._groups,lineType:this._lineType,color:e}}};var ey=((x={})[x.FORWARD=0]="FORWARD",x[x.REVERSED=1]="REVERSED",x[x.INTERNAL=2]="INTERNAL",x[x.EXTERNAL=3]="EXTERNAL",x),ev=((P={})[P.arc=0]="arc",P[P.tangent=1]="tangent",P[P.intersection=2]="intersection",P),e_=((b={})[b.Shape=0]="Shape",b[b.Compound=1]="Compound",b[b.CompoundSolid=2]="CompoundSolid",b[b.Solid=4]="Solid",b[b.Shell=8]="Shell",b[b.Face=16]="Face",b[b.Wire=32]="Wire",b[b.Edge=64]="Edge",b[b.Vertex=128]="Vertex",b);(w=e_||(e_={})).isWhole=function(e){return 0===e||1===e||2===e||4===e},w.stringValue=function(e){switch(e){case 0:return"Shape";case 1:return"Compound";case 2:return"CompoundSolid";case 4:return"Solid";case 8:return"Shell";case 16:return"Face";case 32:return"Wire";case 64:return"Edge";case 128:return"Vertex";default:return"Unknown"}},w.hasCompound=function(e){return(1&e)!=0},w.hasCompoundSolid=function(e){return(2&e)!=0},w.hasSolid=function(e){return(4&e)!=0},w.hasShell=function(e){return(8&e)!=0},w.hasFace=function(e){return(16&e)!=0},w.hasWire=function(e){return(32&e)!=0},w.hasEdge=function(e){return(64&e)!=0},w.hasVertex=function(e){return(128&e)!=0};var ex=((S={})[S.Plate=0]="Plate",S[S.Bezier=1]="Bezier",S[S.BSpline=2]="BSpline",S[S.RectangularTrimmed=3]="RectangularTrimmed",S[S.Conical=4]="Conical",S[S.Cylinder=5]="Cylinder",S[S.Plane=6]="Plane",S[S.Spherical=7]="Spherical",S[S.Toroidal=8]="Toroidal",S[S.Revolution=9]="Revolution",S[S.Extrusion=10]="Extrusion",S[S.Offset=11]="Offset",S[S.Composite=12]="Composite",S);let MathUtils=class MathUtils{static degToRad(e){return Math.PI/180*e}static radToDeg(e){return 180/Math.PI*e}static anyEqualZero(...e){return e.some(e=>Math.abs(e)<F.Float)}static allEqualZero(...e){return e.every(e=>Math.abs(e)<F.Float)}static almostEqual(e,t,r=1e-6){return Math.abs(e-t)<r}static clamp(e,t,r){return Math.max(t,Math.min(r,e))}static minMax(e){if(0===e.length)return;let t=e[0],r=e[0];for(let i=1;i<e.length;i++){let a=e[i];a<t&&(t=a),a>r&&(r=a)}return{min:t,max:r}}};function xyz_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let XYZ=class XYZ{static zero=new XYZ(0,0,0);static unitX=new XYZ(1,0,0);static unitY=new XYZ(0,1,0);static unitZ=new XYZ(0,0,1);static one=new XYZ(1,1,1);x;y;z;constructor(e,t,r){this.x=e,this.y=t,this.z=r}toString(){return`${this.x}, ${this.y}, ${this.z}`}toArray(){return[this.x,this.y,this.z]}cross(e){return new XYZ(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}divided(e){if(!(Math.abs(e)<F.Float))return new XYZ(this.x/e,this.y/e,this.z/e)}reverse(){return new XYZ(-this.x,-this.y,-this.z)}multiply(e){return new XYZ(this.x*e,this.y*e,this.z*e)}sub(e){return new XYZ(this.x-e.x,this.y-e.y,this.z-e.z)}add(e){return new XYZ(this.x+e.x,this.y+e.y,this.z+e.z)}normalize(){let e=this.length();return e<F.Float?void 0:new XYZ(this.x/e,this.y/e,this.z/e)}distanceTo(e){let t=this.x-e.x,r=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+r*r+i*i)}static center(e,t){return new XYZ((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.lengthSq())}angleTo(e){if(this.isEqualTo(XYZ.zero)||XYZ.zero.isEqualTo(e))return;let t=this.cross(e),r=this.dot(e);return Math.atan2(t.length(),r)}angleOnPlaneTo(e,t){let r=this.angleTo(e);if(void 0===r||XYZ.zero.isEqualTo(t))return;let i=this.cross(e).normalize();return i?.isOppositeTo(t)?2*Math.PI-r:r}rotate(e,t){let r=e.normalize();if(void 0===r)return;let i=Math.cos(t);return this.multiply(i).add(r.multiply((1-i)*r.dot(this))).add(r.cross(this).multiply(Math.sin(t)))}isEqualTo(e,t=1e-8){return MathUtils.almostEqual(this.x,e.x,t)&&MathUtils.almostEqual(this.y,e.y,t)&&MathUtils.almostEqual(this.z,e.z,t)}isParallelTo(e,t=1e-8){let r=this.angleTo(e);return void 0===r?void 0:r<=t||Math.PI-r<=t}isOppositeTo(e,t=1e-8){let r=this.angleTo(e);return void 0===r?void 0:Math.PI-r<=t}};xyz_ts_decorate([R.serialze()],XYZ.prototype,"x",void 0),xyz_ts_decorate([R.serialze()],XYZ.prototype,"y",void 0),xyz_ts_decorate([R.serialze()],XYZ.prototype,"z",void 0),XYZ=xyz_ts_decorate([R.register(["x","y","z"])],XYZ);let BoundingBox=class BoundingBox{min;max;constructor(e,t){this.min=e,this.max=t}static zero=new BoundingBox(new XYZ(0,0,0),new XYZ(0,0,0));static transformed(e,t){return new BoundingBox(t.ofPoint(e.min),t.ofPoint(e.max))}static center(e){if(!e)return XYZ.zero;let t=(e.min.x+e.max.x)/2,r=(e.min.y+e.max.y)/2,i=(e.min.z+e.max.z)/2;return new XYZ(t,r,i)}static expand(e,t){return new BoundingBox({x:e.min.x-t,y:e.min.y-t,z:e.min.z-t},{x:e.max.x+t,y:e.max.y+t,z:e.max.z+t})}static wireframe(e){let{min:t,max:r}=e;return{position:new Float32Array([t.x,t.y,t.z,t.x,t.y,r.z,t.x,t.y,r.z,t.x,r.y,r.z,t.x,r.y,r.z,t.x,r.y,t.z,t.x,r.y,t.z,t.x,t.y,t.z,r.x,t.y,t.z,r.x,t.y,r.z,r.x,t.y,r.z,r.x,r.y,r.z,r.x,r.y,r.z,r.x,r.y,t.z,r.x,r.y,t.z,r.x,t.y,t.z,t.x,t.y,t.z,r.x,t.y,t.z,t.x,t.y,r.z,r.x,t.y,r.z,t.x,r.y,r.z,r.x,r.y,r.z,t.x,r.y,t.z,r.x,r.y,t.z]),lineType:eg.Solid,range:[]}}static isValid(e){return e.min.x<=e.max.x&&e.min.y<=e.max.y&&e.min.z<=e.max.z}static expandByPoint(e,t){let{min:r,max:i}=e;r.x=Math.min(r.x,t.x),r.y=Math.min(r.y,t.y),r.z=Math.min(r.z,t.z),i.x=Math.max(i.x,t.x),i.y=Math.max(i.y,t.y),i.z=Math.max(i.z,t.z)}static combine(e,t){return t?e?new BoundingBox({x:Math.min(e.min.x,t.min.x),y:Math.min(e.min.y,t.min.y),z:Math.min(e.min.z,t.min.z)},{x:Math.max(e.max.x,t.max.x),y:Math.max(e.max.y,t.max.y),z:Math.max(e.max.z,t.max.z)}):t:e}static fromNumbers(e){let t={x:1/0,y:1/0,z:1/0},r={x:-1/0,y:-1/0,z:-1/0};for(let i=0;i<e.length;i+=3){let a=e[i],s=e[i+1],n=e[i+2];t.x=Math.min(t.x,a),t.y=Math.min(t.y,s),t.z=Math.min(t.z,n),r.x=Math.max(r.x,a),r.y=Math.max(r.y,s),r.z=Math.max(r.z,n)}return new BoundingBox(t,r)}static fromPoints(e){let t={x:1/0,y:1/0,z:1/0},r={x:-1/0,y:-1/0,z:-1/0};for(let i of e)t.x=Math.min(t.x,i.x),t.y=Math.min(t.y,i.y),t.z=Math.min(t.z,i.z),r.x=Math.max(r.x,i.x),r.y=Math.max(r.y,i.y),r.z=Math.max(r.z,i.z);return new BoundingBox(t,r)}};let Quaternion=class Quaternion{w;x;y;z;constructor(e=1,t=0,r=0,i=0){this.w=e,this.x=t,this.y=r,this.z=i}add(e){return new Quaternion(this.w+e.w,this.x+e.x,this.y+e.y,this.z+e.z)}subtract(e){return new Quaternion(this.w-e.w,this.x-e.x,this.y-e.y,this.z-e.z)}multiply(e){let{w:t,x:r,y:i,z:a}=this,{w:s,x:n,y:o,z:l}=e;return new Quaternion(t*s-r*n-i*o-a*l,t*n+r*s+i*l-a*o,t*o-r*l+i*s+a*n,t*l+r*o-i*n+a*s)}toEuler(){let[e,t,r,i]=[this.w,this.x,this.y,this.z],[a,s,n,o]=[e*e,t*t,r*r,i*i],l=s+o+n+a,c=t*i+r*e;return c>.499*l?{x:0,y:Math.PI/4,z:2*Math.atan2(t,e)}:c<-.499*l?{x:0,y:-Math.PI/4,z:2*Math.atan2(t,e)}:{x:Math.atan2(2*(-r*i+t*e),1-2*(s+n)),y:Math.asin(2*(t*i+r*e)),z:Math.atan2(2*(-t*r+i*e),1-2*(n+o))}}toMatrix4(){let e=this.x*this.x,t=this.y*this.y,r=this.z*this.z,i=e*this.x,a=e*this.y,s=e*this.z,n=t*this.y,o=t*this.z,l=r*this.z,c=t*this.w,d=r*this.w,p=e*this.w;return Matrix4.fromArray([1-n-l,a+d,s-c,0,a-d,1-i-l,o+p,0,s+c,o-p,1-i-n,0,0,0,0,1])}static fromEuler(e,t,r){let i=.5*e,a=.5*t,s=.5*r,n=Math.cos(i),o=Math.sin(i),l=Math.cos(a),c=Math.sin(a),d=Math.cos(s),p=Math.sin(s);return new Quaternion(-o*c*p+n*l*d,o*l*d+n*c*p,-o*l*p+n*c*d,n*l*p+o*c*d)}};function matrix4_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let Matrix4=class Matrix4{_array=new Float32Array(16);get array(){return[...this._array]}determinant(){let[e,t,r,i]=[this._array[0],this._array[1],this._array[2],this._array[3]],[a,s,n,o]=[this._array[4],this._array[5],this._array[6],this._array[7]],[l,c,d,p]=[this._array[8],this._array[9],this._array[10],this._array[11]],[h,u,m,f]=[this._array[12],this._array[13],this._array[14],this._array[15]],g=e*s-t*a,y=e*n-r*a,v=t*n-r*s,_=l*u-c*h,x=l*m-d*h,P=c*m-d*u;return o*(e*P-t*x+r*_)-i*(a*P-s*x+n*_)+f*(l*v-c*y+d*g)-p*(h*v-u*y+m*g)}toArray(){return[...this._array]}add(e){let t=new Matrix4;for(let r=0;r<16;r++)t._array[r]=this._array[r]+e._array[r];return t}invert(){let[e,t,r,i]=[this._array[0],this._array[1],this._array[2],this._array[3]],[a,s,n,o]=[this._array[4],this._array[5],this._array[6],this._array[7]],[l,c,d,p]=[this._array[8],this._array[9],this._array[10],this._array[11]],[h,u,m,f]=[this._array[12],this._array[13],this._array[14],this._array[15]],g=e*s-t*a,y=e*n-r*a,v=e*o-i*a,_=t*n-r*s,x=t*o-i*s,P=r*o-i*n,b=l*u-c*h,w=l*m-d*h,S=l*f-p*h,C=c*m-d*u,D=c*f-p*u,k=d*f-p*m,M=g*k-y*D+v*C+_*S-x*w+P*b;if(0!==M)return M=1/M,Matrix4.fromArray([(s*k-n*D+o*C)*M,(r*D-t*k-i*C)*M,(u*P-m*x+f*_)*M,(d*x-c*P-p*_)*M,(n*S-a*k-o*w)*M,(e*k-r*S+i*w)*M,(m*v-h*P-f*y)*M,(l*P-d*v+p*y)*M,(a*D-s*S+o*b)*M,(t*S-e*D-i*b)*M,(h*x-u*v+f*g)*M,(c*v-l*x-p*g)*M,(s*w-a*C-n*b)*M,(e*C-t*w+r*b)*M,(u*y-h*_-m*g)*M,(l*_-c*y+d*g)*M])}multiply(e){let t=Array(16).fill(0);for(let r=0;r<4;r++)for(let i=0;i<4;i++)for(let a=0;a<4;a++)t[4*r+i]+=this._array[4*r+a]*e._array[4*a+i];return Matrix4.fromArray(t)}equals(e){for(let t=0;t<16;t++)if(!MathUtils.almostEqual(this._array[t],e._array[t]))return!1;return!0}clone(){return Matrix4.fromArray([...this._array])}static fromArray(e){let t=new Matrix4;for(let r=0;r<16;r++)t._array[r]=e[r];return t}static identity(){return Matrix4.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}static zero(){return Matrix4.fromArray(Array(16).fill(0))}static fromEuler(e,t,r){let i=Math.cos(e),a=Math.sin(e),s=Math.cos(t),n=Math.sin(t),o=Math.cos(r),l=Math.sin(r);return Matrix4.fromArray([s*o,i*l+a*n*o,a*l-i*n*o,0,-s*l,i*o-a*n*l,a*o+i*n*l,0,n,-a*s,i*s,0,0,0,0,1])}static fromAxisRad(e,t,r){let i=new XYZ(t.x,t.y,t.z).normalize();if(void 0===i)throw TypeError("invalid vector");let{x:a,y:s,z:n}=i,o=Math.sin(-r),l=Math.cos(-r),c=1-l,d=[c*a*a+l,c*a*s-n*o,c*a*n+s*o,0,c*a*s+n*o,c*s*s+l,c*s*n-a*o,0,c*a*n-s*o,c*s*n+a*o,c*n*n+l,0,0,0,0,1];return d[12]=e.x-e.x*d[0]-e.y*d[4]-e.z*d[8],d[13]=e.y-e.x*d[1]-e.y*d[5]-e.z*d[9],d[14]=e.z-e.x*d[2]-e.y*d[6]-e.z*d[10],Matrix4.fromArray(d)}static fromScale(e,t,r){return Matrix4.fromArray([e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1])}static fromTranslation(e,t,r){return Matrix4.fromArray([1,0,0,0,0,1,0,0,0,0,1,0,e,t,r,1])}static createMirrorWithPlane(e){let t=-e.origin.dot(e.normal),r=e.normal.x,i=e.normal.y,a=e.normal.z,s=-2*r,n=-2*i,o=-2*a;return Matrix4.fromArray([s*r+1,n*r,o*r,0,s*i,n*i+1,o*i,0,s*a,n*a,o*a+1,0,s*t,n*t,o*t,1])}transpose(){let e=new Matrix4;return e._array[0]=this._array[0],e._array[1]=this._array[4],e._array[2]=this._array[8],e._array[3]=this._array[12],e._array[4]=this._array[1],e._array[5]=this._array[5],e._array[6]=this._array[9],e._array[7]=this._array[13],e._array[8]=this._array[2],e._array[9]=this._array[6],e._array[10]=this._array[10],e._array[11]=this._array[14],e._array[12]=this._array[3],e._array[13]=this._array[7],e._array[14]=this._array[11],e._array[15]=this._array[15],e}ofPoints(e){let t=[];for(let r=0;r<e.length/3;r++){let i=e[3*r]*this._array[0]+e[3*r+1]*this._array[4]+e[3*r+2]*this._array[8]+this._array[12],a=e[3*r]*this._array[1]+e[3*r+1]*this._array[5]+e[3*r+2]*this._array[9]+this._array[13],s=e[3*r]*this._array[2]+e[3*r+1]*this._array[6]+e[3*r+2]*this._array[10]+this._array[14],n=e[3*r]*this._array[3]+e[3*r+1]*this._array[7]+e[3*r+2]*this._array[11]+this._array[15];t.push(i/n,a/n,s/n)}return t}ofPoint(e){let t=this.ofPoints([e.x,e.y,e.z]);return new XYZ(t[0],t[1],t[2])}ofVector(e){let t=this.ofVectors([e.x,e.y,e.z]);return new XYZ(t[0],t[1],t[2])}ofVectors(e){let t=[];for(let r=0;r<e.length/3;r++){let i=e[3*r]*this._array[0]+e[3*r+1]*this._array[4]+e[3*r+2]*this._array[8],a=e[3*r]*this._array[1]+e[3*r+1]*this._array[5]+e[3*r+2]*this._array[9],s=e[3*r]*this._array[2]+e[3*r+1]*this._array[6]+e[3*r+2]*this._array[10];t.push(i,a,s)}return t}translationPart(){return new XYZ(this._array[12],this._array[13],this._array[14])}getScale(){let e=Math.hypot(this._array[0],this._array[1],this._array[2]),t=Math.hypot(this._array[4],this._array[5],this._array[6]),r=Math.hypot(this._array[8],this._array[9],this._array[10]);return new XYZ(e,t,r)}getEulerAngles(){let e=this._array,t=e[0],r=e[4],i=e[8],a=e[5],s=e[9],n=e[6],o=e[10],l=0,c=Math.asin(MathUtils.clamp(i,-1,1)),d=0;return .9999999>Math.abs(i)?(l=Math.atan2(-s,o),d=Math.atan2(-r,t)):l=Math.atan2(n,a),{pitch:l,yaw:c,roll:d}}static createFromTRS(e,t,r){let i=Quaternion.fromEuler(t.pitch,t.yaw,t.roll),a=Array(16).fill(0),s=i.x,n=i.y,o=i.z,l=i.w,c=s+s,d=n+n,p=o+o,h=s*c,u=s*d,m=s*p,f=n*d,g=n*p,y=o*p,v=l*c,_=l*d,x=l*p,P=r.x,b=r.y,w=r.z;return a[0]=(1-(f+y))*P,a[1]=(u+x)*P,a[2]=(m-_)*P,a[3]=0,a[4]=(u-x)*b,a[5]=(1-(h+y))*b,a[6]=(g+v)*b,a[7]=0,a[8]=(m+_)*w,a[9]=(g-v)*w,a[10]=(1-(h+f))*w,a[11]=0,a[12]=e.x,a[13]=e.y,a[14]=e.z,a[15]=1,Matrix4.fromArray(a)}};function plane_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}matrix4_ts_decorate([R.serialze()],Matrix4.prototype,"array",null),Matrix4=matrix4_ts_decorate([R.register(["array"],e=>Matrix4.fromArray(e))],Matrix4);let Plane=class Plane{static XY=new Plane(XYZ.zero,XYZ.unitZ,XYZ.unitX);static YZ=new Plane(XYZ.zero,XYZ.unitX,XYZ.unitY);static ZX=new Plane(XYZ.zero,XYZ.unitY,XYZ.unitZ);origin;normal;xvec;yvec;constructor(e,t,r){this.origin=e;let i=t.normalize(),a=r.normalize();if(void 0===i||i.isEqualTo(XYZ.zero))throw Error("normal can not be zero");if(void 0===a||a.isEqualTo(XYZ.zero))throw Error("xDirector can not be zero");if(i.isParallelTo(a))throw Error("xDirector can not parallel normal");this.normal=i,this.xvec=a,this.yvec=i.cross(a).normalize()}translateTo(e){return new Plane(e,this.normal,this.xvec)}project(e){let t=e.sub(this.origin),r=t.dot(this.normal);return this.origin.add(t.sub(this.normal.multiply(r)))}transformed(e){let t=e.ofPoint(this.origin),r=e.ofVector(this.xvec),i=e.ofVector(this.normal);return new Plane(t,i,r)}intersect(e,t=!0){let r=this.origin.sub(e.location);if(r.isEqualTo(XYZ.zero))return this.origin;let i=r.dot(this.normal),a=e.direction.dot(this.normal);if(MathUtils.almostEqual(a,0))return MathUtils.almostEqual(i,0)?e.location:void 0;let s=i/a;if(t||!(s<0))return e.location.add(e.direction.multiply(s))}projectDistance(e,t){let r=this.project(e),i=this.project(t);return r.distanceTo(i)}};plane_ts_decorate([R.serialze()],Plane.prototype,"origin",void 0),plane_ts_decorate([R.serialze()],Plane.prototype,"normal",void 0),plane_ts_decorate([R.serialze()],Plane.prototype,"xvec",void 0),Plane=plane_ts_decorate([R.register(["origin","normal","xvec"])],Plane);let PlaneAngle=class PlaneAngle{plane;lastX;lastY;isNegativeRotation;currentAngle;get angle(){return this.currentAngle}constructor(e){this.plane=e,this.lastX=1,this.lastY=0,this.isNegativeRotation=!1,this.currentAngle=0}movePoint(e){let t=e.sub(this.plane.origin),r=t.dot(this.plane.xvec),i=t.dot(this.plane.yvec);this.isCrossingPositiveXAxis(r,i)&&(this.isNegativeRotation=!this.isNegativeRotation),this.currentAngle=this.calculateAngle(t),this.updateLastProjections(r,i)}calculateAngle(e){let t=180*this.plane.xvec.angleOnPlaneTo(e,this.plane.normal)/Math.PI;return this.isNegativeRotation?t-360:t}isCrossingPositiveXAxis(e,t){let r=this.lastY<-F.Distance&&t>F.Distance,i=this.lastY>-F.Distance&&t<-F.Distance;return(r&&this.currentAngle<F.Angle||i&&this.currentAngle>-F.Angle)&&this.lastX>0&&e>0}updateLastProjections(e,t){Math.abs(e)>F.Distance&&(this.lastX=e),Math.abs(t)>F.Distance&&(this.lastY=t)}};function ray_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let Ray=class Ray{location;direction;constructor(e,t){this.location=e;let r=t.normalize();if(void 0===r||r.isEqualTo(XYZ.zero))throw Error("direction can not be zero");this.direction=r}intersect(e){if(this.direction.isParallelTo(e.direction))return;let t=this.nearestTo(e);return t.sub(e.location).isParallelTo(e.direction)?t:void 0}nearestTo(e){let t=e.direction.cross(this.direction).normalize();if(void 0===t)return this.nearestToPoint(e.location);let r=t.cross(e.direction).normalize();return new Plane(e.location,r,t).intersect(this)}nearestToPoint(e){let t=e.sub(this.location).dot(this.direction);return this.location.add(this.direction.multiply(t))}};function xy_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}ray_ts_decorate([R.serialze()],Ray.prototype,"location",void 0),ray_ts_decorate([R.serialze()],Ray.prototype,"direction",void 0),Ray=ray_ts_decorate([R.register(["location","direction"])],Ray);let XY=class XY{static zero=new XY(0,0);static unitX=new XY(1,0);static unitY=new XY(0,1);x;y;constructor(e,t){this.x=e,this.y=t}cross(e){return this.x*e.y-this.y*e.x}dot(e){return this.x*e.x+this.y*e.y}divided(e){return Math.abs(e)<F.Float?void 0:new XY(this.x/e,this.y/e)}reverse(){return new XY(-this.x,-this.y)}multiply(e){return new XY(this.x*e,this.y*e)}sub(e){return new XY(this.x-e.x,this.y-e.y)}add(e){return new XY(this.x+e.x,this.y+e.y)}normalize(){let e=this.length();return e<F.Float?void 0:new XY(this.x/e,this.y/e)}distanceTo(e){let t=this.x-e.x,r=this.y-e.y;return Math.sqrt(t*t+r*r)}static center(e,t){return new XY((e.x+t.x)/2,(e.y+t.y)/2)}lengthSq(){return this.x**2+this.y**2}length(){return Math.sqrt(this.lengthSq())}angleTo(e){if(!(this.isEqualTo(XY.zero)||e.isEqualTo(XY.zero)))return Math.atan2(this.cross(e),this.dot(e))}isEqualTo(e,t=1e-8){return MathUtils.almostEqual(this.x,e.x,t)&&MathUtils.almostEqual(this.y,e.y,t)}isParallelTo(e,t=1e-8){let r=this.angleTo(e);return void 0===r?void 0:r<=t||Math.PI-r<=t}isOppositeTo(e,t=1e-8){let r=this.angleTo(e);return void 0===r?void 0:Math.PI-r<=t}};function material_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}xy_ts_decorate([R.serialze()],XY.prototype,"x",void 0),xy_ts_decorate([R.serialze()],XY.prototype,"y",void 0),XY=xy_ts_decorate([R.register(["x","y"])],XY);let Texture=class Texture extends HistoryObservable{get image(){return this.getPrivateValue("image","")}set image(e){this.setProperty("image",e)}get wrapS(){return this.getPrivateValue("wrapS",1e3)}set wrapS(e){this.setProperty("wrapS",e)}get wrapT(){return this.getPrivateValue("wrapT",1e3)}set wrapT(e){this.setProperty("wrapT",e)}get rotation(){return this.getPrivateValue("rotation",0)}set rotation(e){this.setProperty("rotation",e)}get offset(){return this.getPrivateValue("offset",new XY(0,0))}set offset(e){this.setProperty("offset",e)}get repeat(){return this.getPrivateValue("repeat",new XY(1,1))}set repeat(e){this.setProperty("repeat",e)}center=new XY(.5,.5)};material_ts_decorate([R.serialze(),A.define("material.texture.image")],Texture.prototype,"image",null),material_ts_decorate([R.serialze()],Texture.prototype,"wrapS",null),material_ts_decorate([R.serialze()],Texture.prototype,"wrapT",null),material_ts_decorate([R.serialze(),A.define("material.texture.rotation")],Texture.prototype,"rotation",null),material_ts_decorate([R.serialze(),A.define("material.texture.offset")],Texture.prototype,"offset",null),material_ts_decorate([R.serialze(),A.define("material.texture.repeat")],Texture.prototype,"repeat",null),material_ts_decorate([R.serialze()],Texture.prototype,"center",void 0),Texture=material_ts_decorate([R.register(["document"])],Texture);let Material=class Material extends HistoryObservable{vertexColors=!1;transparent=!0;id;get name(){return this.getPrivateValue("name")}set name(e){this.setProperty("name",e)}get color(){return this.getPrivateValue("color")}set color(e){this.setProperty("color",e)}get opacity(){return this.getPrivateValue("opacity",1)}set opacity(e){this.setProperty("opacity",e)}get map(){return this.getPrivateValue("map",new Texture(this.document))}set map(e){this.setProperty("map",e)}constructor(e,t,r,i=Id.generate()){super(e),this.id=i,this.setPrivateValue("name",t?.length>0?t:"unnamed"),this.setPrivateValue("color",r)}clone(){let e=new Material(this.document,`${this.name} clone`,this.color);return e.setPrivateValue("map",this.map),e}};material_ts_decorate([R.serialze()],Material.prototype,"vertexColors",void 0),material_ts_decorate([R.serialze()],Material.prototype,"transparent",void 0),material_ts_decorate([R.serialze()],Material.prototype,"id",void 0),material_ts_decorate([R.serialze(),A.define("common.name")],Material.prototype,"name",null),material_ts_decorate([R.serialze(),A.define("common.color",{type:"color"})],Material.prototype,"color",null),material_ts_decorate([R.serialze(),A.define("common.opacity")],Material.prototype,"opacity",null),material_ts_decorate([R.serialze(),A.define("material.map")],Material.prototype,"map",null),Material=material_ts_decorate([R.register(["document","name","color","id"])],Material);let PhongMaterial=class PhongMaterial extends Material{get specular(){return this.getPrivateValue("specular",1118481)}set specular(e){this.setProperty("specular",e)}get shininess(){return this.getPrivateValue("shininess",30)}set shininess(e){this.setProperty("shininess",e)}get emissive(){return this.getPrivateValue("emissive",0)}set emissive(e){this.setProperty("emissive",e)}get specularMap(){return this.getPrivateValue("specularMap",new Texture(this.document))}set specularMap(e){this.setProperty("specularMap",e)}get bumpMap(){return this.getPrivateValue("bumpMap",new Texture(this.document))}set bumpMap(e){this.setProperty("bumpMap",e)}get normalMap(){return this.getPrivateValue("normalMap",new Texture(this.document))}set normalMap(e){this.setProperty("normalMap",e)}get emissiveMap(){return this.getPrivateValue("emissiveMap",new Texture(this.document))}set emissiveMap(e){this.setProperty("emissiveMap",e)}};material_ts_decorate([R.serialze(),A.define("material.specular",{type:"color"})],PhongMaterial.prototype,"specular",null),material_ts_decorate([R.serialze(),A.define("material.shininess")],PhongMaterial.prototype,"shininess",null),material_ts_decorate([R.serialze(),A.define("material.emissive",{type:"color"})],PhongMaterial.prototype,"emissive",null),material_ts_decorate([R.serialze(),A.define("material.specularMap")],PhongMaterial.prototype,"specularMap",null),material_ts_decorate([R.serialze(),A.define("material.bumpMap")],PhongMaterial.prototype,"bumpMap",null),material_ts_decorate([R.serialze(),A.define("material.normalMap")],PhongMaterial.prototype,"normalMap",null),material_ts_decorate([R.serialze(),A.define("material.emissiveMap")],PhongMaterial.prototype,"emissiveMap",null),PhongMaterial=material_ts_decorate([R.register(["document","name","color","id"])],PhongMaterial);let PhysicalMaterial=class PhysicalMaterial extends Material{get metalness(){return this.getPrivateValue("metalness",0)}set metalness(e){this.setProperty("metalness",e)}get metalnessMap(){return this.getPrivateValue("metalnessMap",new Texture(this.document))}set metalnessMap(e){this.setProperty("metalnessMap",e)}get roughness(){return this.getPrivateValue("roughness",1)}set roughness(e){this.setProperty("roughness",e)}get roughnessMap(){return this.getPrivateValue("roughnessMap",new Texture(this.document))}set roughnessMap(e){this.setProperty("roughnessMap",e)}get emissive(){return this.getPrivateValue("emissive",0)}set emissive(e){this.setProperty("emissive",e)}get bumpMap(){return this.getPrivateValue("bumpMap",new Texture(this.document))}set bumpMap(e){this.setProperty("bumpMap",e)}get normalMap(){return this.getPrivateValue("normalMap",new Texture(this.document))}set normalMap(e){this.setProperty("normalMap",e)}get emissiveMap(){return this.getPrivateValue("emissiveMap",new Texture(this.document))}set emissiveMap(e){this.setProperty("emissiveMap",e)}};material_ts_decorate([R.serialze(),A.define("material.metalness")],PhysicalMaterial.prototype,"metalness",null),material_ts_decorate([R.serialze(),A.define("material.metalnessMap")],PhysicalMaterial.prototype,"metalnessMap",null),material_ts_decorate([R.serialze(),A.define("material.roughness")],PhysicalMaterial.prototype,"roughness",null),material_ts_decorate([R.serialze(),A.define("material.roughnessMap")],PhysicalMaterial.prototype,"roughnessMap",null),material_ts_decorate([R.serialze(),A.define("material.emissive",{type:"color"})],PhysicalMaterial.prototype,"emissive",null),material_ts_decorate([R.serialze(),A.define("material.bumpMap")],PhysicalMaterial.prototype,"bumpMap",null),material_ts_decorate([R.serialze(),A.define("material.normalMap")],PhysicalMaterial.prototype,"normalMap",null),material_ts_decorate([R.serialze(),A.define("material.emissiveMap")],PhysicalMaterial.prototype,"emissiveMap",null),PhysicalMaterial=material_ts_decorate([R.register(["document","name","color","id"])],PhysicalMaterial);var eP=r(8715);function node_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}(X||(X={})).isLinkedListNode=function(e){return void 0!==e.add};let Node=class Node extends HistoryObservable{parent;previousSibling;nextSibling;id;constructor(e,t,r){super(e),this.id=r,this.setPrivateValue("name",t||"untitled")}get name(){return this.getPrivateValue("name")}set name(e){this.setProperty("name",e)}get visible(){return this.getPrivateValue("visible",!0)}set visible(e){this.setProperty("visible",e,()=>this.onVisibleChanged())}get parentVisible(){return this.getPrivateValue("parentVisible",!0)}set parentVisible(e){this.setProperty("parentVisible",e,()=>this.onParentVisibleChanged())}disposeInternal(){this.document.visual.context.removeNode([this]),super.disposeInternal()}clone(){let e=R.serializeObject(this);e.properties.id=Id.generate(),e.properties.name=`${this.name}_copy`;let t=R.deserializeObject(this.document,e);return this.parent?.add(t),t}};node_ts_decorate([R.serialze()],Node.prototype,"id",void 0),node_ts_decorate([R.serialze(),A.define("common.name")],Node.prototype,"name",null),node_ts_decorate([R.serialze()],Node.prototype,"visible",null),function(e){function getNodesFromPath(e,t,r,i){nodeOrChildrenAppendToNodes(e,t[0]),path1ToCommonNodes(e,t,i),commonToPath2Nodes(e,t,r,i)}function path1ToCommonNodes(t,r,i){for(let a=0;a<r.length-i;a++){let i=r[a].nextSibling;for(;void 0!==i;)e.nodeOrChildrenAppendToNodes(t,i),i=i.nextSibling}}function commonToPath2Nodes(t,r,i,a){let s=r.at(-a)?.nextSibling;for(;s;){if(s===i[0])return void t.push(i[0]);if(e.isLinkedListNode(s)){if(getNodesFromParentToChild(t,s,i[0]))return}else t.push(s);s=s.nextSibling}}function nodeOrChildrenAppendToNodes(t,r){e.isLinkedListNode(r)?getNodesFromParentToChild(t,r):t.push(r)}function containsDescendant(e,t){return void 0!==t.parent&&(!!e.has(t.parent)||containsDescendant(e,t.parent))}function getNodesFromParentToChild(t,r,i){t.push(r);let a=r.firstChild;for(;void 0!==a;){if(i===a)return t.push(a),!0;if(e.isLinkedListNode(a)){if(getNodesFromParentToChild(t,a,i))return!0}else t.push(a);a=a.nextSibling}return!1}function currentAtBack(e,t){for(;void 0!==e.nextSibling;){if(e.nextSibling===t)return!0;e=e.nextSibling}return!1}function getCommonParentIndex(e,t){let r=1;for(;r<=Math.min(e.length,t.length)&&e.at(-r)===t.at(-r);r++);if(e.at(1-r)!==t.at(1-r))throw Error("can not find a common parent");return r}function getPathToRoot(e){let t=[],r=e;for(;void 0!==r;)t.push(r),r=r.parent;return t}e.getNodesBetween=function(e,t){if(e===t)return[e];let r=[],i=getPathToRoot(e),a=getPathToRoot(t),s=getCommonParentIndex(i,a),n=i.at(1-s);if(n===a[0]||n===i[0]){let e=n===a[0]?i[0]:a[0];getNodesFromParentToChild(r,n,e)}else currentAtBack(i.at(-s),a.at(-s))?getNodesFromPath(r,i,a,s):getNodesFromPath(r,a,i,s);return r},e.nodeOrChildrenAppendToNodes=nodeOrChildrenAppendToNodes,e.findTopLevelNodes=function(e){let t=[];for(let r of e)containsDescendant(e,r)||t.push(r);return t},e.containsDescendant=containsDescendant}(X||(X={}));var eb=q||(q={});function serializeNodeToArray(e,t,r){let i=R.serializeObject(t);return r&&(i.parentId=r),e.push(i),X.isLinkedListNode(t)&&t.firstChild&&serializeNodeToArray(e,t.firstChild,t.id),t.nextSibling&&serializeNodeToArray(e,t.nextSibling,r),e}function visualNode_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}eb.serialize=function(e){let t=[];return serializeNodeToArray(t,e,void 0),t},eb.deserialize=async function(e,t){let r=new Map;return t.forEach(t=>{let i=R.deserializeObject(e,t);X.isLinkedListNode(i)&&r.set(t.properties.id,i);let a=t.parentId;a&&(r.has(a)?r.get(a).add(i):console.warn("parent not found: "+a))}),Promise.resolve(r.get(t[0].properties.id))};let VisualNode=class VisualNode extends Node{get transform(){return this.getPrivateValue("transform",Matrix4.identity())}set transform(e){this.setProperty("transform",e,void 0,{equals:(e,t)=>e.equals(t)})}worldTransform(){let e=this.document.visual.context.getVisual(this);return e?e.worldTransform():this.transform}onVisibleChanged(){this.document.visual.context.setVisible(this,this.visible&&this.parentVisible)}onParentVisibleChanged(){this.document.visual.context.setVisible(this,this.visible&&this.parentVisible)}};function meshNode_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}visualNode_ts_decorate([R.serialze()],VisualNode.prototype,"transform",null);let MeshNode=class MeshNode extends VisualNode{display(){return"body.meshNode"}get materialId(){return this.getPrivateValue("materialId")}set materialId(e){this.setProperty("materialId",e)}_mesh;get mesh(){return this._mesh}set mesh(e){this.setProperty("mesh",e)}constructor(e,t,r,i,a=Id.generate()){super(e,r,a),this._mesh=t,this.setPrivateValue("materialId",i??e.materials.at(0)?.id??"")}boundingBox(){let e=this.transform.ofPoints(this.mesh.position);return BoundingBox.fromNumbers(e)}};function geometryNode_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}meshNode_ts_decorate([R.serialze(),A.define("common.material",{type:"materialId"})],MeshNode.prototype,"materialId",null),meshNode_ts_decorate([R.serialze()],MeshNode.prototype,"mesh",null),MeshNode=meshNode_ts_decorate([R.register(["document","mesh","name","id"])],MeshNode);let FaceMaterialPair=class FaceMaterialPair{faceIndex;materialIndex;constructor(e,t){this.faceIndex=e,this.materialIndex=t}};geometryNode_ts_decorate([R.serialze()],FaceMaterialPair.prototype,"faceIndex",void 0),geometryNode_ts_decorate([R.serialze()],FaceMaterialPair.prototype,"materialIndex",void 0),FaceMaterialPair=geometryNode_ts_decorate([R.register(["faceIndex","materialIndex"])],FaceMaterialPair);let GeometryNode=class GeometryNode extends VisualNode{get materialId(){return this.getPrivateValue("materialId")}set materialId(e){this.setProperty("materialId",e)}_originFaceMesh;get faceMaterialPair(){return this.getPrivateValue("faceMaterialPair",[])}set faceMaterialPair(e){let t=Array.isArray(this.materialId)?[...this.materialId]:this.materialId,r=[...this.faceMaterialPair];this.setProperty("faceMaterialPair",e,()=>this.updateVisual(t,r))}constructor(e,t,r,i=Id.generate()){super(e,t,i),this.setPrivateValue("materialId",r??e.materials.at(0)?.id??"")}_mesh;get mesh(){return this._mesh??=this.createMesh(),this._mesh}boundingBox(){let e=this.mesh.faces?.position;if(e&&0!==e.length||(e=this.mesh.edges?.position),e&&0!==e.length)return BoundingBox.fromNumbers(this.transform.ofPoints(e))}disposeInternal(){super.disposeInternal(),this._mesh=void 0}copyOldValue(){let e=Array.isArray(this.materialId)?[...this.materialId]:this.materialId;return{oldFacePair:[...this.faceMaterialPair],oldMaterial:e}}addFaceMaterial(e){let{oldFacePair:t,oldMaterial:r}=this.copyOldValue();e.forEach(({faceIndex:e,materialId:t})=>{if(this.materialId===t)return;if(this._mesh?.faces?.range.length===1)return void this.setPrivateValue("materialId",t);"string"==typeof this.materialId&&this.setPrivateValue("materialId",[this.materialId,t]);let r=this.materialId.indexOf(t);-1===r?(this.materialId.push(t),this.faceMaterialPair.push(new FaceMaterialPair(e,this.materialId.length-1))):this.faceMaterialPair.push(new FaceMaterialPair(e,r))}),this.updateVisual(r,t)}removeFaceMaterial(e){let{oldFacePair:t,oldMaterial:r}=this.copyOldValue(),i=this.faceMaterialPair.filter(t=>e.includes(t.faceIndex));this.setPrivateValue("faceMaterialPair",this.faceMaterialPair.filter(t=>!e.includes(t.faceIndex))),i.forEach(e=>{!this.faceMaterialPair.some(t=>t.materialIndex===e.materialIndex)&&Array.isArray(this.materialId)&&(this.materialId.splice(e.materialIndex,1),1===this.materialId.length?this.setPrivateValue("materialId",this.materialId[0]):this.materialId.length>1&&this.faceMaterialPair.forEach(t=>{t.materialIndex>e.materialIndex&&t.materialIndex--}))}),this.updateVisual(r,t)}clearFaceMaterial(){let{oldFacePair:e,oldMaterial:t}=this.copyOldValue();Array.isArray(this.materialId)&&this.setPrivateValue("materialId",this.materialId[0]),this.setPrivateValue("faceMaterialPair",[]),this.updateVisual(t,e)}updateVisual=(e,t)=>{if(!this._originFaceMesh)return;0===this.faceMaterialPair.length?this._mesh.faces=this._originFaceMesh:(this._mesh.faces=eP.j.mergeFaceMesh(this._originFaceMesh,this.faceMaterialPair.map(e=>[e.faceIndex,e.materialIndex])),1===this._mesh.faces.groups.length&&this.setPrivateValue("materialId",this.materialId[this.faceMaterialPair[0].materialIndex])),this.emitPropertyChanged("materialId",e),this.emitPropertyChanged("faceMaterialPair",t);let r=Array.isArray(this.materialId)?[...this.materialId]:this.materialId;Transaction.add(this.document,new PropertyHistoryRecord(this,"materialId",e,r)),Transaction.add(this.document,new PropertyHistoryRecord(this,"faceMaterialPair",t,[...this.faceMaterialPair])),this.document.visual.context.redrawNode([this])}};function shapeNode_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}geometryNode_ts_decorate([R.serialze(),A.define("common.material",{type:"materialId"})],GeometryNode.prototype,"materialId",null),geometryNode_ts_decorate([R.serialze()],GeometryNode.prototype,"faceMaterialPair",null);let ShapeNode=class ShapeNode extends GeometryNode{_shape=Result.err(ew);get shape(){return this._shape}setShape(e){if(this._shape.isOk&&this._shape.value.isEqual(e.value))return;if(!e.isOk)return void PubSub.default.pub("displayError",e.error);let t=this._shape;this._shape=e,this._mesh=void 0,this.emitPropertyChanged("shape",t),t.unchecked()?.dispose()}createMesh(){if(!this.shape.isOk)throw Error(this.shape.error);let e=this.shape.value.mesh;return this._originFaceMesh=e.faces,e.faces&&(e.faces=eP.j.mergeFaceMesh(e.faces,this.faceMaterialPair.map(e=>[e.faceIndex,e.materialIndex]))),e}disposeInternal(){super.disposeInternal(),this._shape.unchecked()?.dispose(),this._shape=null}};let MultiShapeMesh=class MultiShapeMesh{_edges;_faces;get edges(){return this._edges.position.length>0?this._edges:void 0}get faces(){return this._faces.position.length>0?this._faces:void 0}constructor(){this._edges={lineType:eg.Solid,position:new Float32Array,range:[],color:eo.defaultEdgeColor},this._faces={index:new Uint32Array,normal:new Float32Array,position:new Float32Array,uv:new Float32Array,range:[],groups:[],color:eo.defaultFaceColor}}addShape(e,t){let r=e.mesh,i=e.matrix.multiply(t);r.faces&&eP.j.combineFaceMeshData(this._faces,r.faces,i),r.edges&&eP.j.combineEdgeMeshData(this._edges,r.edges,i)}};let MultiShapeNode=class MultiShapeNode extends GeometryNode{_shapes;get shapes(){return this._shapes}constructor(e,t,r,i,a=Id.generate()){super(e,t,i,a),this._shapes=r}createMesh(){let e=new MultiShapeMesh;return this._shapes.forEach(t=>{e.addShape(t,Matrix4.identity())}),e}display(){return"body.multiShape"}};shapeNode_ts_decorate([R.serialze()],MultiShapeNode.prototype,"shapes",null),MultiShapeNode=shapeNode_ts_decorate([R.register(["document","name","shapes","materialId","id"])],MultiShapeNode);let ew="Shape not initialized";let ParameterShapeNode=class ParameterShapeNode extends ShapeNode{get shape(){return this._shape.isOk||this._shape.error!==ew||(this._shape=this.generateShape()),this._shape}setPropertyEmitShapeChanged(e,t,r,i){return!!this.setProperty(e,t,r,i)&&(this.setShape(this.generateShape()),!0)}constructor(e,t,r){super(e,void 0,t,r),this.setPrivateValue("name",V.translate(this.display()))}};let EditableShapeNode=class EditableShapeNode extends ShapeNode{display(){return"body.editableShape"}get shape(){return this._shape}set shape(e){this.setShape(e)}constructor(e,t,r,i,a){super(e,t,i,a),this._shape=r instanceof Result?r:Result.ok(r)}};function component_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}function createComponentMesh(e){return{faceMaterials:[],edge:{lineType:eg.Solid,position:new Float32Array(3*e.edge),range:[]},face:{index:new Uint32Array(e.faceIndex),normal:new Float32Array(3*e.facePosition),position:new Float32Array(3*e.facePosition),uv:new Float32Array(2*e.facePosition),range:[],groups:[]},linesegments:Mesh.createLineSegments(e.lineSegment),surfaceMaterials:[],surface:Mesh.createSurface(e.meshPosition,e.meshIndex>0?e.meshIndex:3*e.meshPosition)}}function createComponentSize(){return{facePosition:0,faceIndex:0,edge:0,lineSegment:0,meshIndex:0,meshPosition:0}}shapeNode_ts_decorate([R.serialze()],EditableShapeNode.prototype,"shape",null),EditableShapeNode=shapeNode_ts_decorate([R.register(["document","name","shape","materialId","id"])],EditableShapeNode);let Component=class Component{_nodes;get nodes(){return this._nodes}_name;get name(){return this._name}id;_origin;get origin(){return this._origin}set origin(e){this._origin=e}_boundingBox;get boundingBox(){return this._boundingBox??=this.computeBoundingBox(),this._boundingBox}_mesh;get mesh(){return this._mesh??=this.mergeMesh(),this._mesh}instances=[];constructor(e,t,r,i=Id.generate()){this._name=e,this._nodes=t,this.id=i,this._origin=r??BoundingBox.center(this.boundingBox)}toString(){return this.name}mergeMesh(){let e=createComponentSize();this.getSize(this._nodes,e);let t=createComponentMesh(e),r=createComponentSize(),i=[];return this.mergeNodesMesh(t,i,this._nodes,Matrix4.identity(),r),t.face=eP.j.mergeFaceMesh(t.face,i),t}getSize(e,t){for(let r of e)if(r instanceof ShapeNode&&r.shape.isOk){let e=r.shape.value.mesh;e.faces&&(t.facePosition+=e.faces.position.length/3,t.faceIndex+=e.faces.index.length),e.edges&&(t.edge+=e.edges.position.length/3)}else r instanceof MeshNode?(t.meshPosition+=r.mesh.position.length/3,"surface"===r.mesh.meshType&&(t.meshIndex+=r.mesh.index?.length??0)):r instanceof ComponentNode&&this.getSize(r.component.nodes,t)}mergeNodesMesh=(e,t,r,i,a)=>{for(let s of r){let r=s.transform.multiply(i);s instanceof ShapeNode&&s.shape.isOk?this.mergeShapeNode(e,t,s,r,a):s instanceof ComponentNode?this.mergeNodesMesh(e,t,s.component.nodes,r,a):s instanceof MeshNode?this.mergeMeshNode(e,s,r,a):console.log(`****** to do merge MeshNode ******: ${Object.prototype.toString.call(s)}`)}};mergeShapeNode(e,t,r,i,a){let s=r.shape.value.mesh;s.edges&&(eP.j.setEdgeMeshData(e.edge,s.edges,i,a.edge),a.edge+=s.edges.position.length/3),s.faces&&(this.mergeFaceMaterial(r,e,t),eP.j.setFaceMeshData(e.face,s.faces,i,a),a.facePosition+=s.faces.position.length/3,a.faceIndex+=s.faces.index.length)}mergeFaceMaterial(e,t,r){let i=this.mapOldNewMaterialIndex(e.materialId,t.faceMaterials),a=new Map(e.faceMaterialPair.map(e=>[e.faceIndex,e.materialIndex]));e.mesh.faces?.range.forEach((e,s)=>{a.has(s)||r.push([s+t.face.range.length,i.get(0)])}),e.faceMaterialPair.forEach(e=>{r.push([e.faceIndex+t.face.range.length,i.get(e.materialIndex)])})}mergeMeshNode(e,t,r,i){if("surface"===t.mesh.meshType){let a=this.mapOldNewMaterialIndex(t.materialId,e.surfaceMaterials);eP.j.setSurfaceMeshData(e.surface,t.mesh,r,i,a),i.meshPosition+=t.mesh.position.length/3,t.mesh.index?.length&&(i.meshIndex+=t.mesh.index.length)}else"linesegments"===t.mesh.meshType&&(e.linesegments.position?.set(r.ofPoints(t.mesh.position),3*i.lineSegment),i.lineSegment+=t.mesh.position.length/3)}mapOldNewMaterialIndex(e,t){let r=new Map,i=Array.isArray(e)?e:[e];for(let e=0;e<i.length;e++){let a=t.indexOf(i[e]);-1===a?(t.push(i[e]),r.set(e,t.length-1)):r.set(e,a)}return r}computeBoundingBox(){if(0===this._nodes.length)return;let e=this._nodes[0].boundingBox();for(let t=1;t<this._nodes.length;t++)e=BoundingBox.combine(e,this._nodes[t].boundingBox());return e}};component_ts_decorate([R.serialze()],Component.prototype,"nodes",null),component_ts_decorate([R.serialze()],Component.prototype,"name",null),component_ts_decorate([R.serialze()],Component.prototype,"id",void 0),component_ts_decorate([R.serialze()],Component.prototype,"origin",null),Component=component_ts_decorate([R.register(["name","nodes","origin","id"])],Component);let ComponentNode=class ComponentNode extends VisualNode{display(){return"body.group"}boundingBox(){if(this.component.boundingBox)return BoundingBox.transformed(this.component.boundingBox,this.transform)}_component;get component(){if(!this._component){if(this._component=this.document.components.find(e=>e.id===this.componentId),!this._component)throw Error(`Component ${this.componentId} not found`);this._component.instances.push(this)}return this._component}componentId;insert;constructor(e,t,r,i,a=Id.generate()){super(e,t,a),this.componentId=r,this.insert=i}};function facebaseNode_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}component_ts_decorate([A.define("body.group")],ComponentNode.prototype,"component",null),component_ts_decorate([R.serialze()],ComponentNode.prototype,"componentId",void 0),component_ts_decorate([R.serialze()],ComponentNode.prototype,"insert",void 0),ComponentNode=component_ts_decorate([R.register(["document","name","componentId","insert","id"])],ComponentNode);let FacebaseNode=class FacebaseNode extends ParameterShapeNode{get isFace(){return this.getPrivateValue("isFace",!1)}set isFace(e){this.setProperty("isFace",e)}};function folderNode_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}facebaseNode_ts_decorate([R.serialze(),A.define("option.command.isFace")],FacebaseNode.prototype,"isFace",null);let FolderNode=class FolderNode extends Node{_count=0;_firstChild;_lastChild;get firstChild(){return this._firstChild}get lastChild(){return this._lastChild}get count(){return this._count}size(){return this._count}constructor(e,t,r=Id.generate()){super(e,t,r)}add(...e){let t=e.map(e=>({action:K.add,node:e,oldParent:void 0,oldPrevious:void 0,newParent:this,newPrevious:this._lastChild}));e.forEach(e=>{this.initNode(e)&&this.addToLast(e),this._count++}),this.document.notifyNodeChanged(t)}initNode(e){return e.parent=this,e.parentVisible=this.visible&&this.parentVisible,!!this._firstChild||(this._firstChild=this._lastChild=e,e.previousSibling=e.nextSibling=void 0,!1)}addToLast(e){this._lastChild.nextSibling=e,e.previousSibling=this._lastChild,e.nextSibling=void 0,this._lastChild=e}children(){let e=[],t=this._firstChild;for(;t;)e.push(t),t=t.nextSibling;return e}remove(...e){let t=e.filter(e=>this.validateChild(e)).map(e=>({action:K.remove,node:e,newParent:void 0,newPrevious:void 0,oldParent:this,oldPrevious:e.previousSibling}));t.forEach(e=>this.removeNode(e.node,!0)),this.document.notifyNodeChanged(t)}transfer(...e){let t=e.filter(e=>this.validateChild(e)).map(e=>({action:K.transfer,node:e,newParent:void 0,newPrevious:void 0,oldParent:this,oldPrevious:e.previousSibling}));t.forEach(e=>this.removeNode(e.node,!0)),this.document.notifyNodeChanged(t)}validateChild(e){return e.parent===this||(Logger.warn(`${e.name} is not a child node of the ${this.name} node`),!1)}removeNode(e,t){t&&(e.parent=void 0,e.parentVisible=!0),e===this._firstChild?this.removeFirstNode(e):e===this._lastChild?this.removeLastNode(e):this.removeMiddleNode(e),this._count--}removeFirstNode(e){e===this._lastChild?this._firstChild=this._lastChild=void 0:(this._firstChild=e.nextSibling,this._firstChild.previousSibling=void 0,e.nextSibling=void 0)}removeLastNode(e){this._lastChild=e.previousSibling,this._lastChild.nextSibling=void 0,e.previousSibling=void 0}removeMiddleNode(e){e.previousSibling.nextSibling=e.nextSibling,e.nextSibling.previousSibling=e.previousSibling,e.previousSibling=e.nextSibling=void 0}insertBefore(e,t){if(e&&!this.validateChild(e))return;let r={action:K.insertBefore,node:t,oldParent:void 0,oldPrevious:void 0,newParent:this,newPrevious:e?.previousSibling};this.initNode(t)&&(e&&e!==this._firstChild?this.insertBetweenNodes(e.previousSibling,t,e):this.insertAsFirst(t)),this._count++,this.document.notifyNodeChanged([r])}insertAsFirst(e){this._firstChild.previousSibling=e,e.nextSibling=this._firstChild,this._firstChild=e}insertBetweenNodes(e,t,r){e.nextSibling=t,t.previousSibling=e,t.nextSibling=r,r.previousSibling=t}insertAfter(e,t){if(e&&!this.validateChild(e))return;let r={action:K.insertAfter,oldParent:void 0,oldPrevious:void 0,newParent:this,newPrevious:e,node:t};this.initNode(t)&&(e?e===this._lastChild?this.addToLast(t):this.insertBetweenNodes(e,t,e.nextSibling):this.insertAsFirst(t)),this._count++,this.document.notifyNodeChanged([r])}move(e,t,r){if(r&&r.parent!==t)return void Logger.warn(`${r.name} is not a child node of the ${t.name} node`);let i={action:K.move,oldParent:e.parent,oldPrevious:e.previousSibling,newParent:t,newPrevious:r,node:e};this.removeNode(e,!1),t.initNode(e)&&(r?r===t._lastChild?t.addToLast(e):t.insertBetweenNodes(r,e,r.nextSibling):t.insertAsFirst(e)),t._count++,this.document.notifyNodeChanged([i])}disposeInternal(){this.disposeNodes(this._firstChild),super.disposeInternal()}disposeNodes=e=>{e instanceof FolderNode&&this.disposeNodes(e.firstChild);let t=e?.nextSibling;for(e&&(e.nextSibling=null);t;){let e=t.nextSibling;t.previousSibling=null,t.nextSibling=null,t.dispose(),t=e}e?.dispose()};onVisibleChanged(){this.setChildrenParentVisible()}onParentVisibleChanged(){this.setChildrenParentVisible()}setChildrenParentVisible(){let e=this._firstChild;for(;void 0!==e;)e.parentVisible=this.visible&&this.parentVisible,e=e.nextSibling}};function groupNode_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}FolderNode=folderNode_ts_decorate([R.register(["document","name","id"])],FolderNode);let GroupNode=class GroupNode extends FolderNode{get transform(){return this.getPrivateValue("transform",Matrix4.identity())}set transform(e){this.setProperty("transform",e,void 0,{equals:(e,t)=>e.equals(t)})}};groupNode_ts_decorate([R.serialze()],GroupNode.prototype,"transform",null),GroupNode=groupNode_ts_decorate([R.register(["document","name","id"])],GroupNode);let ShapeNodeFilter=class ShapeNodeFilter{shapeFilter;constructor(e){this.shapeFilter=e}allow(e){return e instanceof ShapeNode&&(!this.shapeFilter||!e.shape.isOk||this.shapeFilter.allow(e.shape.value))}};var eS=((C={})[C.large=0]="large",C[C.small=1]="small",C);let Combobox=class Combobox extends Observable{converter;constructor(e){super(),this.converter=e,this.items=new ObservableCollection}get selectedIndex(){return this.getPrivateValue("selectedIndex",0)}set selectedIndex(e){e<0||e>=this.items.length||this.setProperty("selectedIndex",e)}get selectedItem(){return this.items.at(this.selectedIndex)}items};var eC=((D={})[D.ok=0]="ok",D[D.cancel=1]="cancel",D);function act_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let Act=class Act extends Observable{get name(){return this.getPrivateValue("name")}set name(e){this.setProperty("name",e)}get cameraPosition(){return this.getPrivateValue("cameraPosition")}set cameraPosition(e){this.setProperty("cameraPosition",e)}get cameraTarget(){return this.getPrivateValue("cameraTarget")}set cameraTarget(e){this.setProperty("cameraTarget",e)}get cameraUp(){return this.getPrivateValue("cameraUp")}set cameraUp(e){this.setProperty("cameraUp",e)}static fromView(e,t){return new Act(t,e.cameraController.cameraPosition,e.cameraController.cameraTarget,e.cameraController.cameraUp)}constructor(e,t,r,i){super(),this.setPrivateValue("name",e),this.setPrivateValue("cameraPosition",t),this.setPrivateValue("cameraTarget",r),this.setPrivateValue("cameraUp",i)}};act_ts_decorate([R.serialze()],Act.prototype,"name",null),act_ts_decorate([R.serialze()],Act.prototype,"cameraPosition",null),act_ts_decorate([R.serialze()],Act.prototype,"cameraTarget",null),act_ts_decorate([R.serialze()],Act.prototype,"cameraUp",null),Act=act_ts_decorate([R.register(["name","cameraPosition","cameraTarget","cameraUp"])],Act);var eD=((k={})[k.solid=0]="solid",k[k.wireframe=1]="wireframe",k[k.solidAndWireframe=2]="solidAndWireframe",k);(Z||(Z={})).screenDistance=function(e,t,r,i){let a=e.worldToScreen(i),s=a.x-t,n=a.y-r;return Math.sqrt(s*s+n*n)},($||($={})).isGeometry=function(e){return void 0!==e.geometryNode};var ek=((M={})[M.normal=0]="normal",M[M.edgeHighlight=1]="edgeHighlight",M[M.edgeSelected=2]="edgeSelected",M[M.faceTransparent=4]="faceTransparent",M);(T=ek||(ek={})).addState=function(e,t){return e|t},T.removeState=function(e,t){return e&t^e},T.hasState=function(e,t){return(e&t)===t}},8715:function(e,t,r){r.d(t,{S:()=>GeoUtils,j:()=>MeshUtils});var i=r(8909);let MeshUtils=class MeshUtils{static setFaceMeshData(e,t,r,i){t&&(e.range=e.range.concat(t.range.map(e=>({start:e.start+i.faceIndex,shape:e.shape,count:e.count,transform:r}))),e.index.set(t.index.map(e=>e+i.facePosition),i.faceIndex),e.position.set(r.ofPoints(t.position),3*i.facePosition),e.normal.set(r.ofVectors(t.normal),3*i.facePosition),e.uv.set(t.uv,2*i.facePosition))}static setSurfaceMeshData(e,t,r,i,a){t.groups.forEach(t=>{e.groups.push({start:t.start+i.meshIndex,count:t.count,materialIndex:a.get(t.materialIndex)})}),e.index&&t.index&&e.index.set(t.index.map(e=>e+i.meshPosition),i.meshIndex),e.position&&t.position&&e.position.set(r.ofPoints(t.position),3*i.meshPosition),e.normal&&t.normal&&e.normal.set(r.ofVectors(t.normal),3*i.meshPosition),e.uv&&t.uv&&e.uv.set(t.uv,2*i.meshPosition)}static combineFaceMeshData(e,t,r){t&&(e.range=e.range.concat(t.range.map(t=>({start:t.start+e.index.length,shape:t.shape,count:t.count,transform:r}))),e.index=(0,i.lx)([e.index,t.index.map(t=>t+e.position.length/3)]),e.position=this.concatFloat32Array(e.position,r.ofPoints(t.position)),e.normal=this.concatFloat32Array(e.normal,r.ofVectors(t.normal)),e.uv=this.concatFloat32Array(e.uv,t.uv))}static concatFloat32Array(e,t){let r=new Float32Array(e.length+t.length);return r.set(e),r.set(t,e.length),r}static setEdgeMeshData(e,t,r,i){t&&(e.position.set(r.ofPoints(t.position),3*i),e.range=e.range.concat(t.range.map(e=>({transform:r,start:e.start+i,shape:e.shape,count:e.count}))))}static combineEdgeMeshData(e,t,r){if(!t)return;let i=e.position.length/3;e.position=this.concatFloat32Array(e.position,r.ofPoints(t.position)),e.range=e.range.concat(t.range.map(e=>({start:e.start+i,shape:e.shape,count:e.count,transform:r})))}static mergeFaceMesh(e,t){if(0===t.length)return e;let r=new Map(t);for(let t=0;t<e.range.length;t++)r.has(t)||r.set(t,0);return this.mergeFaceMeshWithMap(e,r)}static mergeFaceMeshWithMap(e,t){let r={position:new Float32Array(e.position.length),normal:new Float32Array(e.normal.length),uv:new Float32Array(e.uv.length),index:new Uint32Array(e.index.length),range:[],color:e.color,groups:[]},i={facePosition:0,faceIndex:0},a=Object.groupBy(t,e=>e[1]);for(let t of Object.keys(a)){let s=parseInt(t),n=i.faceIndex;MeshUtils.mergeSameGroup(a[s],e,r,i),r.groups.push({start:n,count:i.faceIndex-n,materialIndex:s})}return r}static mergeSameGroup(e,t,r,a){for(let s of e){let{start:e,count:n,shape:o,transform:l}=t.range[s[0]],c=t.index.slice(e,e+n),{min:d,max:p}=i.M8.minMax(c);r.position.set(t.position.slice(3*d,(p+1)*3),3*a.facePosition),r.normal.set(t.normal.slice(3*d,(p+1)*3),3*a.facePosition),r.uv.set(t.uv.slice(2*d,(p+1)*2),2*a.facePosition),r.index.set(c.map(e=>e-d+a.facePosition),a.faceIndex),r.range.push({start:a.faceIndex,count:n,shape:o,transform:l}),a.facePosition+=p-d+1,a.faceIndex+=c.length}}static subFace(e,t){let r=e?.range[t];if(!r)return;let a=e.index.slice(r.start,r.start+r.count),{min:s,max:n}=i.M8.minMax(a),[o,l]=[s,n+1];return{position:e.position.slice(3*o,3*l),normal:e.normal.slice(3*o,3*l),index:a.map(e=>e-o),uv:e.uv.slice(2*o,2*l),range:[],color:e.color,groups:[]}}static subFaceOutlines(e,t){let r=this.subFace(e,t);if(r)return this.faceOutline(r)}static addEdge(e,t,r,i){let a=r<i?`${r}_${i}`:`${i}_${r}`,s=e.get(a);if(s)s.count++;else{let s=[...t.position.slice(3*r,3*r+3),...t.position.slice(3*i,3*i+3)];e.set(a,{count:1,points:s})}}static faceOutline(e){let t=new Map;for(let r=0;r<e.index.length;r+=3)this.addEdge(t,e,e.index[r],e.index[r+1]),this.addEdge(t,e,e.index[r+1],e.index[r+2]),this.addEdge(t,e,e.index[r+2],e.index[r]);return new Float32Array(Array.from(t.values()).filter(e=>1===e.count).flatMap(e=>e.points))}static subEdge(e,t){let r=e?.range[t];if(r)return e.position.slice(3*r.start,(r.start+r.count)*3)}};let GeoUtils=class GeoUtils{static nearestPoint(e,t){let r,a=Number.MAX_VALUE;for(let s of e.findSubShapes(i.ax.Edge)){let e=s.curve.nearestFromPoint(t);e.distance<a&&(r={edge:s,point:e.point},a=e.distance)}return r}static curveNormal(e){if(i.DY.isTrimmed(e)&&(e=e.basisCurve),i.DY.isConic(e))return e.axis;let t=e.dn(0,1);return t.isParallelTo(i.vY.unitX)?i.vY.unitZ:t.cross(i.vY.unitX).normalize()}static wireNormal(e){let t,r=e.toFace();if(r.isOk)return r.value.normal(0,0)[1];for(let r of e.findSubShapes(i.ax.Edge)){t=r;break}return this.curveNormal(t.curve)}static findNextEdge(e,t){let r=t.curve,a=r.value(r.lastParameter());for(let r of e.findSubShapes(i.ax.Edge)){if(r.isEqual(t))continue;let e=r.curve;if(a.distanceTo(e.value(e.firstParameter()))<i.Gc.Distance||a.distanceTo(e.value(e.lastParameter()))<i.Gc.Distance)return i.x4.ok(r)}return i.x4.err("Cannot find next edge")}static normal(e){if(e.shapeType===i.ax.Face)return e.normal(0,0)[1];if(e.shapeType===i.ax.Edge){let t=e.curve;return this.curveNormal(t)}return this.wireNormal(e)}static intersects(e,t){let r=[];return t.forEach(t=>{let i=e.intersect(t);i.length>0&&r.push(...i)}),r}}},492:function(e,t,r){r.d(t,{zK:()=>SubshapeSelectionHandler,b3:()=>ViewUtils,t:()=>NodeSelectionHandler,k8:()=>ShapeSelectionHandler});var i=r(8909);let a=`
    border: 1px solid #55aaff;
    background-color: rgba(75, 160, 255, 0.3);
    position: absolute;
    pointer-events: none;
    display: none;
    left: 0px;
    right: 0px;
    width: 0px;
    height: 0px;
`;let SelectionHandler=class SelectionHandler{document;multiMode;controller;rect;showRect;mouse;pointerEventMap;constructor(e,t,r){this.document=e,this.multiMode=t,this.controller=r,this.showRect=!0,this.mouse={isDown:!1,x:0,y:0},this.pointerEventMap=new Map,this.#s=!1,this.dispose=()=>{this.#s||(this.#s=!0,this.disposeInternal())},r?.onCancelled(t=>{this.clearSelected(e),this.cleanHighlights()})}#s;dispose;disposeInternal(){this.pointerEventMap.clear()}pointerMove(e,t){4!==t.buttons&&(this.rect&&this.updateRect(this.rect,t),this.setHighlight(e,t))}pointerDown(e,t){t.preventDefault(),0===t.button&&t.isPrimary&&(this.mouse={isDown:!0,x:t.offsetX,y:t.offsetY},this.multiMode&&this.showRect&&(this.rect=this.initRect(t))),this.pointerEventMap.set(t.pointerId,t)}initRect(e){let t=document.createElement("div");return t.style.cssText=a,document.body.appendChild(t),{element:t,clientX:e.clientX,clientY:e.clientY}}updateRect(e,t){if(1!==this.pointerEventMap.size)return;e.element.style.display="block";let[r,i]=[Math.min(e.clientX,t.clientX),Math.min(e.clientY,t.clientY)],[a,s]=[Math.max(e.clientX,t.clientX),Math.max(e.clientY,t.clientY)];Object.assign(e.element.style,{left:`${r}px`,top:`${i}px`,width:`${a-r}px`,height:`${s-i}px`})}pointerOut(e,t){t.isPrimary&&(this.mouse.isDown=!1,this.removeRect(e),this.cleanHighlights()),this.pointerEventMap.delete(t.pointerId)}pointerUp(e,t){if(t.preventDefault(),this.mouse.isDown&&0===t.button&&t.isPrimary){this.mouse.isDown=!1,this.removeRect(e);let r=this.select(e,t);this.cleanHighlights(),e.update(),r>0&&!this.multiMode&&this.controller?.success()}this.pointerEventMap.delete(t.pointerId)}removeRect(e){this.rect?.element.remove(),this.rect=void 0}keyDown(e,t){"Escape"===t.key?(this.controller?this.controller.cancel():this.clearSelected(e.document.visual.document),this.cleanHighlights()):"Enter"===t.key?(this.cleanHighlights(),this.controller?.success()):"Tab"===t.key&&(t.preventDefault(),this.highlightNext(e))}};let NodeSelectionHandler=class NodeSelectionHandler extends SelectionHandler{filter;_highlights;_detectAtMouse;_lockDetected;nodes(){return this.document.selection.getSelectedNodes()}constructor(e,t,r,i){super(e,t,r),this.filter=i}select(e,t){if(!this._highlights?.length)return this.clearSelected(this.document),0;let r=this._highlights.map(t=>e.document.visual.context.getNode(t)).filter(e=>void 0!==e);return this.document.selection.setSelection(r,t.shiftKey),r.length}getDetecteds(e,t){if(this.rect&&Math.abs(this.mouse.x-t.offsetX)>3&&Math.abs(this.mouse.y-t.offsetY)>3)return e.detectVisualRect(this.mouse.x,this.mouse.y,t.offsetX,t.offsetY,this.filter);this._detectAtMouse=e.detectVisual(t.offsetX,t.offsetY,this.filter);let r=this.getDetecting();return r?[r]:[]}getDetecting(){if(!this._detectAtMouse)return;let e=this._lockDetected?this.getDetcedtingIndex():0;return this._detectAtMouse[e]||void 0}getDetcedtingIndex(){if(!this._detectAtMouse)return -1;for(let e=0;e<this._detectAtMouse.length;e++)if(this._lockDetected===this._detectAtMouse[e])return e;return -1}setHighlight(e,t){let r=this.getDetecteds(e,t);this.highlightDetecteds(e,r)}highlightDetecteds(e,t){this.cleanHighlights(),t.forEach(t=>{e.document.visual.highlighter.addState(t,i.tR.edgeHighlight,i.ax.Shape)}),this._highlights=t,e.update()}cleanHighlights(){this._highlights?.forEach(e=>{this.document.visual.highlighter.removeState(e,i.tR.edgeHighlight,i.ax.Shape)}),this._highlights=void 0}highlightNext(e){if(this._detectAtMouse&&this._detectAtMouse.length>1){let t=this._lockDetected?(this.getDetcedtingIndex()+1)%this._detectAtMouse.length:1;this._lockDetected=this._detectAtMouse[t];let r=this.getDetecting();r&&this.highlightDetecteds(e,[r])}}clearSelected(e){e.selection.clearSelection()}};let ShapeSelectionHandler=class ShapeSelectionHandler extends SelectionHandler{shapeType;filter;_highlights;_detectAtMouse;_lockDetected;constructor(e,t,r,i,a){super(e,r,i),this.shapeType=t,this.filter=a}getDetecteds(e,t){if(this.rect&&Math.abs(this.mouse.x-t.offsetX)>3&&Math.abs(this.mouse.y-t.offsetY)>3)return e.detectShapesRect(this.shapeType,this.mouse.x,this.mouse.y,t.offsetX,t.offsetY,this.filter);this._detectAtMouse=e.detectShapes(this.shapeType,t.offsetX,t.offsetY,this.filter);let r=this.getDetecting();return r?[r]:[]}setHighlight(e,t){let r=this.getDetecteds(e,t);this.highlightDetecteds(e,r)}highlightDetecteds(e,t){this.cleanHighlights(),t.forEach(t=>{e.document.visual.highlighter.addState(t.owner,i.tR.edgeHighlight,this.shapeType,...t.indexes)}),this._highlights=t,e.update()}cleanHighlights(){this._highlights?.forEach(e=>{e.owner.node.document.visual.highlighter.removeState(e.owner,i.tR.edgeHighlight,this.shapeType,...e.indexes)}),this._highlights=void 0}highlightNext(e){if(this._detectAtMouse&&this._detectAtMouse.length>1){let t=this._lockDetected?(this.getDetcedtingIndex()+1)%this._detectAtMouse.length:1;this._lockDetected=this._detectAtMouse[t].shape;let r=this.getDetecting();r&&this.highlightDetecteds(e,[r])}}getDetecting(){if(this._detectAtMouse){let e=this._lockDetected?this.getDetcedtingIndex():0;return this._detectAtMouse[e]}}getDetcedtingIndex(){return this._detectAtMouse?.findIndex(e=>this._lockDetected===e.shape)??-1}};let SubshapeSelectionHandler=class SubshapeSelectionHandler extends ShapeSelectionHandler{_shapes=new Map;selectedState=i.tR.edgeSelected;constructor(e,t,r,i,a){super(e,t,r,i,a),this.showRect=!1}shapes(){return[...this._shapes.values()]}clearSelected(e){for(let e of this._shapes.values())this.removeSelected(e);this._shapes.clear()}select(e,t){let r=e.document.visual.document;return this.multiMode?this._highlights?.forEach(e=>this._shapes.has(e.shape)?this.removeSelected(e):this.addSelected(e)):(this.clearSelected(r),this._highlights?.forEach(this.addSelected.bind(this))),this._shapes.size}removeSelected(e){this._shapes.delete(e.shape),e.owner.node.document.visual.highlighter.removeState(e.owner,this.selectedState,e.shape.shapeType,...e.indexes)}addSelected(e){e.owner.node.document.visual.highlighter.addState(e.owner,this.selectedState,this.shapeType,...e.indexes),this._shapes.set(e.shape,e)}};let ViewUtils=class ViewUtils{static rayFromEye(e,t){let r=e.cameraController.cameraPosition,a=t.sub(r);if("orthographic"!==e.cameraController.cameraType)return new i.zH(r,a);{let r=e.direction(),s=a.dot(r),n=t.sub(r.multiply(s));return new i.zH(n,r)}}static directionAt(e,t){if("orthographic"===e.cameraController.cameraType)return e.direction();{let r=e.cameraController.cameraPosition;return t.sub(r)}}static ensurePlane(e,t){let r=e.direction();if(Math.abs(r.dot(t.normal))<i.Gc.Float){let a=r.cross(e.up());return new i.JO(t.origin,r,a)}return t}static raycastClosestPlane(e,t,r){let a=e.direction();if(Math.abs(a.dot(e.workplane.normal))<i.Gc.Float){let r=a.cross(e.up());return new i.JO(t,a,r)}let s=ViewUtils.rayFromEye(e,r),n=[new i.JO(t,i.vY.unitZ,i.vY.unitX),new i.JO(t,i.vY.unitX,i.vY.unitY),new i.JO(t,i.vY.unitY,i.vY.unitZ)],o=n.map(e=>e.intersect(s)?.distanceTo(t)),l=[n[0],o[0]];for(let e=1;e<o.length;e++)void 0!==o[e]&&(void 0===l[1]||Math.abs(o[e])<Math.abs(l[1]))&&(l=[n[e],o[e]]);return l[0]}}},1530:function(e,t,r){let i;r.d(t,{Mx:()=>Application,NZ:()=>EditEventHandler,GX:()=>EditorService,VD:()=>CommandService,y1:()=>HotkeyService,av:()=>multistepCommand_MultistepCommand});var a,s,n,o=r(8909),l=r(492);let Selection=class Selection{document;_selectedNodes;_unselectedNodes;shapeType;shapeFilter;nodeFilter;constructor(e){this.document=e,this._selectedNodes=[],this._unselectedNodes=[],this.shapeType=o.ax.Shape,this.shapeNodeFilter=e=>{if(e instanceof o.EK){let t=e.shape.value;return!t||!this.shapeFilter||this.shapeFilter.allow(t)}return!this.nodeFilter||this.nodeFilter.allow(e)}}async pickShape(e,t,r,i=o.tR.edgeSelected){let a=new l.zK(this.document,this.shapeType,r,t,this.shapeFilter);return a.selectedState=i,await this.pickAsync(a,e,t,r),a.shapes()}async pickNode(e,t,r){let i=new l.t(this.document,r,t,this.nodeFilter);return await this.pickAsync(i,e,t,r),i.nodes()}async pickAsync(e,t,r,i,a="select.default"){let s=this.document.visual.eventHandler;this.document.visual.eventHandler=e,o.pS.default.pub("viewCursor",a),o.pS.default.pub("statusBarTip",t),i&&o.pS.default.pub("showSelectionControl",r);try{await new Promise((e,t)=>{r.onCompleted(e),r.onCancelled(t)})}catch(e){o.Yd.debug("pick status: ",e)}finally{i&&o.pS.default.pub("clearSelectionControl"),o.pS.default.pub("clearStatusBarTip"),this.document.visual.eventHandler=s,o.pS.default.pub("viewCursor","default")}}dispose(){this._selectedNodes.length=0,this._unselectedNodes.length=0}getSelectedNodes(){return this._selectedNodes}setSelection(e,t){return e=e.filter(this.shapeNodeFilter),t?this.toggleSelectPublish(e,!0):(this.removeSelectedPublish(this._selectedNodes,!1),this.addSelectPublish(e,!0)),this._selectedNodes.length}shapeNodeFilter;deselect(e){this.removeSelectedPublish(e,!0)}clearSelection(){this.removeSelectedPublish(this._selectedNodes,!0)}updateSelection(){this.document.visual.update(),o.pS.default.pub("selectionChanged",this.document,this._selectedNodes,this._unselectedNodes)}toggleSelectPublish(e,t){let r=e.filter(e=>this._selectedNodes.includes(e)),i=e.filter(e=>!this._selectedNodes.includes(e));this.removeSelectedPublish(r,!1),this.addSelectPublish(i,t)}addSelectPublish(e,t){e.forEach(e=>{if(e instanceof o.S3){let t=this.document.visual.context.getVisual(e);t&&this.document.visual.highlighter.addState(t,o.tR.edgeSelected,o.ax.Shape)}}),this._selectedNodes.push(...e),t&&this.updateSelection()}removeSelectedPublish(e,t){for(let t of e)if(t instanceof o.S3){let e=this.document.visual.context.getVisual(t);e&&this.document.visual.highlighter.removeState(e,o.tR.edgeSelected,o.ax.Shape)}this._selectedNodes=this._selectedNodes.filter(t=>!e.includes(t)),this._unselectedNodes=e,t&&this.updateSelection()}};function _ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let Document=class Document extends o.y${application;id;components;visual;history;selection;acts;materials;_nodeChangedObservers;static version="0.6";get name(){return this.getPrivateValue("name")}set name(e){this.name!==e&&(this.setProperty("name",e),this._rootNode&&(this._rootNode.name=e))}_rootNode;get rootNode(){return void 0===this._rootNode&&this.setRootNode(this.initRootNode()),this._rootNode}set rootNode(e){this.setRootNode(e)}setRootNode(e){this._rootNode!==e&&(this._rootNode?.removePropertyChanged(this.handleRootNodeNameChanged),this._rootNode=e??new o.YT(this,this.name),this._rootNode.onPropertyChanged(this.handleRootNodeNameChanged))}_currentNode;get currentNode(){return this._currentNode}set currentNode(e){this.setProperty("currentNode",e)}constructor(e,t,r=o.Id.generate()){super(),this.application=e,this.id=r,this.components=[],this.acts=new o.Vn,this.materials=new o.Vn,this._nodeChangedObservers=new Set,this.handleRootNodeNameChanged=e=>{"name"===e&&(this.name=this.rootNode.name)},this.handleMaterialChanged=e=>{e.action===o.mn.add?o.YW.add(this,{name:"MaterialChanged",dispose(){},undo:()=>this.materials.remove(...e.items),redo:()=>this.materials.push(...e.items)}):e.action===o.mn.remove&&o.YW.add(this,{name:"MaterialChanged",dispose(){},undo:()=>this.materials.push(...e.items),redo:()=>this.materials.remove(...e.items)})},this.setPrivateValue("name",t),this.history=new o.Ay,this.visual=e.visualFactory.create(this),this.selection=new Selection(this),this.materials.onCollectionChanged(this.handleMaterialChanged),e.documents.add(this),o.Yd.info(`new document: ${t}`)}handleRootNodeNameChanged;initRootNode(){return new o.YT(this,this.name)}serialize(){return{classKey:"Document",version:"0.6",properties:{id:this.id,name:this.name,components:this.components.map(e=>o.ei.serializeObject(e)),nodes:o.qV.serialize(this.rootNode),materials:this.materials.map(e=>o.ei.serializeObject(e)),acts:this.acts.map(e=>o.ei.serializeObject(e))}}}disposeInternal(){super.disposeInternal(),this._nodeChangedObservers.clear(),this._rootNode?.removePropertyChanged(this.handleRootNodeNameChanged),this._rootNode?.dispose(),this.visual.dispose(),this.history.dispose(),this.selection.dispose(),this.materials.forEach(e=>e.dispose()),this.materials.clear(),this.acts.forEach(e=>e.dispose()),this.acts.clear(),this._rootNode=void 0,this._currentNode=void 0}async save(){let e=this.serialize();await this.application.storage.put(o.gT.DBName,o.gT.DocumentTable,this.id,e);let t=this.application.activeView?.toImage();await this.application.storage.put(o.gT.DBName,o.gT.RecentTable,this.id,{id:this.id,name:this.name,date:Date.now(),image:t})}async close(){window.confirm(o.oc.translate("prompt.saveDocument{0}",this.name))&&await this.save();let e=this.application.views.filter(e=>e.document===this);this.application.views.remove(...e),this.application.activeView=this.application.views.at(0),this.application.documents.delete(this),this.materials.removeCollectionChanged(this.handleMaterialChanged),o.pS.default.pub("documentClosed",this),o.Yd.info(`document: ${this.name} closed`),this.dispose()}static async open(e,t){let r=await e.storage.get(o.gT.DBName,o.gT.DocumentTable,t);if(void 0===r)return void o.Yd.warn(`document: ${t} not find`);let i=await this.load(e,r);return void 0!==i&&o.Yd.info(`document: ${i.name} opened`),i}static async load(e,t){if("0.6"!==t.version)return void alert("The file version has been upgraded, no compatibility treatment was done in the development phase");let r=new Document(e,t.properties.name,t.properties.id);r.history.disabled=!0,r.materials.push(...t.properties.materials.map(e=>o.ei.deserializeObject(r,e))),r.acts.push(...t.properties.acts.map(e=>o.ei.deserializeObject(r,e))),r.components.push(...t.properties.components.map(e=>o.ei.deserializeObject(r,e)));let i=await o.qV.deserialize(r,t.properties.nodes);return r.setRootNode(i),r.history.disabled=!1,r}handleMaterialChanged;addNodeObserver(e){this._nodeChangedObservers.add(e)}removeNodeObserver(e){this._nodeChangedObservers.delete(e)}notifyNodeChanged(e){o.YW.add(this,new o.Hm(e)),this._nodeChangedObservers.forEach(t=>t.handleNodeChanged(e))}addNode(...e){(this.currentNode??this.rootNode).add(...e)}};async function importFiles(e,t){let r=e.activeView?.document??await e.newDocument("Untitled");o.pS.default.pub("showPermanent",async()=>{await o.YW.executeAsync(r,"import model",async()=>{await r.application.dataExchange.import(r,t)}),r.application.activeView?.cameraController.fitContent()},"toast.excuting{0}",o.oc.translate("command.file.import"))}_ts_decorate([o.ei.serialze()],Document.prototype,"rootNode",null);let Application=class Application{dataExchange;visualFactory;shapeFactory;services;storage;mainWindow;views=new o.Vn;documents=new Set;executingCommand;_activeView;get activeView(){return this._activeView}set activeView(e){this._activeView!==e&&(this._activeView=e,o.pS.default.pub("activeViewChanged",e))}constructor(e){if(void 0!==i)throw Error("Only one application can be created");i=this,this.visualFactory=e.visualFactory,this.shapeFactory=e.shapeFactory,this.services=e.services,this.storage=e.storage,this.dataExchange=e.dataExchange,this.mainWindow=e.mainWindow,this.services.forEach(e=>e.register(this)),this.services.forEach(e=>e.start()),this.initWindowEvents()}initWindowEvents(){window.onbeforeunload=this.handleWindowUnload,window.addEventListener("dragstart",e=>{e.preventDefault()},!1),window.addEventListener("dragover",e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},!1),window.addEventListener("drop",e=>{e.stopPropagation(),e.preventDefault(),this.importFiles(e.dataTransfer?.files)},!1)}handleWindowUnload=e=>{this.activeView&&(e.preventDefault(),e.returnValue="")};async importFiles(e){if(!e||0===e.length)return;let{opens:t,imports:r}=this.groupFiles(e);this.loadDocumentsWithLoading(t),importFiles(this,r)}loadDocumentsWithLoading(e){o.pS.default.pub("showPermanent",async()=>{for(let t of e){let e=JSON.parse(await t.text());await this.loadDocument(e),this.activeView?.cameraController.fitContent()}},"toast.excuting{0}",o.oc.translate("command.doc.open"))}groupFiles(e){let t=[],r=[];for(let i of e)i.name.endsWith(o.Gq)?t.push(i):r.push(i);return{opens:t,imports:r}}async openDocument(e){let t=await Document.open(this,e);return await this.createActiveView(t),t}async newDocument(e){let t=new Document(this,e),r=new o.F5(t,"LightGray",0xdedede),i=new o.F5(t,"DeepGray",9013641);return t.materials.push(r,i),await this.createActiveView(t),t}async loadDocument(e){let t=await Document.load(this,e);return await this.createActiveView(t),t}async createActiveView(e){if(void 0===e)return;let t=e.visual.createView("3d",o.JO.XY);this.activeView=t}};function box_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let BoxNode=class BoxNode extends o.gR{display(){return"body.box"}get dx(){return this.getPrivateValue("dx")}set dx(e){this.setPropertyEmitShapeChanged("dx",e)}get dy(){return this.getPrivateValue("dy")}set dy(e){this.setPropertyEmitShapeChanged("dy",e)}get dz(){return this.getPrivateValue("dz")}set dz(e){this.setPropertyEmitShapeChanged("dz",e)}get plane(){return this.getPrivateValue("plane")}constructor(e,t,r,i,a){super(e),this.setPrivateValue("plane",t),this.setPrivateValue("dx",r),this.setPrivateValue("dy",i),this.setPrivateValue("dz",a)}generateShape(){return this.document.application.shapeFactory.box(this.plane,this.dx,this.dy,this.dz)}};function circle_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}box_ts_decorate([o.ei.serialze(),o.Z9.define("box.dx")],BoxNode.prototype,"dx",null),box_ts_decorate([o.ei.serialze(),o.Z9.define("box.dy")],BoxNode.prototype,"dy",null),box_ts_decorate([o.ei.serialze(),o.Z9.define("box.dz")],BoxNode.prototype,"dz",null),box_ts_decorate([o.ei.serialze()],BoxNode.prototype,"plane",null),BoxNode=box_ts_decorate([o.ei.register(["document","plane","dx","dy","dz"])],BoxNode);let CircleNode=class CircleNode extends o.Vt{display(){return"body.circle"}get center(){return this.getPrivateValue("center")}set center(e){this.setPropertyEmitShapeChanged("center",e)}get radius(){return this.getPrivateValue("radius")}set radius(e){this.setPropertyEmitShapeChanged("radius",e)}get normal(){return this.getPrivateValue("normal")}constructor(e,t,r,i){super(e),this.setPrivateValue("normal",t),this.setPrivateValue("center",r),this.setPrivateValue("radius",i)}generateShape(){let e=this.document.application.shapeFactory.circle(this.normal,this.center,this.radius);if(!e.isOk||!this.isFace)return e;let t=this.document.application.shapeFactory.wire([e.value]);return t.isOk?t.value.toFace():e}};function cone_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}circle_ts_decorate([o.ei.serialze(),o.Z9.define("circle.center")],CircleNode.prototype,"center",null),circle_ts_decorate([o.ei.serialze(),o.Z9.define("circle.radius")],CircleNode.prototype,"radius",null),circle_ts_decorate([o.ei.serialze()],CircleNode.prototype,"normal",null),CircleNode=circle_ts_decorate([o.ei.register(["document","normal","center","radius"])],CircleNode);let ConeNode=class ConeNode extends o.gR{display(){return"body.cone"}get center(){return this.getPrivateValue("center")}set center(e){this.setPropertyEmitShapeChanged("center",e)}get radius(){return this.getPrivateValue("radius")}set radius(e){this.setPropertyEmitShapeChanged("radius",e)}get dz(){return this.getPrivateValue("dz")}set dz(e){this.setPropertyEmitShapeChanged("dz",e)}get normal(){return this.getPrivateValue("normal")}constructor(e,t,r,i,a){super(e),this.setPrivateValue("normal",t),this.setPrivateValue("center",r),this.setPrivateValue("radius",i),this.setPrivateValue("dz",a)}generateShape(){return this.document.application.shapeFactory.cone(this.normal,this.center,this.radius,0,this.dz)}};function cylinder_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}cone_ts_decorate([o.ei.serialze(),o.Z9.define("circle.center")],ConeNode.prototype,"center",null),cone_ts_decorate([o.ei.serialze(),o.Z9.define("circle.radius")],ConeNode.prototype,"radius",null),cone_ts_decorate([o.ei.serialze(),o.Z9.define("box.dz")],ConeNode.prototype,"dz",null),cone_ts_decorate([o.ei.serialze()],ConeNode.prototype,"normal",null),ConeNode=cone_ts_decorate([o.ei.register(["document","normal","center","radius","dz"])],ConeNode);let CylinderNode=class CylinderNode extends o.gR{display(){return"body.cylinder"}get center(){return this.getPrivateValue("center")}set center(e){this.setPropertyEmitShapeChanged("center",e)}get radius(){return this.getPrivateValue("radius")}set radius(e){this.setPropertyEmitShapeChanged("radius",e)}get dz(){return this.getPrivateValue("dz")}set dz(e){this.setPropertyEmitShapeChanged("dz",e)}get normal(){return this.getPrivateValue("normal")}constructor(e,t,r,i,a){super(e),this.setPrivateValue("normal",t),this.setPrivateValue("center",r),this.setPrivateValue("radius",i),this.setPrivateValue("dz",a)}generateShape(){return this.document.application.shapeFactory.cylinder(this.normal,this.center,this.radius,this.dz)}};function ellipse_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}cylinder_ts_decorate([o.ei.serialze(),o.Z9.define("circle.center")],CylinderNode.prototype,"center",null),cylinder_ts_decorate([o.ei.serialze(),o.Z9.define("circle.radius")],CylinderNode.prototype,"radius",null),cylinder_ts_decorate([o.ei.serialze(),o.Z9.define("box.dz")],CylinderNode.prototype,"dz",null),cylinder_ts_decorate([o.ei.serialze()],CylinderNode.prototype,"normal",null),CylinderNode=cylinder_ts_decorate([o.ei.register(["document","normal","center","radius","dz"])],CylinderNode);let EllipseNode=class EllipseNode extends o.Vt{display(){return"body.ellipse"}get center(){return this.getPrivateValue("center")}set center(e){this.setPropertyEmitShapeChanged("center",e)}get majorRadius(){return this.getPrivateValue("majorRadius")}set majorRadius(e){this.setPropertyEmitShapeChanged("majorRadius",e)}get minorRadius(){return this.getPrivateValue("minorRadius")}set minorRadius(e){this.setPropertyEmitShapeChanged("minorRadius",e)}get normal(){return this.getPrivateValue("normal")}get xvec(){return this.getPrivateValue("xvec")}constructor(e,t,r,i,a,s){super(e),this.setPrivateValue("normal",t),this.setPrivateValue("center",r),this.setPrivateValue("xvec",i),this.setPrivateValue("majorRadius",a),this.setPrivateValue("minorRadius",s)}generateShape(){let e=this.document.application.shapeFactory.ellipse(this.normal,this.center,this.xvec,this.majorRadius,this.minorRadius);if(!e.isOk||!this.isFace)return e;let t=this.document.application.shapeFactory.wire([e.value]);return t.isOk?t.value.toFace():e}};function line_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}ellipse_ts_decorate([o.ei.serialze(),o.Z9.define("circle.center")],EllipseNode.prototype,"center",null),ellipse_ts_decorate([o.ei.serialze(),o.Z9.define("ellipse.majorRadius")],EllipseNode.prototype,"majorRadius",null),ellipse_ts_decorate([o.ei.serialze(),o.Z9.define("ellipse.minorRadius")],EllipseNode.prototype,"minorRadius",null),ellipse_ts_decorate([o.ei.serialze()],EllipseNode.prototype,"normal",null),ellipse_ts_decorate([o.ei.serialze()],EllipseNode.prototype,"xvec",null),EllipseNode=ellipse_ts_decorate([o.ei.register(["document","normal","center","xvec","majorRadius","minorRadius"])],EllipseNode);let LineNode=class LineNode extends o.gR{display(){return"body.line"}get start(){return this.getPrivateValue("start")}set start(e){this.setPropertyEmitShapeChanged("start",e)}get end(){return this.getPrivateValue("end")}set end(e){this.setPropertyEmitShapeChanged("end",e)}constructor(e,t,r){super(e),this.setPrivateValue("start",t),this.setPrivateValue("end",r)}generateShape(){return this.document.application.shapeFactory.line(this.start,this.end)}};function polygon_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}line_ts_decorate([o.ei.serialze(),o.Z9.define("line.start")],LineNode.prototype,"start",null),line_ts_decorate([o.ei.serialze(),o.Z9.define("line.end")],LineNode.prototype,"end",null),LineNode=line_ts_decorate([o.ei.register(["document","start","end"])],LineNode);let PolygonNode=class PolygonNode extends o.Vt{display(){return"body.polygon"}get points(){return this.getPrivateValue("points")}set points(e){this.setPropertyEmitShapeChanged("points",e)}constructor(e,t){super(e),this.setPrivateValue("points",t)}generateShape(){let e=this.document.application.shapeFactory.polygon(this.points);return e.isOk&&this.isFace?e.value.toFace():e}};polygon_ts_decorate([o.ei.serialze(),o.Z9.define("polygon.points")],PolygonNode.prototype,"points",null),PolygonNode=polygon_ts_decorate([o.ei.register(["document","points"])],PolygonNode);var c=r(8715);function prism_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let PrismNode=class PrismNode extends o.gR{display(){return"body.prism"}get section(){return this.getPrivateValue("section")}set section(e){this.setPropertyEmitShapeChanged("section",e)}get length(){return this.getPrivateValue("length")}set length(e){this.setPropertyEmitShapeChanged("length",e)}constructor(e,t,r){super(e),this.setPrivateValue("section",t),this.setPrivateValue("length",r)}generateShape(){let e=c.S.normal(this.section).multiply(this.length);return this.document.application.shapeFactory.prism(this.section,e)}};function pyramid_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}prism_ts_decorate([o.ei.serialze()],PrismNode.prototype,"section",null),prism_ts_decorate([o.ei.serialze(),o.Z9.define("common.length")],PrismNode.prototype,"length",null),PrismNode=prism_ts_decorate([o.ei.register(["document","section","length"])],PrismNode);let PyramidNode=class PyramidNode extends o.gR{display(){return"body.pyramid"}get dx(){return this.getPrivateValue("dx")}set dx(e){this.setPropertyEmitShapeChanged("dx",e)}get dy(){return this.getPrivateValue("dy")}set dy(e){this.setPropertyEmitShapeChanged("dy",e)}get dz(){return this.getPrivateValue("dz")}set dz(e){this.setPropertyEmitShapeChanged("dz",e)}get plane(){return this.getPrivateValue("plane")}constructor(e,t,r,i,a){super(e),this.setPrivateValue("plane",t),this.setPrivateValue("dx",r),this.setPrivateValue("dy",i),this.setPrivateValue("dz",a)}generateShape(){return this.document.application.shapeFactory.pyramid(this.plane,this.dx,this.dy,this.dz)}};function rect_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}pyramid_ts_decorate([o.ei.serialze(),o.Z9.define("box.dx")],PyramidNode.prototype,"dx",null),pyramid_ts_decorate([o.ei.serialze(),o.Z9.define("box.dy")],PyramidNode.prototype,"dy",null),pyramid_ts_decorate([o.ei.serialze(),o.Z9.define("box.dz")],PyramidNode.prototype,"dz",null),pyramid_ts_decorate([o.ei.serialze()],PyramidNode.prototype,"plane",null),PyramidNode=pyramid_ts_decorate([o.ei.register(["document","plane","dx","dy","dz"])],PyramidNode);let RectNode=class RectNode extends o.Vt{display(){return"body.rect"}get dx(){return this.getPrivateValue("dx")}set dx(e){this.setPropertyEmitShapeChanged("dx",e)}get dy(){return this.getPrivateValue("dy")}set dy(e){this.setPropertyEmitShapeChanged("dy",e)}get plane(){return this.getPrivateValue("plane")}constructor(e,t,r,i){super(e),this.setPrivateValue("plane",t),this.setPrivateValue("dx",r),this.setPrivateValue("dy",i)}generateShape(){let e=RectNode.points(this.plane,this.dx,this.dy),t=this.document.application.shapeFactory.polygon(e);return t.isOk&&this.isFace?t.value.toFace():t}static points(e,t,r){let i=e.origin;return[i,i.add(e.xvec.multiply(t)),i.add(e.xvec.multiply(t)).add(e.yvec.multiply(r)),i.add(e.yvec.multiply(r)),i]}};function revolve_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}rect_ts_decorate([o.ei.serialze(),o.Z9.define("rect.dx")],RectNode.prototype,"dx",null),rect_ts_decorate([o.ei.serialze(),o.Z9.define("rect.dy")],RectNode.prototype,"dy",null),rect_ts_decorate([o.ei.serialze()],RectNode.prototype,"plane",null),RectNode=rect_ts_decorate([o.ei.register(["document","plane","dx","dy"])],RectNode);let RevolvedNode=class RevolvedNode extends o.gR{display(){return"body.revol"}get profile(){return this.getPrivateValue("profile")}set profile(e){this.setPropertyEmitShapeChanged("profile",e)}get axis(){return this.getPrivateValue("axis")}set axis(e){this.setPropertyEmitShapeChanged("axis",e)}get angle(){return this.getPrivateValue("angle")}set angle(e){this.setPropertyEmitShapeChanged("angle",e)}constructor(e,t,r,i){super(e),this.setPrivateValue("profile",t),this.setPrivateValue("axis",r),this.setPrivateValue("angle",i)}generateShape(){return this.document.application.shapeFactory.revolve(this.profile,this.axis,this.angle)}};function sphere_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}revolve_ts_decorate([o.ei.serialze()],RevolvedNode.prototype,"profile",null),revolve_ts_decorate([o.ei.serialze()],RevolvedNode.prototype,"axis",null),revolve_ts_decorate([o.ei.serialze()],RevolvedNode.prototype,"angle",null),RevolvedNode=revolve_ts_decorate([o.ei.register(["document","profile","axis","angle"])],RevolvedNode);let SphereNode=class SphereNode extends o.gR{display(){return"body.sphere"}get center(){return this.getPrivateValue("center")}set center(e){this.setPropertyEmitShapeChanged("center",e)}get radius(){return this.getPrivateValue("radius")}set radius(e){this.setPropertyEmitShapeChanged("radius",e)}constructor(e,t,r){super(e),this.setPrivateValue("center",t),this.setPrivateValue("radius",r)}generateShape(){return this.document.application.shapeFactory.sphere(this.center,this.radius)}};function sweep_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}sphere_ts_decorate([o.ei.serialze(),o.Z9.define("circle.center")],SphereNode.prototype,"center",null),sphere_ts_decorate([o.ei.serialze(),o.Z9.define("circle.radius")],SphereNode.prototype,"radius",null),SphereNode=sphere_ts_decorate([o.ei.register(["document","center","radius"])],SphereNode);let SweepedNode=class SweepedNode extends o.gR{display(){return"body.sweep"}get profile(){return this.getPrivateValue("profile")}set profile(e){this.setPropertyEmitShapeChanged("profile",e)}get path(){return this.getPrivateValue("path")}set path(e){this.setPropertyEmitShapeChanged("path",e)}constructor(e,t,r){super(e),this.setPrivateValue("profile",t),this.setPrivateValue("path",this.ensureWire(r))}ensureWire(e){let t=e;return e.shapeType!==o.ax.Wire&&(t=this.document.application.shapeFactory.wire([e]).value),t}generateShape(){return this.document.application.shapeFactory.sweep(this.profile,this.path)}};function newDocument_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}sweep_ts_decorate([o.ei.serialze()],SweepedNode.prototype,"profile",null),sweep_ts_decorate([o.ei.serialze()],SweepedNode.prototype,"path",null),SweepedNode=sweep_ts_decorate([o.ei.register(["document","profile","path"])],SweepedNode);let d=1;let NewDocument=class NewDocument{async execute(e){await e.newDocument(`undefined ${d++}`)}};function openDocument_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}NewDocument=newDocument_ts_decorate([(0,o.WD)({key:"doc.new",icon:"icon-new"})],NewDocument);let OpenDocument=class OpenDocument{async execute(e){o.pS.default.pub("showPermanent",async()=>{let t=await (0,o.vZ)(".cd",!1);if(t.isOk){let r=JSON.parse(t.value[0].data),i=await e.loadDocument(r);i?.application.activeView?.cameraController.fitContent()}},"toast.excuting{0}",o.oc.translate("command.doc.open"))}};function performanceTest_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}OpenDocument=openDocument_ts_decorate([(0,o.WD)({key:"doc.open",icon:"icon-open"})],OpenDocument);let PerformanceTestCommand=class PerformanceTestCommand{size=10;gap=1;rowCols=20;async execute(e){let t=await e.newDocument("OCC Performace Test"),r=performance.now(),i=this.gap+this.size;for(let e=0;e<this.rowCols;e++)for(let r=0;r<this.rowCols;r++)for(let a=0;a<this.rowCols;a++){let s=o.vY.zero.add(o.vY.unitX.multiply(e*i)).add(o.vY.unitY.multiply(r*i)).add(o.vY.unitZ.multiply(a*i));this.createShape(t,t.materials.at(0),s)}t.visual.update(),alert(`Create ${this.rowCols*this.rowCols*this.rowCols} shapes, Time: ${performance.now()-r} ms`)}};let OccPerformanceTestCommand=class OccPerformanceTestCommand extends PerformanceTestCommand{index=1;shapes=[];createShape(e,t,r){let i=o.JO.XY.translateTo(r),a=e.application.shapeFactory.box(i,this.size*Math.random(),this.size*Math.random(),this.size*Math.random()).value,s=new o.gC(e,`box ${this.index++}`,a,t.id);e.addNode(s)}};function saveDocument_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}OccPerformanceTestCommand=performanceTest_ts_decorate([(0,o.WD)({key:"test.performace",icon:""})],OccPerformanceTestCommand);let SaveDocument=class SaveDocument{async execute(e){e.activeView?.document&&o.pS.default.pub("showPermanent",async()=>{await e.activeView?.document.save(),o.pS.default.pub("showToast","toast.document.saved")},"toast.excuting{0}",o.oc.translate("command.doc.save"))}};function toFile_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}SaveDocument=saveDocument_ts_decorate([(0,o.WD)({key:"doc.save",icon:"icon-save"})],SaveDocument);let SaveDocumentToFile=class SaveDocumentToFile{async execute(e){e.activeView?.document&&o.pS.default.pub("showPermanent",async()=>{await new Promise((e,t)=>{setTimeout(e,100)});let t=e.activeView?.document.serialize();o.pS.default.pub("showToast","toast.downloading"),(0,o.LR)([JSON.stringify(t)],`${e.activeView?.document.name}${o.Gq}`)},"toast.excuting{0}",o.oc.translate("command.doc.saveToFile"))}};function toggleDynamicWorkplane_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}SaveDocumentToFile=toFile_ts_decorate([(0,o.WD)({key:"doc.saveToFile",icon:"icon-download"})],SaveDocumentToFile);let ToggleDynamicWorkplaneCommand=class ToggleDynamicWorkplaneCommand{async execute(e){o.De.instance.dynamicWorkplane=!o.De.instance.dynamicWorkplane}};ToggleDynamicWorkplaneCommand=toggleDynamicWorkplane_ts_decorate([(0,o.WD)({key:"workingPlane.toggleDynamic",toggle:new o.KX(o.De.instance,"dynamicWorkplane"),icon:"icon-dynamicPlane"})],ToggleDynamicWorkplaneCommand);var p=r(4501);function wechatGroup_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let WeChatGroup=class WeChatGroup{async execute(e){o.pS.default.pub("showDialog","command.wechat.group",this.ui())}ui(){return(0,p.hi)((0,p.PS)({textContent:"chili3d交流群",style:{fontSize:"16px",display:"block",textAlign:"center",marginBottom:"10px"}}),(0,p.lv)({width:360,src:"images/wechat-group.jpg",style:{borderRadius:"10px"}}))}};function boolean_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}WeChatGroup=wechatGroup_ts_decorate([(0,o.WD)({key:"wechat.group",icon:"icon-qrcode"})],WeChatGroup);let BooleanNode=class BooleanNode extends o.gR{display(){return"body.bolean"}get booleanShape(){return this.getPrivateValue("booleanShape")}constructor(e,t){super(e),this.setPrivateValue("booleanShape",t)}generateShape(){return o.x4.ok(this.booleanShape)}};boolean_ts_decorate([o.ei.serialze()],BooleanNode.prototype,"booleanShape",null),BooleanNode=boolean_ts_decorate([o.ei.register(["document","booleanShape"])],BooleanNode);var h=((a={})[a.None=0]="None",a[a.D1=1]="D1",a[a.D2=2]="D2",a[a.D3=4]="D3",a[a.D1D2=3]="D1D2",a[a.D1D2D3=7]="D1D2D3",a);(s=h||(h={})).contains=function(e,t){return 0!==t&&(e&t)===t},s.from=function(e){return({1:1,2:2,3:4})[e]||0};let AxisSnap=class AxisSnap{point;direction;_tempLines;constructor(e,t){this.point=e,this.direction=t}snap(e){let t=e.view.up().cross(e.view.direction()).normalize(),r=t?.cross(this.direction).normalize();if(!r)return;let i=new o.JO(this.point,r,t),a=e.view.rayAt(e.mx,e.my),s=i.intersect(a,!1);if(!s)return;let n=s.sub(this.point).dot(this.direction),l=this.point.add(this.direction.multiply(n));return this.showTempLine(e.view,n),{view:e.view,point:l,distance:n,shapes:[]}}showTempLine(e,t){let r=1e-6>Math.abs(t)?1e15:1e15*t,i=o.bj.from(this.point,this.point.add(this.direction.multiply(r)),o.OI.temporaryEdgeColor,o.SP.Dash),a=e.document.visual.context.displayMesh(i);this._tempLines=[e,a]}removeDynamicObject(){this._tempLines?.[0].document.visual.context.removeMesh(this._tempLines[1])}clear(){this.removeDynamicObject()}};let BaseSnap=class BaseSnap{referencePoint;_tempMeshIds;_highlightedShapes;constructor(e){this.referencePoint=e,this._tempMeshIds=new Map,this._highlightedShapes=[]}removeDynamicObject(){this.clearTempMeshes(),this.unhighlight()}clear(){this.removeDynamicObject()}clearTempMeshes(){this._tempMeshIds.forEach((e,t)=>{e.forEach(e=>t.document.visual.context.removeMesh(e))}),this._tempMeshIds.clear()}addTempMesh(e,t){let r=this._tempMeshIds.get(e);r||(r=[],this._tempMeshIds.set(e,r)),r.push(t)}highlight(e){e.forEach(e=>{e.owner.node.document.visual.highlighter.addState(e.owner,o.tR.edgeHighlight,e.shape.shapeType,...e.indexes)}),this._highlightedShapes.push(...e)}unhighlight(){this._highlightedShapes.forEach(e=>{e.owner.node.document.visual.highlighter.removeState(e.owner,o.tR.edgeHighlight,e.shape.shapeType,...e.indexes)}),this._highlightedShapes.length=0}calculateDistance(e){return this.referencePoint?this.referencePoint().distanceTo(e):void 0}};let FeaturePointStrategy=class FeaturePointStrategy{_snapType;_featureInfos;constructor(e){this._snapType=e,this._featureInfos=new Map}getFeaturePoints(e,t){if(this._featureInfos.has(t))return this._featureInfos.get(t);let r=[];return t.shape.shapeType===o.ax.Edge&&this.getEdgeFeaturePoints(e,t,r),this._featureInfos.set(t,r),r}getEdgeFeaturePoints(e,t,r){let i=t.shape.curve,a=i.value(i.firstParameter()),s=i.value(i.lastParameter()),addPoint=(i,a)=>r.push({view:e,point:t.transform.ofPoint(i),info:a,shapes:[t]});o.DE.has(this._snapType,o.DE.endPoint)&&(addPoint(a,o.oc.translate("snap.end")),addPoint(s,o.oc.translate("snap.end"))),o.DE.has(this._snapType,o.DE.midPoint)&&addPoint(i.value((i.firstParameter()+i.lastParameter())*.5),o.oc.translate("snap.mid"))}clear(){this._featureInfos.clear()}updateSnapType(e){this._snapType=e,this.clear()}};let ObjectSnap=class ObjectSnap extends BaseSnap{_snapType;_featureStrategy;_intersectionInfos;_invisibleInfos;_lastDetected;_hintVertex;constructor(e,t){super(t),this._snapType=e,this.handleSnaped=(e,t)=>{t?.shapes.length===0&&this._lastDetected&&(this.displayHint(this._lastDetected[0],this._lastDetected[1]),this._lastDetected=void 0)},this.onSnapTypeChanged=e=>{("snapType"===e||"enableSnap"===e)&&(this._snapType=o.De.instance.snapType,this._featureStrategy.updateSnapType(this._snapType),this._intersectionInfos.clear())},this._featureStrategy=new FeaturePointStrategy(e),this._intersectionInfos=new Map,this._invisibleInfos=new Map,o.De.instance.onPropertyChanged(this.onSnapTypeChanged)}clear(){super.clear(),this._invisibleInfos.forEach(e=>{e.displays.forEach(t=>e.view.document.visual.context.removeMesh(t))}),this.removeHint(),this._featureStrategy.clear(),o.De.instance.removePropertyChanged(this.onSnapTypeChanged)}handleSnaped;onSnapTypeChanged;removeDynamicObject(){super.removeDynamicObject(),this.removeHint()}removeHint(){void 0!==this._hintVertex&&(this._hintVertex[0].removeMesh(this._hintVertex[1]),this._hintVertex=void 0)}snap(e){let t;if(o.De.instance.enableSnap)return e.shapes.length>0?(this.showInvisibleSnaps(e.view,e.shapes[0]),t=this.snapOnShape(e.view,e.mx,e.my,e.shapes)):t=this.snapeInvisible(e.view,e.mx,e.my),this.referencePoint&&t?.point&&(t.distance=this.referencePoint().distanceTo(t.point)),t}snapOnShape(e,t,r,i){let a=this._featureStrategy.getFeaturePoints(e,i[0]),s=[...a,...this.findPerpendicular(e,i[0]),...this.getIntersections(e,i[0],i)].sort((i,a)=>this.sortSnaps(e,t,r,i,a));if(0!==s.length){if(o.wB.screenDistance(e,t,r,s[0].point)<o.De.instance.SnapDistance)return this.hilighted(e,s[0].shapes),s[0];this._lastDetected=[e,s[0]]}}displayHint(e,t){this.hilighted(e,t.shapes);let r=o.zp.from(t.point,o.OI.hintVertexSize,o.OI.hintVertexColor);this._hintVertex=[e.document.visual.context,e.document.visual.context.displayMesh(r)]}snapeInvisible(e,t,r){let{minDistance:i,snap:a}=this.getNearestInvisibleSnap(e,t,r);if(i<o.De.instance.SnapDistance)return this.hilighted(e,a.shapes),a}getNearestInvisibleSnap(e,t,r){let i,a=Number.MAX_VALUE;return this._invisibleInfos.forEach(s=>{s.snaps.forEach(s=>{let n=o.wB.screenDistance(e,t,r,s.point);n<a&&(a=n,i=s)})}),{minDistance:a,snap:i}}showInvisibleSnaps(e,t){if(t.shape.shapeType===o.ax.Edge){if(this._invisibleInfos.has(t))return;let r=t.shape.curve.basisCurve;o.DY.isCircle(r)&&this.showCircleCenter(r,e,t)}}showCircleCenter(e,t,r){let i=r.transform.ofPoint(e.center),a=o.zp.from(i,o.OI.hintVertexSize,o.OI.hintVertexColor),s=t.document.visual.context.displayMesh(a);this._invisibleInfos.set(r,{view:t,snaps:[{view:t,point:i,info:o.oc.translate("snap.center"),shapes:[r]}],displays:[s]})}hilighted(e,t){this.highlight(t)}sortSnaps(e,t,r,i,a){return o.wB.screenDistance(e,t,r,i.point)-o.wB.screenDistance(e,t,r,a.point)}findPerpendicular(e,t){let r=[];if(!o.DE.has(this._snapType,o.DE.perpendicular)||void 0===this.referencePoint)return r;let i=t.shape.curve,a=t.transform,s=i.project(a.invert().ofPoint(this.referencePoint())).at(0);return void 0===s||r.push({view:e,point:a.ofPoint(s),info:o.oc.translate("snap.perpendicular"),shapes:[t]}),r}getIntersections(e,t,r){let i=[];return(o.DE.has(this._snapType,o.DE.intersection)||t.shape.shapeType===o.ax.Edge)&&r.forEach(r=>{if(r===t||r.shape.shapeType!==o.ax.Edge)return;let a=this.getIntersectionKey(t,r),s=this._intersectionInfos.get(a);void 0===s&&(s=this.findIntersections(e,t,r),this._intersectionInfos.set(a,s)),i.push(...s)}),i}getIntersectionKey(e,t){return e.shape.id<t.shape.id?`${e.shape.id}:${t.shape.id}`:`${t.shape.id}:${e.shape.id}`}findIntersections(e,t,r){let i=t.shape.transformedMul(t.transform),a=r.shape.transformedMul(r.transform),s=i.intersect(a);return i.dispose(),a.dispose(),s.map(i=>({view:e,point:i.point,info:o.oc.translate("snap.intersection"),shapes:[t,r]}))}};let PlaneSnapBase=class PlaneSnapBase{refPoint;removeDynamicObject(){}clear(){}constructor(e){this.refPoint=e}snapAtPlane(e,t){e=l.b3.ensurePlane(t.view,e);let r=t.view.rayAt(t.mx,t.my),i=e.intersect(r);if(!i)return;let a=this.refPoint?this.refPoint().distanceTo(i):void 0;return{view:t.view,point:i,distance:a,shapes:[]}}};let WorkplaneSnap=class WorkplaneSnap extends PlaneSnapBase{snap(e){return this.snapAtPlane(e.view.workplane,e)}};let PlaneSnap=class PlaneSnap extends PlaneSnapBase{plane;constructor(e,t){super(t),this.plane=e}snap(e){let t=e.view.screenToWorld(e.mx,e.my),r=this.plane(t),i=this.snapAtPlane(r,e);return i&&(i.plane=r),i}};let PointOnCurveSnap=class PointOnCurveSnap{pointData;constructor(e){this.pointData=e}snap(e){let t=e.view.rayAt(e.mx,e.my),r=this.pointData.curve.nearestExtrema(t);if(r)return{view:e.view,point:r.p1,shapes:[]}}removeDynamicObject(){}clear(){}};let Axis=class Axis extends o.zH{name;constructor(e,t,r){super(e,t),this.name=r}static getAxiesAtPlane(e,t,r){let createAxis=(t,r)=>new Axis(e,t,o.oc.translate(r)),i=[createAxis(t.xvec,"axis.x"),createAxis(t.xvec.reverse(),"axis.x"),createAxis(t.yvec,"axis.y"),createAxis(t.yvec.reverse(),"axis.y")];return r&&i.push(createAxis(t.normal,"axis.z"),createAxis(t.normal.reverse(),"axis.z")),i}};let TrackingBase=class TrackingBase{trackingZ;tempMeshes;isCleared;constructor(e){this.trackingZ=e,this.tempMeshes=new Map,this.isCleared=!1}clear(){this.clearTempMeshes(),this.isCleared=!0}clearTempMeshes(){this.tempMeshes.forEach((e,t)=>{e.forEach(e=>t.visual.context.removeMesh(e))}),this.tempMeshes.clear()}addTempMesh(e,t){let r=this.tempMeshes.get(e);r||(r=[],this.tempMeshes.set(e,r)),r.push(t)}displayPoint(e,t,r,i){let a=o.zp.from(t.point,r,i),s=e.visual.context.displayMesh(a);return this.addTempMesh(e,s),s}};let AxisTracking=class AxisTracking extends TrackingBase{axies=new Map;constructor(e){super(e)}getAxes(e,t,r){return this.axies.has(e)||this.axies.set(e,this.initAxes(e.workplane,t,r)),this.axies.get(e)}initAxes(e,t,r){if(void 0===r)return Axis.getAxiesAtPlane(t,e,this.trackingZ);let i=[],a=0;for(;a<360;){let s=e.xvec.rotate(e.normal,a/180*Math.PI);i.push(new Axis(t,s,`${a} \xb0`)),a+=r}return this.trackingZ&&(i.push(new Axis(t,e.normal,o.oc.translate("axis.z"))),i.push(new Axis(t,e.normal.reverse(),o.oc.translate("axis.z")))),i}clear(){super.clear(),this.axies.clear()}};let ObjectTracking=class ObjectTracking extends TrackingBase{timer;snapping;trackings=new Map;constructor(e){super(e)}clear(){this.clearTimer(),super.clear(),this.trackings.clear()}getTrackingRays(e){let t=[];return this.trackings.get(e.document)?.map(r=>{let i=l.b3.ensurePlane(e,e.workplane),a=Axis.getAxiesAtPlane(r.snap.point,i,this.trackingZ);t.push({axes:a,objectName:r.snap.info})}),t}showTrackingAtTimeout(e,t){(void 0===t||this.snapping!==t)&&(this.snapping=t,this.clearTimer(),t&&(this.timer=window.setTimeout(()=>this.switchTrackingPoint(e,t),600)))}clearTimer(){void 0!==this.timer&&(clearTimeout(this.timer),this.timer=void 0)}switchTrackingPoint(e,t){if(this.isCleared||0===t.shapes.length)return;this.trackings.has(e)||this.trackings.set(e,[]);let r=this.trackings.get(e),i=r.find(e=>e.snap.point.isEqualTo(t.point));i?this.removeTrackingPoint(e,i,r):this.addTrackingPoint(t,e,r),e.visual.update()}removeTrackingPoint(e,t,r){e.visual.context.removeMesh(t.shapeId),this.trackings.set(e,r.filter(e=>e!==t))}addTrackingPoint(e,t,r){let i=this.displayPoint(t,e,o.OI.trackingVertexSize,o.OI.trackingVertexColor);r.push({shapeId:i,snap:e})}};let TrackingSnap=class TrackingSnap{referencePoint;_axisTracking;_objectTracking;_tempLines;constructor(e,t){this.referencePoint=e,this._tempLines=new Map,this.handleSnaped=(e,t)=>{o.De.instance.enableSnapTracking&&this._objectTracking.showTrackingAtTimeout(e,t)},this.onSnapTypeChanged=e=>{("snapType"===e||"enableSnapTracking"===e||"enableSnap"===e)&&(this.removeDynamicObject(),this._objectTracking.clear(),this._axisTracking.clear())},this._axisTracking=new AxisTracking(t),this._objectTracking=new ObjectTracking(t),o.De.instance.onPropertyChanged(this.onSnapTypeChanged)}handleSnaped;snap(e){if(!o.De.instance.enableSnapTracking)return;let t=this.detectTracking(e.view,e.mx,e.my);if(0===t.length)return;t.sort(e=>e.distance);let r=this.shapeIntersectTracking(e,t);return void 0!==r?r:1===t.length?this.getSnapedAndShowTracking(e.view,t[0].point,[t[0]]):this.trackingIntersectTracking(e.view,t)??this.getSnapedAndShowTracking(e.view,t[0].point,[t[0]])}trackingIntersectTracking(e,t){let r=t[0].axis.intersect(t[1].axis);return r?this.getSnapedAndShowTracking(e,r,[t[0],t[1]]):void 0}getSnapedAndShowTracking(e,t,r){let i,a,s=r.map(r=>this.showTempLine(e,r.axis.location,t)).filter(e=>void 0!==e);return this._tempLines.set(e,s),1===r.length?(a=t.distanceTo(r[0].axis.location),i=r[0].axis.name):2===r.length&&(i=o.oc.translate("snap.intersection")),{view:e,point:t,info:i,shapes:[],refPoint:r[0].axis.location,distance:a}}showTempLine(e,t,r){let i=r.sub(t),a=i.normalize();if(!a)return;let s=Math.min(1e10*i.length(),1e20),n=t.add(a.multiply(s)),l=o.bj.from(t,n,o.OI.temporaryEdgeColor,o.SP.Dash);return e.document.visual.context.displayMesh(l)}shapeIntersectTracking(e,t){if(0===e.shapes.length||e.shapes[0].shape.shapeType!==o.ax.Edge)return;let r=this.findIntersection(e,t);if(!r)return;let i=this.showTempLine(e.view,r.location,r.intersect);if(void 0!==i)return this._tempLines.set(e.view,[i]),{view:e.view,point:r.intersect,info:o.oc.translate("snap.intersection"),shapes:[e.shapes[0]]}}findIntersection(e,t){let r=e.shapes[0].shape,i=[];return t.forEach(e=>{r.intersect(e.axis).forEach(t=>{i.push({intersect:t.point,location:e.axis.location})})}),i.sort(t=>o.wB.screenDistance(e.view,e.mx,e.my,t.intersect)),i.at(0)}detectTracking(e,t,r){let i=[];if(this.referencePoint){let a=this._axisTracking.getAxes(e,this.referencePoint());i.push(...this.getSnapedFromAxes(a,e,t,r))}return this._objectTracking.getTrackingRays(e).forEach(a=>{i.push(...this.getSnapedFromAxes(a.axes,e,t,r,a.objectName))}),i}getSnapedFromAxes(e,t,r,i,a){let s=[];for(let n of e){let e=this.rayDistanceAtScreen(t,r,i,n);if(e<o.De.instance.SnapDistance){let o=t.rayAt(r,i),l=n.nearestTo(o);if(0>l.sub(n.location).dot(n.direction))continue;s.push({axis:n,distance:e,point:l,info:a??n.name,isObjectTracking:void 0!==a})}}return s}rayDistanceAtScreen(e,t,r,i){let a=e.worldToScreen(i.location),s=new o.XY(t-a.x,r-a.y);if(s.isEqualTo(o.XY.zero))return 0;let n=e.worldToScreen(i.location.add(i.direction.multiply(1e5)));if(a.distanceTo(n)<o.Gc.Float)return s.length();let l=n.sub(a).normalize(),c=s.dot(l);return Math.sqrt(s.lengthSq()-c*c)}removeDynamicObject(){this._tempLines.forEach((e,t)=>{e.forEach(e=>{t.document.visual.context.removeMesh(e)})}),this._tempLines.clear()}onSnapTypeChanged;clear(){this.removeDynamicObject(),this._axisTracking.clear(),this._objectTracking.clear(),o.De.instance.removePropertyChanged(this.onSnapTypeChanged)}};let SnapEventHandler=class SnapEventHandler{document;controller;snaps;data;_tempPoint;_tempShapes;_snaped;_state;constructor(e,t,r,i){this.document=e,this.controller=t,this.snaps=r,this.data=i,this._state=0,this.showTempShape(void 0),t.onCancelled(()=>this.handleCancel())}get snaped(){return this._snaped}get state(){return this._state}dispose(){this._snaped=void 0,this._state=0}handleSuccess(){this._state=0,this.controller.success(),this.cleanupResources()}handleCancel(){3!==this._state&&(this._state=3,this.controller.cancel(),this.cleanupResources())}cleanupResources(){this.clearSnapTip(),this.clearInput(),this.removeTempVisuals(),this.snaps.forEach(e=>e.clear())}clearInput(){o.pS.default.pub("clearInput")}pointerMove(e,t){this._state=1,this.removeTempVisuals(),this.updateSnapPoint(e,t),this.updateVisualFeedback(e)}updateSnapPoint(e,t){this.setSnaped(e,t),this._snaped?this.showSnapPrompt(this.formatPrompt(this._snaped)):this.clearSnapTip()}updateVisualFeedback(e){this.showTempShape(this._snaped?.point),e.document.visual.update()}formatPrompt(e){let t=this.data.prompt?.(e);if(!t){let r=e.distance??e.refPoint?.distanceTo(e.point);r&&(t=`${r.toFixed(2)}`)}return[e.info,t].filter(e=>void 0!==e).join(" -> ")}setSnaped(e,t){this.trySnapToFeaturePoint(e,t)||(this._snaped=this.findSnapPoint(o.ax.Edge,e,t),this.snaps.forEach(t=>t.handleSnaped?.(e.document.visual.document,this._snaped)))}trySnapToFeaturePoint(e,t){let r=this.findNearestFeaturePoint(e,t);return!!r&&(this._snaped={view:e,point:r.point,info:r.prompt,shapes:[]},!0)}findNearestFeaturePoint(e,t){let r,i=Number.MAX_VALUE;for(let a of this.data.featurePoints||[]){if(a.when&&!a.when())continue;let s=o.wB.screenDistance(e,t.offsetX,t.offsetY,a.point);s<i&&(i=s,r=a)}return i<o.De.instance.SnapDistance?r:void 0}findSnapPoint(e,t,r){let i=this.detectShapes(e,t,r);for(let e of this.snaps){let t=e.snap(i);if(t&&this.validateSnapPoint(t))return t}}validateSnapPoint(e){return!this.data.validator||this.data.validator(e.point)}detectShapes(e,t,r){return{shapes:t.detectShapes(e,r.offsetX,r.offsetY,this.data.filter),view:t,mx:r.offsetX,my:r.offsetY}}clearSnapTip(){o.pS.default.pub("clearFloatTip")}showSnapPrompt(e){if(!e)return void this.clearSnapTip();o.pS.default.pub("showFloatTip",o.Cs.info,e)}removeTempVisuals(){this.removeTempShapes(),this.snaps.forEach(e=>e.removeDynamicObject())}showTempShape(e){if(e){let t=o.zp.from(e,o.OI.temporaryVertexSize,o.OI.temporaryVertexColor);this._tempPoint=this.document.visual.context.displayMesh(t)}this._tempShapes=this.data.preview?.(e)?.map(e=>this.document.visual.context.displayMesh(e))}removeTempShapes(){this._tempPoint&&(this.document.visual.context.removeMesh(this._tempPoint),this._tempPoint=void 0),this._tempShapes?.forEach(e=>{this.document.visual.context.removeMesh(e)}),this.document.visual.update(),this._tempShapes=void 0}pointerDown(e,t){"mouse"===t.pointerType&&0===t.button&&(this._snaped?this.handleSuccess():o.pS.default.pub("showToast","toast.snap.notFoundValidPoint"))}pointerUp(e,t){"mouse"!==t.pointerType&&t.isPrimary&&this._snaped&&this.handleSuccess()}mouseWheel(e,t){e.update()}keyDown(e,t){switch(t.key){case"Escape":this._snaped=void 0,this.handleCancel();break;case"Enter":this._snaped=void 0,this.handleSuccess();break;default:this.handleNumericInput(e,t)}}handleNumericInput(e,t){["-","0","1","2","3","4","5","6","7","8","9"].includes(t.key)&&(this._state=2,o.pS.default.pub("showInput",t.key,t=>{let r=this.inputError(t);return r?o.x4.err(r):(this._snaped=this.getPointFromInput(e,t),this.handleSuccess(),o.x4.ok(t))}))}};let AngleSnapEventHandler=class AngleSnapEventHandler extends SnapEventHandler{center;planeAngle;plane;constructor(e,t,r,i,a){if(!a.plane)throw Error("AngleSnapEventHandler: no plane");let s=new ObjectSnap(o.De.instance.snapType,a.refPoint);super(e,t,[s,new TrackingSnap(r,!1),new PlaneSnap(a.plane,r)],a),this.center=r,this.formatAnglePrompt=e=>e?.point?(this.planeAngle.movePoint(e.point),`${this.planeAngle.angle.toFixed(2)} \xb0`):"";let n=i.sub(r()).normalize();this.plane=new o.JO(r(),a.plane().normal,n),this.planeAngle=new o.n4(this.plane),a.prompt??=this.formatAnglePrompt}formatAnglePrompt;inputError(e){return isNaN(Number.parseFloat(e))?"error.input.invalidNumber":void 0}getPointFromInput(e,t){let r=Number.parseFloat(t)*Math.PI/180,i=this.plane.xvec.rotate(this.plane.normal,r);return{point:this.center().add(i),view:e,shapes:[],plane:this.plane}}};let SnapLengthAtAxisHandler=class SnapLengthAtAxisHandler extends SnapEventHandler{constructor(e,t,r){super(e,t,[new ObjectSnap(o.De.instance.snapType,()=>r.point),new AxisSnap(r.point,r.direction)],r)}getPointFromInput(e,t){let r=this.calculateDistance(Number(t));return{view:e,point:this.calculatePoint(r),distance:r,shapes:[]}}calculateDistance(e){return this.shouldReverse()?-e:e}calculatePoint(e){return this.data.point.add(this.data.direction.multiply(e))}shouldReverse(){return this._snaped?.point&&this._snaped.point.sub(this.data.point).dot(this.data.direction)<-o.Gc.Distance}inputError(e){return Number.isNaN(Number(e))?"error.input.invalidNumber":void 0}};let SnapLengthAtPlaneHandler=class SnapLengthAtPlaneHandler extends SnapEventHandler{lengthData;workplane;constructor(e,t,r){let i=new ObjectSnap(o.De.instance.snapType,r.point);super(e,t,[i,new TrackingSnap(r.point,!1),new PlaneSnap(r.plane,r.point)],r),this.lengthData=r}setSnaped(e,t){super.setSnaped(e,t),this.updateWorkplane()}updateWorkplane(){this._snaped&&(this.workplane=this.lengthData.plane(this._snaped.point),this._snaped.plane=this.workplane)}getPointFromInput(e,t){let r=this.workplane??e.workplane;return{point:this.calculatePoint(t,r),view:e,shapes:[],plane:r}}calculatePoint(e,t){let r=e.split(",").map(Number);return 1===r.length?this.calculatePointFromDistance(r[0]):this.calculatePointFromCoordinates(r,t)}calculatePointFromDistance(e){let t=this._snaped?.point.sub(this.data.point()).normalize();return this.data.point().add(t.multiply(e))}calculatePointFromCoordinates(e,t){return this.data.point().add(t.xvec.multiply(e[0])).add(t.yvec.multiply(e[1]))}inputError(e){let t=e.split(",").map(Number);if(t.some(Number.isNaN)||1!==t.length&&2!==t.length)return"error.input.invalidNumber"}};let PointSnapEventHandler=class PointSnapEventHandler extends SnapEventHandler{constructor(e,t,r){let i=new ObjectSnap(o.De.instance.snapType,r.refPoint);super(e,t,[i,new TrackingSnap(r.refPoint,!0),r.plane?new PlaneSnap(r.plane,r.refPoint):new WorkplaneSnap(r.refPoint)],r)}getPointFromInput(e,t){let r=this.parseInputDimensions(t),i=this.getRefPoint()??o.vY.zero,a={point:i,view:e,shapes:[]};return 1===r.length&&this._snaped?.point?a.point=this.calculatePointFromDistance(i,r[0]):r.length>1&&(a.point=this.calculatePointFromCoordinates(i,r)),a}parseInputDimensions(e){return e.split(",").map(Number)}calculatePointFromDistance(e,t){let r=this._snaped.point.sub(e).normalize();return e.add(r.multiply(t))}calculatePointFromCoordinates(e,t){let r=this.data.plane?.()??this.snaped.view.workplane,i=e.add(r.xvec.multiply(t[0])).add(r.yvec.multiply(t[1]));return 3===t.length&&(i=i.add(r.normal.multiply(t[2]))),i}inputError(e){let t=this.parseInputDimensions(e),r=h.from(t.length);return this.isValidDimension(r)?this.hasInvalidNumbers(t)?"error.input.invalidNumber":this.requiresThreeNumbers(t)?"error.input.threeNumberCanBeInput":this.isInvalidSingleNumber(t)?"error.input.cannotInputANumber":void 0:"error.input.unsupportedInputs"}isValidDimension(e){return h.contains(this.data.dimension,e)}hasInvalidNumbers(e){return e.some(Number.isNaN)}requiresThreeNumbers(e){return void 0===this.getRefPoint()&&3!==e.length}isInvalidSingleNumber(e){let t=this.getRefPoint();return 1===e.length&&t&&(!this._snaped||this._snaped.point.isEqualTo(t))}getRefPoint(){return this.data.refPoint?.()??this._snaped?.refPoint}};let SnapPointOnCurveEventHandler=class SnapPointOnCurveEventHandler extends SnapEventHandler{constructor(e,t,r){let i=new ObjectSnap(o.De.instance.snapType);super(e,t,[i,new PointOnCurveSnap(r),new WorkplaneSnap],r)}getPointFromInput(e,t){let r=this.data.curve.length(),i=Number(t)/r;return{point:this.data.curve.value(i),view:e,shapes:[]}}inputError(e){return Number.isNaN(Number(e))?"error.input.invalidNumber":void 0}};let SnapStep=class SnapStep{tip;handleStepData;keepSelected;constructor(e,t,r=!1){this.tip=e,this.handleStepData=t,this.keepSelected=r}async execute(e,t){this.keepSelected||(e.selection.clearSelection(),e.visual.highlighter.clear());let r=this.handleStepData();this.setValidator(r);let i=this.getEventHandler(e,t,r);return await e.selection.pickAsync(i,this.tip,t,!1,"draw"),t.result?.status==="success"?i.snaped:void 0}setValidator(e){let t=e.validator;e.validator=r=>t?t(r)&&this.validator(e,r):this.validator(e,r)}};function defaultSnapedData(){return{dimension:h.D1D2D3}}let AngleStep=class AngleStep extends SnapStep{handleCenter;handleP1;constructor(e,t,r,i=defaultSnapedData,a=!1){super(e,i,a),this.handleCenter=t,this.handleP1=r}getEventHandler(e,t,r){return new AngleSnapEventHandler(e,t,this.handleCenter,this.handleP1(),r)}validator(e,t){return void 0===e.refPoint||e.refPoint().distanceTo(t)>o.Gc.Distance}};let LengthAtAxisStep=class LengthAtAxisStep extends SnapStep{getEventHandler(e,t,r){return new SnapLengthAtAxisHandler(e,t,r)}validator(e,t){return Math.abs(t.sub(e.point).dot(e.direction))>o.Gc.Distance}};let LengthAtPlaneStep=class LengthAtPlaneStep extends SnapStep{getEventHandler(e,t,r){return new SnapLengthAtPlaneHandler(e,t,r)}validator(e,t){return e.plane(t).project(t).distanceTo(e.point())>o.Gc.Distance}};function pointStep_defaultSnapedData(){return{dimension:h.D1|h.D1D2D3}}let PointStep=class PointStep extends SnapStep{constructor(e,t=pointStep_defaultSnapedData,r=!1){super(e,t,r)}getEventHandler(e,t,r){return new PointSnapEventHandler(e,t,r)}validator(e,t){return void 0===e.refPoint||e.refPoint().distanceTo(t)>o.Gc.Distance}};let PointOnCurveStep=class PointOnCurveStep extends SnapStep{constructor(e,t,r=!1){super(e,t,r)}validator(e,t){return!0}getEventHandler(e,t,r){return new SnapPointOnCurveEventHandler(e,t,r)}};let SelectStep=class SelectStep{snapeType;prompt;options;constructor(e,t,r){this.snapeType=e,this.prompt=t,this.options=r}async execute(e,t){let{shapeType:r,shapeFilter:i}=e.selection;e.selection.shapeType=this.snapeType,e.selection.shapeFilter=this.options?.shapeFilter,this.options?.keepSelection||(e.selection.clearSelection(),e.visual.highlighter.clear());try{return await this.select(e,t)}finally{e.selection.shapeType=r,e.selection.shapeFilter=i}}};let SelectShapeStep=class SelectShapeStep extends SelectStep{async select(e,t){let r=await e.selection.pickShape(this.prompt,t,this.options?.multiple===!0,this.options?.selectedState);if(0!==r.length)return{view:e.application.activeView,shapes:r,nodes:r.map(e=>e.owner.node)}}};let SelectNodeStep=class SelectNodeStep{prompt;options;constructor(e,t){this.prompt=e,this.options=t}async execute(e,t){let{nodeFilter:r}=e.selection;e.selection.nodeFilter=this.options?.filter,this.options?.keepSelection||(e.selection.clearSelection(),e.visual.highlighter.clear());try{let r=await e.selection.pickNode(this.prompt,t,this.options?.multiple===!0);if(0===r.length)return;return{view:e.application.activeView,shapes:[],nodes:r}}finally{e.selection.nodeFilter=r}}};let GetOrSelectNodeStep=class GetOrSelectNodeStep extends SelectNodeStep{execute(e,t){let r=e.selection.getSelectedNodes().filter(e=>!this.options?.filter?.allow||this.options.filter.allow(e));return r.length>0?(t.success(),Promise.resolve({view:e.application.activeView,shapes:[],nodes:r})):super.execute(e,t)}};function multistepCommand_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let multistepCommand_MultistepCommand=class multistepCommand_MultistepCommand extends o.uu{stepDatas=[];get repeatOperation(){return this.getPrivateValue("repeatOperation",!1)}set repeatOperation(e){this.setProperty("repeatOperation",e)}canExcute(){return Promise.resolve(!0)}async executeAsync(){await this.canExcute()&&await this.executeSteps()&&(this.executeMainTask(),this.repeatOperation&&(this.resetSteps(),await this.executeAsync()))}async executeSteps(){let e=this.getSteps();try{for(;this.stepDatas.length<e.length;){this.controller=new o.Op;let t=await e[this.stepDatas.length].execute(this.document,this.controller);if(void 0===t||this.controller.result?.status!=="success")return!1;this.stepDatas.push(t)}return!0}finally{this.document.selection.clearSelection(),this.document.visual.highlighter.clear()}}resetSteps(){this.stepDatas.length=0}meshPoint(e){return o.zp.from(e,o.OI.editVertexSize,o.OI.editVertexColor)}meshLine(e,t,r=o.OI.defaultEdgeColor,i){let a=o.bj.from(e,t,r,o.SP.Solid);return void 0!==i&&(a.lineWidth=i),a}meshCreatedShape(e,...t){let r=this.application.shapeFactory[e](...t);return this.meshShape(r)}meshShape(e,t=!0){if(e instanceof o.x4&&!e.isOk)throw e.error;let r=e instanceof o.x4?e.value:e,i=r.edgesMeshPosition();return t&&r.dispose(),i}findPlane=(e,t,r)=>void 0!==r&&o.De.instance.dynamicWorkplane?l.b3.raycastClosestPlane(e,t,r):e.workplane.translateTo(t);transformdFirstShape(e,t=!0){let r=e.shapes[0].shape.transformedMul(e.shapes[0].transform);return t&&this.disposeStack.add(r),r}};function commands_boolean_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}multistepCommand_ts_decorate([o.Z9.define("option.command.repeat")],multistepCommand_MultistepCommand.prototype,"repeatOperation",null);let BooleanOperate=class BooleanOperate extends multistepCommand_MultistepCommand{executeMainTask(){o.YW.execute(this.document,"boolean",()=>{let e=this.transformdFirstShape(this.stepDatas[0]),t=this.transformdFirstShape(this.stepDatas[1]),r=this.getBooleanOperateType(),i=this.getBooleanShape(r,e,t);if(!i.isOk)return void o.pS.default.pub("showToast","error.default:{0}","boolean failed");let a=new BooleanNode(this.document,i.value);this.document.rootNode.add(a),this.stepDatas.forEach(e=>e.nodes?.[0]?.parent?.remove(e.nodes[0])),this.document.visual.update()})}getBooleanShape(e,t,r){switch(e){case"common":return this.application.shapeFactory.booleanCommon(t,r);case"cut":return this.application.shapeFactory.booleanCut(t,r);default:return this.application.shapeFactory.booleanFuse(t,r)}}getSteps(){return[new SelectShapeStep(o.ax.Shape,"prompt.select.shape",{nodeFilter:{allow:e=>e instanceof o.EK}}),new SelectShapeStep(o.ax.Shape,"prompt.select.shape",{nodeFilter:{allow:e=>e instanceof o.EK&&!this.stepDatas[0].nodes?.map(e=>e.shape.value).includes(e.shape.value)},keepSelection:!0})]}};let BooleanCommon=class BooleanCommon extends BooleanOperate{getBooleanOperateType(){return"common"}};BooleanCommon=commands_boolean_ts_decorate([(0,o.WD)({key:"boolean.common",icon:"icon-booleanCommon"})],BooleanCommon);let BooleanCut=class BooleanCut extends BooleanOperate{getBooleanOperateType(){return"cut"}};BooleanCut=commands_boolean_ts_decorate([(0,o.WD)({key:"boolean.cut",icon:"icon-booleanCut"})],BooleanCut);let BooleanFuse=class BooleanFuse extends BooleanOperate{getBooleanOperateType(){return"fuse"}};function arc_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}BooleanFuse=commands_boolean_ts_decorate([(0,o.WD)({key:"boolean.fuse",icon:"icon-booleanFuse"})],BooleanFuse);let ArcNode=class ArcNode extends o.gR{display(){return"body.arc"}get center(){return this.getPrivateValue("center")}set center(e){this.setPropertyEmitShapeChanged("center",e)}get start(){return this.getPrivateValue("start")}get normal(){return this.getPrivateValue("normal")}get angle(){return this.getPrivateValue("angle")}set angle(e){this.setPropertyEmitShapeChanged("angle",e)}constructor(e,t,r,i,a){super(e),this.setPrivateValue("normal",t),this.setPrivateValue("center",r),this.setPrivateValue("start",i),this.setPrivateValue("angle",a)}generateShape(){return this.document.application.shapeFactory.arc(this.normal,this.center,this.start,this.angle)}};function createCommand_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}arc_ts_decorate([o.ei.serialze(),o.Z9.define("circle.center")],ArcNode.prototype,"center",null),arc_ts_decorate([o.ei.serialze(),o.Z9.define("arc.start")],ArcNode.prototype,"start",null),arc_ts_decorate([o.ei.serialze()],ArcNode.prototype,"normal",null),arc_ts_decorate([o.ei.serialze(),o.Z9.define("arc.angle")],ArcNode.prototype,"angle",null),ArcNode=arc_ts_decorate([o.ei.register(["document","normal","center","start","angle"])],ArcNode);let CreateCommand=class CreateCommand extends multistepCommand_MultistepCommand{executeMainTask(){o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{let e=this.geometryNode();this.document.addNode(e),this.document.visual.update()})}};let CreateFaceableCommand=class CreateFaceableCommand extends CreateCommand{_isFace=!1;get isFace(){return this._isFace}set isFace(e){this.setProperty("isFace",e)}};function create_arc_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}createCommand_ts_decorate([o.Z9.define("option.command.isFace")],CreateFaceableCommand.prototype,"isFace",null);let Arc=class Arc extends CreateCommand{_planeAngle;getSteps(){return[new PointStep("operate.pickCircleCenter"),new LengthAtPlaneStep("operate.pickRadius",this.getRadiusData),new AngleStep("operate.pickNextPoint",()=>this.stepDatas[0].point,()=>this.stepDatas[1].point,this.getAngleData)]}getRadiusData=()=>{let{point:e,view:t}=this.stepDatas[0];return{point:()=>e,preview:this.circlePreview,plane:r=>this.findPlane(t,e,r),validator:t=>!(t.distanceTo(e)<o.Gc.Distance)&&!1===t.sub(e).isParallelTo(this.stepDatas[0].view.workplane.normal)}};getAngleData=()=>{let[e,t]=[this.stepDatas[0].point,this.stepDatas[1].point],r=this.stepDatas[1].plane??this.findPlane(this.stepDatas[1].view,e,t),i=[this.meshPoint(e),this.meshPoint(t)];return this._planeAngle=new o.n4(new o.JO(e,r.normal,t.sub(e))),{dimension:h.D1D2,preview:r=>this.anglePreview(r,e,t,i),plane:()=>r,validators:[this.angleValidator(e,r)]}};anglePreview(e,t,r,i){e=e??r,this._planeAngle.movePoint(e);let a=[...i];return Math.abs(this._planeAngle.angle)>o.Gc.Angle&&a.push(this.meshCreatedShape("arc",this._planeAngle.plane.normal,t,r,this._planeAngle.angle)),a}angleValidator(e,t){return r=>r.distanceTo(e)>=o.Gc.Distance&&!r.sub(e).isParallelTo(t.normal)}geometryNode(){let[e,t]=[this.stepDatas[0].point,this.stepDatas[1].point],r=this.stepDatas[1].plane??this.findPlane(this.stepDatas[1].view,e,t);return this._planeAngle?.movePoint(this.stepDatas[2].point),new ArcNode(this.document,r.normal,e,t,this._planeAngle.angle)}circlePreview=e=>{let t=this.meshPoint(this.stepDatas[0].point);if(!e)return[t];let{point:r,view:i}=this.stepDatas[0],a=this.findPlane(i,r,e);return[t,this.meshLine(this.stepDatas[0].point,e),this.meshCreatedShape("circle",a.normal,r,a.projectDistance(r,e))]}};function bezier_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Arc=create_arc_ts_decorate([(0,o.WD)({key:"create.arc",icon:"icon-arc"})],Arc);let BezierCommand=class BezierCommand extends CreateCommand{geometryNode(){let e=this.application.shapeFactory.bezier(this.stepDatas.map(e=>e.point));return new o.gC(this.document,o.oc.translate("command.create.bezier"),e.value)}async executeSteps(){let e=this.getSteps(),t=!0;for(;;){let r=t?e[0]:e[1];t&&(t=!1),this.controller=new o.Op;let i=await r.execute(this.document,this.controller);if(void 0===i)return this.controller.result?.status==="success";this.stepDatas.push(i)}}getSteps(){return[new PointStep("operate.pickFistPoint"),new PointStep("operate.pickNextPoint",this.getNextData)]}getNextData=()=>({refPoint:()=>this.stepDatas.at(-1).point,dimension:h.D1D2D3,validator:this.validator,preview:this.preview});preview=e=>{let t=this.stepDatas.map(e=>this.meshPoint(e.point)),r=this.stepDatas.map(e=>e.point);return e&&r.push(e),r.length>1&&(t.push(...this.previewLines(r)),t.push(this.meshCreatedShape("bezier",r))),t};previewLines=e=>{if(e.length<2)return[];let t=[];for(let r=1;r<e.length;r++)t.push(this.meshHandle(e[r-1],e[r]));return t};meshHandle(e,t){return o.bj.from(e,t,o.OI.temporaryEdgeColor,o.SP.Dash)}validator=e=>{for(let t of this.stepDatas)if(.001>e.distanceTo(t.point))return!1;return!0}};function create_rect_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}BezierCommand=bezier_ts_decorate([(0,o.WD)({key:"create.bezier",icon:"icon-bezier"})],BezierCommand),(n||(n={})).get=function(e,t,r){let i=new o.JO(t,e.normal,e.xvec),a=r.sub(t),s=a.dot(i.xvec),n=a.dot(i.yvec);return{plane:i,dx:s,dy:n,p1:t,p2:r}};let RectCommandBase=class RectCommandBase extends CreateCommand{getSteps(){return[new PointStep("operate.pickFistPoint"),new LengthAtPlaneStep("operate.pickNextPoint",this.nextSnapData)]}nextSnapData=()=>{let{point:e,view:t}=this.stepDatas[0];return{point:()=>e,preview:this.previewRect,plane:r=>this.findPlane(t,e,r),validator:this.handleValid,prompt:e=>{let t=this.rectDataFromTemp(e.point);return`${t.dx.toFixed(2)}, ${t.dy.toFixed(2)}`}}};handleValid=e=>{let t=this.rectDataFromTemp(e);return void 0!==t&&!o.M8.anyEqualZero(t.dx,t.dy)};previewRect=e=>{if(void 0===e)return[this.meshPoint(this.stepDatas[0].point)];let{plane:t,dx:r,dy:i}=this.rectDataFromTemp(e);return[this.meshPoint(this.stepDatas[0].point),this.meshPoint(e),this.meshCreatedShape("rect",t,r,i)]};rectDataFromTemp(e){let{view:t,point:r}=this.stepDatas[0],i=o.De.instance.dynamicWorkplane?l.b3.raycastClosestPlane(t,r,e):this.stepDatas[0].view.workplane.translateTo(r);return n.get(i,r,e)}rectDataFromTwoSteps(){let e;return this.stepDatas[1].plane?n.get(this.stepDatas[1].plane,this.stepDatas[0].point,this.stepDatas[1].point):this.rectDataFromTemp(this.stepDatas[1].point)}};let Rect=class Rect extends RectCommandBase{get isFace(){return this.getPrivateValue("isFace",!1)}set isFace(e){this.setProperty("isFace",e)}geometryNode(){let{plane:e,dx:t,dy:r}=this.rectDataFromTwoSteps(),i=new RectNode(this.document,e,t,r);return i.isFace=this.isFace,i}};function create_box_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}create_rect_ts_decorate([o.Z9.define("option.command.isFace")],Rect.prototype,"isFace",null),Rect=create_rect_ts_decorate([(0,o.WD)({key:"create.rect",icon:"icon-rect"})],Rect);let Box=class Box extends RectCommandBase{getSteps(){return[...super.getSteps(),new LengthAtAxisStep("operate.pickNextPoint",this.getHeightStepData)]}getHeightStepData=()=>{let e=this.stepDatas[1].plane;if(void 0===e)throw Error("plane is undefined, please report bug");return{point:this.stepDatas[1].point,direction:e.normal,preview:this.previewBox}};previewBox=e=>{if(!e)return this.previewRect(this.stepDatas[1].point);let{plane:t,dx:r,dy:i}=this.rectDataFromTwoSteps();return[this.meshPoint(this.stepDatas[0].point),this.meshPoint(this.stepDatas[1].point),this.meshCreatedShape("box",t,r,i,this.getHeight(t,e))]};geometryNode(){let e=this.rectDataFromTwoSteps(),t=this.getHeight(e.plane,this.stepDatas[2].point);return new BoxNode(this.document,e.plane,e.dx,e.dy,t)}getHeight(e,t){let r=t.sub(this.stepDatas[1].point).dot(e.normal);return Math.abs(r)<o.Gc.Distance?r<0?-1e-5:1e-5:r}};function create_circle_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Box=create_box_ts_decorate([(0,o.WD)({key:"create.box",icon:"icon-box"})],Box);let Circle=class Circle extends CreateFaceableCommand{getSteps(){return[new PointStep("operate.pickCircleCenter"),new LengthAtPlaneStep("operate.pickRadius",this.getRadiusData)]}getRadiusData=()=>{let{point:e,view:t}=this.stepDatas[0];return{point:()=>e,preview:this.circlePreview,plane:r=>this.findPlane(t,e,r),validator:r=>{if(r.distanceTo(e)<o.Gc.Distance)return!1;let i=this.findPlane(t,e,r);return!1===r.sub(e).isParallelTo(i.normal)}}};geometryNode(){let[e,t]=[this.stepDatas[0].point,this.stepDatas[1].point],r=this.stepDatas[1].plane??this.findPlane(this.stepDatas[1].view,e,t),i=new CircleNode(this.document,r.normal,e,r.projectDistance(e,t));return i.isFace=this.isFace,i}circlePreview=e=>{if(!e)return[this.meshPoint(this.stepDatas[0].point)];let{point:t,view:r}=this.stepDatas[0],i=this.findPlane(r,t,e);return[this.meshPoint(this.stepDatas[0].point),this.meshLine(t,e),this.meshCreatedShape("circle",i.normal,t,i.projectDistance(t,e))]}};function create_cone_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Circle=create_circle_ts_decorate([(0,o.WD)({key:"create.circle",icon:"icon-circle"})],Circle);let Cone=class Cone extends CreateCommand{getSteps(){return[new PointStep("operate.pickCircleCenter"),new LengthAtPlaneStep("operate.pickRadius",this.getRadiusData),new LengthAtAxisStep("operate.pickNextPoint",this.getHeightStepData)]}getRadiusData=()=>{let e=this.stepDatas[0].point;return{point:()=>e,preview:this.circlePreview,plane:t=>this.findPlane(this.stepDatas[0].view,e,t),validator:t=>{if(t.distanceTo(e)<o.Gc.Distance)return!1;let r=this.findPlane(this.stepDatas[0].view,e,t);return!1===t.sub(e).isParallelTo(r.normal)}}};circlePreview=e=>{if(!e)return[this.meshPoint(this.stepDatas[0].point)];let t=this.stepDatas[0].point,r=this.findPlane(this.stepDatas[0].view,t,e);return[this.meshPoint(this.stepDatas[0].point),this.meshLine(t,e),this.meshCreatedShape("circle",r.normal,t,r.projectDistance(t,e))]};getHeightStepData=()=>({point:this.stepDatas[0].point,direction:this.stepDatas[1].plane.normal,preview:this.previewCone});previewCone=e=>{if(!e)return this.circlePreview(this.stepDatas[1].point);let t=this.stepDatas[0].point,r=this.meshPoint(t),i=this.stepDatas[1].plane,a=i.projectDistance(t,this.stepDatas[1].point),s=t.add(i.normal.multiply(this.getHeight(i,e)));return[r,this.meshCreatedShape("circle",i.normal,t,a),this.meshLine(t.add(i.xvec.multiply(a)),s),this.meshLine(t.add(i.xvec.multiply(-a)),s),this.meshLine(t.add(i.yvec.multiply(a)),s),this.meshLine(t.add(i.yvec.multiply(-a)),s)]};meshLine(e,t){return o.bj.from(e,t,o.OI.defaultEdgeColor,o.SP.Solid)}geometryNode(){let e=this.stepDatas[1].plane,t=e.projectDistance(this.stepDatas[0].point,this.stepDatas[1].point),r=this.getHeight(e,this.stepDatas[2].point);return new ConeNode(this.document,r<0?e.normal.reverse():e.normal,this.stepDatas[0].point,t,Math.abs(r))}getHeight(e,t){return t.sub(this.stepDatas[0].point).dot(e.normal)}};function face_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Cone=create_cone_ts_decorate([(0,o.WD)({key:"create.cone",icon:"icon-cone"})],Cone);let FaceNode=class FaceNode extends o.gR{display(){return"body.face"}get shapes(){return this.getPrivateValue("shapes")}set shapes(e){this.setPropertyEmitShapeChanged("shapes",e)}constructor(e,t){super(e),this.setPrivateValue("shapes",t)}isAllClosed(){return this.shapes.every(e=>e.isClosed()||e.shapeType===o.ax.Wire)}getWires(){let e=[];this.isAllClosed()?this.addClosedEdges(e,this.shapes):this.addUnclosedEdges(e,this.shapes);for(let t=1;t<e.length;t++)e[t].reserve();return e}addClosedEdges(e,t){for(let t of this.shapes)t.shapeType===o.ax.Wire?e.push(t):this.addUnclosedEdges(e,[t])}addUnclosedEdges(e,t){let r=this.document.application.shapeFactory.wire(t);if(!r.isOk)throw Error("Cannot create wire from open shapes");e.push(r.value)}generateShape(){if(0===this.shapes.length)return o.x4.err("No shapes to create face");let e=this.getWires();return this.document.application.shapeFactory.face(e)}};function wire_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}face_ts_decorate([o.ei.serialze()],FaceNode.prototype,"shapes",null),FaceNode=face_ts_decorate([o.ei.register(["document","shapes"])],FaceNode);let WireNode=class WireNode extends o.gR{display(){return"body.wire"}get edges(){return this.getPrivateValue("edges")}set edges(e){this.setPropertyEmitShapeChanged("edges",e)}constructor(e,t){super(e),this.setPrivateValue("edges",t)}generateShape(){return this.document.application.shapeFactory.wire(this.edges)}};function converter_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}wire_ts_decorate([o.ei.serialze()],WireNode.prototype,"edges",null),WireNode=wire_ts_decorate([o.ei.register(["document","edges"])],WireNode);let ConvertCommand=class ConvertCommand extends o.uu{async executeAsync(){let e=await this.getOrPickModels(this.document);if(!e)return void o.pS.default.pub("showToast","toast.select.noSelected");o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{let t=this.create(this.document,e);t.isOk?(this.document.rootNode.add(t.value),this.document.visual.update(),o.pS.default.pub("showToast","toast.success")):o.pS.default.pub("showToast","toast.converter.error"),e.forEach(e=>e.parent?.remove(e))})}shapeFilter(){return{allow:e=>e.shapeType===o.ax.Edge||e.shapeType===o.ax.Wire}}async getOrPickModels(e){let t=this.shapeFilter(),r=this._getSelectedModels(e,t);if(e.selection.clearSelection(),r.length>0)return r;let i=new SelectNodeStep("prompt.select.models",{filter:new o._J(t),multiple:!0});this.controller=new o.Op;let a=await i.execute(e,this.controller);return e.selection.clearSelection(),a?.nodes}_getSelectedModels(e,t){return e.selection.getSelectedNodes().map(e=>e).filter(e=>{if(void 0===e)return!1;let r=e.shape.value;return void 0!==r&&(void 0===t||!!t.allow(r))})}};let ConvertToWire=class ConvertToWire extends ConvertCommand{create(e,t){let r=t.map(e=>e.shape.value.transformedMul(e.worldTransform())),i=new WireNode(e,r),a=i.generateShape();return a.isOk?o.x4.ok(i):o.x4.err(a.error)}};ConvertToWire=converter_ts_decorate([(0,o.WD)({key:"convert.toWire",icon:"icon-toPoly"})],ConvertToWire);let ConvertToFace=class ConvertToFace extends ConvertCommand{create(e,t){let r=t.map(e=>e.shape.value.transformedMul(e.worldTransform())),i=new FaceNode(e,r),a=i.generateShape();return a.isOk?o.x4.ok(i):o.x4.err(a.error)}};ConvertToFace=converter_ts_decorate([(0,o.WD)({key:"convert.toFace",icon:"icon-toFace"})],ConvertToFace);let ConvertToShell=class ConvertToShell extends ConvertCommand{shapeFilter(){return{allow:e=>e.shapeType===o.ax.Face}}create(e,t){let r=t.map(e=>e.shape.value.transformedMul(e.worldTransform())),i=this.application.shapeFactory.shell(r);if(r.forEach(e=>e.dispose()),!i.isOk)return o.x4.err(i.error);let a=new o.gC(e,"shell",i);return o.x4.ok(a)}};ConvertToShell=converter_ts_decorate([(0,o.WD)({key:"convert.toShell",icon:"icon-toShell"})],ConvertToShell);let ConvertToSolid=class ConvertToSolid extends ConvertCommand{shapeFilter(){return{allow:e=>e.shapeType===o.ax.Shell}}create(e,t){let r=t.map(e=>e.shape.value.transformedMul(e.worldTransform())),i=this.application.shapeFactory.solid(r);if(r.forEach(e=>e.dispose()),!i.isOk)return o.x4.err(i.error);let a=new o.gC(e,"solid",i);return o.x4.ok(a)}};function copySubShape_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}ConvertToSolid=converter_ts_decorate([(0,o.WD)({key:"convert.toSolid",icon:"icon-toSolid"})],ConvertToSolid);let CopySubShapeCommand=class CopySubShapeCommand extends multistepCommand_MultistepCommand{executeMainTask(){o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{this.stepDatas[0].shapes.forEach(e=>{let t=e.shape.clone(),r=new o.gC(this.document,o.ax.stringValue(t.shapeType),t),i=e.owner.node;r.transform=i.transform,i.parent.insertAfter(i,r)}),this.document.visual.update(),o.pS.default.pub("showToast","toast.success")})}getSteps(){return[new SelectShapeStep(o.ax.Edge|o.ax.Face,"prompt.select.shape",{multiple:!0})]}};function create_cylinder_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}CopySubShapeCommand=copySubShape_ts_decorate([(0,o.WD)({key:"create.copyShape",icon:"icon-subShape"})],CopySubShapeCommand);let Cylinder=class Cylinder extends CreateCommand{getSteps(){return[new PointStep("operate.pickCircleCenter"),new LengthAtPlaneStep("operate.pickRadius",this.getRadiusData),new LengthAtAxisStep("operate.pickNextPoint",this.getHeightStepData)]}getRadiusData=()=>{let{point:e,view:t}=this.stepDatas[0];return{point:()=>e,preview:this.circlePreview,plane:r=>this.findPlane(t,e,r),validator:r=>{if(r.distanceTo(e)<o.Gc.Distance)return!1;let i=this.findPlane(t,e,r);return!1===r.sub(e).isParallelTo(i.normal)}}};circlePreview=e=>{if(!e)return[this.meshPoint(this.stepDatas[0].point)];let t=this.stepDatas[0].point,r=this.findPlane(this.stepDatas[0].view,t,e);return[this.meshPoint(this.stepDatas[0].point),this.meshLine(t,e),this.meshCreatedShape("circle",r.normal,t,r.projectDistance(t,e))]};getHeightStepData=()=>({point:this.stepDatas[0].point,direction:this.stepDatas[1].plane.normal,preview:this.previewCylinder,validator:e=>Math.abs(this.getHeight(this.stepDatas[1].plane,e))>.001});previewCylinder=e=>{if(!e)return this.circlePreview(this.stepDatas[1].point);let t=this.stepDatas[1].plane,r=t.projectDistance(this.stepDatas[0].point,this.stepDatas[1].point),i=this.getHeight(t,e);return[this.meshPoint(this.stepDatas[0].point),this.meshCreatedShape("cylinder",i<0?t.normal.reverse():t.normal,this.stepDatas[0].point,r,Math.abs(i))]};geometryNode(){let e=this.stepDatas[1].plane,t=e.projectDistance(this.stepDatas[0].point,this.stepDatas[1].point),r=this.getHeight(e,this.stepDatas[2].point);return new CylinderNode(this.document,r<0?e.normal.reverse():e.normal,this.stepDatas[0].point,t,Math.abs(r))}getHeight(e,t){return t.sub(this.stepDatas[0].point).dot(e.normal)}};function create_ellipse_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Cylinder=create_cylinder_ts_decorate([(0,o.WD)({key:"create.cylinder",icon:"icon-cylinder"})],Cylinder);let Ellipse=class Ellipse extends CreateFaceableCommand{getSteps(){return[new PointStep("operate.pickCircleCenter"),new LengthAtPlaneStep("operate.pickRadius",this.getRadius1Data),new LengthAtAxisStep("operate.pickRadius",this.getRadius2Data)]}getRadius1Data=()=>{let e=this.stepDatas[0].point;return{point:()=>e,preview:this.previewCircle,plane:t=>this.findPlane(this.stepDatas[0].view,e,t),validator:this.validatePoint}};validatePoint=e=>{let t=this.stepDatas[0].point;if(e.distanceTo(t)<o.Gc.Distance)return!1;let r=this.findPlane(this.stepDatas[0].view,t,e);return!1===e.sub(t).isParallelTo(r.normal)};previewCircle=e=>{if(void 0===e)return[this.meshPoint(this.stepDatas[0].point)];let t=this.findPlane(this.stepDatas[0].view,this.stepDatas[0].point,e);return[this.meshPoint(this.stepDatas[0].point),this.meshPoint(e),this.meshCreatedShape("circle",t.normal,this.stepDatas[0].point,e.distanceTo(this.stepDatas[0].point))]};getRadius2Data=()=>{let e=this.stepDatas[0].point,t=this.stepDatas[1].plane.normal.cross(this.stepDatas[1].point.sub(e)).normalize();return{point:e,preview:this.ellipsePreview,direction:t,validator:this.validatePoint}};geometryNode(){let[e,t,r]=[this.stepDatas[0].point,this.stepDatas[1].point,this.stepDatas[2].point],i=this.stepDatas[1].plane,a=i.projectDistance(e,t),s=i.projectDistance(e,r);return new EllipseNode(this.document,i.normal,e,t.sub(e),a,s>a?a:s)}ellipsePreview=e=>e?[this.meshPoint(this.stepDatas[0].point),this.meshPoint(this.stepDatas[1].point),this.createEllipse(e)]:this.previewCircle(this.stepDatas[1].point);createEllipse(e){let t=this.stepDatas[0].point,r=this.stepDatas[1].point,i=this.stepDatas[1].plane,a=i.projectDistance(t,r),s=i.projectDistance(t,e);return this.meshCreatedShape("ellipse",i.normal,t,r.sub(t),a,s>a?a:s)}};function fuse_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Ellipse=create_ellipse_ts_decorate([(0,o.WD)({key:"create.ellipse",icon:"icon-ellipse"})],Ellipse);let Fuse=class Fuse extends CreateCommand{geometryNode(){let e=this.stepDatas[0].shapes[0].shape,[t,r]=e.normal(0,0),i=this.stepDatas[1].point.sub(t).dot(r);return new PrismNode(this.document,e,i)}getSteps(){return[new SelectShapeStep(o.ax.Face,"prompt.select.faces"),new LengthAtAxisStep("operate.pickNextPoint",this.getLengthStepData)]}getLengthStepData=()=>{let e=this.stepDatas[0].shapes[0].shape,[t,r]=e.normal(0,0);return{point:t,direction:r,preview:i=>{if(!i)return[];let a=i.sub(t).dot(r);if(Math.abs(a)<o.Gc.Float)return[];let s=r.multiply(a);return[this.application.shapeFactory.prism(e,s).value.mesh.edges]}}}};function group_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Fuse=fuse_ts_decorate([(0,o.WD)({key:"convert.fuse",icon:"icon-circle"})],Fuse);let GroupDefinition=class GroupDefinition extends o.y${get name(){return this.getPrivateValue("name","unnamed")}set name(e){this.setProperty("name",e)}get insert(){return this.getPrivateValue("insert",o.vY.zero)}set insert(e){this.setProperty("insert",e)}get convertInstance(){return this.getPrivateValue("convertInstance",!0)}set convertInstance(e){this.setProperty("convertInstance",e)}};let GroupCommand=class GroupCommand extends multistepCommand_MultistepCommand{getSteps(){return[new GetOrSelectNodeStep("prompt.select.shape",{multiple:!0})]}executeMainTask(){let e=this.stepDatas[0].nodes?.filter(e=>e instanceof o.S3);if(!e||0===e.length)return void o.pS.default.pub("showToast","toast.select.noSelected");let t=new GroupDefinition;o.pS.default.pub("showDialog","command.create.group",this.dialog(t),r=>{r===o.Xs.ok&&this.createGroup(t,e)})}createGroup(e,t){o.YW.execute(this.document,"create group",()=>{for(let e of t){let t=e.worldTransform();e.parent?.transfer(e),e.transform=t}let r=new o.wA(e.name,this.stepDatas[0].nodes,e.insert);if(this.document.components.push(r),e.convertInstance){let t=new o.sK(this.document,e.name,r.id,r.origin);this.document.rootNode.add(t)}})}pickInsertPoint=async(e,t)=>{let r=this.findDialog(t.target);if(!r)return;r.close();let i=new PickInsertPointCommand(this.document,e);try{if(this.document.application.executingCommand)throw Error("Command is executing");this.document.application.executingCommand=i,await i.execute(this.document.application)}finally{r.showModal(),this.document.application.executingCommand=void 0}};findDialog=e=>e instanceof HTMLDialogElement?e:e.parentElement?this.findDialog(e.parentElement):void 0;dialog(e){return(0,p.hi)({style:{display:"flex",flexDirection:"column",gap:"10px"}},(0,p.PS)({textContent:new o.Xx("common.name")},": "),(0,p.qH)({value:new o.KX(e,"name"),onkeydown:e=>{e.stopPropagation()},onblur:t=>{e.name=t.target.value}}),(0,p.PS)({textContent:new o.Xx("option.command.insertPoint")},": "),(0,p.hi)({style:{display:"inline-flex",flexDirection:"row",padding:"10px",backgroundColor:"#eee",borderRadius:"5px",gap:"6px"}},(0,p.qH)({value:new o.KX(e,"insert",new p.S6),onkeydown:e=>{e.stopPropagation()}}),(0,p.LI)({textContent:new o.Xx("option.command.insertPoint"),onclick:t=>this.pickInsertPoint(e,t)})),(0,p.hi)((0,p.qH)({type:"checkbox",id:"instanceID",checked:new o.KX(e,"convertInstance"),onchange:t=>{e.convertInstance=t.target.checked}})," ",(0,p.PS)({textContent:new o.Xx("option.command.isConvertInstance"),htmlFor:"instanceID"})))}};GroupCommand=group_ts_decorate([(0,o.WD)({key:"create.group",icon:"icon-group"})],GroupCommand);let PickInsertPointCommand=class PickInsertPointCommand{document;defination;constructor(e,t){this.document=e,this.defination=t}async execute(e){let t=new PointStep("option.command.insertPoint"),r=new o.Op,i=await t.execute(this.document,r);i?.point&&(this.defination.insert=i.point)}};function create_line_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let Line=class Line extends CreateCommand{get isContinue(){return this.getPrivateValue("isContinue",!1)}set isContinue(e){this.setProperty("isContinue",e)}geometryNode(){return new LineNode(this.document,this.stepDatas[0].point,this.stepDatas[1].point)}getSteps(){return[new PointStep("operate.pickFistPoint"),new PointStep("operate.pickNextPoint",this.getSecondPointData)]}resetSteps(){this.isContinue?(this.stepDatas[0]=this.stepDatas[1],this.stepDatas.length=1):this.stepDatas.length=0}getSecondPointData=()=>({refPoint:()=>this.stepDatas[0].point,dimension:h.D1D2D3,validator:e=>this.stepDatas[0].point.distanceTo(e)>o.Gc.Distance,preview:this.linePreview});linePreview=e=>e?[this.meshPoint(this.stepDatas[0].point),this.meshLine(this.stepDatas[0].point,e)]:[this.meshPoint(this.stepDatas[0].point)]};function offset_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}create_line_ts_decorate([o.Z9.define("option.command.isConnected",{dependencies:[{property:"repeatOperation",value:!0}]})],Line.prototype,"isContinue",null),Line=create_line_ts_decorate([(0,o.WD)({key:"create.line",icon:"icon-line"})],Line);let OffsetCommand=class OffsetCommand extends multistepCommand_MultistepCommand{executeMainTask(){let e=this.getAxis().normal,t=this.createOffsetShape(e,this.stepDatas[1].distance),r=new o.gC(this.document,o.oc.translate("command.create.offset"),t.value);this.document.rootNode.add(r),this.document.visual.update()}getSteps(){return[new SelectShapeStep(o.ax.Edge|o.ax.Wire|o.ax.Face,"prompt.select.shape"),new LengthAtAxisStep("common.length",()=>{let e=this.getAxis();return{point:e.point,direction:e.direction,preview:t=>this.preview(e,t)}})]}preview(e,t){let r=[this.meshPoint(e.point)];if(void 0!==t){r.push(this.meshLine(e.point,t));let i=t.sub(e.point).dot(e.direction),a=this.createOffsetShape(e.normal,i);a.isOk&&r.push(a.value.edgesMeshPosition())}return r}getAxis(){let e=this.stepDatas[0].shapes[0].point,t=this.transformdFirstShape(this.stepDatas[0]);return t.shapeType===o.ax.Edge?this.getEdgeAxis(t,e):this.getFaceOrWireAxis(t,e)}getFaceOrWireAxis(e,t){let r=e;e.shapeType===o.ax.Wire&&(r=e.toFace().value);let i=r.normal(0,0)[1],{nearest:a,direction:s}=this.getNearstPointAndDirection(e,t,i);return{point:a.point,normal:i,direction:s.cross(i).normalize()}}getEdgeAxis(e,t){let r=e.curve,i=r.dn(r.parameter(t,.001),1),a=c.S.normal(e);return{point:t,normal:a,direction:i.cross(a).normalize()}}getNearstPointAndDirection(e,t,r){let i=e;e.shapeType===o.ax.Face&&(i=e.outerWire());let a=c.S.nearestPoint(i,t),s=c.S.findNextEdge(i,a.edge).value,n=a.edge.curve.dn(0,1),l=a.edge.orientation()===s.orientation()?1:-1,d=s.curve.dn(0,1).multiply(l);return n.cross(d).normalize()?.isOppositeTo(r)&&(n=n.multiply(-1)),{nearest:a,direction:n}}createOffsetShape(e,t){let r=this.transformdFirstShape(this.stepDatas[0]);if(r.shapeType===o.ax.Edge)return r.offset(t,e);let i=r;return r.shapeType===o.ax.Face&&(i=r.outerWire()),i.offset(t,o.AH.intersection)}};function create_polygon_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}OffsetCommand=offset_ts_decorate([(0,o.WD)({key:"create.offset",icon:"icon-offset"})],OffsetCommand);let Polygon=class Polygon extends CreateFaceableCommand{geometryNode(){let e=new PolygonNode(this.document,this.stepDatas.map(e=>e.point));return e.isFace=this.isFace,e}async executeSteps(){let e=this.getSteps(),t=!0;for(;;){let r=t?e[0]:e[1];t&&(t=!1),this.controller=new o.Op;let i=await r.execute(this.document,this.controller);if(void 0===i)return this.controller.result?.status==="success";if(this.stepDatas.push(i),this.isClose(i))return!0}}isClose(e){return this.stepDatas.length>1&&this.stepDatas[0].point.distanceTo(e.point)<=o.Gc.Distance}getSteps(){return[new PointStep("operate.pickFistPoint"),new PointStep("operate.pickNextPoint",this.getNextData)]}getNextData=()=>({refPoint:()=>this.stepDatas.at(-1).point,dimension:h.D1D2D3,validator:this.validator,preview:this.preview,featurePoints:[{point:this.stepDatas.at(0).point,prompt:o.oc.translate("prompt.polygon.close"),when:()=>this.stepDatas.length>2}]});preview=e=>{let t=this.stepDatas.map(e=>this.meshPoint(e.point)),r=new o.G$;return this.stepDatas.forEach(e=>r.addPosition(e.point.x,e.point.y,e.point.z)),e&&r.addPosition(e.x,e.y,e.z),[...t,r.build()]};validator=e=>{for(let t of this.stepDatas)if(.001>e.distanceTo(t.point))return!1;return!0}};function create_prism_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Polygon=create_polygon_ts_decorate([(0,o.WD)({key:"create.polygon",icon:"icon-polygon"})],Polygon);let Prism=class Prism extends CreateCommand{geometryNode(){let e=this.transformdFirstShape(this.stepDatas[0],!1),{point:t,normal:r}=this.getAxis(e),i=this.stepDatas[1].point.sub(t).dot(r);return new PrismNode(this.document,e,i)}getSteps(){return[new SelectShapeStep(o.ax.Face|o.ax.Edge|o.ax.Wire,"prompt.select.shape"),new LengthAtAxisStep("operate.pickNextPoint",this.getLengthStepData,!0)]}getLengthStepData=()=>{let e=this.transformdFirstShape(this.stepDatas[0]),{point:t,normal:r}=this.getAxis(e);return{point:t,direction:r,preview:i=>{if(!i)return[];let a=i.sub(t).dot(r);if(Math.abs(a)<o.Gc.Float)return[];let s=r.multiply(a);return[this.meshCreatedShape("prism",e,s)]}}};getAxis(e){return{point:this.stepDatas[0].shapes[0].point,normal:c.S.normal(e)}}};function create_pyramid_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Prism=create_prism_ts_decorate([(0,o.WD)({key:"convert.prism",icon:"icon-prism"})],Prism);let Pyramid=class Pyramid extends RectCommandBase{getSteps(){return[...super.getSteps(),new LengthAtAxisStep("operate.pickNextPoint",this.getHeightStepData)]}getHeightStepData=()=>{let e=this.stepDatas[1].plane;if(void 0===e)throw Error("plane is undefined, please report bug");return{point:this.stepDatas[1].point.add(this.stepDatas[0].point).multiply(.5),direction:e.normal,preview:this.previewPyramid}};previewPyramid=e=>{if(!e)return this.previewRect(this.stepDatas[1].point);let t=this.rectDataFromTwoSteps();return[this.meshPoint(this.stepDatas[0].point),this.meshPoint(this.stepDatas[1].point),this.meshCreatedShape("pyramid",t.plane,t.dx,t.dy,this.getHeight(t.plane,e))]};geometryNode(){let e=this.rectDataFromTwoSteps(),t=this.getHeight(e.plane,this.stepDatas[2].point);return new PyramidNode(this.document,e.plane,e.dx,e.dy,t)}getHeight(e,t){return t.sub(e.origin).dot(e.normal)}};function create_revolve_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Pyramid=create_pyramid_ts_decorate([(0,o.WD)({key:"create.pyramid",icon:"icon-pyramid"})],Pyramid);let Revolve=class Revolve extends CreateCommand{get angle(){return this.getPrivateValue("angle",360)}set angle(e){this.setProperty("angle",e)}geometryNode(){let e=this.transformdFirstShape(this.stepDatas[0],!1),t=this.stepDatas[1].shapes[0].shape.curve.basisCurve,r=this.stepDatas[1].shapes[0].transform,i=new o.zH(r.ofPoint(t.value(0)),r.ofVector(t.direction));return new RevolvedNode(this.document,e,i,this.angle)}getSteps(){return[new SelectShapeStep(o.ax.Edge|o.ax.Face|o.ax.Wire,"prompt.select.shape"),new SelectShapeStep(o.ax.Edge,"prompt.select.edges",{shapeFilter:new LineFilter,keepSelection:!0})]}};create_revolve_ts_decorate([o.Z9.define("common.angle")],Revolve.prototype,"angle",null),Revolve=create_revolve_ts_decorate([(0,o.WD)({key:"convert.revol",icon:"icon-revolve"})],Revolve);let LineFilter=class LineFilter{allow(e){if(e.shapeType===o.ax.Edge){let t=e.curve.basisCurve;return o.DY.isLine(t)}return!1}};function section_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let Section=class Section extends multistepCommand_MultistepCommand{executeMainTask(){let e=this.transformdFirstShape(this.stepDatas[0]),t=this.transformdFirstShape(this.stepDatas[1]),r=e.section(t),i=new o.gC(this.document,o.oc.translate("command.create.section"),r);this.document.rootNode.add(i),this.document.visual.update()}getSteps(){return[new SelectShapeStep(o.ax.Shape,"prompt.select.shape",{selectedState:o.tR.faceTransparent}),new SelectShapeStep(o.ax.Shape,"prompt.select.shape",{keepSelection:!0})]}};function create_sphere_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Section=section_ts_decorate([(0,o.WD)({key:"create.section",icon:"icon-section"})],Section);let Sphere=class Sphere extends CreateCommand{getSteps(){return[new PointStep("operate.pickCircleCenter"),new LengthAtPlaneStep("operate.pickRadius",this.getRadiusData)]}getRadiusData=()=>{let e=this.stepDatas[0].point;return{point:()=>e,preview:this.previewSphere,plane:()=>this.stepDatas[0].view.workplane.translateTo(e),validator:t=>t.distanceTo(e)>o.Gc.Distance}};previewSphere=e=>{if(!e)return[this.meshPoint(this.stepDatas[0].point)];let t=this.stepDatas[0].point?.distanceTo(e);return[this.meshPoint(this.stepDatas[0].point),this.meshCreatedShape("circle",o.vY.unitZ,this.stepDatas[0].point,t),this.meshCreatedShape("circle",o.vY.unitY,this.stepDatas[0].point,t)]};geometryNode(){let e=this.stepDatas[0].point.distanceTo(this.stepDatas[1].point);return new SphereNode(this.document,this.stepDatas[0].point,e)}};function create_sweep_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Sphere=create_sphere_ts_decorate([(0,o.WD)({key:"create.sphere",icon:"icon-sphere"})],Sphere);let Sweep=class Sweep extends CreateCommand{geometryNode(){let e=this.transformdFirstShape(this.stepDatas[0],!1),t=this.transformdFirstShape(this.stepDatas[1],!1);return new SweepedNode(this.document,e,t)}getSteps(){return[new SelectShapeStep(o.ax.Edge|o.ax.Wire|o.ax.Face,"prompt.select.shape"),new SelectShapeStep(o.ax.Edge|o.ax.Wire,"prompt.select.edges",{keepSelection:!0})]}};function thickSolid_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Sweep=create_sweep_ts_decorate([(0,o.WD)({key:"convert.sweep",icon:"icon-sweep"})],Sweep);let ThickSolidCommand=class ThickSolidCommand extends multistepCommand_MultistepCommand{get thickness(){return this.getPrivateValue("thickness",10)}set thickness(e){this.setProperty("thickness",e)}executeMainTask(){o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{this.stepDatas[0].shapes.forEach(e=>{let t=this.application.shapeFactory.makeThickSolidBySimple(e.shape,this.thickness);if(!t.isOk)return void o.pS.default.pub("showToast","toast.converter.error");let r=new o.gC(this.document,o.oc.translate("command.create.thickSolid"),t),i=e.owner.node;r.transform=i.transform,i.parent.insertAfter(i,r)}),this.document.visual.update(),o.pS.default.pub("showToast","toast.success")})}getSteps(){return[new SelectShapeStep(o.ax.Face,"prompt.select.faces",{multiple:!0})]}};function createActCommand_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}thickSolid_ts_decorate([o.Z9.define("option.command.thickness")],ThickSolidCommand.prototype,"thickness",null),ThickSolidCommand=thickSolid_ts_decorate([(0,o.WD)({key:"create.thickSolid",icon:"icon-thickSolid"})],ThickSolidCommand);let u=0;let ActAlignCameraCommand=class ActAlignCameraCommand{async execute(e){let t=e.activeView;t&&t.document.acts.push(new o.Wj(`${o.oc.translate("ribbon.group.act")} ${u++}`,t.cameraController.cameraPosition,t.cameraController.cameraTarget,t.cameraController.cameraUp))}};function delete_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}ActAlignCameraCommand=createActCommand_ts_decorate([(0,o.WD)({key:"act.alignCamera",icon:"icon-act"})],ActAlignCameraCommand);let Delete=class Delete extends multistepCommand_MultistepCommand{executeMainTask(){let e=this.stepDatas[0].nodes;if(!e||0===e.length)return void o.pS.default.pub("showToast","toast.select.noSelected");this.document.currentNode&&e.includes(this.document.currentNode)&&(this.document.currentNode=this.document.rootNode),this.document.selection.clearSelection(),o.YW.execute(this.document,"delete",()=>{e.forEach(e=>e.parent?.remove(e))}),this.document.visual.update(),o.pS.default.pub("showToast","toast.delete{0}Objects",e.length)}getSteps(){return[new GetOrSelectNodeStep("prompt.select.models",{multiple:!0})]}};function folder_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Delete=delete_ts_decorate([(0,o.WD)({key:"modify.deleteNode",icon:"icon-delete"})],Delete);let m=1;let NewFolder=class NewFolder{async execute(e){let t=e.activeView?.document,r=new o.YT(t,`Folder${m++}`);t.addNode(r)}};function importExport_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}NewFolder=folder_ts_decorate([(0,o.WD)({key:"create.folder",icon:"icon-folder-plus"})],NewFolder);let Import=class Import{async execute(e){let t=e.dataExchange.importFormats().join(","),r=await (0,o.h3)(t,!0);if(!r.isOk||0===r.value.length)return void alert(r.error);importFiles(e,r.value)}};Import=importExport_ts_decorate([(0,o.WD)({key:"file.import",icon:"icon-import"})],Import);let Export=class Export extends o.uu{get formats(){return this.getPrivateValue("formats",this.initCombobox())}set formats(e){this.setProperty("formats",e)}initCombobox(){let e=new o.hQ;return e.items.push(...this.application.dataExchange.exportFormats()),e}async executeAsync(){let e=await this.selectNodesAsync();if(!e||0===e.length)return void o.pS.default.pub("showToast","toast.select.noSelected");o.pS.default.pub("showPermanent",async()=>{let t=this.formats.selectedItem;if(void 0===t)return;let r=await this.application.dataExchange.export(t,e);r&&(o.pS.default.pub("showToast","toast.downloading"),(0,o.LR)(r,`${e[0].name}${t}`))},"toast.excuting{0}",o.oc.translate("command.file.export"))}async selectNodesAsync(){this.controller=new o.Op;let e=new SelectNodeStep("prompt.select.models",{multiple:!0,keepSelection:!0}),t=await e.execute(this.application.activeView?.document,this.controller);return t?.nodes?t.nodes:void o.pS.default.pub("showToast","prompt.select.noModelSelected")}};function angle_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}importExport_ts_decorate([o.Z9.define("file.format")],Export.prototype,"formats",null),Export=importExport_ts_decorate([(0,o.WD)({key:"file.export",icon:"icon-export"})],Export);let AngleMeasure=class AngleMeasure extends multistepCommand_MultistepCommand{getSteps(){let e=new PointStep("operate.pickFistPoint");return[e,new PointStep("operate.pickNextPoint",this.getSecondPointData),new PointStep("operate.pickNextPoint",this.getThirdPointData)]}getSecondPointData=()=>({refPoint:()=>this.stepDatas[0].point,dimension:h.D1D2D3,validator:e=>this.stepDatas[0].point.distanceTo(e)>o.Gc.Distance,preview:this.linePreview});linePreview=e=>e?[this.meshPoint(this.stepDatas[0].point),this.meshLine(this.stepDatas[0].point,e)]:[this.meshPoint(this.stepDatas[0].point)];getThirdPointData=()=>({refPoint:()=>this.stepDatas[0].point,dimension:h.D1D2D3,prompt:e=>this.anglePrompt(e.point),validator:e=>this.stepDatas[0].point.distanceTo(e)>o.Gc.Distance&&this.stepDatas[1].point.distanceTo(e)>o.Gc.Distance,preview:this.arcPreview});anglePrompt=e=>{let{rad:t}=this.arcInfo(e);return(180*t/Math.PI).toFixed(2)+"\xb0"};arcPreview=e=>{let t=[this.meshPoint(this.stepDatas[0].point),this.meshPoint(this.stepDatas[1].point),this.meshLine(this.stepDatas[0].point,this.stepDatas[1].point,o.OI.highlightEdgeColor,3)];if(!e)return t;let{v1:r,rad:i,normal:a}=this.arcInfo(e),s=180*i/Math.PI;if(s<o.Gc.Angle)return t;let n=this.meshLine(this.stepDatas[0].point,e,o.OI.highlightEdgeColor,3),l=this.application.shapeFactory.arc(a,this.stepDatas[0].point,this.stepDatas[0].point.add(r.multiply(.5*this.lineLength(e))),s).unchecked()?.mesh.edges;return l.lineWidth=3,l.color=o.OI.highlightEdgeColor,[n,l,...t]};lineLength(e){let t=this.stepDatas[0].point.distanceTo(this.stepDatas[1].point);return e?Math.min(t,this.stepDatas[0].point.distanceTo(e)):t}arcInfo(e){let t=this.stepDatas[1].point.sub(this.stepDatas[0].point).normalize(),r=e.sub(this.stepDatas[0].point).normalize(),i=t.angleTo(r),a=t.cross(r).normalize();return{v1:t,v2:r,rad:i,normal:a}}executeMainTask(){let{v1:e,rad:t,normal:r}=this.arcInfo(this.stepDatas[2].point),i=e.rotate(r,.5*t).multiply(.5*this.lineLength(this.stepDatas[2].point)).add(this.stepDatas[0].point),a=this.document.visual.context.displayMesh(this.meshPoint(this.stepDatas[2].point),...this.arcPreview(this.stepDatas[2].point));this.application.activeView?.htmlText((180*t/Math.PI).toFixed(2)+"\xb0",i,{onDispose:()=>{this.document.visual.context.removeMesh(a)}})}};function length_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}AngleMeasure=angle_ts_decorate([(0,o.WD)({key:"measure.angle",icon:"icon-measureAngle"})],AngleMeasure);let LengthMeasure=class LengthMeasure extends multistepCommand_MultistepCommand{getSteps(){return[new PointStep("operate.pickFistPoint"),new PointStep("operate.pickNextPoint",this.getSecondPointData)]}getSecondPointData=()=>({refPoint:()=>this.stepDatas[0].point,dimension:h.D1D2D3,validator:e=>this.stepDatas[0].point.distanceTo(e)>o.Gc.Distance,preview:this.linePreview});linePreview=e=>e?[this.meshPoint(this.stepDatas[0].point),this.meshLine(this.stepDatas[0].point,e)]:[this.meshPoint(this.stepDatas[0].point)];executeMainTask(){let e=this.stepDatas[0].point,t=this.stepDatas[1].point,r=e.distanceTo(t),i=this.document.visual.context.displayMesh(this.meshPoint(e),this.meshLine(e,t,o.OI.highlightEdgeColor,3),this.meshPoint(t));this.application.activeView?.htmlText(r.toFixed(2),e.add(t).multiply(.5),{onDispose:()=>{this.document.visual.context.removeMesh(i)}})}};LengthMeasure=length_ts_decorate([(0,o.WD)({key:"measure.length",icon:"icon-measureLength"})],LengthMeasure);var f=r(307);function select_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let SelectMeasure=class SelectMeasure extends o.uu{#n=!1;#o=0;#l;#c=new Set;#d;get category(){return this.#d||(this.#d=this.initCombobox()),this.#d}set category(e){this.#d?.clearPropertyChanged(),this.#d=e,this.#d.onPropertyChanged(this.onTypeChange)}initCombobox(){let e=new o.hQ;return e.items.push("common.length","common.area","common.volume"),e.onPropertyChanged(this.onTypeChange),e}onTypeChange=()=>{this.#n=!0,this.controller?.cancel(),this.#l?.container.remove(),this.#l=void 0,this.#c.forEach(e=>e.dispose()),this.#c.clear(),this.#o=0};initSumUI(){this.#l&&this.#l.container.remove(),this.#l={container:(0,p.hi)({className:f.selectSum}),header:(0,p.h1)({textContent:new o.Xx(this.#d.selectedItem)}),list:(0,p.ul)(),value:(0,p.yP)({textContent:"0.00"})},this.#l.container.append(this.#l.header,this.#l.list,(0,p.h2)(this.#l.value)),this.application.activeView?.dom?.append(this.#l.container)}addSumItem(e){this.#o+=e,this.#l||this.initSumUI();let t=document.createElement("li");t.textContent=e.toFixed(2),this.#l.list.append(t),this.#l.value.textContent=this.#o.toFixed(2)}afterExecute(){super.afterExecute(),this.category?.clearPropertyChanged(),this.#c.forEach(e=>e.dispose()),this.#c.clear(),this.#l?.container.remove()}async executeAsync(){for(;;){this.controller=new o.Op;let e=[o.ax.Edge,"prompt.select.edges"];1===this.category.selectedIndex?e=[o.ax.Face,"prompt.select.faces"]:2===this.category.selectedIndex&&(e=[o.ax.Solid,"prompt.select.solids"]);let t=new SelectShapeStep(e[0],e[1]),r=await t.execute(this.document,this.controller);if(this.controller.result?.status!=="success")if(!this.#n)return;else{this.#n=!1;continue}this.createMeasure(r?.shapes[0])}}createMeasure=e=>{e&&(e.shape.shapeType===o.ax.Edge?this.edgeMeasure(e.shape,e.transform):e.shape.shapeType===o.ax.Face?this.faceMeasure(e.shape,e.transform):e.shape.shapeType===o.ax.Solid&&this.solidMeasure(e.shape,e.transform,o.kB.center(e.owner.boundingBox())))};edgeMeasure(e,t){let r=(e=e.transformedMul(t)).curve.startPoint(),i=e.curve.endPoint(),a=e.length();this.addSumItem(a);let s=e.mesh.edges;e.dispose(),s.lineWidth=3,s.color=o.OI.highlightEdgeColor;let n=this.document.visual.context.displayMesh(s);this.#c.add(this.application.activeView.htmlText(a.toFixed(2),r.add(i).multiply(.5),{hideDelete:!0,onDispose:()=>{this.document.visual.context.removeMesh(n)}}))}faceMeasure(e,t){let r=e.outerWire(),i=r.mesh.edges;r.dispose(),i.lineWidth=3,i.color=o.OI.highlightEdgeColor,i.position=new Float32Array(t.ofPoints(i.position));let a=e.area();this.addSumItem(a);let s=this.wireCenter(i.position),n=this.document.visual.context.displayMesh(i);this.#c.add(this.application.activeView.htmlText(a.toFixed(2),s,{hideDelete:!0,onDispose:()=>{this.document.visual.context.removeMesh(n)}}))}wireCenter(e){let t={x:0,y:0,z:0};for(let r=0;r<e.length;r+=3)t.x+=e[r],t.y+=e[r+1],t.z+=e[r+2];let r=e.length/3;return t.x/=r,t.y/=r,t.z/=r,t}solidMeasure(e,t,r){let i=e.mesh.edges;i.lineWidth=3,i.color=o.OI.highlightEdgeColor,i.position=new Float32Array(t.ofPoints(i.position));let a=e.volume();this.addSumItem(a);let s=this.document.visual.context.displayMesh(i);this.#c.add(this.application.activeView.htmlText(a.toFixed(2),t.ofPoint(r),{hideDelete:!0,onDispose:()=>{this.document.visual.context.removeMesh(s)}}))}};function break_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}select_ts_decorate([o.Z9.define("common.type")],SelectMeasure.prototype,"category",null),SelectMeasure=select_ts_decorate([(0,o.WD)({key:"measure.select",icon:"icon-measureSelect"})],SelectMeasure);let Break=class Break extends multistepCommand_MultistepCommand{executeMainTask(){o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{let e=this.stepDatas[0].shapes[0].shape,t=e.curve,r=this.stepDatas[0].shapes[0].owner.node.worldTransform().invert().ofPoint(this.stepDatas[1].point),i=t.parameter(r,.001);if(void 0===i)return;let a=t.trim(i,t.lastParameter());t.setTrim(t.firstParameter(),i),e.update(t);let s=this.stepDatas[0].nodes[0],n=new o.gC(this.document,`${s.name}_1`,e),l=new o.gC(this.document,`${s.name}_2`,a.makeEdge());n.transform=s.transform,l.transform=s.transform,s.parent?.insertAfter(s,n),s.parent?.insertAfter(n,l),s.parent?.remove(s),this.document.visual.update()})}getSteps(){return[new SelectShapeStep(o.ax.Shape,"prompt.select.edges",{shapeFilter:{allow:e=>e.shapeType===o.ax.Edge}}),new PointOnCurveStep("operate.pickFistPoint",this.handlePointData,!0)]}handlePointData=()=>{let e=this.stepDatas[0].shapes[0].shape,t=e.curve.transformed(e.matrix.multiply(this.stepDatas[0].shapes[0].transform));return this.disposeStack.add(t),{curve:t,dimension:h.D1,preview:e=>{if(!e)return[];let r=t.project(e).at(0);return[this.meshPoint(r??e)]}}}};function brush_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Break=break_ts_decorate([(0,o.WD)({key:"modify.break",icon:"icon-break"})],Break);let AddBrushCommand=class AddBrushCommand extends multistepCommand_MultistepCommand{get materialId(){return this.getPrivateValue("materialId",this.document.materials.at(0)?.id)}set materialId(e){this.setProperty("materialId",e)}getSteps(){return[new SelectShapeStep(o.ax.Face,"prompt.select.faces",{multiple:!0})]}executeMainTask(){let e=new Map;this.stepDatas[0].shapes.forEach(t=>{t.owner.node instanceof o.R3&&(e.has(t.owner.node)||e.set(t.owner.node,[]),e.get(t.owner.node).push({faceIndex:t.shape.index,materialId:this.materialId}))}),o.YW.execute(this.document,"add face material",()=>{e.forEach((e,t)=>{t.addFaceMaterial(e)})}),this.document.visual.update()}};brush_ts_decorate([o.Z9.define("common.material",{type:"materialId"})],AddBrushCommand.prototype,"materialId",null),AddBrushCommand=brush_ts_decorate([(0,o.WD)({key:"modify.brushAdd",icon:"icon-addBrush"})],AddBrushCommand);let RemoveBrushCommand=class RemoveBrushCommand extends multistepCommand_MultistepCommand{getSteps(){return[new SelectShapeStep(o.ax.Face,"prompt.select.faces",{multiple:!0})]}executeMainTask(){let e=new Map;this.stepDatas[0].shapes.forEach(t=>{t.owner.node instanceof o.R3&&(e.has(t.owner.node)||e.set(t.owner.node,[]),e.get(t.owner.node).push(t.shape.index))}),o.YW.execute(this.document,"remove face material",()=>{e.forEach((e,t)=>{t.removeFaceMaterial(e)})}),this.document.visual.update()}};RemoveBrushCommand=brush_ts_decorate([(0,o.WD)({key:"modify.brushRemove",icon:"icon-removeBrush"})],RemoveBrushCommand);let ClearBrushCommand=class ClearBrushCommand extends multistepCommand_MultistepCommand{getSteps(){return[new SelectNodeStep("prompt.select.shape",{multiple:!0,keepSelection:!0})]}executeMainTask(){o.YW.execute(this.document,"clear face material",()=>{this.stepDatas[0].nodes?.forEach(e=>{e instanceof o.R3&&e.clearFaceMaterial()})}),this.document.visual.update()}};function chamfer_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}ClearBrushCommand=brush_ts_decorate([(0,o.WD)({key:"modify.brushClear",icon:"icon-clearBrush"})],ClearBrushCommand);let ChamferCommand=class ChamferCommand extends multistepCommand_MultistepCommand{get length(){return this.getPrivateValue("length",10)}set length(e){this.setProperty("length",e)}executeMainTask(){o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{let e=this.stepDatas[0].shapes[0].owner.node,t=this.stepDatas.at(-1).shapes.map(e=>e.shape.index),r=this.document.application.shapeFactory.chamfer(e.shape.value,t,this.length),i=new o.gC(this.document,e.name,r,e.materialId);i.transform=e.transform,(e.parent??this.document.rootNode).add(i),e.parent?.remove(e),this.document.visual.update()})}getSteps(){return[new SelectShapeStep(o.ax.Shape,"prompt.select.shape",{shapeFilter:{allow:e=>e.shapeType===o.ax.Solid||e.shapeType===o.ax.Compound||e.shapeType===o.ax.CompoundSolid},selectedState:o.tR.faceTransparent}),new SelectShapeStep(o.ax.Edge,"prompt.select.edges",{multiple:!0,keepSelection:!0})]}};function explode_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}chamfer_ts_decorate([o.Z9.define("common.length")],ChamferCommand.prototype,"length",null),ChamferCommand=chamfer_ts_decorate([(0,o.WD)({key:"modify.chamfer",icon:"icon-chamfer"})],ChamferCommand);let Explode=class Explode extends multistepCommand_MultistepCommand{getSteps(){return[new GetOrSelectNodeStep("prompt.select.shape",{multiple:!0})]}executeMainTask(){this.document.selection.clearSelection(),o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{this.stepDatas[0].nodes?.forEach(e=>{e instanceof o.EK?this.explodeShapeNode(e):e instanceof o.sK?this.explodeComponentNode(e):e instanceof o.Rr&&this.explodeMultiShapeNode(e)})}),this.document.visual.update()}explodeShapeNode(e){let t=e.shape.value.iterShape();if(1===t.length){let r=new o.gC(this.document,e.name,t[0],e.materialId);r.transform=e.transform,e.parent?.insertAfter(e.previousSibling,r)}else this.groupShapes(e,t);e.parent?.remove(e)}groupShapes(e,t){let r=new o.Gw(this.document,e.name);r.transform=e.transform,e.parent?.insertAfter(e.previousSibling,r);let i=1;for(let e of t){let t=`${o.ax.stringValue(e.shapeType)} ${i++}`,a=new o.gC(this.document,t,e);r.add(a)}}explodeComponentNode(e){for(let t of e.component.nodes){let r=t.clone();r.transform=t.transform.multiply(e.transform),e.parent?.insertAfter(e.previousSibling,r)}e.parent?.remove(e)}explodeMultiShapeNode(e){for(let t of e.shapes){let r=new o.gC(this.document,e.name,t.transformed(e.transform));e.parent?.insertAfter(e.previousSibling,r)}e.parent?.remove(e),e.shapes.forEach(e=>e.dispose())}};function fillet_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Explode=explode_ts_decorate([(0,o.WD)({key:"modify.explode",icon:"icon-explode"})],Explode);let FilletCommand=class FilletCommand extends multistepCommand_MultistepCommand{get radius(){return this.getPrivateValue("radius",10)}set radius(e){this.setProperty("radius",e)}executeMainTask(){o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{let e=this.stepDatas[0].shapes[0].owner.node,t=this.stepDatas.at(-1).shapes.map(e=>e.shape.index),r=this.document.application.shapeFactory.fillet(e.shape.value,t,this.radius),i=new o.gC(this.document,e.name,r,e.materialId);i.transform=e.transform,(e.parent??this.document.rootNode).add(i),e.parent?.remove(e),this.document.visual.update()})}getSteps(){return[new SelectShapeStep(o.ax.Shape,"prompt.select.shape",{shapeFilter:{allow:e=>e.shapeType===o.ax.Solid||e.shapeType===o.ax.Compound||e.shapeType===o.ax.CompoundSolid},selectedState:o.tR.faceTransparent}),new SelectShapeStep(o.ax.Edge,"prompt.select.edges",{multiple:!0,keepSelection:!0})]}};function transformedCommand_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}fillet_ts_decorate([o.Z9.define("circle.radius")],FilletCommand.prototype,"radius",null),FilletCommand=fillet_ts_decorate([(0,o.WD)({key:"modify.fillet",icon:"icon-fillet"})],FilletCommand);let TransformedCommand=class TransformedCommand extends multistepCommand_MultistepCommand{models;positions;get isClone(){return this.getPrivateValue("isClone",!1)}set isClone(e){this.setProperty("isClone",e)}transformPreview=e=>({position:new Float32Array(this.transfrom(e).ofPoints(this.positions)),lineType:o.SP.Solid,color:o.OI.defaultEdgeColor,range:[]});async ensureSelectedModels(){return this.models=this.document.selection.getSelectedNodes().filter(e=>e instanceof o.S3),this.models.length>0||(this.controller=new o.Op,this.models=await this.document.selection.pickNode("prompt.select.models",this.controller,!0),this.models.length>0||(this.controller.result?.status==="success"&&o.pS.default.pub("showToast","toast.select.noSelected"),!1))}async canExcute(){return!!await this.ensureSelectedModels()&&(this.positions=this.models.flatMap(e=>e instanceof o.bR?e.mesh.position?e.transform.ofPoints(e.mesh.position):[]:e instanceof o.R3?e.mesh.edges?.position?e.transform.ofPoints(e.mesh.edges.position):[]:e instanceof o.sK?Array.from(o.kB.wireframe(e.boundingBox()).position):[]),!0)}getTempLineData(e,t){return o.bj.from(e,t,o.OI.temporaryEdgeColor,o.SP.Solid)}executeMainTask(){o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{let e=this.isClone?this.models?.map(e=>e.clone()):this.models,t=this.transfrom(this.stepDatas.at(-1).point);e?.forEach(e=>{e.transform=e.transform.multiply(t)}),this.document.visual.update()})}};function mirror_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}transformedCommand_ts_decorate([o.Z9.define("common.clone")],TransformedCommand.prototype,"isClone",null);let Mirror=class Mirror extends TransformedCommand{transfrom(e){let t=this.stepDatas[0].point,r=this.stepDatas[0].view.workplane.normal,i=e.sub(t).cross(r),a=new o.JO(t,i,r);return o.yG.createMirrorWithPlane(a)}getSteps(){return[new PointStep("operate.pickFistPoint",void 0,!0),new PointStep("operate.pickNextPoint",this.getSecondPointData,!0)]}getSecondPointData=()=>({refPoint:()=>this.stepDatas[0].point,dimension:h.D1D2,preview:this.mirrorPreview,validator:e=>{let t=e.sub(this.stepDatas[0].point);return t.length()>.001&&!t.isParallelTo(this.stepDatas[0].view.workplane.normal)}});mirrorPreview=e=>{let t=this.meshPoint(this.stepDatas[0].point);if(!e)return[t];let r=this.transformPreview(e),i=e.sub(this.stepDatas[0].point).normalize().multiply(1e6);return[t,r,this.getTempLineData(this.stepDatas[0].point.sub(i),e.add(i))]}};function move_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Mirror=mirror_ts_decorate([(0,o.WD)({key:"modify.mirror",icon:"icon-mirror"})],Mirror);let Move=class Move extends TransformedCommand{getSteps(){return[new PointStep("operate.pickFistPoint",void 0,!0),new PointStep("operate.pickNextPoint",this.getSecondPointData,!0)]}getSecondPointData=()=>({refPoint:()=>this.stepDatas[0].point,dimension:h.D1D2D3,preview:this.movePreview});movePreview=e=>{let t=this.meshPoint(this.stepDatas[0].point);return e?[t,this.transformPreview(e),this.getTempLineData(this.stepDatas[0].point,e)]:[t]};transfrom(e){let{x:t,y:r,z:i}=e.sub(this.stepDatas[0].point);return o.yG.fromTranslation(t,r,i)}};function removeFeature_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Move=move_ts_decorate([(0,o.WD)({key:"modify.move",icon:"icon-move"})],Move);let RemoveFaceCommand=class RemoveFaceCommand extends multistepCommand_MultistepCommand{executeMainTask(){o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{let e=this.stepDatas[0].shapes[0].owner.node,t=this.stepDatas.at(-1).shapes.map(e=>e.shape),r=this.document.application.shapeFactory.removeFeature(e.shape.value,t),i=new o.gC(this.document,e.name,r,e.materialId);i.transform=e.transform,this.document.addNode(i),e.parent?.remove(e),this.document.visual.update()})}getSteps(){return[new SelectShapeStep(o.ax.Shape,"prompt.select.shape",{shapeFilter:{allow:e=>e.shapeType===o.ax.Solid||e.shapeType===o.ax.Compound||e.shapeType===o.ax.CompoundSolid},selectedState:o.tR.faceTransparent}),new SelectShapeStep(o.ax.Face,"prompt.select.faces",{multiple:!0,keepSelection:!0})]}};function removeSubShapes_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}RemoveFaceCommand=removeFeature_ts_decorate([(0,o.WD)({key:"modify.removeFeature",icon:"icon-removeFeature"})],RemoveFaceCommand);let RemoveSubShapesCommand=class RemoveSubShapesCommand extends multistepCommand_MultistepCommand{executeMainTask(){o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{let e=this.stepDatas[0].shapes[0].owner.node,t=this.stepDatas.at(-1).shapes.map(e=>e.shape),r=this.document.application.shapeFactory.removeSubShape(e.shape.value,t),i=new o.gC(this.document,e.name,r,e.materialId);i.transform=e.transform,e.parent?.insertAfter(e.previousSibling,i),e.parent?.remove(e),this.document.visual.update()})}getSteps(){return[new SelectShapeStep(o.ax.Shape,"prompt.select.shape",{shapeFilter:{allow:e=>e.shapeType!==o.ax.Vertex&&e.shapeType!==o.ax.Edge},selectedState:o.tR.faceTransparent}),new SelectShapeStep(o.ax.Edge|o.ax.Face,"prompt.select.shape",{multiple:!0,keepSelection:!0})]}};function rotate_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}RemoveSubShapesCommand=removeSubShapes_ts_decorate([(0,o.WD)({key:"modify.removeShapes",icon:"icon-removeSubShape"})],RemoveSubShapesCommand);let Rotate=class Rotate extends TransformedCommand{transfrom(e){let t=this.stepDatas[1].plane.normal,r=this.stepDatas[0].point,i=this.getAngle(e);return o.yG.fromAxisRad(r,t,i)}getSteps(){return[new PointStep("operate.pickFistPoint",void 0,!0),new LengthAtPlaneStep("operate.pickNextPoint",this.getSecondPointData,!0),new AngleStep("operate.pickNextPoint",()=>this.stepDatas[0].point,()=>this.stepDatas[1].point,this.getThirdPointData,!0)]}getSecondPointData=()=>{let{point:e,view:t}=this.stepDatas[0];return{point:()=>e,preview:this.circlePreview,plane:r=>this.findPlane(t,e,r),validator:t=>!(t.distanceTo(e)<o.Gc.Distance)&&!1===t.sub(e).isParallelTo(this.stepDatas[0].view.workplane.normal)}};circlePreview=e=>{let t=this.meshPoint(this.stepDatas[0].point);if(!e)return[t];let{point:r,view:i}=this.stepDatas[0],a=this.findPlane(i,r,e);return[t,this.meshLine(this.stepDatas[0].point,e),this.meshCreatedShape("circle",a.normal,r,a.projectDistance(r,e))]};getThirdPointData=()=>({dimension:h.D1D2,preview:this.anglePreview,plane:()=>this.stepDatas[1].plane,validator:e=>e.distanceTo(this.stepDatas[0].point)>.001&&e.distanceTo(this.stepDatas[1].point)>.001});getAngle(e){let t=this.stepDatas[1].plane.normal,r=this.stepDatas[0].point,i=this.stepDatas[1].point.sub(r),a=e.sub(r);return i.angleOnPlaneTo(a,t)}anglePreview=e=>{e=e??this.stepDatas[1].point;let t=[this.transformPreview(e),this.meshPoint(this.stepDatas[0].point),this.meshPoint(this.stepDatas[1].point),this.getRayData(this.stepDatas[1].point),this.getRayData(e)],r=this.getAngle(e);return Math.abs(r)>o.Gc.Angle&&t.push(this.meshCreatedShape("arc",this.stepDatas[1].plane.normal,this.stepDatas[0].point,this.stepDatas[1].point,180*r/Math.PI)),t};getRayData(e){let t=this.stepDatas[0].point,r=t.add(e.sub(t).normalize().multiply(1e6));return this.getTempLineData(t,r)}};function split_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Rotate=rotate_ts_decorate([(0,o.WD)({key:"modify.rotate",icon:"icon-rotate"})],Rotate);let Split=class Split extends multistepCommand_MultistepCommand{splitedShape(){let e=this.stepDatas[0].shapes[0].shape,t=this.stepDatas[0].shapes[0].transform.invert(),r=this.stepDatas[1].shapes.map(e=>e.shape.transformedMul(e.transform.multiply(t))),i=e.split(r);return r.forEach(e=>e.dispose()),i}executeMainTask(){o.YW.execute(this.document,`excute ${Object.getPrototypeOf(this).data.name}`,()=>{let e=this.stepDatas[0].nodes[0],t=this.splitedShape(),r=new o.gC(this.document,e.name,t);r.transform=e.transform,e.parent?.add(r),this.removeModels(this.stepDatas[0].shapes[0].owner,...this.stepDatas[1].shapes.map(e=>e.owner)),this.document.visual.update()})}removeModels(...e){e.forEach(e=>{let t=this.document.visual.context.getNode(e);t?.parent?.remove(t)})}getSteps(){return[new SelectShapeStep(o.ax.Shape,"prompt.select.shape",{selectedState:o.tR.faceTransparent}),new SelectShapeStep(o.ax.Wire|o.ax.Edge,"prompt.select.shape",{multiple:!0,keepSelection:!0})]}};function trim_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Split=split_ts_decorate([(0,o.WD)({key:"modify.split",icon:"icon-split"})],Split);let Trim=class Trim extends o.uu{async executeAsync(){let e=new o.YW(this.document,o.oc.translate("command.modify.trim"));e.start();try{await this.trimAsync()}catch(t){throw e.rollback(),t}e.commit()}async trimAsync(){for(this.document.visual.highlighter.clear(),this.document.selection.clearSelection();!this.isCompleted;){this.controller=new o.Op;let e=new PickTrimEdgeEventHandler(this.document,this.controller);if(await this.document.selection.pickAsync(e,"prompt.select.edges",this.controller,!1,"select.default"),this.controller.result?.status!=="success"||!e.selected)break;this.trimEdge(e.selected),e.dispose()}}trimEdge(e){let t=this.document.visual.context.getNode(e.edge.owner),r=t?.materialId;e.segments.retainSegments.forEach(i=>{let a=e.curve.trim(i.start,i.end).makeEdge();t?.parent?.add(new o.gC(this.document,t.name,a,r))}),t?.parent?.remove(t)}};Trim=trim_ts_decorate([(0,o.WD)({key:"modify.trim",icon:"icon-trim"})],Trim);let EdgeFilter=class EdgeFilter{allow(e){return e.shapeType===o.ax.Edge}};let PickTrimEdgeEventHandler=class PickTrimEdgeEventHandler extends l.k8{#p;highlightedEdge;highlight;releaseStack=new Set;get selected(){return this.#p}constructor(e,t){super(e,o.ax.Shape,!1,t,new EdgeFilter)}highlightDetecteds(e,t){if(this.cleanHighlights(),1!==t.length||t[0].shape.shapeType!==o.ax.Edge)return;let r=o.kB.transformed(t[0].owner.boundingBox(),t[0].transform),i=this.filterByBoundingBox(r,e,t[0].shape.id),a=t[0].shape.transformedMul(t[0].transform);this.releaseStack.add(a);let s=findSegments(a.curve,a,i,t),n=a.trim(s.deleteSegment.start,s.deleteSegment.end).mesh.edges;n.color=o.OI.highlightEdgeColor,n.lineWidth=3,this.highlightedEdge=e.document.visual.highlighter.highlightMesh(n),this.highlight={edge:t[0],segments:s,curve:a.curve},e.update()}cleanHighlights(){void 0!==this.highlightedEdge&&(this.document.visual.highlighter.removeHighlightMesh(this.highlightedEdge),this.highlightedEdge=void 0,this.highlight=void 0,this.document.application.activeView?.update())}clearSelected(e){this.#p=void 0}select(e,t){return this.#p=this.highlight,+!!this.#p}filterByBoundingBox(e,t,r){let i=o.kB.expand(e,.001);return t.document.visual.context.boundingBoxIntersectFilter(i,new EdgeFilter).map(e=>{let t=e?.geometryNode,i=t?.shape.value;if(i.id===r)return;let a=i.transformedMul(t.worldTransform());return this.releaseStack.add(a),a}).filter(e=>void 0!==e)}disposeInternal(){super.disposeInternal(),this.releaseStack.forEach(e=>e.dispose()),this.releaseStack.clear()}};function findSegments(e,t,r,i){let a=c.S.intersects(t,r).map(e=>e.parameter);if(a.push(e.firstParameter(),e.lastParameter()),2===(a=Array.from(new Set(a)).sort((e,t)=>e-t)).length)return allSegment(a);let s=e.parameter(i[0].point,5);for(let e=1;e<a.length;e++)if(s<a[e])if(1===e)return startSegment(a);else if(e===a.length-1)return lastSegment(a);else return centerSegment(a,e);return allSegment(a)}function allSegment(e){return{deleteSegment:{start:e[0],end:e.at(-1)},retainSegments:[]}}function centerSegment(e,t){return{deleteSegment:{start:e.at(t-1),end:e.at(t)},retainSegments:[{start:e[0],end:e[t-1]},{start:e[t],end:e.at(-1)}]}}function lastSegment(e){return{deleteSegment:{start:e.at(-2),end:e.at(-1)},retainSegments:[{start:e[0],end:e.at(-2)}]}}function startSegment(e){return{deleteSegment:{start:e[0],end:e[1]},retainSegments:[{start:e[1],end:e.at(-1)}]}}function redo_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}let Redo=class Redo{async execute(e){let t=e.activeView?.document;t?.history.redo(),t?.visual.update()}};function undo_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Redo=redo_ts_decorate([(0,o.WD)({key:"edit.redo",icon:"icon-redo"})],Redo);let Undo=class Undo{async execute(e){let t=e.activeView?.document;t?.history.undo(),t?.visual.update()}};function workingPlane_ts_decorate(e,t,r,i){var a,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(s<3?a(n):s>3?a(t,r,n):a(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}Undo=undo_ts_decorate([(0,o.WD)({key:"edit.undo",icon:"icon-undo"})],Undo);let WorkingPlaneViewModel=class WorkingPlaneViewModel extends o.y${planes=new o.io(["XOY","YOZ","ZOX"],o.W7.radio,["XOY"])};workingPlane_ts_decorate([o.Z9.define("dialog.title.selectWorkingPlane")],WorkingPlaneViewModel.prototype,"planes",void 0);let SetWorkplane=class SetWorkplane{async execute(e){let t=e.activeView;if(!t)return;let r=new WorkingPlaneViewModel;o.pS.default.pub("showDialog","dialog.title.selectWorkingPlane",this.ui(r),e=>{e===o.Xs.ok&&(t.workplane=[o.JO.XY,o.JO.YZ,o.JO.ZX][r.planes.selectedIndexes[0]])})}ui(e){return(0,p.hi)(...o.Z9.getProperties(e).map(t=>{let r=e[t.name];return r instanceof o.io?new p.Ee(o.oc.translate(t.display),r):""}))}};SetWorkplane=workingPlane_ts_decorate([(0,o.WD)({key:"workingPlane.set",icon:"icon-setWorkingPlane"})],SetWorkplane);let AlignToPlane=class AlignToPlane{async execute(e){let t=e.activeView;if(!t)return;t.document.selection.clearSelection();let r=new o.Op,i=await new SelectShapeStep(o.ax.Face,"prompt.select.faces").execute(t.document,r);if(r.dispose(),!i||0===i.shapes.length)return;t.document.visual.highlighter.clear();let a=i.shapes[0].shape.transformedMul(i.shapes[0].transform),[s,n]=a.normal(0,0);a.dispose();let l=o.vY.unitX;n.isParallelTo(o.vY.unitZ)||(l=o.vY.unitZ.cross(n).normalize()),t.workplane=new o.JO(s,n,l)}};AlignToPlane=workingPlane_ts_decorate([(0,o.WD)({key:"workingPlane.alignToPlane",icon:"icon-alignWorkingPlane"})],AlignToPlane);let FromSection=class FromSection extends multistepCommand_MultistepCommand{executeMainTask(){let e=this.transformedCurve(),t=this.stepDatas[1].point,r=e.parameter(t,.001);if(void 0===r)return;let i=e.d1(r).vec.normalize(),a=this.findXVec(i),s=new o.JO(t,i,a),n=this.application.activeView;n&&(n.workplane=s)}findXVec(e){let t;return e.isEqualTo(o.vY.unitZ)?o.vY.unitX:e.isEqualTo(new o.vY(0,0,-1))?o.vY.unitY:e.cross(o.vY.unitZ).normalize()}getSteps(){return[new SelectShapeStep(o.ax.Edge,"prompt.select.edges"),new PointOnCurveStep("operate.pickFistPoint",this.handlePointData,!0)]}transformedCurve(){let e=this.stepDatas[0].shapes[0].shape,t=e.matrix.multiply(this.stepDatas[0].shapes[0].transform),r=e.curve.transformed(t);return this.disposeStack.add(r),r}handlePointData=()=>{let e=this.transformedCurve();return{curve:e,dimension:h.D1,preview:t=>{if(!t)return[];let r=e.project(t).at(0);return[this.meshPoint(r??t)]}}}};FromSection=workingPlane_ts_decorate([(0,o.WD)({key:"workingPlane.fromSection",icon:"icon-fromSection"})],FromSection);let EditEventHandler=class EditEventHandler extends l.t{selectedNodes;constructor(e,t){super(e,!0),this.selectedNodes=t,o.pS.default.pub("showProperties",e,t)}disposeInternal(){o.pS.default.pub("showProperties",this.document,[]),super.disposeInternal()}};let g=["doc.new","doc.open","doc.save"];let CommandService=class CommandService{_lastCommand;_checking=!1;_app;get app(){if(void 0===this._app)throw Error("Executor is not initialized");return this._app}start(){o.pS.default.sub("executeCommand",this.executeCommand),o.pS.default.sub("activeViewChanged",this.onActiveViewChanged),o.Yd.info(`${CommandService.name} started`)}stop(){o.pS.default.remove("executeCommand",this.executeCommand),o.pS.default.remove("activeViewChanged",this.onActiveViewChanged),o.Yd.info(`${CommandService.name} stoped`)}register(e){this._app=e,o.Yd.info(`${CommandService.name} registed`)}onActiveViewChanged=async e=>{this.app.executingCommand&&o.wV.isCancelableCommand(this.app.executingCommand)&&await this.app.executingCommand.cancel()};executeCommand=async e=>{let t="special.last"===e?this._lastCommand:e;t&&await this.canExecute(t)&&(o.Yd.info(`executing command ${t}`),await this.executeAsync(t))};async executeAsync(e){let t=new(o.mY.get(e));this.app.executingCommand=t,o.pS.default.pub("showProperties",this.app.activeView?.document,[]);try{await t.execute(this.app)}catch(e){o.pS.default.pub("displayError",e),o.Yd.error(e)}finally{this._lastCommand=e,this.app.executingCommand=void 0}}async canExecute(e){if(this._checking)return!1;this._checking=!0;let t=await this.checking(e);return this._checking=!1,t}async checking(e){return o.mY.get(e)?g.includes(e)||void 0!==this.app.activeView?!this.app.executingCommand||(o.mY.getData(this.app.executingCommand)?.key===e?(o.pS.default.pub("showToast","toast.command.{0}excuting",e),!1):!!o.wV.isCancelableCommand(this.app.executingCommand)&&(await this.app.executingCommand.cancel(),!0)):(o.Yd.error("No active document"),!1):(o.Yd.error(`Can not find ${e} command`),!1)}};let EditorService=class EditorService{factory;editHandler;constructor(e){this.factory=e,this.handleSelectionChanged=(e,t)=>{this.editHandler?.dispose(),this.editHandler=void 0,e.application.executingCommand||(t.length>0?(this.editHandler=this.factory(e,t),e.visual.eventHandler=this.editHandler):e.visual.resetEventHandler())}}register(e){o.Yd.info(`${EditorService.name} registed`)}start(){o.pS.default.sub("selectionChanged",this.handleSelectionChanged),o.Yd.info(`${EditorService.name} started`)}stop(){o.pS.default.remove("selectionChanged",this.handleSelectionChanged),o.Yd.info(`${EditorService.name} stopped`)}handleSelectionChanged};let y={Delete:"modify.deleteNode",Backspace:"modify.deleteNode"," ":"special.last",Enter:"special.last","ctrl+z":"edit.undo","ctrl+y":"edit.redo"};let HotkeyService=class HotkeyService{app;_keyMap=new Map;constructor(){this.addMap(y)}register(e){this.app=e,o.Yd.info(`${HotkeyService.name} registed`)}start(){window.addEventListener("keydown",this.eventHandlerKeyDown),window.addEventListener("keydown",this.commandKeyDown),o.Yd.info(`${HotkeyService.name} started`)}stop(){window.removeEventListener("keydown",this.eventHandlerKeyDown),window.removeEventListener("keydown",this.commandKeyDown),o.Yd.info(`${HotkeyService.name} stoped`)}eventHandlerKeyDown=e=>{e.preventDefault();let t=this.app?.activeView?.document?.visual,r=this.app?.activeView;r&&t&&(t.eventHandler.keyDown(r,e),t.viewHandler.keyDown(r,e),this.app.executingCommand&&e.stopImmediatePropagation())};commandKeyDown=e=>{e.preventDefault();let t=this.getCommand(e);void 0!==t&&o.pS.default.pub("executeCommand",t)};getKey(e){let t=e.key;return e.ctrlKey&&(t="ctrl+"+t),e.shiftKey&&(t="shift+"+t),e.altKey&&(t="alt+"+t),t}map(e,t){let r=this.getKey(t);this._keyMap.set(r,e)}getCommand(e){let t=this.getKey(e);return this._keyMap.get(t)}addMap(e){Object.keys(e).forEach(t=>{this._keyMap.set(t,e[t])})}}},8057:function(e,t,r){e.exports={rootPanel:"chili3d-_3fab6219d4b896c5-rootPanel",headerPanel:"chili3d-_3fab6219d4b896c5-headerPanel",contextPanel:"chili3d-_3fab6219d4b896c5-contextPanel",expanderIcon:"chili3d-_3fab6219d4b896c5-expanderIcon",headerText:"chili3d-_3fab6219d4b896c5-headerText",hidden:"chili3d-_3fab6219d4b896c5-hidden"}},2921:function(e,t,r){e.exports={radioGroup:"chili3d-_710cc6ac21796093-radioGroup"}},307:function(e,t,r){e.exports={selectSum:"chili3d-ab90d2926f77ec82-selectSum"}}},t={};function __webpack_require__(r){var i=t[r];if(void 0!==i)return i.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,__webpack_require__),a.exports}__webpack_require__.m=e,__webpack_require__.d=(e,t)=>{for(var r in t)__webpack_require__.o(t,r)&&!__webpack_require__.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},__webpack_require__.f={},__webpack_require__.e=e=>Promise.all(Object.keys(__webpack_require__.f).reduce((t,r)=>(__webpack_require__.f[r](e,t),t),[])),__webpack_require__.k=e=>""+e+".css",__webpack_require__.u=e=>""+e+".js",__webpack_require__.g=(()=>{if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}})(),__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={},t="chili3d:";__webpack_require__.l=function(r,i,a,s){if(e[r])return void e[r].push(i);if(void 0!==a)for(var n,o,l=document.getElementsByTagName("script"),c=0;c<l.length;c++){var d=l[c];if(d.getAttribute("src")==r||d.getAttribute("data-webpack")==t+a){n=d;break}}n||(o=!0,(n=document.createElement("script")).charset="utf-8",n.timeout=120,__webpack_require__.nc&&n.setAttribute("nonce",__webpack_require__.nc),n.setAttribute("data-webpack",t+a),n.src=r),e[r]=[i];var onScriptComplete=function(t,i){n.onerror=n.onload=null,clearTimeout(p);var a=e[r];if(delete e[r],n.parentNode&&n.parentNode.removeChild(n),a&&a.forEach(function(e){return e(i)}),t)return t(i)},p=setTimeout(onScriptComplete.bind(null,void 0,{type:"timeout",target:n}),12e4);n.onerror=onScriptComplete.bind(null,n.onerror),n.onload=onScriptComplete.bind(null,n.onload),o&&document.head.appendChild(n)}})(),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},__webpack_require__.rv=()=>"1.3.5",(()=>{__webpack_require__.g.importScripts&&(e=__webpack_require__.g.location+"");var e,t=__webpack_require__.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var i=r.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=r[i--].src}if(!e)throw Error("Automatic publicPath is not supported in this browser");__webpack_require__.p=e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/")})(),(()=>{var e={909:0},t="chili3d",loadCssChunkData=(t,r)=>{e[r]=0},r="data-webpack-loading",loadStylesheet=function(e,i,a,s,n){var o,l,c="chunk-"+e;if(!s){for(var d=document.getElementsByTagName("link"),p=0;p<d.length;p++){var h=d[p],u=h.getAttribute("href")||h.href;if(u&&!u.startsWith(__webpack_require__.p)&&(u=__webpack_require__.p+(u.startsWith("/")?u.slice(1):u)),"stylesheet"==h.rel&&(u&&u.startsWith(i)||h.getAttribute("data-webpack")==t+":"+c)){o=h;break}}if(!a)return o}o||(l=!0,o=document.createElement("link"),__webpack_require__.nc&&o.setAttribute("nonce",__webpack_require__.nc),o.setAttribute("data-webpack",t+":"+c),n&&o.setAttribute("fetchpriority",n),o.setAttribute(r,1),o.rel="stylesheet",o.href=i);var onLinkComplete=function(e,t){if(o.onerror=o.onload=null,o.removeAttribute(r),clearTimeout(m),t&&"load"!=t.type&&o.parentNode.removeChild(o),a(t),e)return e(t)};if(o.getAttribute(r)){var m=setTimeout(onLinkComplete.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=onLinkComplete.bind(null,o.onerror),o.onload=onLinkComplete.bind(null,o.onload)}else onLinkComplete(void 0,{type:"load",target:o});return s?document.head.insertBefore(o,s):l&&document.head.appendChild(o),o};loadCssChunkData(__webpack_require__.m,0,"909"),__webpack_require__.f.css=function(t,r,i){var a=__webpack_require__.o(e,t)?e[t]:void 0;if(0!==a)if(a)r.push(a[2]);else if(/^(796|897|909)$/.test(t)){var s=new Promise(function(r,i){a=e[t]=[r,i]});r.push(a[2]=s);var n=__webpack_require__.p+__webpack_require__.k(t),o=Error();loadStylesheet(t,n,function(r){if(__webpack_require__.o(e,t)&&(0!==(a=e[t])&&(e[t]=void 0),a))if("load"!==r.type){var i=r&&r.type,s=r&&r.target&&r.target.src;o.message="Loading css chunk "+t+" failed.\n("+i+": "+s+")",o.name="ChunkLoadError",o.type=i,o.request=s,a[1](o)}else loadCssChunkData(__webpack_require__.m,t),a[0]()},void 0,i)}else e[t]=0}})(),(()=>{__webpack_require__.b=document.baseURI||self.location.href;var e={909:0};__webpack_require__.f.j=function(t,r){var i=__webpack_require__.o(e,t)?e[t]:void 0;if(0!==i)if(i)r.push(i[2]);else{var a=new Promise((r,a)=>i=e[t]=[r,a]);r.push(i[2]=a);var s=__webpack_require__.p+__webpack_require__.u(t),n=Error();__webpack_require__.l(s,function(r){if(__webpack_require__.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var a=r&&("load"===r.type?"missing":r.type),s=r&&r.target&&r.target.src;n.message="Loading chunk "+t+" failed.\n("+a+": "+s+")",n.name="ChunkLoadError",n.type=a,n.request=s,i[1](n)}},"chunk-"+t,t)}};var webpackJsonpCallback=(t,r)=>{var i,a,[s,n,o]=r,l=0;if(s.some(t=>0!==e[t])){for(i in n)__webpack_require__.o(n,i)&&(__webpack_require__.m[i]=n[i]);o&&o(__webpack_require__)}for(t&&t(r);l<s.length;l++)a=s[l],__webpack_require__.o(e,a)&&e[a]&&e[a][0](),e[a]=0},t=self.webpackChunkchili3d=self.webpackChunkchili3d||[];t.forEach(webpackJsonpCallback.bind(null,0)),t.push=webpackJsonpCallback.bind(null,t.push.bind(t))})(),__webpack_require__.ruid="bundler=rspack@1.3.5",(()=>{var e=__webpack_require__(1530),t=__webpack_require__(8909);async function importBrep(e,r){let i=e.application.shapeFactory.converter.convertFromBrep(await r.text());return i.isOk?t.x4.ok(new t.gC(e,r.name,i.value)):t.x4.err(i.error)}async function exportBrep(e,r){let i=e.application.shapeFactory.combine(r);return i.isOk?e.application.shapeFactory.converter.convertToBrep(i.value):t.x4.err(i.error)}let DefaultDataExchange=class DefaultDataExchange{importFormats(){return[".step",".stp",".iges",".igs",".brep"]}exportFormats(){return[".step",".iges",".brep"]}async import(e,t){for(let r of t)await this.handleSingleFileImport(e,r)}async handleSingleFileImport(e,t){let r=t.name.endsWith(".brep")?await importBrep(e,t):await this.handleStepIgesImport(e,t);if(!r?.isOk)return;let i=r.value;i.name=t.name,e.addNode(i),e.visual.update()}async handleStepIgesImport(e,r){let i=new Uint8Array(await r.arrayBuffer());return this.isStepFile(r.name)?e.application.shapeFactory.converter.convertFromSTEP(e,i):this.isIgesFile(r.name)?e.application.shapeFactory.converter.convertFromIGES(e,i):void alert(t.oc.translate("error.import.unsupportedFileType:{0}",r.name))}async export(e,t){if(!this.validateExportType(e))return;let r=this.getExportShapes(t);if(!r.length)return;let i=await this.convertShapes(e,t[0].document,r);return r.forEach(e=>e.dispose()),this.handleExportResult(i)}validateExportType(e){let r=this.exportFormats().includes(e);return r||t.pS.default.pub("showToast","error.import.unsupportedFileType:{0}",e),r}getExportShapes(e){let r=e.filter(e=>e instanceof t.EK).map(e=>e.shape.value.transformedMul(e.worldTransform()));return r.length||t.pS.default.pub("showToast","error.export.noNodeCanBeExported"),r}async convertShapes(e,t,r){return".step"===e?this.handleStepExport(t,r):".iges"===e?this.handleIgesExport(t,r):exportBrep(t,r)}handleStepExport(e,t){return e.application.shapeFactory.converter.convertToSTEP(...t)}handleIgesExport(e,t){return e.application.shapeFactory.converter.convertToIGES(...t)}handleExportResult(e){return e?.isOk?[e.value]:void t.pS.default.pub("showToast","error.default:{0}",e?.error)}isStepFile(e){return e.endsWith(".step")||e.endsWith(".stp")}isIgesFile(e){return e.endsWith(".iges")||e.endsWith(".igs")}};let AppBuilder=class AppBuilder{_inits=[];_additionalModules=[];_storage;_visualFactory;_shapeFactory;_window;useIndexedDB(){return this._inits.push(async()=>{t.Yd.info("initializing IndexedDBStorage");let e=await __webpack_require__.e("392").then(__webpack_require__.bind(__webpack_require__,2702));this._storage=new e.IndexedDBStorage}),this}useWasmOcc(){return this._inits.push(async()=>{t.Yd.info("initializing wasm occ");let e=await __webpack_require__.e("33").then(__webpack_require__.bind(__webpack_require__,584));await e.initWasm(),this._shapeFactory=new e.ShapeFactory}),this}useThree(){return this._inits.push(async()=>{t.Yd.info("initializing three");let e=await Promise.all([__webpack_require__.e("325"),__webpack_require__.e("897")]).then(__webpack_require__.bind(__webpack_require__,6603));this._visualFactory=new e.ThreeVisulFactory}),this}useUI(){return this._inits.push(async()=>{t.Yd.info("initializing MainWindow"),this.loadAdditionalI18n();let e=await __webpack_require__.e("796").then(__webpack_require__.bind(__webpack_require__,8249));this._window=new e.MainWindow(await this.getRibbonTabs())}),this}addAdditionalModules(...e){return this._additionalModules.push(...e),this}async getRibbonTabs(){return(await __webpack_require__.e("962").then(__webpack_require__.bind(__webpack_require__,9052))).DefaultRibbon}async build(){for(let e of this._inits)await e();this.ensureNecessary();let e=this.createApp();this._window?.init(e),this.loadAdditionalCommands(),t.Yd.info("Application build completed")}createApp(){return new e.Mx({storage:this._storage,shapeFactory:this._shapeFactory,visualFactory:this._visualFactory,services:this.getServices(),mainWindow:this._window,dataExchange:this.initDataExchange()})}initDataExchange(){return new DefaultDataExchange}ensureNecessary(){if(void 0===this._shapeFactory)throw Error("ShapeFactory not set");if(void 0===this._visualFactory)throw Error("VisualFactory not set");if(void 0===this._storage)throw Error("storage has not been initialized")}loadAdditionalI18n(){for(let e of this._additionalModules)e.i18n().forEach(e=>{t.oc.combineTranslation(e.code,e.translation)})}loadAdditionalCommands(){for(let e of this._additionalModules)this._window&&e.ribbonCommands().forEach(e=>{this._window.registerRibbonCommand(e.tabName,e.groupName,e.command)})}getServices(){return[new e.VD,new e.y1,new e.GX((t,r)=>new e.NZ(t,r))]}};let Loading=class Loading extends HTMLElement{constructor(){super(),this.initSpinner(),this.initLabel(),this.initAnimation(),this.style.cssText=`
            position: fixed;
            display: block;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background-color: rgba(0, 0, 0, 0.5);
        `}initSpinner(){let e=document.createElement("div");e.style.cssText=`
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 5px solid #fff;
            border-top-color: #000;
            animation: spin 1s infinite linear;
        `,this.appendChild(e)}initAnimation(){let e=document.createElement("style");e.innerHTML=`
          @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
          }
        `,document.head.appendChild(e)}initLabel(){let e=document.createElement("div");e.innerText="Loading...",e.style.cssText=`
        color: white;
        font-size: 16px;
        position: relative;
        top: calc(40% + 100px);
        left: calc(50% + 25px);
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        `,this.appendChild(e)}};customElements.define("chili-loading",Loading);let r=new Loading;document.body.appendChild(r),new AppBuilder().useIndexedDB().useWasmOcc().useThree().useUI().build().then(e=>{document.body.removeChild(r)}).catch(e=>{t.Yd.error(e)})})()})();
//# sourceMappingURL=main.js.map