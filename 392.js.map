{"version":3,"file":"392.js","sources":["webpack://chili3d/./packages/chili-storage/src/indexedDBStorage.ts"],"sourcesContent":["// Part of the Chili3d Project, under the AGPL-3.0 License.\r\n// See LICENSE file in the project root for full license information.\r\n\r\nimport { Constants, IStorage, Logger } from \"chili-core\";\r\n\r\nexport class IndexedDBStorage implements IStorage {\r\n    readonly version: number = 4;\r\n\r\n    async get(database: string, table: string, id: string): Promise<any> {\r\n        const db = await this.open(database, table, this.version);\r\n        try {\r\n            return await IndexedDBStorage.get(db, table, id);\r\n        } finally {\r\n            db.close();\r\n        }\r\n    }\r\n\r\n    async put(database: string, table: string, id: string, value: any): Promise<boolean> {\r\n        const db = await this.open(database, table, this.version);\r\n        try {\r\n            return await IndexedDBStorage.put(db, table, id, value);\r\n        } finally {\r\n            db.close();\r\n        }\r\n    }\r\n\r\n    async delete(database: string, table: string, id: string): Promise<boolean> {\r\n        const db = await this.open(database, table, this.version);\r\n        try {\r\n            return await IndexedDBStorage.delete(db, table, id);\r\n        } finally {\r\n            db.close();\r\n        }\r\n    }\r\n\r\n    async page(database: string, table: string, page: number): Promise<any[]> {\r\n        const db = await this.open(database, table, this.version);\r\n        try {\r\n            return await IndexedDBStorage.getPage(db, table, page);\r\n        } finally {\r\n            db.close();\r\n        }\r\n    }\r\n\r\n    private open(\r\n        dbName: string,\r\n        storeName: string,\r\n        version: number,\r\n        options?: IDBObjectStoreParameters,\r\n    ): Promise<IDBDatabase> {\r\n        let request = window.indexedDB.open(dbName, version);\r\n        return new Promise((resolve, reject) => {\r\n            request.onsuccess = (e) => {\r\n                Logger.info(`open ${dbName} success`);\r\n                resolve((e.target as unknown as any).result);\r\n            };\r\n\r\n            request.onerror = (e) => {\r\n                Logger.error(`open ${dbName} error`);\r\n                reject(e);\r\n            };\r\n\r\n            request.onupgradeneeded = (e) => {\r\n                Logger.info(`upgrade ${dbName}`);\r\n                let db: IDBDatabase = (e.target as unknown as any).result;\r\n                [Constants.DocumentTable, Constants.RecentTable].forEach((store) => {\r\n                    if (!db.objectStoreNames.contains(store)) {\r\n                        Logger.info(`create store ${store}`);\r\n                        db.createObjectStore(store, options);\r\n                    }\r\n                });\r\n            };\r\n        });\r\n    }\r\n\r\n    private static get(db: IDBDatabase, storeName: string, key: string) {\r\n        const request = db.transaction([storeName], \"readonly\").objectStore(storeName).get(key);\r\n        return new Promise((resolve, reject) => {\r\n            request.onsuccess = (e) => {\r\n                Logger.info(`${storeName} store get object success`);\r\n                resolve((e.target as unknown as any).result);\r\n            };\r\n            request.onerror = (e) => {\r\n                Logger.error(`${storeName} store get object error`);\r\n                reject(e);\r\n            };\r\n        });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param db IDBDatabase\r\n     * @param storeName store name\r\n     * @param page page, start with 0\r\n     * @param count items per page\r\n     * @returns\r\n     */\r\n    private static getPage(\r\n        db: IDBDatabase,\r\n        storeName: string,\r\n        page: number,\r\n        count: number = 20,\r\n    ): Promise<any[]> {\r\n        const result: any[] = [];\r\n        let index = 0;\r\n        let isAdvanced = false;\r\n        const request = db.transaction([storeName], \"readonly\").objectStore(storeName).openCursor();\r\n\r\n        return new Promise((resolve, reject) => {\r\n            request.onsuccess = (e) => {\r\n                const cursor: IDBCursorWithValue = (e.target as unknown as any).result;\r\n                if (!cursor || index === count) {\r\n                    Logger.info(`${storeName} store get objects success`);\r\n                    resolve(result);\r\n                } else if (!isAdvanced && page * count > 0) {\r\n                    isAdvanced = true;\r\n                    cursor.advance(page * count);\r\n                } else {\r\n                    result.push(cursor.value);\r\n                    index++;\r\n                    cursor.continue();\r\n                }\r\n            };\r\n            request.onerror = (e) => {\r\n                Logger.error(`${storeName} store get objects error`);\r\n                reject(e);\r\n            };\r\n        });\r\n    }\r\n\r\n    private static delete(db: IDBDatabase, storeName: string, key: string): Promise<boolean> {\r\n        const request = db.transaction([storeName], \"readwrite\").objectStore(storeName).delete(key);\r\n        return new Promise((resolve, reject) => {\r\n            request.onsuccess = () => {\r\n                Logger.info(`${storeName} store delete object success`);\r\n                resolve(true);\r\n            };\r\n            request.onerror = (e) => {\r\n                Logger.error(`${storeName} store delete object error`);\r\n                reject(e);\r\n            };\r\n        });\r\n    }\r\n\r\n    private static put(db: IDBDatabase, storeName: string, key: IDBValidKey, value: any): Promise<boolean> {\r\n        const request = db.transaction([storeName], \"readwrite\").objectStore(storeName).put(value, key);\r\n        return new Promise((resolve, reject) => {\r\n            request.onsuccess = () => {\r\n                Logger.info(`${storeName} store put object success`);\r\n                resolve(true);\r\n            };\r\n            request.onerror = (e) => {\r\n                Logger.error(`${storeName} store put object error`);\r\n                reject(e);\r\n            };\r\n        });\r\n    }\r\n}\r\n"],"names":["IndexedDBStorage","database","table","id","db","value","page","dbName","storeName","version","options","request","window","Promise","resolve","reject","e","Logger","Constants","store","key","count","result","index","isAdvanced","cursor"],"mappings":"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"}