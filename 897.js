"use strict";(self.webpackChunkchili3d=self.webpackChunkchili3d||[]).push([["897"],{6603:function(e,t,s){s.r(t),s.d(t,{ThreeVisulFactory:()=>ThreeVisulFactory});var i,r=s(8909),a=s(492),n=s(6467),o=s(8715),h=s(6944),l=s(0),c=s(3813);let ThreeHelper=class ThreeHelper{static toMatrix(e){return r.yG.fromArray(e.toArray())}static toXYZ(e){return new r.vY(e.x,e.y,e.z)}static fromXYZ(e){return new n.Pa4(e.x,e.y,e.z)}static isPerspectiveCamera(e){return e.isPerspectiveCamera}static isOrthographicCamera(e){return e.isOrthographicCamera}static fromColor(e){return new n.Ilk(e)}static toColor(e){return e.getHex()}static findGroupIndex(e,t){for(let s=0;s<e.length;s++)if(t>=e[s].start&&t<e[s].start+e[s].count)return s}static transformVector(e,t){let s=e.elements,i=t.x*s[0]+t.y*s[4]+t.z*s[8],r=t.x*s[1]+t.y*s[5]+t.z*s[9],a=t.x*s[2]+t.y*s[6]+t.z*s[10];return new n.Pa4(i,r,a)}static getBoundingBox(e){let t=new n.ZzF;if(t.setFromObject(e),!t.isEmpty())return{min:ThreeHelper.toXYZ(t.min),max:ThreeHelper.toXYZ(t.max)}}static boxCorners(e){let t=e.min,s=e.max;return[new n.Pa4(t.x,t.y,t.z),new n.Pa4(s.x,t.y,t.z),new n.Pa4(s.x,s.y,t.z),new n.Pa4(t.x,s.y,t.z),new n.Pa4(t.x,t.y,s.z),new n.Pa4(s.x,t.y,s.z),new n.Pa4(s.x,s.y,s.z),new n.Pa4(t.x,s.y,s.z)]}static loadTexture(e){if(!e?.image)return null;let t=new n.dpR().load(e.image);return t.wrapS=n.rpg,t.wrapT=n.rpg,t.center.set(.5,.5),t.repeat.set(e.repeat.x,e.repeat.y),t.rotation=r.M8.degToRad(e.rotation),t}static parsePhysicalMaterial(e){return new n.EJi({color:e.color,side:n.ehD,transparent:!0,name:e.name,opacity:e.opacity,map:this.loadTexture(e.map),roughness:e.roughness,metalness:e.metalness,bumpMap:this.loadTexture(e.bumpMap),normalMap:this.loadTexture(e.normalMap),emissiveMap:this.loadTexture(e.emissiveMap),roughnessMap:this.loadTexture(e.roughnessMap),metalnessMap:this.loadTexture(e.metalnessMap)})}static parsePhongMaterial(e){return new n.xoR({color:e.color,side:n.ehD,transparent:!0,name:e.name,opacity:e.opacity,map:this.loadTexture(e.map),specularMap:this.loadTexture(e.specularMap),shininess:e.shininess,emissive:ThreeHelper.fromColor(e.emissive),emissiveMap:this.loadTexture(e.emissiveMap)})}static parseBasicMaterial(e){return new n.YBo({color:e.color,side:n.ehD,transparent:!0,name:e.name,opacity:e.opacity,map:this.loadTexture(e.map)})}static parseToThreeMaterial(e){return e instanceof r.yx?this.parsePhysicalMaterial(e):e instanceof r.JF?this.parsePhongMaterial(e):this.parseBasicMaterial(e)}};let d=new c.Y({linewidth:3,color:ThreeHelper.fromColor(r.OI.highlightEdgeColor),side:n.ehD,polygonOffset:!0,polygonOffsetFactor:-4,polygonOffsetUnits:-4});new c.Y({linewidth:3,color:ThreeHelper.fromColor(r.OI.highlightEdgeColor),side:n.ehD,polygonOffset:!0,polygonOffsetFactor:-4,polygonOffsetUnits:-4,dashed:!0,dashScale:100,dashSize:100,gapSize:100});let m=new c.Y({linewidth:3,color:ThreeHelper.fromColor(r.OI.selectedEdgeColor),side:n.ehD,polygonOffset:!0,polygonOffsetFactor:-4,polygonOffsetUnits:-4}),p=new n.YBo({transparent:!0,side:n.ehD,color:ThreeHelper.fromColor(r.OI.selectedFaceColor),opacity:.1});let ThreeGeometryFactory=class ThreeGeometryFactory{static createVertexGeometry(e){let t=new n.u9r;t.setAttribute("position",new n.TlE(e.position,3));let s=new n.UY4({size:e.size,sizeAttenuation:!1});return this.setColor(t,e,s),s.depthFunc=n.Se2,new n.woe(t,s)}static createFaceGeometry(e){let t=ThreeGeometryFactory.createFaceBufferGeometry(e),s=new n.YBo({side:n.ehD});return this.setColor(t,e,s),new n.Kj0(t,s)}static setColor(e,t,s){"number"==typeof t.color?s.color.set(t.color):Array.isArray(t.color)&&(s.vertexColors=!0,e.setAttribute("color",new n.a$l(t.color,3)))}static createFaceBufferGeometry(e){let t=new n.u9r;return t.setAttribute("position",new n.TlE(e.position,3)),t.setAttribute("normal",new n.TlE(e.normal,3)),t.setAttribute("uv",new n.TlE(e.uv,2)),e.index&&e.index.length>0&&t.setIndex(new n.TlE(e.index,1)),t.computeBoundingBox(),t}static createEdgeGeometry(e){let t=this.createEdgeBufferGeometry(e),s=e.lineWidth??1,i=new c.Y({linewidth:s,polygonOffset:!0,polygonOffsetFactor:-4,polygonOffsetUnits:-4});return e.lineType===r.SP.Dash&&(i.dashed=!0,i.dashScale=100,i.dashSize=100,i.gapSize=100),this.setColor(t,e,i),new h.w(t,i).computeLineDistances()}static createEdgeBufferGeometry(e){let t=new l.z;return t.setPositions(e.position),t.computeBoundingBox(),t}};var u=s(5684),g=s(9494);let Constants=class Constants{static RaycasterThreshold=10;static Layers=Object.freeze({Default:0,Wireframe:1,Solid:2,Isolation:30})};let f=new n.YBo({color:ThreeHelper.fromColor(r.OI.highlightFaceColor),side:n.ehD,transparent:!0,opacity:.56});let ThreeVisualObject=class ThreeVisualObject extends n.Tme{get transform(){return ThreeHelper.toMatrix(this.matrix)}set transform(e){this.matrix.fromArray(e.toArray())}_node;get node(){return this._node}worldTransform(){return ThreeHelper.toMatrix(this.matrixWorld)}constructor(e){super(),this._node=e,this.matrixAutoUpdate=!1,this.visible=e.visible&&e.parentVisible,this.transform=e.transform,e.onPropertyChanged(this.handlePropertyChanged)}handlePropertyChanged=e=>{"transform"===e&&(this.transform=this.node.transform)};boundingBox(){return ThreeHelper.getBoundingBox(this)}dispose(){this.node.removePropertyChanged(this.handlePropertyChanged),this._node=null}};let ThreeMeshObject=class ThreeMeshObject extends ThreeVisualObject{context;meshNode;_mesh;material;get mesh(){return this._mesh}constructor(e,t){super(t),this.context=e,this.meshNode=t,this.handleGeometryPropertyChanged=e=>{"mesh"===e?(this.disposeMesh(),this._mesh=this.createMesh(),this.add(this._mesh)):"materialId"===e&&this._mesh instanceof n.Kj0&&(this.material=this.context.getMaterial(this.meshNode.materialId),this._mesh.material=this.material)},this._mesh=this.createMesh(),this.material=this._mesh.material,this.add(this._mesh),t.onPropertyChanged(this.handleGeometryPropertyChanged)}highlight(){this._mesh instanceof n.Kj0&&(this._mesh.material=f),this._mesh instanceof h.w&&(this._mesh.material=d)}unhighlight(){this._mesh instanceof n.Kj0&&(this._mesh.material=this.material),this._mesh instanceof h.w&&(this._mesh.material=this.material)}getSubShapeAndIndex(e,t){return{shape:void 0,subShape:void 0,index:-1,groups:[]}}subShapeVisual(e){return[]}createMesh(){switch(this.meshNode.mesh.meshType){case"linesegments":return this.newLineSegments();case"surface":return this.newMesh();default:throw Error("Unknown mesh type")}}handleGeometryPropertyChanged;newMesh(){let e=new n.u9r;e.setAttribute("position",new n.TlE(this.meshNode.mesh.position,3)),this.meshNode.mesh.normal&&e.setAttribute("normal",new n.TlE(this.meshNode.mesh.normal,3)),this.meshNode.mesh.uv&&e.setAttribute("uv",new n.TlE(this.meshNode.mesh.uv,2)),this.meshNode.mesh.index&&e.setIndex(new n.TlE(this.meshNode.mesh.index,1)),this.meshNode.mesh.groups.length>1&&(e.groups=this.meshNode.mesh.groups),e.computeBoundingBox();let t=new n.Kj0(e,this.context.getMaterial(this.meshNode.materialId));return t.layers.set(Constants.Layers.Solid),t}newLineSegments(){let e=new c.Y({linewidth:1,color:this.meshNode.mesh.color,side:n.ehD}),t=new l.z;t.setPositions(this.meshNode.mesh.position),t.computeBoundingBox();let s=new h.w(t,e);return s.layers.set(Constants.Layers.Wireframe),s}newLine(){let e=new c.Y({linewidth:1,color:this.meshNode.mesh.color,side:n.ehD}),t=new g.L;t.setPositions(this.meshNode.mesh.position),t.computeBoundingBox();let s=new u.w(t,e);return s.layers.set(Constants.Layers.Wireframe),s}wholeVisual(){return[this.mesh]}disposeMesh(){(this._mesh instanceof h.w||this._mesh instanceof u.w)&&this._mesh.material.dispose(),this._mesh.geometry?.dispose()}dispose(){super.dispose(),this.meshNode.removePropertyChanged(this.handleGeometryPropertyChanged),this.disposeMesh()}};let GroupVisualObject=class GroupVisualObject extends n.ZAu{groupNode;get transform(){return ThreeHelper.toMatrix(this.matrix)}set transform(e){this.matrix.fromArray(e.toArray())}worldTransform(){return ThreeHelper.toMatrix(this.matrixWorld)}constructor(e){super(),this.groupNode=e,this.handlePropertyChanged=e=>{"transform"===e&&(this.transform=this.groupNode.transform)},this.matrixAutoUpdate=!1,this.transform=e.transform,e.onPropertyChanged(this.handlePropertyChanged)}handlePropertyChanged;boundingBox(){return ThreeHelper.getBoundingBox(this)}dispose(){this.groupNode.removePropertyChanged(this.handlePropertyChanged)}};let ThreeComponentObject=class ThreeComponentObject extends ThreeVisualObject{componentNode;context;_boundbox;_edges;_faces;_linesegments;_surfaces;get edges(){return this._edges}get faces(){return this._faces}get linesegments(){return this._linesegments}get surfaces(){return this._surfaces}_edgeMaterial;constructor(e,t){super(e),this.componentNode=e,this.context=t,this._edgeMaterial=new c.Y({linewidth:1,color:r.OI.defaultEdgeColor,side:n.ehD,polygonOffset:!0,polygonOffsetFactor:-2,polygonOffsetUnits:-2}),this.initEdges(),this.initFaces(),this.initLinesegments(),this.initSurfaces()}initEdges(){let e=this.componentNode.component.mesh.edge;if(!e||0===e.position.length)return;let t=ThreeGeometryFactory.createEdgeBufferGeometry(e);this._edges=new h.w(t,this._edgeMaterial),this._edges.layers.set(Constants.Layers.Wireframe),this.add(this._edges)}initFaces(){let e=this.componentNode.component.mesh.face;if(!e||0===e.position.length)return;let t=ThreeGeometryFactory.createFaceBufferGeometry(e);e.groups.length>1&&(t.groups=e.groups);let s=this.context.getMaterial(this.componentNode.component.mesh.faceMaterials);this._faces=new n.Kj0(t,s),this._faces.layers.set(Constants.Layers.Solid),this.add(this._faces)}initSurfaces(){let e=this.componentNode.component.mesh.surface;if(!e||e.position?.length===0)return;let t=ThreeGeometryFactory.createFaceBufferGeometry(e);e.groups.length>1&&(t.groups=e.groups);let s=this.context.getMaterial(this.componentNode.component.mesh.surfaceMaterials);this._surfaces=new n.Kj0(t,s),this._surfaces.layers.set(Constants.Layers.Solid),this.add(this._surfaces)}initLinesegments(){let e=this.componentNode.component.mesh.linesegments;if(!e||e.position?.length===0)return;let t=new l.z;t.setPositions(e.position),t.computeBoundingBox(),this._linesegments=new h.w(t,this._edgeMaterial),this._linesegments.layers.set(Constants.Layers.Wireframe),this.add(this._linesegments)}boundingBox(){return this.componentNode.component.boundingBox}highlight(){if(!this._boundbox){let e=this.componentNode.component.boundingBox;if(!e)return;let t=new l.z;t.setPositions(r.kB.wireframe(e).position),this._boundbox=new h.w(t,d),this.add(this._boundbox)}this._boundbox.visible=!0}unhighlight(){this._boundbox&&(this._boundbox.visible=!1)}getSubShapeAndIndex(e,t){let s="face"===e?this.componentNode.component.mesh.face.range:this.componentNode.component.mesh.edge.range,i=ThreeHelper.findGroupIndex(s,t);return void 0!==i?{shape:s[i].shape,subShape:s[i].shape,transform:s[i].transform,index:i,groups:s}:{shape:void 0,subShape:void 0,transform:void 0,index:-1,groups:[]}}subShapeVisual(e){let t=[],s=e===r.ax.Shape||r.ax.hasCompound(e)||r.ax.hasCompoundSolid(e)||r.ax.hasSolid(e);return(s||r.ax.hasEdge(e)||r.ax.hasWire(e))&&t.push(this.edges),(s||r.ax.hasFace(e)||r.ax.hasShell(e))&&t.push(this.faces),t.filter(e=>void 0!==e)}wholeVisual(){return[this.edges,this.faces,this.linesegments,this.surfaces].filter(e=>void 0!==e)}};let ThreeGeometry=class ThreeGeometry extends ThreeVisualObject{geometryNode;context;_faceMaterial;_edgeMaterial;_edges;_faces;constructor(e,t){super(e),this.geometryNode=e,this.context=t,this._edgeMaterial=new c.Y({linewidth:1,color:r.OI.defaultEdgeColor,side:n.ehD,polygonOffset:!0,polygonOffsetFactor:-2,polygonOffsetUnits:-2}),this.handleGeometryPropertyChanged=e=>{"materialId"===e?this.changeFaceMaterial(this.context.getMaterial(this.geometryNode.materialId)):"shape"===e&&(this.removeMeshes(),this.generateShape())},this._faceMaterial=t.getMaterial(e.materialId),this.generateShape(),e.onPropertyChanged(this.handleGeometryPropertyChanged)}getMainMaterial(){return this._faces?this._faceMaterial:this._edgeMaterial}changeFaceMaterial(e){this._faces&&(this._faceMaterial=e,this._faces.material=e)}box(){return this._faces?.geometry.boundingBox??this._edges?.geometry.boundingBox}boundingBox(){let e=this._faces?.geometry.boundingBox??this._edges?.geometry.boundingBox;if(e)return{min:ThreeHelper.toXYZ(e.min),max:ThreeHelper.toXYZ(e.max)}}handleGeometryPropertyChanged;generateShape(){let e=this.geometryNode.mesh;e?.faces?.position.length&&this.initFaces(e.faces),e?.edges?.position.length&&this.initEdges(e.edges)}dispose(){super.dispose(),this._edges?.material.dispose(),this._edgeMaterial=null,this.geometryNode.removePropertyChanged(this.handleGeometryPropertyChanged),this.removeMeshes()}removeMeshes(){this._edges&&(this.remove(this._edges),this._edges.geometry.dispose(),this._edges=null),this._faces&&(this.remove(this._faces),this._faces.geometry.dispose(),this._faces=null)}initEdges(e){let t=ThreeGeometryFactory.createEdgeBufferGeometry(e);this._edges=new h.w(t,this._edgeMaterial),this._edges.layers.set(Constants.Layers.Wireframe),this.add(this._edges)}initFaces(e){let t=ThreeGeometryFactory.createFaceBufferGeometry(e);e.groups.length>1&&(t.groups=e.groups),this._faces=new n.Kj0(t,this._faceMaterial),this._faces.layers.set(Constants.Layers.Solid),this.add(this._faces)}setFacesMateiralTemperary(e){this._faces&&(this._faces.material=e)}setEdgesMateiralTemperary(e){this._edges&&(this._edges.material=e)}removeTemperaryMaterial(){this._edges&&(this._edges.material=this._edgeMaterial),this._faces&&(this._faces.material=this._faceMaterial)}cloneSubEdge(e){let t=o.j.subEdge(this.geometryNode.mesh.edges,e);if(!t)return;let s=new l.z;return s.setPositions(t),s.applyMatrix4(this.matrixWorld),new h.w(s,this._edgeMaterial)}cloneSubFace(e){let t=o.j.subFace(this.geometryNode.mesh.faces,e);if(!t)return;let s=ThreeGeometryFactory.createFaceBufferGeometry(t);return s.applyMatrix4(this.matrixWorld),new n.Kj0(s,this._faceMaterial)}faces(){return this._faces}edges(){return this._edges}getSubShapeAndIndex(e,t){let s,i,a,n=-1;"edge"===e?(a=this.geometryNode.mesh.edges?.range)&&(n=ThreeHelper.findGroupIndex(a,t),s=a[n].shape,i=a[n].transform):(a=this.geometryNode.mesh.faces?.range)&&(n=ThreeHelper.findGroupIndex(a,t),s=a[n].shape,i=a[n].transform);let o=s;return this.geometryNode instanceof r.EK&&(o=this.geometryNode.shape.value),{transform:i,shape:o,subShape:s,index:n,groups:a??[]}}subShapeVisual(e){let t=[],s=e===r.ax.Shape||r.ax.hasCompound(e)||r.ax.hasCompoundSolid(e)||r.ax.hasSolid(e);return(s||r.ax.hasEdge(e)||r.ax.hasWire(e))&&t.push(this.edges()),(s||r.ax.hasFace(e)||r.ax.hasShell(e))&&t.push(this.faces()),t.filter(e=>void 0!==e)}wholeVisual(){return[this.edges(),this.faces()].filter(e=>void 0!==e)}};(i||(i={})).is=function(e){return e&&"function"==typeof e.highlight&&"function"==typeof e.unhighlight};let GeometryState=class GeometryState{highlighter;visual;_states;constructor(e,t){this.highlighter=e,this.visual=t,this._states=new Map}getState(e,t){let s=this.state_key(e,t);return this._states.get(s)?.[0]}state_key(e,t){return`${e}_${t}`}addState(e,t,s){this.updateState("add",e,t,s)}removeState(e,t,s){this.updateState("remove",e,t,s)}updateState(e,t,s,i){r.ax.isWhole(s)?this.setWholeState(e,t,s):i.length>0&&this.setSubGeometryState(e,t,s,i)}setWholeState(e,t,s){let a=this.state_key(s),[n,o]=this.updateStates(a,e,t);this.visual instanceof ThreeGeometry?o===r.tR.normal?this.visual.removeTemperaryMaterial():r.tR.hasState(o,r.tR.edgeHighlight)?this.visual.setEdgesMateiralTemperary(d):r.tR.hasState(o,r.tR.edgeSelected)?this.visual.setEdgesMateiralTemperary(m):r.tR.hasState(o,r.tR.faceTransparent)&&(this.visual.removeTemperaryMaterial(),this.visual.setFacesMateiralTemperary(p)):i.is(this.visual)&&(o!==r.tR.normal?this.visual.highlight():this.visual.unhighlight()),this._states.set(a,[o,void 0])}updateStates(e,t,s){let i=this._states.get(e)?.[0],a=i;if(void 0===a){if("remove"===t)return[void 0,r.tR.normal];a=s}else a=("add"===t?r.tR.addState:r.tR.removeState)(a,s);return[i,a]}resetState(){this.highlighter.container.children.forEach(e=>{e.geometry?.dispose()}),this.highlighter.container.clear(),this.visual instanceof ThreeGeometry?this.visual.removeTemperaryMaterial():this.visual instanceof ThreeMeshObject&&this.visual.unhighlight(),this._states.clear()}setSubGeometryState(e,t,s,i){let a=[];i.forEach(i=>{let n=this.state_key(s,i),[o,h]=this.updateStates(n,e,t);void 0!==o&&h===r.tR.normal?a.push(n):this.addSubEdgeState(s,n,i,h)}),a.forEach(e=>{let t=this._states.get(e)?.[1];t&&(this.highlighter.container.remove(t),t.geometry?.dispose(),this._states.delete(e))})}addSubEdgeState(e,t,s,i){let a=this.getOrCloneGeometry(e,t,s);a&&"material"in a&&(a.material=r.tR.hasState(i,r.tR.edgeHighlight)?d:m,this._states.set(t,[i,a]))}getOrCloneGeometry(e,t,s){let i;if(!(this.visual instanceof ThreeGeometry))return;let a=this._states.get(t)?.[1];if(a)return a;if((r.ax.hasFace(e)||r.ax.hasShell(e))&&(i=o.j.subFaceOutlines(this.visual.geometryNode.mesh.faces,s)),void 0===i&&(r.ax.hasEdge(e)||r.ax.hasWire(e))&&(i=o.j.subEdge(this.visual.geometryNode.mesh.edges,s)),!i)return void console.warn(`Invalid type ${e} for ${t}`);let n=new l.z;n.setPositions(i);let c=new h.w(n);return this.highlighter.container.add(c),c.applyMatrix4(this.visual.matrixWorld),c}};let ThreeHighlighter=class ThreeHighlighter{content;_stateMap;container;constructor(e){this.content=e,this._stateMap=new Map,this.container=new n.ZAu,this.container.name="highlighter",this.content.scene.add(this.container)}clear(){this._stateMap.forEach((e,t)=>{this.resetState(t)}),this._stateMap.clear()}resetState(e){this._stateMap.has(e)&&(this._stateMap.get(e).resetState(),this._stateMap.delete(e))}getState(e,t,s){if(this._stateMap.has(e))return this._stateMap.get(e).getState(t,s)}addState(e,t,s,...i){this.getOrInitState(e).addState(t,s,i)}removeState(e,t,s,...i){this.getOrInitState(e).removeState(t,s,i)}getOrInitState(e){let t=this._stateMap.get(e);return t||(t=new GeometryState(this,e),this._stateMap.set(e,t)),t}highlightMesh(...e){let t=new n.ZAu;return e.forEach(e=>{r.YO.isVertex(e)?t.add(ThreeGeometryFactory.createVertexGeometry(e)):r.YO.isEdge(e)?t.add(ThreeGeometryFactory.createEdgeGeometry(e)):r.YO.isFace(e)&&t.add(ThreeGeometryFactory.createFaceGeometry(e))}),this.container.add(t),t.id}removeHighlightMesh(e){let t=this.container.getObjectById(e);void 0!==t&&(t.children.forEach(e=>{(e instanceof n.Kj0||e instanceof h.w||e instanceof n.woe)&&(e.geometry.dispose(),e.material.dispose()),r.Rl.isDisposable(e)&&e.dispose()}),t.children.length=0,this.container.remove(t))}};var _=s(4501),y=s(3817),v=s(6361),w=s(6514);let x=Math.PI/180,b=88*x;n.V1s.DEFAULT_UP=new n.Pa4(0,0,1);let CameraController=class CameraController extends r.y${view;_width;_height;_target;_position;_rotateCenter;_camera;get cameraType(){return this.getPrivateValue("cameraType","perspective")}set cameraType(e){this.setProperty("cameraType",e)&&(this._camera=this.createCamera(this._camera.near,this._camera.far),this.camera instanceof n.iKG&&this.updateOrthographicCamera(this.camera),this.updateCameraPosionTarget())}get target(){return this._target}set target(e){this._target.copy(e)}get cameraPosition(){return ThreeHelper.toXYZ(this._position)}get cameraTarget(){return ThreeHelper.toXYZ(this._target)}get cameraUp(){return ThreeHelper.toXYZ(this._camera.up)}get camera(){return this._camera}constructor(e){super(),this.view=e,this._width=100,this._height=100,this._target=new n.Pa4,this._position=new n.Pa4(1500,1500,1500),this._camera=this.createCamera(.1,1e6)}createCamera(e,t){let s;return s="perspective"===this.cameraType?new n.cPb(50,this._width/this._height,e,t):new n.iKG(-this._width/2,this._width/2,this._height/2,-this._height/2,e,t),this.setCameraLayer(s,this.view.mode),s}setCameraLayer(e,t){t===r.wO.wireframe?(e.layers.enable(Constants.Layers.Wireframe),e.layers.disable(Constants.Layers.Solid)):t===r.wO.solid?(e.layers.enable(Constants.Layers.Solid),e.layers.disable(Constants.Layers.Wireframe)):e.layers.enableAll()}pan(e,t){let s=.002*this._target.distanceTo(this._position),i=this._target.clone().sub(this._position).normalize(),r=i.clone().cross(this.camera.up).normalize(),a=r.clone().cross(i).normalize(),n=r.multiplyScalar(-e).add(a.multiplyScalar(t)).multiplyScalar(s);this._target.add(n),this._position.add(n),this.updateCameraPosionTarget()}updateCameraPosionTarget(){1-Math.abs(this._target.clone().sub(this._position).normalize().z)<r.Gc.Float?this._camera.up.set(0,1,0):this._camera.up.copy(n.V1s.DEFAULT_UP),this._camera.position.copy(this._position),this._camera.lookAt(this._target),this._camera.updateProjectionMatrix()}setSize(e,t){this._width=e,this._height=t,this.camera instanceof n.cPb?this.camera.aspect=e/t:this.camera instanceof n.iKG&&this.updateOrthographicCamera(this.camera),this.camera.updateProjectionMatrix()}updateOrthographicCamera(e){let t=this._width/this._height,s=this._position.distanceTo(this._target)*Math.tan(50*x/2);e.left=-s*t,e.right=s*t,e.top=s,e.bottom=-s}startRotate(e,t){let s=new n.ZzF,i=this.view.document.selection.getSelectedNodes();if(i.length>0){for(let e of i){let t=this.view.document.visual.context.getVisual(e);s.expandByObject(t)}this._rotateCenter=s.getCenter(new n.Pa4);return}let r=this.view.detectVisual(e,t).at(0);if(r instanceof ThreeVisualObject){s.setFromObject(r),this._rotateCenter=s.getCenter(new n.Pa4);return}this._rotateCenter=void 0}rotate(e,t){let s=this._rotateCenter??this._target,i=this._position.clone().sub(s),r=this.camera.up.clone().cross(i).normalize(),a=new n.yGw().makeRotationAxis(r,-(.01*this.ensureRotateY(i,t))),o=new n.yGw().makeRotationAxis(this.camera.up,-(.01*e)),h=new n.yGw().multiplyMatrices(o,a);if(this._position=ThreeHelper.transformVector(h,i).add(s),this._rotateCenter){let e=this._target.clone().sub(this._camera.position);this._target=ThreeHelper.transformVector(h,e).add(this._position)}this.updateCameraPosionTarget()}ensureRotateY(e,t){let s=Math.PI/2-e.angleTo(n.V1s.DEFAULT_UP),i=s+.01*t;return i>b?t=(b-s)/.01:i<-b&&(t=(-b-s)/.01),t}fitContent(){let e=this.view.document.visual.context,t=this.getBoundingSphere(e),s=25;this._width<this._height&&(s=s*this._width/this._height);let i=t.radius/Math.sin(s*x),r=this._target.clone().sub(this._position).normalize();this._target.copy(t.center),this._position.copy(this._target.clone().sub(r.clone().multiplyScalar(i))),this._camera instanceof n.iKG&&this.updateOrthographicCamera(this._camera),this.updateCameraNearFar(),this.updateCameraPosionTarget()}getBoundingSphere(e){let t=new n.aLr,s=this.view.document.selection.getSelectedNodes().filter(e=>e instanceof r.S3);if(0===s.length)return new n.ZzF().setFromObject(e.visualShapes).getBoundingSphere(t),t;let i=new n.ZzF;for(let t of s){let s=e.getVisual(t),r=new n.ZzF().setFromObject(s);r&&i.union(r)}return i.getBoundingSphere(t),t}zoom(e,t,s){let i=this._target.clone().sub(this._position),r=this.caclueZoomFactor(e,t,i),a=s>0?r:-r,o=this.mouseToWorld(e,t);this._camera instanceof n.cPb&&(o=this.caculePerspectiveCameraMouse(i,o));let h=this._target.clone().sub(o).multiplyScalar(a);this._target.add(h),this._position.copy(this._target.clone().sub(i.clone().multiplyScalar(1+a))),100>i.length()&&(this._target=this._position.clone().add(i.clone().normalize().multiplyScalar(100))),this._camera instanceof n.iKG&&this.updateOrthographicCamera(this._camera),this.updateCameraNearFar(),this.updateCameraPosionTarget()}caclueZoomFactor(e,t,s){let i=new n.iMs;i.setFromCamera(this.view.screenToCameraRect(e,t),this.camera);let r=i.intersectObjects(this.view.content.visualShapes.children).at(0)?.point,a=.1;return r&&(a=.1*this._position.distanceTo(r)/s.length()),a}updateCameraNearFar(){let e=this._position.distanceTo(this._target);e<1e3?(this.camera.near=.1,this.camera.far=1e4):e<1e5?(this.camera.near=10,this.camera.far=1e6):e<1e6?(this.camera.near=1e3,this.camera.far=1e7):(this.camera.near=1e4,this.camera.far=1e8)}caculePerspectiveCameraMouse(e,t){let s=e.clone().normalize(),i=t.clone().sub(this._position).dot(s),r=this._position.clone().add(s.clone().multiplyScalar(i)),a=r.distanceTo(t)*e.length()/r.distanceTo(this._position),n=t.clone().sub(r).normalize().multiplyScalar(a);return t=this._target.clone().add(n)}lookAt(e,t,s){this._position.set(e.x,e.y,e.z),this._target.set(t.x,t.y,t.z),this.camera.up.set(s.x,s.y,s.z),this.updateCameraPosionTarget()}mouseToWorld(e,t){let s=2*e/this._width-1,i=-2*t/this._height+1,r=this._position.distanceTo(this._target),a=(this._camera.far+this._camera.near-2*r)/(this._camera.near-this._camera.far);return new n.Pa4(s,i,a).unproject(this._camera)}};var C=s(4460);let T={size:200,padding:16,bubbleSizePrimary:18,bubbleSizeSeconday:10,lineWidth:2,fontSize:"24px",fontFamily:"arial",fontColor:"#151515",fontYAdjust:0,colors:{x:["#f73c3c","#942424"],y:["#6ccb26","#417a17"],z:["#178cf0","#0e5490"]}};let ViewGizmo=class ViewGizmo extends HTMLElement{view;_axes;_center;_canvas;_context;cameraController;_canClick;_selectedAxis;_mouse;constructor(e){super(),this.view=e,this._canClick=!0,this._onPointerMove=e=>{e.stopPropagation(),1===e.buttons&&(0!==e.movementX||0!==e.movementY)&&(this.cameraController.rotate(4*e.movementX,4*e.movementY),this._canClick=!1);let t=this._canvas.getBoundingClientRect();this._mouse=new n.Pa4(e.clientX-t.left,e.clientY-t.top,0).multiplyScalar(2),this.view.update()},this._onPointerDown=e=>{e.stopPropagation(),this._canvas.setPointerCapture(e.pointerId)},this._onPointerUp=e=>{e.stopPropagation(),this._canvas.releasePointerCapture(e.pointerId)},this._onPointerOut=e=>{e.stopPropagation(),this._mouse=void 0,this.style.backgroundColor="transparent"},this._onPointerEnter=e=>{e.stopPropagation(),this.style.backgroundColor="rgba(66, 66, 66, .9)"},this._onClick=e=>{if(e.stopPropagation(),!this._canClick){this._canClick=!0;return}if(this._selectedAxis){let e=this.cameraController.camera.position.distanceTo(this.cameraController.target),t=this._selectedAxis.direction.clone().multiplyScalar(e).add(this.cameraController.target);this.cameraController.camera.position.copy(t);let s=new r.vY(0,0,1);"z"===this._selectedAxis.axis?s=new r.vY(0,1,0):"-z"===this._selectedAxis.axis&&(s=new r.vY(0,-1,0)),this.cameraController.lookAt(this.cameraController.camera.position,this.cameraController.target,s),this.view.update()}},this.cameraController=e.cameraController,this._axes=this._initAxes(),this._center=new n.Pa4(.5*T.size,.5*T.size,0),this._canvas=this._initCanvas(),this._context=this._canvas.getContext("2d"),this._initStyle()}_initStyle(){this.style.zIndex="999",this.style.position="absolute",this.style.top="20px",this.style.right="20px",this.style.borderRadius="100%",this.style.cursor="pointer",this.style.userSelect="none",this.style.webkitUserSelect="none"}_initCanvas(){let e=document.createElement("canvas");return e.width=T.size,e.height=T.size,e.style.width=`${.5*T.size}px`,e.style.height=`${.5*T.size}px`,this.append(e),e}_initAxes(){return[{axis:"x",direction:new n.Pa4(1,0,0),position:new n.Pa4,size:T.bubbleSizePrimary,color:T.colors.x,lineWidth:T.lineWidth,label:"X"},{axis:"y",direction:new n.Pa4(0,1,0),position:new n.Pa4,size:T.bubbleSizePrimary,color:T.colors.y,lineWidth:T.lineWidth,label:"Y"},{axis:"z",direction:new n.Pa4(0,0,1),position:new n.Pa4,size:T.bubbleSizePrimary,color:T.colors.z,lineWidth:T.lineWidth,label:"Z"},{axis:"-x",direction:new n.Pa4(-1,0,0),position:new n.Pa4,size:T.bubbleSizeSeconday,color:T.colors.x},{axis:"-y",direction:new n.Pa4(0,-1,0),position:new n.Pa4,size:T.bubbleSizeSeconday,color:T.colors.y},{axis:"-z",direction:new n.Pa4(0,0,-1),position:new n.Pa4,size:T.bubbleSizeSeconday,color:T.colors.z}]}connectedCallback(){this._canvas.addEventListener("pointermove",this._onPointerMove),this._canvas.addEventListener("pointerenter",this._onPointerEnter),this._canvas.addEventListener("pointerout",this._onPointerOut),this._canvas.addEventListener("click",this._onClick),this._canvas.addEventListener("pointerdown",this._onPointerDown),this._canvas.addEventListener("pointerup",this._onPointerUp)}disconnectedCallback(){this._canvas.removeEventListener("pointermove",this._onPointerMove),this._canvas.removeEventListener("pointerenter",this._onPointerEnter),this._canvas.removeEventListener("pointerout",this._onPointerOut),this._canvas.removeEventListener("click",this._onClick),this._canvas.removeEventListener("pointerdown",this._onPointerDown),this._canvas.removeEventListener("pointerup",this._onPointerUp)}_onPointerMove;_onPointerDown;_onPointerUp;_onPointerOut;_onPointerEnter;_onClick;clear(){this._context.clearRect(0,0,this._canvas.width,this._canvas.height)}update(){this.clear();let e=new n.yGw().makeRotationFromEuler(this.cameraController.camera.rotation).invert();this._axes.forEach(t=>t.position=this.getBubblePosition(t.direction.clone().applyMatrix4(e))),this._axes.sort((e,t)=>e.position.z-t.position.z),this.setSelectedAxis(this._axes),this.drawAxes(this._axes)}setSelectedAxis(e){if(this._selectedAxis=void 0,this._mouse&&this._canClick){let t=1/0;for(let s of e){let e=this._mouse.distanceTo(s.position);e<t&&e<s.size&&(t=e,this._selectedAxis=s)}}}drawAxes(e){for(let t of e){let e=this.getAxisColor(t);this.drawCircle(t.position,t.size,e),this.drawLine(this._center,t.position,e,t.lineWidth),this.drawLabel(t)}}getAxisColor(e){let t;return this._selectedAxis===e?"#FFFFFF":e.position.z>=-.01?e.color[0]:e.color[1]}drawCircle(e,t=10,s="#FF0000"){this._context.beginPath(),this._context.arc(e.x,e.y,t,0,2*Math.PI,!1),this._context.fillStyle=s,this._context.fill(),this._context.closePath()}drawLine(e,t,s,i){i&&(this._context.beginPath(),this._context.moveTo(e.x,e.y),this._context.lineTo(t.x,t.y),this._context.lineWidth=i,this._context.strokeStyle=s,this._context.stroke(),this._context.closePath())}drawLabel(e){e.label&&(this._context.font=[T.fontSize,T.fontFamily].join(" "),this._context.fillStyle=T.fontColor,this._context.textBaseline="middle",this._context.textAlign="center",this._context.fillText(e.label,e.position.x,e.position.y+T.fontYAdjust))}getBubblePosition(e){return new n.Pa4(e.x*(this._center.x-T.bubbleSizePrimary/2-T.padding)+this._center.x,this._center.y-e.y*(this._center.y-T.bubbleSizePrimary/2-T.padding),e.z)}};customElements.define("view-gizmo",ViewGizmo);let ThreeView=class ThreeView extends r.y${document;highlighter;content;_dom;_resizeObserver;_scene;_renderer;_cssRenderer;_workplane;_needsUpdate;_gizmo;cameraController;dynamicLight;get name(){return this.getPrivateValue("name")}set name(e){this.setProperty("name",e)}get dom(){return this._dom}_isClosed;get isClosed(){return this._isClosed}get camera(){return this.cameraController.camera}get mode(){return this.getPrivateValue("mode",r.wO.solidAndWireframe)}set mode(e){this.setProperty("mode",e,()=>{this.cameraController.setCameraLayer(this.camera,this.mode)})}constructor(e,t,s,i,a){super(),this.document=e,this.highlighter=i,this.content=a,this._needsUpdate=!1,this.dynamicLight=new n.Ox3(0xffffff,2),this._isClosed=!1,this._resizerObserverCallback=e=>{for(let t of e)if(t.target===this._dom)return void this.resize(t.contentRect.width,t.contentRect.height)},this.setPrivateValue("name",t),this._scene=a.scene,this._workplane=s;let o=(0,r.Ds)(this._resizerObserverCallback,100);this._resizeObserver=new ResizeObserver(o),this.cameraController=new CameraController(this),this._renderer=this.initRenderer(),this._cssRenderer=this.initCssRenderer(),this._scene.add(this.dynamicLight),this._gizmo=new ViewGizmo(this),this.setPrivateValue("mode",r.wO.solidAndWireframe),this.camera.layers.enableAll(),this.document.application.views.push(this),this.animate()}disposeInternal(){super.disposeInternal(),this._resizeObserver.disconnect()}close(){if(this._isClosed)return;this._isClosed=!0,this.document.application.views.remove(this);let e=this.document.application.views.find(e=>e.document===this.document);e?this.document.application.activeView===this&&(this.document.application.activeView=e):this.document.close(),this.dispose(),r.pS.default.pub("viewClosed",this)}_resizerObserverCallback;get renderer(){return this._renderer}initRenderer(){let e=new y.CP7({antialias:!1,alpha:!0});return e.setPixelRatio(window.devicePixelRatio),e}initCssRenderer(){return new w.M}setDom(e){this._dom&&this._resizeObserver.unobserve(this._dom),this._dom=e,this._gizmo?.remove(),e.appendChild(this._gizmo),this._renderer.domElement.remove(),this._renderer.domElement.style.userSelect="none",this._renderer.domElement.style.webkitUserSelect="none",e.appendChild(this._renderer.domElement),this._cssRenderer.domElement.remove(),this._cssRenderer.domElement.style.position="absolute",this._cssRenderer.domElement.style.top="0px",this._cssRenderer.domElement.style.userSelect="none",this._cssRenderer.domElement.style.webkitUserSelect="none",e.appendChild(this._cssRenderer.domElement),this.resize(e.clientWidth,e.clientHeight),this._resizeObserver.observe(e),this.cameraController.updateCameraPosionTarget()}htmlText(e,t,s){let dispose=()=>{s?.onDispose?.(),this.content.cssObjects.remove(i),i.element.remove()},i=new w.j((0,_.hi)({className:C.htmlText},(0,_.yP)({textContent:e}),s?.hideDelete===!0?"":(0,_.YP)({className:C.delete,icon:"icon-times",onclick:e=>{e.stopPropagation(),dispose()}})));return i.position.set(t.x,t.y,t.z),s?.center&&i.center.set(s.center.x,s.center.y),this.content.cssObjects.add(i),{dispose}}toImage(){return this._renderer.render(this._scene,this.camera),this.renderer.domElement.toDataURL()}get workplane(){return this._workplane}set workplane(e){this.setProperty("workplane",e)}update(){this._needsUpdate=!0}animate(){if(this._isClosed||(requestAnimationFrame(()=>{this.animate()}),!this._needsUpdate))return;let e=this.camera.position.clone().sub(this.cameraController.target);this.dynamicLight.position.copy(e),this._renderer.render(this._scene,this.camera),this._cssRenderer.render(this._scene,this.camera),this._gizmo?.update(),this._needsUpdate=!1}resize(e,t){t<1e-5||(this.camera instanceof n.cPb?(this.camera.aspect=e/t,this.camera.updateProjectionMatrix()):this.camera instanceof n.iKG&&this.camera.updateProjectionMatrix(),this._renderer.setSize(e,t),this._cssRenderer.setSize(e,t),this.cameraController.setSize(e,t),this.update())}get width(){return this._dom?.clientWidth??1}get height(){return this._dom?.clientHeight??1}screenToCameraRect(e,t){return new n.FM8(e/this.width*2-1,-(2*(t/this.height))+1)}rayAt(e,t){let{x:s,y:i}=this.screenToCameraRect(e,t),a=new n.Pa4,o=new n.Pa4(s,i,.5);if(this.camera instanceof n.cPb)a.setFromMatrixPosition(this.camera.matrixWorld),o.unproject(this.camera).sub(a).normalize();else if(this.camera instanceof n.iKG){let e=(this.camera.near+this.camera.far)/(this.camera.near-this.camera.far);a.set(s,i,e).unproject(this.camera),o.set(0,0,-1).transformDirection(this.camera.matrixWorld)}else console.error("Unsupported camera type: "+this.camera);return new r.zH(ThreeHelper.toXYZ(a),ThreeHelper.toXYZ(o))}screenToWorld(e,t){let s=this.mouseToWorld(e,t);return ThreeHelper.toXYZ(s)}worldToScreen(e){let t=this.width/2,s=this.height/2,i=new n.Pa4(e.x,e.y,e.z).project(this.camera);return new r.XY(Math.round(t*i.x+t),Math.round(-s*i.y+s))}direction(){let e=new n.Pa4;return this.camera.getWorldDirection(e),ThreeHelper.toXYZ(e)}up(){return ThreeHelper.toXYZ(this.camera.up)}mouseToWorld(e,t,s=.5){let{x:i,y:r}=this.screenToCameraRect(e,t);return new n.Pa4(i,r,s).unproject(this.camera)}detectVisual(e,t,s){let i=[];for(let r of this.findIntersectedNodes(e,t)){let e=r.object.parent;if(!e)continue;let t=this.getNodeFromObject(e);void 0!==t&&(void 0===s||s.allow(t))&&i.push(e)}return i}detectVisualRect(e,t,s,i,r){let a=this.initSelectionBox(e,t,s,i),n=new Set;for(let e of a.select()){let t=e.parent;if(!t?.visible)continue;let s=this.getNodeFromObject(t);void 0!==s&&(void 0===r||r.allow(s))&&n.add(t)}return Array.from(n)}getNodeFromObject(e){let t;return e instanceof ThreeMeshObject?t=e.meshNode:e instanceof ThreeGeometry?t=e.geometryNode:e instanceof ThreeComponentObject&&(t=e.componentNode),t}initSelectionBox(e,t,s,i){let r=new v.M(this.camera,this._scene),a=this.screenToCameraRect(e,t),n=this.screenToCameraRect(s,i);return r.startPoint.set(a.x,a.y,.5),r.endPoint.set(n.x,n.y,.5),r}detectShapesRect(e,t,s,i,r,a){let n=this.initSelectionBox(t,s,i,r),o=[],h=new Set;for(let t of n.select())this.addDetectedShape(o,h,e,t,a);return o}addDetectedShape(e,t,s,i,a){let n=this.getParentShape(i);if(void 0===n||t.has(n))return;let addShape=s=>{e.push({shape:n,transform:ThreeHelper.toMatrix(i.parent.matrixWorld),owner:i.parent,indexes:s}),t.add(n)};if(s===r.ax.Shape)return void addShape([]);if((n.shapeType&s)==0||a&&!a.allow(n))return;let o=i instanceof h.w?n.mesh.edges?.range:n.mesh.faces?.range;addShape([...Array(o?.length).keys()])}getParentShape(e){if(e.parent?.visible&&e.parent instanceof ThreeGeometry)return e.parent.geometryNode.shape.unchecked()}detectShapes(e,t,s,i){let a=this.findIntersectedShapes(e,t,s);return r.ax.isWhole(e)?this.detectThreeShapes(a,i):this.detectSubShapes(e,a,i)}detectThreeShapes(e,t){for(let s of e){let e,i=s.object.parent;if(i instanceof ThreeGeometry){if((i.geometryNode instanceof r.EK?e=i.geometryNode.shape.unchecked():i.geometryNode instanceof r.Rr&&(e=this.findShapeAndIndex(i,s).shape),e)&&(!t||t.allow(e)))return[{owner:i,shape:e,transform:i.worldTransform(),point:ThreeHelper.toXYZ(s.pointOnLine??s.point),indexes:[]}]}}return[]}detectSubShapes(e,t,s){let i=[];for(let r of t){let t=r.object.parent;if(t instanceof ThreeVisualObject){let{shape:a,indexes:n,transform:o}=this.getSubShapeFromInsection(e,t,r);if(!a||s&&!s.allow(a))continue;let h=t.worldTransform();i.push({owner:t,shape:a,transform:o?h.multiply(o):h,point:ThreeHelper.toXYZ(r.pointOnLine??r.point),indexes:n})}}return i}getSubShapeFromInsection(e,t,s){let{shape:i,subShape:a,index:n,groups:o,transform:h}=this.findShapeAndIndex(t,s);if(!a||!i)return{shape:void 0,indexes:[]};if(r.ax.hasSolid(e)&&a.shapeType===r.ax.Face){let e=this.getAncestorAndIndex(r.ax.Solid,a,i,o);if(e.shape)return e}if(r.ax.hasShell(e)&&a.shapeType===r.ax.Face){let e=this.getAncestorAndIndex(r.ax.Shell,a,i,o);if(e.shape)return e}if(r.ax.hasWire(e)&&a.shapeType===r.ax.Edge){let e=this.getAncestorAndIndex(r.ax.Wire,a,i,o);if(e.shape)return e}return(r.ax.hasFace(e)||a.shapeType!==r.ax.Face)&&(r.ax.hasEdge(e)||a.shapeType!==r.ax.Edge)?{shape:a,indexes:[n],transform:h}:{shape:void 0,indexes:[n]}}getAncestorAndIndex(e,t,s,i){let r=t.findAncestor(e,s).at(0);if(!r)return{shape:void 0,indexes:[]};let a=[];for(let e of r.findSubShapes(t.shapeType))this.findIndex(i,e,a);return{shape:r,indexes:a,subShape:t,transform:i.at(0)?.transform}}findIndex(e,t,s){for(let i=0;i<e.length;i++)t.isEqual(e[i].shape)&&s.push(i)}findShapeAndIndex(e,t){let s="edge",i=2*t.faceIndex;return t.pointOnLine||(s="face",i=3*t.faceIndex),e.getSubShapeAndIndex(s,i)}findIntersectedNodes(e,t){let s=[];return this.document.visual.context.visuals().forEach(e=>{e.visible&&e instanceof ThreeVisualObject&&s.push(...e.wholeVisual())}),this.initRaycaster(e,t).intersectObjects(s,!1)}findIntersectedShapes(e,t,s){let i=this.initRaycaster(t,s),r=this.initIntersectableShapes(e);return i.intersectObjects(r,!1)}initIntersectableShapes(e){let t=[];return this.document.visual.context.visuals().forEach(s=>{s.visible&&s instanceof ThreeVisualObject&&t.push(...s.subShapeVisual(e))}),t}initRaycaster(e,t){let s=Constants.RaycasterThreshold,{x:i,y:a}=this.screenToCameraRect(e,t),o=new n.FM8(i,a),h=new n.iMs;return this.mode===r.wO.wireframe?(h.layers.disableAll(),h.layers.enable(Constants.Layers.Wireframe)):this.mode===r.wO.solid?(h.layers.disableAll(),h.layers.enable(Constants.Layers.Solid)):h.layers.enableAll(),h.setFromCamera(o,this.camera),h.params={...h.params,Line2:{threshold:s},Line:{threshold:s},Points:{threshold:s}},h}};let ThreeVisualContext=class ThreeVisualContext{visual;scene;_visualNodeMap;_NodeVisualMap;materialMap;visualShapes;tempShapes;cssObjects;constructor(e,t){this.visual=e,this.scene=t,this._visualNodeMap=new Map,this._NodeVisualMap=new Map,this.materialMap=new Map,this.onMaterialCollectionChanged=e=>{e.action===r.mn.add?e.items.forEach(this.createThreeMaterial.bind(this)):e.action===r.mn.remove&&e.items.forEach(this.removeThreeMaterial.bind(this))},this.onMaterialPropertyChanged=(e,t)=>{let s=this.materialMap.get(t?.id);if(!s)return;let{isOk:i,value:a}=r.ud.getPathValue(t,e);i&&("color"===e?s.color.set(a):e.includes(".")?this.setTextureValue(t,s,e,a):s[e]=a instanceof r.xE?ThreeHelper.loadTexture(a):a)},this.handleNodeChanged=e=>{let t=[],s=[];e.forEach(e=>{e.action===r.s4.add||e.action===r.s4.insertBefore||e.action===r.s4.insertAfter?r.ND.nodeOrChildrenAppendToNodes(t,e.node):e.action===r.s4.remove||e.action===r.s4.transfer?r.ND.nodeOrChildrenAppendToNodes(s,e.node):e.action===r.s4.move&&e.newParent&&this.moveNode(e.node,e.oldParent)}),this.addNode(t),this.removeNode(s)},this.visualShapes=new n.ZAu,this.tempShapes=new n.ZAu,this.cssObjects=new n.ZAu,t.add(this.visualShapes,this.tempShapes,this.cssObjects),e.document.addNodeObserver(this),e.document.materials.onCollectionChanged(this.onMaterialCollectionChanged)}onMaterialCollectionChanged;createThreeMaterial(e){let t=ThreeHelper.parseToThreeMaterial(e);r.ud.addDeepPropertyChangedHandler(e,this.onMaterialPropertyChanged),this.materialMap.set(e.id,t)}removeThreeMaterial(e){let t=this.materialMap.get(e.id);this.materialMap.delete(e.id),r.ud.removeDeepPropertyChangedHandler(e,this.onMaterialPropertyChanged),t?.dispose()}onMaterialPropertyChanged;setTextureValue(e,t,s,i){let a=s.split(".");if(s.endsWith(".image")&&e[a[0]]instanceof r.xE&&a[0]in t){t[a[0]]=ThreeHelper.loadTexture(e[a[0]]);return}let n=t;for(let e=0;e<a.length-1;e++)n=n[a[e]];void 0!==n&&(i instanceof r.XY?n[a.at(-1)].set(i.x,i.y):n[a.at(-1)]=i)}handleNodeChanged;addVisualObject(e){e instanceof n.Tme&&this.visualShapes.add(e)}removeVisualObject(e){e instanceof n.Tme&&this.visualShapes.remove(e)}dispose(){this.visualShapes.traverse(e=>{r.Rl.isDisposable(e)&&e.dispose()}),this.visual.document.materials.forEach(e=>e.removePropertyChanged(this.onMaterialPropertyChanged)),this.visual.document.materials.removeCollectionChanged(this.onMaterialCollectionChanged),this.visual.document.removeNodeObserver(this),this.materialMap.forEach(e=>e.dispose()),this.materialMap.clear(),this.visualShapes.clear(),this.tempShapes.clear(),this._visualNodeMap.clear(),this._NodeVisualMap.clear(),this.scene.remove(this.visualShapes,this.tempShapes)}getNode(e){return this._visualNodeMap.get(e)}redrawNode(e){this.removeNode(e),this.addNode(e)}get shapeCount(){return this.visualShapes.children.length}getVisual(e){return this._NodeVisualMap.get(e)}visuals(){let e=[];return this.visualShapes.children.forEach(t=>this._getVisualObject(e,t)),e}boundingBoxIntersectFilter(e,t){let s=new n.ZzF().setFromPoints([ThreeHelper.fromXYZ(e.min),ThreeHelper.fromXYZ(e.max)]);return this.visuals().filter(e=>{let i=e?.geometryNode,a=i?.shape.unchecked();if(t&&a&&!t.allow(a))return!1;let o=r.kB.transformed(e.boundingBox(),i.worldTransform());if(void 0===o)return!1;let h=new n.ZzF(new n.Pa4(o.min.x,o.min.y,o.min.z),new n.Pa4(o.max.x,o.max.y,o.max.z));return s.intersectsBox(h)})}_getVisualObject(e,t){"Group"===t.type?t.children.forEach(t=>this._getVisualObject(e,t)):(t instanceof ThreeGeometry||t instanceof ThreeMeshObject||t instanceof ThreeComponentObject)&&e.push(t)}displayMesh(...e){let t=new n.ZAu;return e.forEach(e=>{r.YO.isVertex(e)?t.add(ThreeGeometryFactory.createVertexGeometry(e)):r.YO.isEdge(e)?t.add(ThreeGeometryFactory.createEdgeGeometry(e)):r.YO.isFace(e)&&t.add(ThreeGeometryFactory.createFaceGeometry(e))}),this.tempShapes.add(t),t.id}removeMesh(e){let t=this.tempShapes.getObjectById(e);void 0!==t&&(t.children.forEach(e=>{(e instanceof n.Kj0||e instanceof n.ejS||e instanceof n.woe)&&(e.geometry.dispose(),e.material.dispose()),r.Rl.isDisposable(e)&&e.dispose()}),t.children.length=0,this.tempShapes.remove(t))}setVisible(e,t){let s=this.getVisual(e);void 0!==s&&s.visible!==t&&(s.visible=t)}moveNode(e,t){if(t===e.parent)return;let s=this._NodeVisualMap.get(t)??this.visualShapes,i=this._NodeVisualMap.get(e.parent)??this.visualShapes;if(s!==i&&s instanceof n.ZAu){let t=this._NodeVisualMap.get(e);t instanceof n.Tme&&(s.remove(t),i.add(t))}}addNode(e){e.forEach(e=>{this._NodeVisualMap.has(e)||this.displayNode(e)})}displayNode(e){let t;e instanceof r.bR?t=new ThreeMeshObject(this,e):e instanceof r.R3?t=new ThreeGeometry(e,this):e instanceof r.Gw?t=new GroupVisualObject(e):e instanceof r.sK&&(t=new ThreeComponentObject(e,this)),t&&(this.getParentVisual(e).add(t),this._visualNodeMap.set(t,e),this._NodeVisualMap.set(e,t))}removeNode(e){e.forEach(e=>{let t=this._NodeVisualMap.get(e);this._NodeVisualMap.delete(e),t&&(this._visualNodeMap.delete(t),t.parent?.remove(t),t.dispose())})}getParentVisual(e){let t=this.visualShapes;if(e.parent){let s=this._NodeVisualMap.get(e.parent);s instanceof n.ZAu&&(t=s)}return t}findShapes(e){if(e===r.ax.Shape)return[...this.visualShapes.children];let t=[];return this.visualShapes.traverse(s=>{if(s instanceof ThreeGeometry){if(e===r.ax.Edge){let e=s.edges();e&&t.push(e)}else if(e===r.ax.Face){let e=s.faces();e&&t.push(e)}}}),t}getMaterial(e){if(Array.isArray(e)){let t=[];for(let s of e){let e=this.materialMap.get(s);if(!e)throw Error(`Material not found: ${s}`);t.push(e)}return 1===t.length?t[0]:t}let t=this.materialMap.get(e);if(!t)throw Error(`Material not found: ${e}`);return t}};let ThreeViewHandler=class ThreeViewHandler{_lastDown;_clearDownId;_offsetPoint;lastPointerEventMap=new Map;currentPointerEventMap=new Map;canRotate=!0;dispose(){this.clearTimeout(),this.lastPointerEventMap.clear(),this.currentPointerEventMap.clear()}mouseWheel(e,t){e.cameraController.zoom(t.offsetX,t.offsetY,t.deltaY),e.update()}pointerMove(e,t){"mouse"===t.pointerType?this.handleMouseMove(e,t):this.handleTouchMove(e,t),e.update()}handleMouseMove(e,t){if(4!==t.buttons)return;let s=0,i=0;this._offsetPoint&&(s=t.offsetX-this._offsetPoint.x,i=t.offsetY-this._offsetPoint.y,this._offsetPoint={x:t.offsetX,y:t.offsetY}),t.shiftKey&&this.canRotate?e.cameraController.rotate(s,i):t.shiftKey||e.cameraController.pan(s,i),0!==s&&0!==i&&(this._lastDown=void 0)}handleTouchMove(e,t){if(!this.currentPointerEventMap.has(t.pointerId))return void this.currentPointerEventMap.set(t.pointerId,t);if(3===this.currentPointerEventMap.size&&3===this.lastPointerEventMap.size){let t=this.getPrimaryTouchOffset();t&&e.cameraController.rotate(t.dx,t.dy)}else if(2===this.currentPointerEventMap.size&&2===this.lastPointerEventMap.size){let t=this.getCenterAndDistance(this.lastPointerEventMap),s=this.getCenterAndDistance(this.currentPointerEventMap),i=this.distance(s.center.x,s.center.y,t.center.x,t.center.y),r=s.distance-t.distance;i>.5*Math.abs(r)?e.cameraController.pan(s.center.x-t.center.x,s.center.y-t.center.y):e.cameraController.zoom(s.center.x,s.center.y,-r)}this.lastPointerEventMap.clear(),this.lastPointerEventMap=this.currentPointerEventMap,this.currentPointerEventMap=new Map}getPrimaryTouchOffset(){let findPrimary=e=>{let t;for(let[,s]of e)if(s.isPrimary){t=s;break}return t},e=findPrimary(this.lastPointerEventMap),t=findPrimary(this.currentPointerEventMap);if(e&&t)return{dx:t.offsetX-e.offsetX,dy:t.offsetY-e.offsetY}}getCenterAndDistance(e){let t=e.values(),s=t.next().value,i=t.next().value;return{center:{x:(s.offsetX+i.offsetX)/2,y:(s.offsetY+i.offsetY)/2},distance:this.distance(s.offsetX,i.offsetX,s.offsetY,i.offsetY)}}distance(e,t,s,i){return Math.sqrt(Math.pow(e-s,2)+Math.pow(t-i,2))}pointerDown(e,t){this.clearTimeout(),"mouse"===t.pointerType?this.handleMouseDown(t,e):this.lastPointerEventMap.set(t.pointerId,t)}handleMouseDown(e,t){this._lastDown&&this._lastDown.time+500>Date.now()&&4===e.buttons?(this._lastDown=void 0,t.cameraController.fitContent(),t.update()):4===e.buttons&&(t.cameraController.startRotate(e.offsetX,e.offsetY),this._lastDown={time:Date.now(),key:e.buttons},this._offsetPoint={x:e.offsetX,y:e.offsetY})}clearTimeout(){this._clearDownId&&(clearTimeout(this._clearDownId),this._clearDownId=void 0)}pointerOut(e,t){this._lastDown=void 0,this.lastPointerEventMap.delete(t.pointerId),this.currentPointerEventMap.delete(t.pointerId)}pointerUp(e,t){4===t.buttons&&this._lastDown&&(this._clearDownId=window.setTimeout(()=>{this._lastDown=void 0,this._clearDownId=void 0},500)),this._offsetPoint=void 0,this.lastPointerEventMap.delete(t.pointerId),this.currentPointerEventMap.delete(t.pointerId)}keyDown(e,t){}};n.Tme.DEFAULT_UP.set(0,0,1);let ThreeVisual=class ThreeVisual{document;defaultEventHandler;context;scene;highlighter;viewHandler;_eventHandler;get eventHandler(){return this._eventHandler}set eventHandler(e){this._eventHandler!==e&&(this._eventHandler=e,r.Yd.info(`Changed EventHandler to ${Object.getPrototypeOf(e).constructor.name}`))}constructor(e){this.document=e,this.scene=this.initScene(),this.defaultEventHandler=new a.t(e,!0),this.viewHandler=new ThreeViewHandler,this.context=new ThreeVisualContext(this,this.scene),this.highlighter=new ThreeHighlighter(this.context),this._eventHandler=this.defaultEventHandler}initScene(){let e=new n.xsS,t=new n.Mig(8947848,4),s=new n.y8_(250);return e.add(t,s),e}resetEventHandler(){this.eventHandler=this.defaultEventHandler}isExcutingHandler(){return this.eventHandler!==this.defaultEventHandler}createView(e,t){return new ThreeView(this.document,e,t,this.highlighter,this.context)}update(){this.document.application.views.forEach(e=>{e.document===this.document&&e.update()})}dispose(){this.context.dispose(),this.defaultEventHandler.dispose(),this._eventHandler.dispose(),this.viewHandler.dispose(),this.scene.traverse(e=>{r.Rl.isDisposable(e)&&e.dispose()}),this.scene.clear()}};let ThreeVisulFactory=class ThreeVisulFactory{kernelName="three";create(e){return new ThreeVisual(e)}}},4460:function(e,t,s){e.exports={htmlText:"chili3d-ad69817ab66c6b13-htmlText",delete:"chili3d-ad69817ab66c6b13-delete"}}}]);
//# sourceMappingURL=897.js.map